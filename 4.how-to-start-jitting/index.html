<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>How to start JIT-ting</title>
		<meta name="description" content="Darkside of Software Engineering.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Fedor Indutny&#39;s Blog">
		<link rel="alternate" href="/feed/feed.json" type="application/json" title="Fedor Indutny&#39;s Blog">
		<meta name="generator" content="Eleventy v2.0.0">
		
		<style>/* Only include the syntax highlighter CSS on blog posts */
/**
 * okaidia theme for JavaScript, CSS and HTML
 * Loosely based on Monokai textmate theme by http://www.monokai.nl/
 * @author ocodia
 */

code[class*="language-"],
pre[class*="language-"] {
	color: #f8f8f2;
	background: none;
	text-shadow: 0 1px rgba(0, 0, 0, 0.3);
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
	border-radius: 0.3em;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #272822;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: #8292a2;
}

.token.punctuation {
	color: #f8f8f2;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.constant,
.token.symbol,
.token.deleted {
	color: #f92672;
}

.token.boolean,
.token.number {
	color: #ae81ff;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #a6e22e;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string,
.token.variable {
	color: #f8f8f2;
}

.token.atrule,
.token.attr-value,
.token.function,
.token.class-name {
	color: #e6db74;
}

.token.keyword {
	color: #66d9ef;
}

.token.regex,
.token.important {
	color: #fd971f;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}

/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
* { box-sizing: border-box; }
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #082840;
	--text-color-link-active: #5f2b48;
	--text-color-link-visited: #17050F;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main {
	padding: 1rem;
}
main :first-child {
	margin-top: 0;
}

header {
	border-bottom: 1px dashed var(--color-gray-20);
}
header:after {
	content: "";
	display: table;
	clear: both;
}

.links-nextprev {
	list-style: none;
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
}
pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
}
code {
	word-break: normal;
}

/* Header */
header {
	display: flex;
	gap: 1em .5em;
	flex-wrap: wrap;
	align-items: center;
	padding: 1em;
}
.home-link {
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
	margin-right: 2em;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	padding: 0;
	margin: 0;
	list-style: none;
  align-items: center;
}
.nav-item {
	display: inline-block;
	margin-right: 1em;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}
.nav-item svg.social {
  display: block;
  width: 18px;
  height: 18px;
}

/* Posts list */
.postlist {
	list-style: none;
	padding: 0;
	padding-left: 1.5rem;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	content: "" counter(start-from, decimal-leading-zero) ". ";
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	padding-left: .25em;
	padding-right: .5em;
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	text-transform: capitalize;
	font-style: italic;
}
.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

/* Direct Links / Markdown Headers */
.header-anchor {
	text-decoration: none;
	font-style: normal;
	font-size: 1em;
	margin-left: .1em;
}
a[href].header-anchor,
a[href].header-anchor:visited {
	color: transparent;
}
a[href].header-anchor:focus,
a[href].header-anchor:hover {
	text-decoration: underline;
}
a[href].header-anchor:focus,
:hover > a[href].header-anchor {
	color: #aaa;
}

h2 + .header-anchor {
	font-size: 1.5em;
}

footer {
  padding: 1.5em 0 0.5em 0;
  font-size: 0.75em;
  text-align: right;
}

img {
  max-width: 100%;
  height: auto;
}</style>
	</head>
	<body>
		<a href="#skip" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">Fedor Indutny&#39;s Blog</a>

      
			<nav>
				<h2 class="visually-hidden">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/blog/">Archive</a></li>
					<li class="nav-item"><a href="/about/">About Me</a></li>
          <li class="nav-item">
            <a href="https://github.com/indutny" target="_blank" rel="noreferrer">
              <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github fa-w-16 social" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
            </a>
          </li>
          <li class="nav-item">
            <a href="https://fosstodon.org/@indutny" target="_blank" rel="me">
              <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="mastodon" class="svg-inline--fa fa-mastodon fa-w-14 social" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"></path></svg>
            </a>
          </li>
				</ul>
			</nav>
		</header>

		<main id="skip">
			
<h1>How to start JIT-ting</h1>

<ul class="post-metadata">
	<li><time datetime="2013-11-01">01 November 2013</time></li>
	<li><a href="/tags/compilers/" class="post-tag">compilers</a></li>
</ul>

<h2 id="premise" tabindex="-1">Premise <a class="header-anchor" href="#premise">#</a></h2>
<p>Most developers heard about JIT compilers and how they can make slow interpreted
languages run at a speed, comparable to native code. However, not many people
understand how exactly this JIT thing works, and even less people could
write their own compilers.</p>
<p>I think having at least, basic knowledge of compiler internals may greatly
improve understanding of the code that is running on that software.</p>
<p>In this article, we'll visit some peaks of JIT-island, and probably even
implement a compiler ourselves!</p>
<h2 id="what-we-ll-start-with" tabindex="-1">What we'll start with <a class="header-anchor" href="#what-we-ll-start-with">#</a></h2>
<p>Knowing some compiler basics, we can assume that every compiler is
transforming input in some format (usually, a source code) into the output in
another or same format (usually, a machine code). JIT compilers are not an
exception.</p>
<p>What really makes them exceptional, is the fact that they're running not ahead
of time (like gcc, clang and others), but Just-In-Time (i.e. right before
executing compiler's output).</p>
<p>To start developing our own JIT compiler we'll need to select the input language
for it. Considering <a href="http://adambard.com/blog/top-github-languages-for-2013-so-far/">TOP GITHUB LANGUAGES FOR 2013 (SO FAR)</a>, JavaScript
seems like a good candidate for implementing some limited subset of
it with simplified semantics. Even more, we'll implement JIT compiler in the
JavaScript itself. You can call it META-META!</p>
<h2 id="ast" tabindex="-1">AST <a class="header-anchor" href="#ast">#</a></h2>
<p>Our compiler will accept JavaScript source code as its input, and produce (and
immediately execute) machine code for the very popular X64 platform. But, while
its pretty comfortable for humans to work with a textual representation,
compiler developers are usually tending to create multiple Intermediate
Representations (IR) before generating the final machine code.</p>
<p>Since we're writing simplified compiler, having only one IR should be enough for
us, and I'll choose Abstract Syntax Tree (AST) representation for this purposes.</p>
<p>Getting AST out of JavaScript code is really easy nowadays, and we can choose
any (of dozens) library we like: <a href="https://github.com/ariya/esprima">esprima</a>, <a href="https://github.com/ariya/esprima">uglify-js</a>, etc. Just to be
on one page with me, I recommend you to choose <a href="https://github.com/ariya/esprima">esprima</a>. It has a nice and
well defined <a href="https://developer.mozilla.org/en-US/docs/SpiderMonkey/Parser_API">output format</a>.</p>
<p>For example, this code: <code>obj.method(42)</code> will produce the following AST (using
<code>esprima.parse(&quot;...&quot;)</code>):</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'Program'</span><span class="token punctuation">,</span><br>  <span class="token literal-property property">body</span><span class="token operator">:</span><br>   <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'ExpressionStatement'</span><span class="token punctuation">,</span><br>       <span class="token literal-property property">expression</span><span class="token operator">:</span><br>        <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'CallExpression'</span><span class="token punctuation">,</span><br>          <span class="token literal-property property">callee</span><span class="token operator">:</span><br>           <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'MemberExpression'</span><span class="token punctuation">,</span><br>             <span class="token literal-property property">computed</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>             <span class="token literal-property property">object</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'Identifier'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'obj'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>             <span class="token literal-property property">property</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'Identifier'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'method'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>          <span class="token literal-property property">arguments</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'Literal'</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">42</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span></code></pre>
<h2 id="machine-code" tabindex="-1">Machine code <a class="header-anchor" href="#machine-code">#</a></h2>
<p>Let's summarize: we have JavaScript source (<em>check</em>), its AST (<em>check</em>), and we
want to get machine code for it.</p>
<p>If you're already familiar with assembly language then you can skip this
chapter, as it contains only basic introductionary material on this topic.
However, if you're new to it, reading next chapter may be hard without learning
some basics first. So please stay here, it won't take too long!</p>
<p>Assembly language is the nearest textual representation of the binary code that
your CPU(s) understand and is(are) able to run. Considering that processors are
executing code by reading and running instructions one-by-one, it may seem
logical to you that almost every line in assembly program represent an
instruction:</p>
<pre><code>mov rax, 1    ; Put 1 into the register named `rax`
mov rbx, 2    ; Put 2 into the register named `rbx`
add rax, rbx  ; Calculate sum of `rax` and `rbx` and put it into `rax`
</code></pre>
<p>This program's output (assuming you'll get it from <code>rax</code> register) is 3. And,
as you've probably already figured out, it puts some data in some CPU slots
(<a href="http://en.wikipedia.org/wiki/Processor_register">registers</a>) and asks the CPU to calculate the sum of them.</p>
<p>Usually processors have enough registers to store results of intermediate
operations, but in some situations you may want to store/load data (and work
with it) from the computer's memory:</p>
<pre><code>mov rax, 1
mov [rbp-8], rbx  ; Save rbx register into a stack slot
mov rbx, 2
add rax, rbx
mov rbx, [rbp-8]  ; Restore rbx register from a stack slot
</code></pre>
<p>Registers have names, memory slots have addresses. These addresses are usually
written using <code>[...]</code> syntax. For example, <code>[rbp-8]</code> means: take the value of
the <code>rbp</code> register, subtract <code>8</code>, and access a memory slot using the resulting
value as the address.</p>
<p>You can see that we're using <code>rbp</code> register here. <code>rbp</code> usually contains
address at which on-stack variables storage (i.e. variables that are stored in
current procedure's <a href="http://en.wikipedia.org/wiki/Stack_(abstract_data_type)">stack</a>) starts; <code>8</code> is a size of <code>rbx</code> register (and any
other register, prefixed with <code>r</code>), and since the <a href="http://en.wikipedia.org/wiki/Stack_(abstract_data_type)">stack</a> is growing upwards,
we need to subtract it from <code>rbp</code> to get a free address slot for our purposes.</p>
<p>There are many more nuances of programming at such a low level, and
unfortunately I'm not going to cover all of them here. Also, please be aware
that I gave you a very shallow description, and what actually happens here may
sometimes be much more complex.</p>
<p>Knowing things mentioned above should be enough to proceed to the code
generation.</p>
<h2 id="code-generation" tabindex="-1">Code generation <a class="header-anchor" href="#code-generation">#</a></h2>
<p>Implementing the entire JavaScript is a rather complicated practice, so we'll
implement only a simplified arithmetics engine for now. (Which should be as fun
as getting to the whole thing later!)</p>
<p>The best and the easiest way to do it, is to traverse the AST using
<a href="http://en.wikipedia.org/wiki/Depth-first_search">Depth First Search</a>, generating machine code for each node. You might wonder
how could you generate machine code in a memory-safe language like JavaScript.
That's where I'm going to introduce you to <a href="https://github.com/indutny/jit.js">jit.js</a>.</p>
<p>It is a node.js module (and C++ addon, actually) capable of generating and
execution of machine code, using assembly-like JavaScript syntax:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">var</span> jit <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jit.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">var</span> fn <span class="token operator">=</span> jit<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">Proc</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mov</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">Return</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 42</span></code></pre>
<h2 id="let-s-write-it" tabindex="-1">Let's write it <a class="header-anchor" href="#let-s-write-it">#</a></h2>
<p>Thus only one thing left now, a module to traverse the AST tree, generated by
<a href="https://github.com/ariya/esprima">esprima</a>. Thankfully, considering its structure and our minimalistic
compiler design it should be pretty easy.</p>
<p>We're going to support:</p>
<ol>
<li>Number literals (<code>{ type: 'Literal', value: 123 }</code>)</li>
<li>Binary expression, with operators: <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, <code>%</code>
(<code>{ type: 'BinaryExpression', operator: '+', left: ... , right: .... }</code>)</li>
<li>Unary expression, with the <code>-</code> operator
(<code>{ type: 'UnaryExpression', operator: '-', argument: ... }</code>)</li>
</ol>
<p>All these operations are performed on integers, so don't expect it to work
properly with values like <code>0.5</code>, <code>0.66666</code>, etc.</p>
<p>While processing expression, we'll be visiting each supported AST node of it,
generating code that returns it's result in the <code>rax</code> register. Sounds easy,
right? The only rule here is that we should keep all other registers clean
after leaving the AST node. Which, in other words, means that we should save all
registers that are used and restore them after they're not needed anymore.
Fortunately, CPUs have two magic instructions <code>push</code> and <code>pop</code> that can help us
with that task.</p>
<p>Here is the resulting code with descriptive comments:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">var</span> jit <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jit.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    esprima <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'esprima'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    assert <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'assert'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">var</span> ast <span class="token operator">=</span> esprima<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// Compile</span><br><span class="token keyword">var</span> fn <span class="token operator">=</span> jit<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// This will generate default entry boilerplate</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">Proc</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">visit</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ast<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// The result should be in 'rax' at this point</span><br><br>    <span class="token comment">// This will generate default exit boilerplate</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">Return</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// Execute</span><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">function</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token parameter">ast</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ast<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'Program'</span><span class="token punctuation">)</span><br>    <span class="token function">visitProgram</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ast<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ast<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'Literal'</span><span class="token punctuation">)</span><br>    <span class="token function">visitLiteral</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ast<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ast<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'UnaryExpression'</span><span class="token punctuation">)</span><br>    <span class="token function">visitUnary</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ast<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ast<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'BinaryExpression'</span><span class="token punctuation">)</span><br>    <span class="token function">visitBinary</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ast<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">else</span><br>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Unknown ast node: '</span> <span class="token operator">+</span> ast<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">visitProgram</span><span class="token punctuation">(</span><span class="token parameter">ast</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span>length<span class="token punctuation">,</span><br>               <span class="token number">1</span><span class="token punctuation">,</span><br>               <span class="token string">'Only one statement programs are supported'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token string">'ExpressionStatement'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">visit</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ast<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">visitLiteral</span><span class="token punctuation">(</span><span class="token parameter">ast</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> ast<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token string">'number'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>value <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">,</span><br>               ast<span class="token punctuation">.</span>value<span class="token punctuation">,</span><br>               <span class="token string">'Only integer numbers are supported'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mov</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> ast<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">visitBinary</span><span class="token punctuation">(</span><span class="token parameter">ast</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// Preserve 'rbx' after leaving the AST node</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'rbx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Visit right side of expresion</span><br>  <span class="token function">visit</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ast<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Move it to 'rbx'</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mov</span><span class="token punctuation">(</span><span class="token string">'rbx'</span><span class="token punctuation">,</span> <span class="token string">'rax'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Visit left side of expression (the result is in 'rax')</span><br>  <span class="token function">visit</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ast<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">//</span><br>  <span class="token comment">// So, to conclude, we've left side in 'rax' and right in 'rbx'</span><br>  <span class="token comment">//</span><br><br>  <span class="token comment">// Execute binary operation</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ast<span class="token punctuation">.</span>operator <span class="token operator">===</span> <span class="token string">'+'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token string">'rbx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ast<span class="token punctuation">.</span>operator <span class="token operator">===</span> <span class="token string">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token string">'rbx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ast<span class="token punctuation">.</span>operator <span class="token operator">===</span> <span class="token string">'*'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Signed multiplication</span><br>    <span class="token comment">// rax = rax * rbx</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">imul</span><span class="token punctuation">(</span><span class="token string">'rbx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ast<span class="token punctuation">.</span>operator <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Preserve 'rdx'</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'rdx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// idiv is dividing rdx:rax by rbx, therefore we need to clear rdx</span><br>    <span class="token comment">// before running it</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">xor</span><span class="token punctuation">(</span><span class="token string">'rdx'</span><span class="token punctuation">,</span> <span class="token string">'rdx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Signed division, rax = rax / rbx</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">idiv</span><span class="token punctuation">(</span><span class="token string">'rbx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Restore 'rdx'</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token string">'rdx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ast<span class="token punctuation">.</span>operator <span class="token operator">===</span> <span class="token string">'%'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Preserve 'rdx'</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'rdx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Prepare to execute idiv</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">xor</span><span class="token punctuation">(</span><span class="token string">'rdx'</span><span class="token punctuation">,</span> <span class="token string">'rdx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">idiv</span><span class="token punctuation">(</span><span class="token string">'rbx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// idiv puts remainder in 'rdx'</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mov</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token string">'rdx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Restore 'rdx'</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token string">'rdx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Unsupported binary operator: '</span> <span class="token operator">+</span> ast<span class="token punctuation">.</span>operator<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">// Restore 'rbx'</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token string">'rbx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// The result is in 'rax'</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">visitUnary</span><span class="token punctuation">(</span><span class="token parameter">ast</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// Visit argument and put result into 'rax'</span><br>  <span class="token function">visit</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ast<span class="token punctuation">.</span>argument<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ast<span class="token punctuation">.</span>operator <span class="token operator">===</span> <span class="token string">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Negate argument</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">neg</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Unsupported unary operator: '</span> <span class="token operator">+</span> ast<span class="token punctuation">.</span>operator<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>You can try it by cloning it from <a href="https://github.com/indutny/jit.js/tree/master/example/basic">github</a>, running <code>npm install</code> in it's
folder and then voila!</p>
<pre class="language-bash" tabindex="0"><code class="language-bash">$ <span class="token function">node</span> ./main.js <span class="token string">'1 + 2 * 3'</span><br><span class="token number">7</span></code></pre>
<p>Thanks for reading up to this point! I'll talk about floating point operations
and the heap in the next blog post!</p>

<ul class="links-nextprev"><li>Previous: <a href="/3.dtrace-ustack-helper/">DTrace and the little ustack helper that could</a></li><li>Next: <a href="/6.allocating-numbers/">Allocating numbers</a></li>
</ul>

		</main>

		<footer>
      Copyright Fedor Indutny 2023;
      <a href="https://github.com/indutny/blog" target="_blank" rel="noreferrer">Released</a>
      under
      <a href="https://opensource.org/licenses/mit-license.php" target="_blank" rel="noreferrer">
        MIT license
      </a>.
    </footer>

		<!-- Current page: /4.how-to-start-jitting/ -->
	</body>
</html>
