<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Running node.js + DTrace on FreeBSD</title>
		<meta name="description" content="Darkside of Software Engineering.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Fedor Indutny&#39;s Blog">
		<link rel="alternate" href="/feed/feed.json" type="application/json" title="Fedor Indutny&#39;s Blog">
		<meta name="generator" content="Eleventy v2.0.1">
		
		<style>/* Only include the syntax highlighter CSS on blog posts */
/**
 * okaidia theme for JavaScript, CSS and HTML
 * Loosely based on Monokai textmate theme by http://www.monokai.nl/
 * @author ocodia
 */

code[class*="language-"],
pre[class*="language-"] {
	color: #f8f8f2;
	background: none;
	text-shadow: 0 1px rgba(0, 0, 0, 0.3);
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
	border-radius: 0.3em;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #272822;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: #8292a2;
}

.token.punctuation {
	color: #f8f8f2;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.constant,
.token.symbol,
.token.deleted {
	color: #f92672;
}

.token.boolean,
.token.number {
	color: #ae81ff;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #a6e22e;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string,
.token.variable {
	color: #f8f8f2;
}

.token.atrule,
.token.attr-value,
.token.function,
.token.class-name {
	color: #e6db74;
}

.token.keyword {
	color: #66d9ef;
}

.token.regex,
.token.important {
	color: #fd971f;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}

/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
* { box-sizing: border-box; }
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #082840;
	--text-color-link-active: #5f2b48;
	--text-color-link-visited: #17050F;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main {
	padding: 1rem;
}
main :first-child {
	margin-top: 0;
}

header {
	border-bottom: 1px dashed var(--color-gray-20);
}
header:after {
	content: "";
	display: table;
	clear: both;
}

.links-nextprev {
	list-style: none;
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
}
pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
}
code {
	word-break: normal;
}

/* Header */
header {
	display: flex;
	gap: 1em .5em;
	flex-wrap: wrap;
	align-items: center;
	padding: 1em;
}
.home-link {
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
	margin-right: 2em;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	padding: 0;
	margin: 0;
	list-style: none;
  align-items: center;
}
.nav-item {
	display: inline-block;
	margin-right: 1em;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}
.nav-item svg.social {
  display: block;
  width: 18px;
  height: 18px;
}

/* Posts list */
.postlist {
	list-style: none;
	padding: 0;
	padding-left: 1.5rem;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	content: "" counter(start-from, decimal-leading-zero) ". ";
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	padding-left: .25em;
	padding-right: .5em;
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	text-transform: capitalize;
	font-style: italic;
}
.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

/* Direct Links / Markdown Headers */
.header-anchor {
	text-decoration: none;
	font-style: normal;
	font-size: 1em;
	margin-left: .1em;
}
a[href].header-anchor,
a[href].header-anchor:visited {
	color: transparent;
}
a[href].header-anchor:focus,
a[href].header-anchor:hover {
	text-decoration: underline;
}
a[href].header-anchor:focus,
:hover > a[href].header-anchor {
	color: #aaa;
}

h2 + .header-anchor {
	font-size: 1.5em;
}

footer {
  padding: 1.5em 0 0.5em 0;
  font-size: 0.75em;
  text-align: right;
}

img {
  max-width: 100%;
  height: auto;
}</style>
	</head>
	<body>
		<a href="#skip" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">Fedor Indutny&#39;s Blog</a>

      
			<nav>
				<h2 class="visually-hidden">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/blog/">Archive</a></li>
					<li class="nav-item"><a href="/about/">About Me</a></li>
          <li class="nav-item">
            <a href="https://github.com/indutny" target="_blank" rel="noreferrer">
              <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github social" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
            </a>
          </li>
          <li class="nav-item">
            <a href="https://fosstodon.org/@indutny" target="_blank" rel="me">
              <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="mastodon" class="svg-inline--fa fa-mastodon social" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"></path></svg>
            </a>
          </li>
				</ul>
			</nav>
		</header>

		<main id="skip">
			
<h1>Running node.js + DTrace on FreeBSD</h1>

<ul class="post-metadata">
	<li><time datetime="2014-04-01">01 April 2014</time></li>
	<li><a href="/tags/dtrace/" class="post-tag">DTrace</a></li>
</ul>

<h2 id="preface" tabindex="-1">Preface <a class="header-anchor" href="#preface">#</a></h2>
<p>Tracing node.js activity and detecting performance problems and bottlenecks
has always been an important topic for many people in the community. Though,
various ways to do this were available, including: systemtap, ETW and perfctr on
Windows. The most complete tracing support was done by Joyent guys for the
DTrace tool which works best on their <a href="http://wiki.illumos.org/display/illumos/illumos+Home">Illumos</a> fork, called <a href="http://smartos.org/">SmartOS</a>.</p>
<p>Fortunately, since 9.0 version, FreeBSD maintainers have started fixing and
tweaking their DTrace implementation too (which is actually a backport from
Solaris). Considering that FreeBSD is much easier to install and is much
more usable as a primary OS for developers, being able to do flamegraphs for
node.js on it is something that I highly desired at the time.</p>
<h2 id="what-was-broken" tabindex="-1">What was broken <a class="header-anchor" href="#what-was-broken">#</a></h2>
<p>Sadly, it wasn't working out-of-the-box. After the installation of FreeBSD in a
VirtualBox has finished, I immediately tried to build and dtrace node with a
<code>jstack()</code> utility (see my previous <a href="/3.dtrace-ustack-helper">blog post</a> on that topic), but it did
not work out. After some struggling it became obvious that <code>/dev/dtrace/helper</code>
has pretty narrow permissions and the node, running under non-root user, wasn't
able to register itself within the system's DTrace module.</p>
<p>Calling <code>sudo chmod 666 /dev/dtrace/helper</code> improved the situation, but not that
much: version 0.11 of node.js was crashing, and version v0.10 was still not
registering it's ustack helper and DTrace provider (see <a href="http://www.solarisinternals.com/wiki/index.php/DTrace_Topics_USDT#USDT">USDT</a> docs). This
problem was a bit tougher than the helper permissions, and took awhile to fix.</p>
<h2 id="how-node-interacts-with-dtrace" tabindex="-1">How node interacts with DTrace <a class="header-anchor" href="#how-node-interacts-with-dtrace">#</a></h2>
<p>First of all, a bit of information about how node.js compiles it's DTrace
helpers and how they are used by the system. There were <a href="http://www.bsdcan.org/2008/schedule/attachments/60_dtrace_bsdcan.pdf">some slides</a> on that
topic (how DTrace USDT interacts with kernel), but at that moment I figured it
out by reading the implementation's source.</p>
<p>There are two <code>.d</code> files in the node.js source tree: <code>src/node_provider.d</code> and
<code>src/v8ustack.d</code>. The former declares a <code>node</code> DTrace USDT provider and the
latter exports an ustack helper Both of these files are compiled with
<code>dtrace -G -s &lt;file.d&gt; -o &lt;out.o&gt;</code>, which in fact does the following thing:</p>
<ol>
<li>Compile all D-language chunks into DIFs (<a href="https://github.com/freebsd/freebsd/blob/3ecc6f129801776dd571d69cf9a262a97ad23968/sys/cddl/contrib/opensolaris/uts/common/sys/dtrace.h#L112">DTrace Intermediate Format</a></li>
<li>Encode them in the DOF (<a href="https://github.com/freebsd/freebsd/blob/3ecc6f129801776dd571d69cf9a262a97ad23968/sys/cddl/contrib/opensolaris/uts/common/sys/dtrace.h#L570">DTrace Object File</a>) format</li>
<li>Put them into the special <code>._SUNW_dof</code> ELF section</li>
<li>Link it to the internally-stored <code>drti.o</code>, providing <code>dtrace_dof_init</code> and
<code>dtrace_dof_fini</code> helper functions.</li>
</ol>
<p>These functions are called on the executable's initialization and
deinitialization (surprisingly!), each making an <code>ioctl()</code> syscall on the
<code>/dev/dtrace/helper</code>. Specifically, <code>dtrace_dof_init()</code> loads and verifies the
<code>._SUNW_dof</code> section of an ELF-file and registers it with-in the kernel.</p>
<h2 id="how-i-fixed-it" tabindex="-1">How I fixed it <a class="header-anchor" href="#how-i-fixed-it">#</a></h2>
<p>I decided to investigate the node.js v0.11 crashes. It was crashing on a
<a href="https://github.com/freebsd/freebsd/blob/4d784918edbf9aefbab5ab12e4701d3104c3ff45/cddl/contrib/opensolaris/lib/libdtrace/common/drti.c#L110">this line</a>, so it was either an ELF symbol problem or a DOF string
problem. Initially, I found that the DOF did not contain the STRTAB section
that <code>dtri.o</code> was searching for, but it turned out to be a slightly bigger
problem. Since node.js has two separate <code>.d</code> files, it has two DOFs for
each of them in it's <code>._SUNW_dof</code> section, but the <code>drti.o</code> was loading only
one! After all I came up with a following patch:</p>
<pre class="language-diff" tabindex="0"><code class="language-diff">commit c46786f47483e7fc218727aa52cf6b2278a45053<br>Author: Fedor Indutny &lt;fedor.indutny@gmail.com><br>Date:   Mon Feb 17 01:16:13 2014 +0400<br><br><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   dtrace: proper symbol fixup and import in drti<br></span><span class="token prefix unchanged"> </span><span class="token line">   <br></span><span class="token prefix unchanged"> </span><span class="token line">   Application may contain multiple DOFs, merged into one ._SUNW_dof ELF<br></span><span class="token prefix unchanged"> </span><span class="token line">   section. Process all of them and fix symbols only in those ones that<br></span><span class="token prefix unchanged"> </span><span class="token line">   actaully define a provider. Use proper strtab for resolving symbols.<br></span></span><br>diff --git a/cddl/contrib/opensolaris/lib/libdtrace/common/drti.c b/cddl/contrib/opensolaris/lib/libdtrace/common/drti.c<br>index 3b4a38c..e47cfb4d 100644<br><span class="token coord">--- a/cddl/contrib/opensolaris/lib/libdtrace/common/drti.c</span><br><span class="token coord">+++ b/cddl/contrib/opensolaris/lib/libdtrace/common/drti.c</span><br><span class="token coord">@@ -20,6 +20,7 @@</span><br><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> */<br></span><span class="token prefix unchanged"> </span><span class="token line">/*<br></span><span class="token prefix unchanged"> </span><span class="token line"> * Copyright 2008 Sun Microsystems, Inc.  All rights reserved.<br></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> * Copyright 2013 Voxer Inc. All rights reserved.<br></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> * Use is subject to license terms.<br></span><span class="token prefix unchanged"> </span><span class="token line"> */<br></span><span class="token prefix unchanged"> </span><span class="token line"><br></span></span>@@ -144,7 +145,8 @@ dtrace_dof_init(void)<br><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">	Lmid_t lmid;<br></span><span class="token prefix unchanged"> </span><span class="token line">#else<br></span><span class="token prefix unchanged"> </span><span class="token line">	u_long lmid = 0;<br></span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">	dof_sec_t *sec;<br></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">	dof_sec_t *sec, *secstart, *dofstrtab, *dofprobes;<br></span><span class="token prefix inserted">+</span><span class="token line">	dof_provider_t *dofprovider;<br></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">	size_t i;<br></span><span class="token prefix unchanged"> </span><span class="token line">#endif<br></span><span class="token prefix unchanged"> </span><span class="token line">	int fd;<br></span></span>@@ -152,12 +154,13 @@ dtrace_dof_init(void)<br><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">#if !defined(sun)<br></span><span class="token prefix unchanged"> </span><span class="token line">	Elf *e;<br></span><span class="token prefix unchanged"> </span><span class="token line">	Elf_Scn *scn = NULL;<br></span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">	Elf_Data *symtabdata = NULL, *dynsymdata = NULL;<br></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">	Elf_Data *symtabdata = NULL, *dynsymdata = NULL, *dofdata = NULL;<br></span><span class="token prefix inserted">+</span><span class="token line">	dof_hdr_t *dof_next = NULL;<br></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">	GElf_Shdr shdr;<br></span><span class="token prefix unchanged"> </span><span class="token line">	int efd, nprobes;<br></span><span class="token prefix unchanged"> </span><span class="token line">	char *s;<br></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">	char *dofstrtabraw;<br></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">	size_t shstridx, symtabidx = 0, dynsymidx = 0;<br></span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">	unsigned char *dofstrtab = NULL;<br></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">	unsigned char *buf;<br></span><span class="token prefix unchanged"> </span><span class="token line">	int fixedprobes = 0;<br></span><span class="token prefix unchanged"> </span><span class="token line">#endif<br></span></span>@@ -209,7 +212,9 @@ dtrace_dof_init(void)<br><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">		} else if (shdr.sh_type == SHT_PROGBITS) {<br></span><span class="token prefix unchanged"> </span><span class="token line">			s = elf_strptr(e, shstridx, shdr.sh_name);<br></span><span class="token prefix unchanged"> </span><span class="token line">			if  (s &amp;&amp; strcmp(s, ".SUNW_dof") == 0) {<br></span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">				dof = elf_getdata(scn, NULL)->d_buf;<br></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">				dofdata = elf_getdata(scn, NULL);<br></span><span class="token prefix inserted">+</span><span class="token line">				dof = dofdata->d_buf;<br></span><span class="token prefix inserted">+</span><span class="token line">				break;<br></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">			}<br></span><span class="token prefix unchanged"> </span><span class="token line">		}<br></span><span class="token prefix unchanged"> </span><span class="token line">	}<br></span></span>@@ -219,6 +224,9 @@ dtrace_dof_init(void)<br><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">		close(efd);<br></span><span class="token prefix unchanged"> </span><span class="token line">		return;<br></span><span class="token prefix unchanged"> </span><span class="token line">	}<br></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"><br></span><span class="token prefix inserted">+</span><span class="token line">	while ((char *) dof &lt; (char *) dofdata->d_buf + dofdata->d_size) {<br></span><span class="token prefix inserted">+</span><span class="token line">		dof_next = (void *) ((char *) dof + dof->dofh_filesz);<br></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">#endif<br></span><span class="token prefix unchanged"> </span><span class="token line"><br></span><span class="token prefix unchanged"> </span><span class="token line">	if (dof->dofh_ident[DOF_ID_MAG0] != DOF_MAG_MAG0 ||<br></span></span>@@ -290,34 +298,49 @@ dtrace_dof_init(void)<br><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">	 * We are assuming the number of probes is less than the number of<br></span><span class="token prefix unchanged"> </span><span class="token line">	 * symbols (libc can have 4k symbols, for example).<br></span><span class="token prefix unchanged"> </span><span class="token line">	 */<br></span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">	sec = (dof_sec_t *)(dof + 1);<br></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">	secstart = sec = (dof_sec_t *)(dof + 1);<br></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">	buf = (char *)dof;<br></span><span class="token prefix unchanged"> </span><span class="token line">	for (i = 0; i &lt; dof->dofh_secnum; i++, sec++) {<br></span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">		if (sec->dofs_type == DOF_SECT_STRTAB)<br></span><span class="token prefix deleted">-</span><span class="token line">			dofstrtab = (unsigned char *)(buf + sec->dofs_offset);<br></span><span class="token prefix deleted">-</span><span class="token line">		else if (sec->dofs_type == DOF_SECT_PROBES &amp;&amp; dofstrtab)<br></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">		if (sec->dofs_type != DOF_SECT_PROVIDER)<br></span><span class="token prefix inserted">+</span><span class="token line">			continue;<br></span><span class="token prefix inserted">+</span><span class="token line"><br></span><span class="token prefix inserted">+</span><span class="token line">		dofprovider = (void *) (buf + sec->dofs_offset);<br></span><span class="token prefix inserted">+</span><span class="token line">		dofstrtab = secstart + dofprovider->dofpv_strtab;<br></span><span class="token prefix inserted">+</span><span class="token line">		dofprobes = secstart + dofprovider->dofpv_probes;<br></span><span class="token prefix inserted">+</span><span class="token line"><br></span><span class="token prefix inserted">+</span><span class="token line">		if (dofstrtab->dofs_type != DOF_SECT_STRTAB) {<br></span><span class="token prefix inserted">+</span><span class="token line">			fprintf(stderr, "WARNING: expected STRTAB section, but got %d\n",<br></span><span class="token prefix inserted">+</span><span class="token line">					dofstrtab->dofs_type);<br></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">			break;<br></span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">	<br></span><span class="token prefix deleted">-</span><span class="token line">	}<br></span><span class="token prefix deleted">-</span><span class="token line">	nprobes = sec->dofs_size / sec->dofs_entsize;<br></span><span class="token prefix deleted">-</span><span class="token line">	fixsymbol(e, symtabdata, symtabidx, nprobes, buf, sec, &amp;fixedprobes,<br></span><span class="token prefix deleted">-</span><span class="token line">	    dofstrtab);<br></span><span class="token prefix deleted">-</span><span class="token line">	if (fixedprobes != nprobes) {<br></span><span class="token prefix deleted">-</span><span class="token line">		/*<br></span><span class="token prefix deleted">-</span><span class="token line">		 * If we haven't fixed all the probes using the<br></span><span class="token prefix deleted">-</span><span class="token line">		 * symtab section, look inside the dynsym<br></span><span class="token prefix deleted">-</span><span class="token line">		 * section.<br></span><span class="token prefix deleted">-</span><span class="token line">		 */<br></span><span class="token prefix deleted">-</span><span class="token line">		fixsymbol(e, dynsymdata, dynsymidx, nprobes, buf, sec,<br></span><span class="token prefix deleted">-</span><span class="token line">		    &amp;fixedprobes, dofstrtab);<br></span><span class="token prefix deleted">-</span><span class="token line">	}<br></span><span class="token prefix deleted">-</span><span class="token line">	if (fixedprobes != nprobes) {<br></span><span class="token prefix deleted">-</span><span class="token line">		fprintf(stderr, "WARNING: number of probes "<br></span><span class="token prefix deleted">-</span><span class="token line">		    "fixed does not match the number of "<br></span><span class="token prefix deleted">-</span><span class="token line">		    "defined probes (%d != %d, "<br></span><span class="token prefix deleted">-</span><span class="token line">		    "respectively)\n", fixedprobes, nprobes);<br></span><span class="token prefix deleted">-</span><span class="token line">		fprintf(stderr, "WARNING: some probes might "<br></span><span class="token prefix deleted">-</span><span class="token line">		    "not fire or your program might crash\n");<br></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">		}<br></span><span class="token prefix inserted">+</span><span class="token line">		if (dofprobes->dofs_type != DOF_SECT_PROBES) {<br></span><span class="token prefix inserted">+</span><span class="token line">			fprintf(stderr, "WARNING: expected PROBES section, but got %d\n",<br></span><span class="token prefix inserted">+</span><span class="token line">			    dofprobes->dofs_type);<br></span><span class="token prefix inserted">+</span><span class="token line">			break;<br></span><span class="token prefix inserted">+</span><span class="token line">		}<br></span><span class="token prefix inserted">+</span><span class="token line"><br></span><span class="token prefix inserted">+</span><span class="token line">		dprintf(1, "found provider %p\n", dofprovider);<br></span><span class="token prefix inserted">+</span><span class="token line">		dofstrtabraw = (char *)(buf + dofstrtab->dofs_offset);<br></span><span class="token prefix inserted">+</span><span class="token line">		nprobes = dofprobes->dofs_size / dofprobes->dofs_entsize;<br></span><span class="token prefix inserted">+</span><span class="token line">		fixsymbol(e, symtabdata, symtabidx, nprobes, buf, dofprobes, &amp;fixedprobes,<br></span><span class="token prefix inserted">+</span><span class="token line">				dofstrtabraw);<br></span><span class="token prefix inserted">+</span><span class="token line">		if (fixedprobes != nprobes) {<br></span><span class="token prefix inserted">+</span><span class="token line">			/*<br></span><span class="token prefix inserted">+</span><span class="token line">			 * If we haven't fixed all the probes using the<br></span><span class="token prefix inserted">+</span><span class="token line">			 * symtab section, look inside the dynsym<br></span><span class="token prefix inserted">+</span><span class="token line">			 * section.<br></span><span class="token prefix inserted">+</span><span class="token line">			 */<br></span><span class="token prefix inserted">+</span><span class="token line">			fixsymbol(e, dynsymdata, dynsymidx, nprobes, buf, dofprobes,<br></span><span class="token prefix inserted">+</span><span class="token line">					&amp;fixedprobes, dofstrtabraw);<br></span><span class="token prefix inserted">+</span><span class="token line">		}<br></span><span class="token prefix inserted">+</span><span class="token line">		if (fixedprobes != nprobes) {<br></span><span class="token prefix inserted">+</span><span class="token line">			fprintf(stderr, "WARNING: number of probes "<br></span><span class="token prefix inserted">+</span><span class="token line">			    "fixed does not match the number of "<br></span><span class="token prefix inserted">+</span><span class="token line">			    "defined probes (%d != %d, "<br></span><span class="token prefix inserted">+</span><span class="token line">			    "respectively)\n", fixedprobes, nprobes);<br></span><span class="token prefix inserted">+</span><span class="token line">			fprintf(stderr, "WARNING: some probes might "<br></span><span class="token prefix inserted">+</span><span class="token line">			    "not fire or your program might crash\n");<br></span><span class="token prefix inserted">+</span><span class="token line">		}<br></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">	}<br></span><span class="token prefix unchanged"> </span><span class="token line">#endif<br></span><span class="token prefix unchanged"> </span><span class="token line">	if ((gen = ioctl(fd, DTRACEHIOC_ADDDOF, &amp;dh)) == -1)<br></span></span>@@ -330,7 +353,12 @@ dtrace_dof_init(void)<br><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">	}<br></span><span class="token prefix unchanged"> </span><span class="token line"><br></span><span class="token prefix unchanged"> </span><span class="token line">	(void) close(fd);<br></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"><br></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">#if !defined(sun)<br></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">		/* End of while loop */<br></span><span class="token prefix inserted">+</span><span class="token line">		dof = dof_next;<br></span><span class="token prefix inserted">+</span><span class="token line">	}<br></span><span class="token prefix inserted">+</span><span class="token line"><br></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">	elf_end(e);<br></span><span class="token prefix unchanged"> </span><span class="token line">	(void) close(efd);<br></span><span class="token prefix unchanged"> </span><span class="token line">#endif</code></pre>
<p>Although, node.js v0.11 has stopped crashing after applying it to the kernel
source code and rebuilding <code>libdtrace</code>, it still wasn't registering an ustack
helper and a provider (<code>sudo dtrace -l</code> did not contain any
<code>node&lt;pid&gt;:::</code> probes).</p>
<p>While reading <a href="https://github.com/freebsd/freebsd/blob/4d784918edbf9aefbab5ab12e4701d3104c3ff45/cddl/contrib/opensolaris/lib/libdtrace/common/drti.c#L52">FreeBSD's source code</a> further, I found an environment
variable <code>DTRACE_DOF_INIT_DEBUG</code> that helped me to take a deeper look into
what was happening for both node.js v0.10 and v0.11. After setting it to
<code>DTRACE_DOF_INIT_DEBUG=1</code> node.js has started printing following things to the
stderr:</p>
<pre class="language-txt" tabindex="0"><code class="language-txt">dtrace DOF node: DTrace ioctl failed for DOF at 0x804c00000:<br>Argument list too long</code></pre>
<p>This was totally uninformative, and I started grepping through a DTrace kernel
module with a hope to find some clues to this errors. <code>Argument list too long</code>
is a verbose description of the <code>E2BIG</code> errno, and luckily the <a href="https://github.com/freebsd/freebsd/blob/3ecc6f129801776dd571d69cf9a262a97ad23968/sys/cddl/contrib/opensolaris/uts/common/dtrace/dtrace.c#L11989">first place</a>
where it is used was the place that I needed to fix. Basically, for the security
purpose kernel limits the size of the DOF that could be loaded in it's memory.
This limit is set to the 128 KB by default, and the node.js now has
significantly bigger ustack helper (7 MB for v0.11). Instead of just raising it
to a higher value, I decided to export <code>sysctl</code> variable to make it configurable
without rebuilding the kernel. Running node again after this tweaks gave me:</p>
<pre class="language-txt" tabindex="0"><code class="language-txt">dtrace DOF node: DTrace ioctl failed for DOF at 0x804c00000:<br>Invalid argument</code></pre>
<p>This failure was even more vague, since it meant that the <code>EINVAL</code> was returned
somewhere, and there was tons of places where it could have happened. After
inserting tons of debug prints in all possible places in kernel, I have isolated
it down to <a href="https://github.com/freebsd/freebsd/blob/3ecc6f129801776dd571d69cf9a262a97ad23968/sys/cddl/contrib/opensolaris/uts/common/dtrace/dtrace.c#L12462">this place</a>. Indeed, both of node DOFs contained a lot of
actions and the default limit (16 * 1024) was way to small for it. Exporting
another sysctl variable has solved all problems and running node.js has finally
printed this:</p>
<pre class="language-txt" tabindex="0"><code class="language-txt">dtrace DOF node: DTrace ioctl succeeded for DOF at 0x8052c2c2c<br>dtrace DOF node: DTrace ioctl succeeded for DOF at 0x804c00000<br>dtrace DOF node: found provider 0x8052c3000</code></pre>
<p>Just to confirm it, I checked the <code>dtrace -l</code> output and (yikes!) it was there
too:</p>
<pre class="language-txt" tabindex="0"><code class="language-txt">48986 node909 node ... gc-done<br>48987 node909 node ... gc-start<br>48988 node909 node ... http-client-request<br>48989 node909 node ... http-client-response<br>48990 node909 node ... http-server-request<br>48991 node909 node ... http-server-response<br>48992 node909 node ... net-server-connection<br>48993 node909 node ... net-socket-read<br>48994 node909 node ... net-socket-write<br>48995 node909 node ... net-stream-end</code></pre>
<h2 id="how-to-apply-all-this-patches" tabindex="-1">How to apply all this patches <a class="header-anchor" href="#how-to-apply-all-this-patches">#</a></h2>
<p>I have came up with <a href="https://github.com/indutny/freebsd/compare/release/10.0.0...feature/10.0-dtrace-patches">this instruction</a> for fixing your FreeBSD installation
to make node.js DTrace helpers work. Just a brief in-line description:</p>
<ol>
<li>Apply <a href="https://github.com/indutny/freebsd/compare/release/10.0.0...feature/10.0-dtrace-patches">these patches</a> to <code>/usr/src</code></li>
<li>Rebuild and install kernel:
<code>sudo make buildkernel &amp;&amp; sudo make installkernel</code></li>
<li>Reboot <code>sudo shutdown -r</code></li>
<li>Raise sysctl limits:</li>
</ol>
<ul>
<li><code>sudo sysctl -w kern.dtrace.helper_actions_max=16000</code></li>
<li><code>sudo sysctl -w kern.dtrace.dof_maxsize=8000000</code></li>
</ul>
<ol start="5">
<li>Clone node.js:
<code>git clone git://github.com/joyent/node &amp;&amp; cd node &amp;&amp; git checkout v0.10</code></li>
<li>Configure it: <code>./configure --prefix=... --with-dtrace</code></li>
<li>Build and install it: <code>gmake -j24 &amp;&amp; gmake install</code></li>
<li>Make DTrace device accessible to non-root users:
<code>sudo chmod 666 /dev/dtrace/helper</code></li>
<li>Verify that node.js DTrace probes are inserted:
<code>DTRACE_DOF_INIT_DEBUG=1 /path/to/node</code>.</li>
</ol>
<p>Thanks for reading this, and please let me know if any of these patches don't
work for you!</p>

<ul class="links-nextprev"><li>Previous: <a href="/6.smis-and-doubles/">SMIs and Doubles</a></li><li>Next: <a href="/8.bud-a-tls-swiss-knife/">Bud - a TLS &quot;swiss knife&quot;</a></li>
</ul>

		</main>

		<footer>
      Copyright Fedor Indutny 2023;
      <a href="https://github.com/indutny/blog" target="_blank" rel="noreferrer">Released</a>
      under
      <a href="https://opensource.org/licenses/mit-license.php" target="_blank" rel="noreferrer">
        MIT license
      </a>.
    </footer>

		<!-- Current page: /7.freebsd-dtrace/ -->
	</body>
</html>
