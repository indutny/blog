<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Diving into C++ internals of node</title>
		<meta name="description" content="Darkside of Software Engineering.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Fedor Indutny&#39;s Blog">
		<link rel="alternate" href="/feed/feed.json" type="application/json" title="Fedor Indutny&#39;s Blog">
		<meta name="generator" content="Eleventy v2.0.1">
		
		<style>/* Only include the syntax highlighter CSS on blog posts */
/**
 * okaidia theme for JavaScript, CSS and HTML
 * Loosely based on Monokai textmate theme by http://www.monokai.nl/
 * @author ocodia
 */

code[class*="language-"],
pre[class*="language-"] {
	color: #f8f8f2;
	background: none;
	text-shadow: 0 1px rgba(0, 0, 0, 0.3);
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
	border-radius: 0.3em;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #272822;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: #8292a2;
}

.token.punctuation {
	color: #f8f8f2;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.constant,
.token.symbol,
.token.deleted {
	color: #f92672;
}

.token.boolean,
.token.number {
	color: #ae81ff;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #a6e22e;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string,
.token.variable {
	color: #f8f8f2;
}

.token.atrule,
.token.attr-value,
.token.function,
.token.class-name {
	color: #e6db74;
}

.token.keyword {
	color: #66d9ef;
}

.token.regex,
.token.important {
	color: #fd971f;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}

/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
* { box-sizing: border-box; }
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #082840;
	--text-color-link-active: #5f2b48;
	--text-color-link-visited: #17050F;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main {
	padding: 1rem;
}
main :first-child {
	margin-top: 0;
}

header {
	border-bottom: 1px dashed var(--color-gray-20);
}
header:after {
	content: "";
	display: table;
	clear: both;
}

.links-nextprev {
	list-style: none;
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
}
pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
}
code {
	word-break: normal;
}

/* Header */
header {
	display: flex;
	gap: 1em .5em;
	flex-wrap: wrap;
	align-items: center;
	padding: 1em;
}
.home-link {
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
	margin-right: 2em;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	padding: 0;
	margin: 0;
	list-style: none;
  align-items: center;
}
.nav-item {
	display: inline-block;
	margin-right: 1em;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}
.nav-item svg.social {
  display: block;
  width: 18px;
  height: 18px;
}

/* Posts list */
.postlist {
	list-style: none;
	padding: 0;
	padding-left: 1.5rem;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	content: "" counter(start-from, decimal-leading-zero) ". ";
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	padding-left: .25em;
	padding-right: .5em;
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	text-transform: capitalize;
	font-style: italic;
}
.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

/* Direct Links / Markdown Headers */
.header-anchor {
	text-decoration: none;
	font-style: normal;
	font-size: 1em;
	margin-left: .1em;
}
a[href].header-anchor,
a[href].header-anchor:visited {
	color: transparent;
}
a[href].header-anchor:focus,
a[href].header-anchor:hover {
	text-decoration: underline;
}
a[href].header-anchor:focus,
:hover > a[href].header-anchor {
	color: #aaa;
}

h2 + .header-anchor {
	font-size: 1.5em;
}

footer {
  padding: 1.5em 0 0.5em 0;
  font-size: 0.75em;
  text-align: right;
}

img {
  max-width: 100%;
  height: auto;
}</style>
	</head>
	<body>
		<a href="#skip" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">Fedor Indutny&#39;s Blog</a>

      
			<nav>
				<h2 class="visually-hidden">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/blog/">Archive</a></li>
					<li class="nav-item"><a href="/about/">About Me</a></li>
          <li class="nav-item">
            <a href="https://github.com/indutny" target="_blank" rel="noreferrer">
              <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github social" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
            </a>
          </li>
          <li class="nav-item">
            <a href="https://fosstodon.org/@indutny" target="_blank" rel="me">
              <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="mastodon" class="svg-inline--fa fa-mastodon social" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"></path></svg>
            </a>
          </li>
				</ul>
			</nav>
		</header>

		<main id="skip">
			
<h1>Diving into C++ internals of node</h1>

<ul class="post-metadata">
	<li><time datetime="2015-05-16">16 May 2015</time></li>
</ul>

<h2 id="intro" tabindex="-1">Intro <a class="header-anchor" href="#intro">#</a></h2>
<p>There is nothing to be scared about in the C++ internals of the project,
especially in internals of <a href="https://github.com/nodejs/io.js">io.js</a> and <a href="https://github.com/nodejs/node">node.js</a>.</p>
<p>If you ever tried to optimize JavaScript code to squeeze out every possible
performance or memory usage improvement out of it - you already wrote some C++
code.</p>
<p>Many blogs, workshops mention JavaScript optimizations, and some of the popular
suggestions are:</p>
<h3 id="hidden-classes" tabindex="-1">Hidden Classes <a class="header-anchor" href="#hidden-classes">#</a></h3>
<p>Declare all properties in the constructor to avoid creating extra
&quot;hidden classes&quot;. This makes them pretty much the same as a C structures,
or C++ classes, where properties are declared ahead of time to help the
compiler optimize access to them.</p>
<p>Example:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Point</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<br>  <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<br>  <span class="token keyword">this</span><span class="token punctuation">.</span>z <span class="token operator">=</span> z<br><span class="token punctuation">}</span></code></pre>
<p>Similar code in C++:</p>
<pre class="language-c" tabindex="0"><code class="language-c">class Point <span class="token punctuation">{</span><br> public<span class="token operator">:</span><br>  <span class="token keyword">double</span> x<span class="token punctuation">;</span><br>  <span class="token keyword">double</span> y<span class="token punctuation">;</span><br>  <span class="token keyword">double</span> z<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<h3 id="avoid-polymorphism" tabindex="-1">Avoid Polymorphism <a class="header-anchor" href="#avoid-polymorphism">#</a></h3>
<p>Avoid storing different types of values in a variables, and avoid passing
different types of values as an arguments to the function. This principle could
also be called &quot;Make your code monomorphic&quot;, or &quot;don't mess with Compiler&quot;.
This makes code look like as it has static typing, which is what we do in
C++.</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;- good</span><br><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;- polymorphism!</span></code></pre>
<p>Compare to:</p>
<pre class="language-c" tabindex="0"><code class="language-c"><span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<h3 id="cache-and-reuse" tabindex="-1">Cache and Reuse <a class="header-anchor" href="#cache-and-reuse">#</a></h3>
<p>Cache and reuse instances of objects that are expensive to create and are
allocated often. This is one is similar to manual memory allocation in C++.</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><span class="token punctuation">}</span><br><br>Parser<span class="token punctuation">.</span>freelist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>Parser<span class="token punctuation">.</span><span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>freelist<span class="token punctuation">.</span>length<span class="token punctuation">)</span><br>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>freelist<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token class-name">Parser</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>release <span class="token operator">=</span> <span class="token operator">...</span><span class="token punctuation">;</span></code></pre>
<p>In C++:</p>
<pre class="language-c" tabindex="0"><code class="language-c">Parser<span class="token operator">*</span> p <span class="token operator">=</span> new <span class="token function">Parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>delete p<span class="token punctuation">;</span></code></pre>
<p>To conclude, even if you never wrote C++ code, you actually very likely did it
in JS.</p>
<p>It is no surprise we use C++ in io.js/node.js. After all, V8 is written in C++
and it provides only a limited set of ECMAScript JavaScript APIs. They are
definitely cool, but if you got used to <code>setTimeout()</code> / <code>clearTimeout()</code> -
you'll be pretty disappointed to use just plain ECMA.</p>
<p>Our C++ layer lives on top of the event-loop and provides all sorts of APIs:
from net sockets to dns queries, from file system events to the zlib bindings.
Which is the main reason why node.js was created in the first place!</p>
<h2 id="short-history-of-c-layer" tabindex="-1">Short History of C++ layer <a class="header-anchor" href="#short-history-of-c-layer">#</a></h2>
<p><picture><source type="image/avif" srcset="/img/pjQ6T0k8WH-1012.avif 1012w"><source type="image/webp" srcset="/img/pjQ6T0k8WH-1012.webp 1012w"><img alt="History of Git Blame" loading="lazy" decoding="async" src="/img/pjQ6T0k8WH-1012.jpeg" width="1012" height="1500"></picture></p>
<p>To better understand all of these, and to ease the contribution process - it
might be a good idea to start with the history of the subject. Luckily, from its
inception, node.js is using VCS, in particular git, so the history of the
development might be revealed by running <code>git log</code> and <code>git blame</code> on it.</p>
<p>Briefly, <code>git log deps/v8</code> - has the history of v8 fighting us, and
<code>git log src/</code> - has the history of us fighting v8.</p>
<h2 id="very-first-version" tabindex="-1">Very first version <a class="header-anchor" href="#very-first-version">#</a></h2>
<p>Jokes aside, everything started from <a href="https://github.com/nodejs/io.js/commit/61890720">61890720</a> commit. The commit log
just says:</p>
<p>add readme and initial code</p>
<p>Unfortunately, we can't elaborate much from it, and need to figure out the
details ourselves. What do we see there?</p>
<ul>
<li><a href="https://github.com/taf2/libebb">libebb</a> - which was used as an HTTP parser. Ryan used the code
from the <a href="https://github.com/gnosek/ebb">Ebb</a> server that he has previously written for Ruby</li>
<li><a href="https://cs.fit.edu/code/projects/cse2410_fall2014_bounce/repository/revisions/90fc8d36220c0d66c352ee5f72080b8592d310d5/show/deps/liboi">liboi</a>- which was as a TCP server framework on top of the <a href="http://software.schmorp.de/pkg/libev.html">libev</a>.
liboi stands for <code>Library for Output Input</code></li>
</ul>
<p>So the first code (that actually started compiling only at <a href="https://github.com/nodejs/io.js/commit/7b7ceea">7b7ceea</a>) only
had one HTTP server and supplied JavaScript source code was just a handler for
it.</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Process</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>verbose<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Processing "</span> <span class="token operator">+</span> request<span class="token punctuation">.</span>host <span class="token operator">+</span><br>        request<span class="token punctuation">.</span>path <span class="token operator">+</span><br>        <span class="token string">" from "</span> <span class="token operator">+</span> request<span class="token punctuation">.</span>referrer <span class="token operator">+</span><br>        <span class="token string">"@"</span> <span class="token operator">+</span> request<span class="token punctuation">.</span>userAgent<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>output<span class="token punctuation">[</span>request<span class="token punctuation">.</span>host<span class="token punctuation">]</span><span class="token punctuation">)</span><br>    output<span class="token punctuation">[</span>request<span class="token punctuation">.</span>host<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><br>  <span class="token keyword">else</span><br>    output<span class="token punctuation">[</span>request<span class="token punctuation">.</span>host<span class="token punctuation">]</span><span class="token operator">++</span><br><span class="token punctuation">}</span></code></pre>
<p>How was it organized internally?</p>
<p>There was a <code>server.cc</code> file which was reading the command line options, loading
the JavaScript source file, feeding all of these into V8, and starting the HTTP
server.</p>
<p>Second C++ file was <code>js_http_request_processor.cc</code> and it was responsible for
invoking the JavaScript http request handler. Not that much for a separate C++
file, right?</p>
<p>It wasn't working that much at that point, and didn't have any of
functionality that is provided today. So let's conclude and move on from it
quickly.</p>
<p>This version is characterized by following:</p>
<ul>
<li>One file to setup V8 and let JavaScript know about command-line arguments</li>
<li>HTTP server fully implemented in C/C++, not invoking the JavaScript for any
networking activities</li>
<li>One C++ instance per every incoming request, this instance maps some of the
HTTP fields (like host, url, method) to the JavaScript object.</li>
</ul>
<p>The last bullet point is very important to note: the C++ instance &lt;-&gt; JS object
mapping is a building brick of all future releases of node.js (including the
present one).</p>
<h2 id="064c8f02" tabindex="-1">064c8f02 <a class="header-anchor" href="#064c8f02">#</a></h2>
<p>Now we quickly jump to <a href="https://github.com/nodejs/io.js/commit/064c8f02">064c8f02</a>. The commit log says:</p>
<p>Use ObjectWrap base class for File, Socket, Server.</p>
<p>And this is the point where node.js has introduced one API to wrap all objects.</p>
<p><code>net.Server</code>, <code>net.Socket</code>, and <code>File</code> C++ classes are children of this
<code>ObjectWrap</code> class. Which means that for every instance of them -
there will be one instance of a JS object. Invoking methods on this JS object
will invoke C++ methods on the corresponding C++ class, and the constructor
itself is a C++ class constructor.</p>
<p>There are now different files for different parts of the provided API:</p>
<ul>
<li><code>src/node.cc</code> to set up C++ libraries and invoke <code>src/main.js</code> which
loads the script file and does some JavaScript initialization. (At this commit
we started to write as much code as possible in JavaScript, and leave
the rest in the C++ land. This pattern is used in io.js and node.js now too)</li>
<li><code>src/http.cc</code> - http server API, Connection, HttpRequest objects</li>
<li><code>src/file.cc</code>, <code>src/file.js</code> - future <code>fs</code> module.
<code>src/file.js</code> consists of the API abstractions for the C++ layer,
basically the same thing as with <code>src/node.cc</code> and <code>src/main.js</code></li>
<li><code>src/process.cc</code> has only <code>exit()</code> method so far, will evolve into the
<code>process</code> object</li>
<li><code>src/timers.cc</code> is about <code>setTimeout</code>/<code>setInterval</code></li>
</ul>
<p>Just a side note: HTTP server is still provided by <a href="https://cs.fit.edu/code/projects/cse2410_fall2014_bounce/repository/revisions/90fc8d36220c0d66c352ee5f72080b8592d310d5/show/deps/liboi">liboi</a>, and node.js is
using <a href="http://software.schmorp.de/pkg/libev.html">libev</a>.</p>
<h2 id="v0-2" tabindex="-1">v0.2 <a class="header-anchor" href="#v0-2">#</a></h2>
<p>There was lots of growing and maturing from that commit to the v0.2, and most
notable of them were about separating the JS parts from the C++ ones,
adding CommonJS support, and tons of new modules! The file structure is
beginning to look like what we have now:</p>
<ul>
<li><code>lib/</code> folder for all JavaScript CommonJS modules</li>
<li><code>src/</code> for their C++ counterparts</li>
<li><code>deps/</code> for all dependencies: v8, http-parser, c-ares (for async DNS),
libeio (for async FS), and libev (for async networking and auxiliary stuff)</li>
</ul>
<p>Previously barely used through the <code>src/</code>, <code>ObjectWrap</code> now became a public API,
which helped polish it out a lot and improved our core use case as well.</p>
<p>Very importantly, in <a href="https://github.com/nodejs/io.js/commit/064c8f02">064c8f02</a> all C++ interfaces were global objects. In
v0.2 they are provided by <code>process.binding</code> and are thus not directly visible to
the user's code.</p>
<p>For example, <code>process.binding('fs')</code>:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token operator">></span> process<span class="token punctuation">.</span><span class="token function">binding</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">{</span> <span class="token literal-property property">access</span><span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> access<span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token literal-property property">close</span><span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> close<span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token literal-property property">open</span><span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> open<span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token operator">...</span>lots <span class="token keyword">of</span> stuff<span class="token operator">...</span></code></pre>
<p>returns lots of C++ methods and classes that are heavily used for interoperation
between C++ and JS in <code>lib/fs.js</code>. Similar stuff is done for the rest of the
<code>lib/</code> modules.</p>
<h2 id="v0-6" tabindex="-1">v0.6 <a class="header-anchor" href="#v0-6">#</a></h2>
<p>Just a short note: <code>libev</code> was removed and replaced by <a href="https://github.com/libuv/libuv">libuv</a>. A product of
lots of work by Ben Noordhuis, Bert Belder, Ryan Dahl, and others!</p>
<p>The v0.6 version is a major milestone in evolution of node.js. Partly because
Windows is now in the list of the officially supported platforms, partly because
we have our own single event-loop platform that supports both async File System
and async networking operations.</p>
<h2 id="v0-10" tabindex="-1">v0.10 <a class="header-anchor" href="#v0-10">#</a></h2>
<p>Good, stable, but boring...</p>
<h2 id="v0-12-and-io-js" tabindex="-1">v0.12 and io.js <a class="header-anchor" href="#v0-12-and-io-js">#</a></h2>
<p>Lots of new stuff! :)</p>
<p>Mainly, we have outgrown the <code>ObjectWrap</code> to accommodate the tracing API (which
is still needs lots of rework, AFAIK). The hip thing now is <code>AsyncWrap</code> which is
in many ways the same thing, but now is attached to some particular domain of
operation (i.e. http, dns, tls) and which might have the another <code>AsyncWrap</code> as
a parent. Note that <code>ObjectWrap</code> lives in <code>src/node_object_wrap.h</code>, and
<code>AsyncWrap</code> in <code>src/async-wrap.h</code>.</p>
<p>This is now the present point of the node.js evolution, and I would like to
stop with the Software Archeology at this point.</p>
<h2 id="interoperation-handles-wraps-and-unicorns" tabindex="-1">Interoperation, handles, wraps, and unicorns! <a class="header-anchor" href="#interoperation-handles-wraps-and-unicorns">#</a></h2>
<p>We are finally ready to dive into the C++ internals, and explore them in a
greater detail.</p>
<p>As we already figured out - whole APIs provided by the node.js/io.js live in
two folders: <code>lib</code> and <code>src</code>. <code>lib</code> holds the core modules, <code>src</code> holds their
C++ counterparts.</p>
<p>When you call <code>require('fs')</code> - it does nothing but just executes the contents
of the <code>lib/fs.js</code> file. No magic here.</p>
<p>Now comes the interesting part, JavaScript is not capable of file system
operations, nor it is capable of networking. This is actually for the
best! (You don't want your browser to mess up whole file system,
right?) So when you do <code>fs.writeFileSync</code>, or when you are calling
<code>http.request()</code> there is a lot of low-level C++ stuff happening outside of the
JS-land.</p>
<p>While the <code>fs</code> module is quite simple to explain, it is quite boring too. After
all, in most of the cases it is just using number to represent the opened
file (so called <code>file descriptor</code>), and it is passing this number around:
from C++ to JS, and from JS to C++. Nothing interesting, let's move on!</p>
<p>Certainly much more attractive is the <code>net</code> module. We create sockets, get
the <code>connect</code> events, and expect the <code>.write()</code> callbacks to be eventually
invoked. All of these should be powered by the C++ machinery!</p>
<p>Here is where most of the interoperation is happening. The
<code>tcp_wrap</code> and <code>stream_wrap</code> bindings (remember, <code>process.binding()</code>, right?)
provide very useful classes for JS-land: TCP, TCPConnectWrap, WriteWrap,
ShutdownWrap.</p>
<ul>
<li><code>TCP</code> holds the TCP socket and provides methods for writing and reading
stuff</li>
<li><code>*Wrap</code> objects are what you pass to the <code>TCP</code> methods when you expect
some async action to happen, and need to receive notification (callback) on
their completion.</li>
</ul>
<p>For example, the normal workflow for <code>net.connect()</code> follows:</p>
<ul>
<li>Create <code>TCP</code> instance in <code>lib/net.js</code>, store it in the <code>_handle</code> property of
the <code>net.Socket</code> object</li>
<li>Parse all arguments to <code>net.connect()</code></li>
<li>Create <code>TCPConnectWrap</code> instance (usually named <code>req</code>)</li>
<li>Invoke <code>.connect()</code> method with <code>req, port, host</code></li>
<li>Get <code>req.oncomplete</code> function invoked eventually, once the connection was
established, or once the kernel reported an error</li>
</ul>
<p>In conclusion: most of the C++ classes are either handles, or requests.
Requests are very temporary and never outlive the handle that they are bound to,
while the handles are something that live much longer (i.e. for the entire life
time of the TCP connection).</p>
<p>Speaking of the file structure: <code>TCP</code> is represented by the <code>TCPWrap</code> class in
<code>src/tcp_wrap.cc</code>, <code>TCPConnectWrap</code> lives in the same place, and <code>WriteWrap</code>
is in the <code>stream_base.cc</code> file (in io.js).</p>
<h2 id="structure-of-c-files" tabindex="-1">Structure of C++ files <a class="header-anchor" href="#structure-of-c-files">#</a></h2>
<p>But how does the C++ provide this classes to JavaScript?</p>
<p>Each binding has a <code>NODE_MODULE_CONTEXT_AWARE_BUILTIN</code> macro that registers it
in the <code>node.cc</code>. This has the same effect as following JavaScript snippet:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">modules<span class="token punctuation">[</span>moduleName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><br>  <span class="token literal-property property">initialized</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>  <span class="token literal-property property">initFn</span><span class="token operator">:</span> moduleInitFn<br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>When <code>process.binding('moduleName')</code> is invoked, <code>node.cc</code> looks up the proper
internal binding in this hashmap and initializes it (if it wasn't previously
initialized) by calling the supplied function.</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">process<span class="token punctuation">.</span><span class="token function-variable function">binding</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">moduleName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> module <span class="token operator">=</span> modules<span class="token punctuation">[</span>moduleName<span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>initialized<span class="token punctuation">)</span><br>    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span><br><br>  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br>  module<span class="token punctuation">.</span><span class="token function">initFn</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>This initialization function receives <code>exports</code> object as an input, and exports
the methods and classes to it in pretty much the same way as you normally do
in CommonJS modules.</p>
<p>Each of the exported classes are bound to some C++ classes, and most of them are
actually derived from the <code>AsyncWrap</code> C++ class.</p>
<p>The Handle instances are destroyed automatically by V8's GC (once they are
closed in JS), and the Wraps are manually destroyed by the Handle, once they are
not used anymore.</p>
<p>Side-note:</p>
<p>there are two types of references to the JS
objects from C++ land: normal and weak. By default <code>AsyncWrap</code>s are referencing
their objects in a <code>normal</code> way, which means that the JS objects representing
the C++ classes won't be garbage collected until C++ class will dispose the
reference. The weak mode is turned on only when the <code>MakeWeak</code> is called
somewhere in C++. This might be very useful when debugging memory leaks.</p>
<h2 id="small-exam" tabindex="-1">Small exam <a class="header-anchor" href="#small-exam">#</a></h2>
<h3 id="situation" tabindex="-1">Situation <a class="header-anchor" href="#situation">#</a></h3>
<p>You debug some io.js/node.js issue, and find that it is crashing when
instantiating a class provided by <code>process.binding('broken')</code>. Where will you
attempt to search for the C++ source code of that class?</p>
<h3 id="answer" tabindex="-1">Answer <a class="header-anchor" href="#answer">#</a></h3>
<p>Somewhere in <code>src/</code>. Find
<code>NODE_MODULE_CONTEXT_AWARE_BUILTIN(broken, ...)</code> and it is most like going to be
in <code>src/broken_something.cc</code>.</p>
<h2 id="c-streams" tabindex="-1">C++ Streams <a class="header-anchor" href="#c-streams">#</a></h2>
<p>Now comes one of my recent obsessions. The C++ Stream API.</p>
<p>It is a established fact for me that exposing the building blocks of APIs helps
to renovate, reshape and make them better <em>a lot better</em>. One of such thing
that I was always keen to re-do was a <code>StreamWrap</code> instance.</p>
<p>It was ok-ish in v0.10, but when we moved TLS (SSL) implementation into C++
land it changed dramatically... and, honestly saying, not in a good way.</p>
<p>The previously singular <code>StreamWrap</code> instance, now became a monster that was
capable of passing the incoming data elsewhere, skipping the JavaScript
callbacks completely and doing some dark-magic OpenSSL machinery on top of it.
The implementation worked like a charm, providing much better TLS performance,
but the source code became cluttered and rigid.</p>
<p>This &quot;move-parsing-to-elsewhere&quot; thing reminded me a lot about the
<code>stream.pipe</code> that we had for JavaScript streams for ages. The natural thing to
do about it was to introduce something similar in the C++ land too. This is
exactly what was done in io.js, and the results of this live in
<code>src/stream_base.cc</code>.</p>
<h2 id="next-step-with-the-c-stream-apis" tabindex="-1">Next step with the C++ Stream APIs <a class="header-anchor" href="#next-step-with-the-c-stream-apis">#</a></h2>
<p>Now we have a very general implementation of this thing that could be reused in
many places. The first thing that I expect will be using this might be an
HTTP2 stream. To do it in core, we should do it in user-land first, and it could
be accomplished only by exposing the C++ Stream API, in the same way as we did
it with ObjectWrap.</p>
<h2 id="epilogue" tabindex="-1">Epilogue <a class="header-anchor" href="#epilogue">#</a></h2>
<p>I'm going to ask you to:</p>
<ul>
<li>Clone the io.js repo</li>
<li>Open the <code>src/</code></li>
<li>Go through files in it, and check what you read about it</li>
<li>Open <code>src/stream_base.h</code>, <code>src/stream_base.cc</code> and friends and figure out
what seems to be wrong to you</li>
<li><a href="https://github.com/nodejs/io.js/pulls">Send a PR</a></li>
<li>Have fun!</li>
</ul>

<ul class="links-nextprev"><li>Previous: <a href="/b.side-projects/">Side Projects</a></li><li>Next: <a href="/d.sea-of-nodes/">Sea of Nodes</a></li>
</ul>

		</main>

		<footer>
      Copyright Fedor Indutny 2024;
      <a href="https://github.com/indutny/blog" target="_blank" rel="noreferrer">Released</a>
      under
      <a href="https://opensource.org/licenses/mit-license.php" target="_blank" rel="noreferrer">
        MIT license
      </a>.
    </footer>

		<!-- Current page: /c.cpp-in-node/ -->
	</body>
</html>
