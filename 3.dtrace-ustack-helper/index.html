<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>DTrace and the little ustack helper that could</title>
		<meta name="description" content="Darkside of Software Engineering.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Fedor Indutny&#39;s Blog">
		<link rel="alternate" href="/feed/feed.json" type="application/json" title="Fedor Indutny&#39;s Blog">
		<meta name="generator" content="Eleventy v2.0.0">
		
		<style>/* Only include the syntax highlighter CSS on blog posts */
/**
 * okaidia theme for JavaScript, CSS and HTML
 * Loosely based on Monokai textmate theme by http://www.monokai.nl/
 * @author ocodia
 */

code[class*="language-"],
pre[class*="language-"] {
	color: #f8f8f2;
	background: none;
	text-shadow: 0 1px rgba(0, 0, 0, 0.3);
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
	border-radius: 0.3em;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #272822;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: #8292a2;
}

.token.punctuation {
	color: #f8f8f2;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.constant,
.token.symbol,
.token.deleted {
	color: #f92672;
}

.token.boolean,
.token.number {
	color: #ae81ff;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #a6e22e;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string,
.token.variable {
	color: #f8f8f2;
}

.token.atrule,
.token.attr-value,
.token.function,
.token.class-name {
	color: #e6db74;
}

.token.keyword {
	color: #66d9ef;
}

.token.regex,
.token.important {
	color: #fd971f;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}

/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
* { box-sizing: border-box; }
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #082840;
	--text-color-link-active: #5f2b48;
	--text-color-link-visited: #17050F;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main {
	padding: 1rem;
}
main :first-child {
	margin-top: 0;
}

header {
	border-bottom: 1px dashed var(--color-gray-20);
}
header:after {
	content: "";
	display: table;
	clear: both;
}

.links-nextprev {
	list-style: none;
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
}
pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
}
code {
	word-break: normal;
}

/* Header */
header {
	display: flex;
	gap: 1em .5em;
	flex-wrap: wrap;
	align-items: center;
	padding: 1em;
}
.home-link {
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
	margin-right: 2em;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	padding: 0;
	margin: 0;
	list-style: none;
  align-items: center;
}
.nav-item {
	display: inline-block;
	margin-right: 1em;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}
.nav-item svg.social {
  display: block;
  width: 18px;
  height: 18px;
}

/* Posts list */
.postlist {
	list-style: none;
	padding: 0;
	padding-left: 1.5rem;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	content: "" counter(start-from, decimal-leading-zero) ". ";
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	padding-left: .25em;
	padding-right: .5em;
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	text-transform: capitalize;
	font-style: italic;
}
.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

/* Direct Links / Markdown Headers */
.header-anchor {
	text-decoration: none;
	font-style: normal;
	font-size: 1em;
	margin-left: .1em;
}
a[href].header-anchor,
a[href].header-anchor:visited {
	color: transparent;
}
a[href].header-anchor:focus,
a[href].header-anchor:hover {
	text-decoration: underline;
}
a[href].header-anchor:focus,
:hover > a[href].header-anchor {
	color: #aaa;
}

h2 + .header-anchor {
	font-size: 1.5em;
}

footer {
  padding: 1.5em 0 0.5em 0;
  font-size: 0.75em;
  text-align: right;
}

img {
  max-width: 100%;
  height: auto;
}</style>
	</head>
	<body>
		<a href="#skip" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">Fedor Indutny&#39;s Blog</a>

      
			<nav>
				<h2 class="visually-hidden">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/blog/">Archive</a></li>
					<li class="nav-item"><a href="/about/">About Me</a></li>
          <li class="nav-item">
            <a href="https://github.com/indutny" target="_blank" rel="noreferrer">
              <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github fa-w-16 social" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
            </a>
          </li>
          <li class="nav-item">
            <a href="https://fosstodon.org/@indutny" target="_blank" rel="me">
              <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="mastodon" class="svg-inline--fa fa-mastodon fa-w-14 social" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"></path></svg>
            </a>
          </li>
				</ul>
			</nav>
		</header>

		<main id="skip">
			
<h1>DTrace and the little ustack helper that could</h1>

<ul class="post-metadata">
	<li><time datetime="2013-01-11">11 January 2013</time></li>
	<li><a href="/tags/dtrace/" class="post-tag">DTrace</a></li>
</ul>

<p><picture><source type="image/avif" srcset="/img/8T1ihGV-f7-747.avif 747w"><source type="image/webp" srcset="/img/8T1ihGV-f7-747.webp 747w"><img alt="Flamegraph" loading="lazy" decoding="async" src="/img/8T1ihGV-f7-747.png" width="747" height="326"></picture></p>
<p><a href="http://blog.nodejs.org/2012/04/25/profiling-node-js/">Flamegraphs</a> are awesome if you need to profile your node.js application.
They provide a nice looking visual view of where your application is spending
its time. Although they're <a href="http://blog.nodejs.org/2012/04/25/profiling-node-js/">well</a> <a href="http://dtrace.org/blogs/dap/2012/01/05/where-does-your-node-program-spend-its-time/">documented</a>, no one has ever said a
word on how they work internally, but everyone mentions
&quot;ustack helper&quot; which, right now, works only on SmartOS.</p>
<h1 id="call-stack" tabindex="-1">Call stack <a class="header-anchor" href="#call-stack">#</a></h1>
<p>To understand profiling, one must understand what a callstack is. During its
lifetime every application is using <a href="http://en.wikipedia.org/wiki/Stack_(abstract_data_type)">stack</a>, which is a chunk of memory which can
be changed by using <code>push</code>, <code>pop</code>, <code>call</code> and other CPU instructions, or
by accessing it directly.</p>
<p>The <code>push</code> and <code>pop</code> instructions simply expand/shrink stack storing/loading
data on top of it. The <code>call</code> instruction is a little bit more interesting:</p>
<p><em>(Quote from
<a href="http://download.intel.com/products/processor/manual/325462.pdf">Intel® 64 and IA-32 Architectures Software Developer’s Manual</a>)</em></p>
<blockquote>
    ...the processor pushes the value of the EIP register (which contains the
    offset of the instruction following the CALL instruction) on the stack (for
    use later as a return-instruction pointer). The processor then branches to
    the address in the current code segment specified by the target operand.
</blockquote>
<p>So coupled with the <code>ret</code> instruction <code>call</code> allows you to jump into some
function and return back to the place where it was called. (Despite it's
simplicity, I still find it amazing.)</p>
<p>That's how calling functions really work internally, but stack can be also used
to store local (on-stack) function's data. This is achieved using stack frames.
This is how functions' assembly code do usually look:</p>
<p><em>(I'll use <a href="http://en.wikipedia.org/wiki/X86_assembly_language#Syntax">AT&amp;T assembly syntax</a>)</em></p>
<pre class="language-txt" tabindex="0"><code class="language-txt">push ebp ; Save previous frame pointer<br>mov  esp, ebp ; Set new frame pointer<br>sub  $0x60, esp ; Allocate space on stack<br><br>; Function's body.<br>mov  $0x10, -0x8(%ebp) ; set on-stack variable<br><br>mov  ebp, esp ; Shrink stack to it's initial value<br>pop  ebp ; Restore previous frame pointer<br>ret  0 ; Return to caller</code></pre>
<p>If represented graphically stack generally looks like this:</p>
<p><picture><source type="image/avif" srcset="/img/1g3z_8Q7Fn-397.avif 397w"><source type="image/webp" srcset="/img/1g3z_8Q7Fn-397.webp 397w"><img alt="Callstack" loading="lazy" decoding="async" src="/img/1g3z_8Q7Fn-397.png" width="397" height="472"></picture></p>
<p>The main pros of using structure above are:</p>
<ul>
<li>Easiness of restoring stack back to its initial position</li>
<li>Fast and simple access to on-stack variables</li>
</ul>
<h1 id="stack-trace" tabindex="-1">Stack trace <a class="header-anchor" href="#stack-trace">#</a></h1>
<p>Suppose your application has thrown an exception or crashed with a segmentation
fault. To find the cause of the problem one may start by looking at the stack
trace where the crash has happened:</p>
<pre class="language-txt" tabindex="0"><code class="language-txt">#0  0x00007fff84356d16 in kevent ()<br>#1  0x00000001000557b7 in kqueue_poll ()<br>#2  0x000000010004c77a in uv__run ()<br>#3  0x000000010004c92a in uv_run ()<br>#4  0x0000000100015319 in node::Start ()<br>#5  0x000000010000dd24 in start ()</code></pre>
<p>Here, on the left, you can see addresses of functions' code. Debugger gets them
by taking current <code>eip</code> and <code>ebp</code> registers (which stands for current
instruction address and current stack frame address), walking stack frames and
collecting return addresses from it. On the right side, you can see functions'
real names. <a href="http://www.gnu.org/software/gdb/">gdb</a> automatically loads this information for you by searching
for debugging symbols corresponding to addresses it has collected.</p>
<h1 id="flamegraph" tabindex="-1">Flamegraph <a class="header-anchor" href="#flamegraph">#</a></h1>
<p>In order to create flamegraph, one will need to periodically collect
application's stack traces and join them (the process is called
<a href="http://en.wikipedia.org/wiki/Profiling_(computer_programming)#Statistical_profilers">statistical profiling</a>),  making boxes with functions that were called more
often - wider, and putting box on the top of another box only if their functions
appear above each other in the stack trace.</p>
<h1 id="v8-s-stack-frames" tabindex="-1">V8's stack frames <a class="header-anchor" href="#v8-s-stack-frames">#</a></h1>
<p>When collecting stack traces of C/C++ application, dtrace will use static
debugging information using binary's symbols table. But when it comes to dynamic
languages, getting such information turns out to be more complicated:
functions are compiled lazily, often recompiled with applied optimizations, old
code may be evicted by GC... in other words, application is evolving during its
execution.</p>
<p>Thankfully, V8 provides this information, but instead of debugging symbols
it stores it in stack frames. Here is an example of v8's stack frame structure:</p>
<p><picture><source type="image/avif" srcset="/img/yVoU9rIBqQ-397.avif 397w"><source type="image/webp" srcset="/img/yVoU9rIBqQ-397.webp 397w"><img alt="V8 Callstack" loading="lazy" decoding="async" src="/img/yVoU9rIBqQ-397.png" width="397" height="367"></picture></p>
<p>So knowing this structure we can identify frames by checking marker/function
value and getting function names from V8's heap (it's too big topic to cover
here, believe me).</p>
<p>That's exactly the job of ustack helper, it takes frame address and should figure
out and return function's name, or just fail. So everytime you call <code>jstack()</code>
function in DTrace probe, ustack helper will be called for every unidentified
frame.</p>
<h1 id="ustack-helper-example" tabindex="-1">ustack helper example <a class="header-anchor" href="#ustack-helper-example">#</a></h1>
<p><em>NOTE: some knowledge of D language is required to fully understand code below</em></p>
<pre class="language-d" tabindex="0"><code class="language-d">dtrace<span class="token punctuation">:</span>helper<span class="token punctuation">:</span>ustack<span class="token punctuation">:</span><br><span class="token punctuation">{</span><br>  <span class="token comment">/* frame pointer */</span><br>  <span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span>fp <span class="token operator">=</span> arg1<span class="token punctuation">;</span><br><br>  <span class="token comment">/* Last statement - result */</span><br>  <span class="token string">"whoa! you've identified me"</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>If you replace contents of <code>src/v8ustack.d</code> in node.js sources, recompile it
(on SmartOS), run <code>bash benchmark/http-flamegraph.sh</code>, and open <code>stacks.src</code>,
which should contain following stack traces:</p>
<pre class="language-txt" tabindex="0"><code class="language-txt">node`_ZN2v88internal7Context14native_contextEv<br>node`_ZN4node10StreamWrap15WriteStringImplILNS_13...<br>node`_ZN4node10StreamWrap15WriteUtf8StringERKN2v89ArgumentsE+0x9<br>whoa! you've identified me<br>whoa! you've identified me<br>whoa! you've identified me</code></pre>
<p>As you can see, DTrace has identified some C++ functions and for all other
addresses has called our ustack helper.</p>
<p>Let's read some data from V8's stack frame:</p>
<pre class="language-d" tabindex="0"><code class="language-d">#define FP_MARKER <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><br>#define FT_ENTRY <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span><br><br><span class="token comment">/* Init */</span><br>dtrace<span class="token punctuation">:</span>helper<span class="token punctuation">:</span>ustack<span class="token punctuation">:</span><br><span class="token punctuation">{</span><br>  <span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span>fp <span class="token operator">=</span> arg1<span class="token punctuation">;</span><br>  <span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span>done <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br>  <span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span>marker <span class="token operator">=</span> <span class="token punctuation">(</span>uint64_t<span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">/* Get marker */</span><br>dtrace<span class="token punctuation">:</span>helper<span class="token punctuation">:</span>ustack<span class="token punctuation">:</span><br><span class="token punctuation">{</span><br>  <span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span>marker <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>uint64_t<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">copyin</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span>fp <span class="token operator">+</span> FP_MARKER<span class="token punctuation">,</span><br>                                     <span class="token function">sizeof</span><span class="token punctuation">(</span>uint64_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">/* Match entry marker */</span><br>dtrace<span class="token punctuation">:</span>helper<span class="token punctuation">:</span>ustack<span class="token punctuation">:</span><br><span class="token operator">/</span><span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span>marker <span class="token operator">==</span> FT_ENTRY<span class="token operator">/</span><br><span class="token punctuation">{</span><br>  <span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span>done <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><br>  <span class="token string">"entry"</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">/* Match everything else */</span><br>dtrace<span class="token punctuation">:</span>helper<span class="token punctuation">:</span>ustack<span class="token punctuation">:</span><br><span class="token operator">/</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span>done<span class="token operator">/</span><br><span class="token punctuation">{</span><br>  <span class="token string">"everything else"</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>Run it again, and if you're lucky enough you'll find this in <code>stacks.src</code>:</p>
<pre class="language-txt" tabindex="0"><code class="language-txt">everything else<br>everything else<br>entry<br>node`_ZN2v88internalL6InvokeEbNS0...</code></pre>
<p>Important things about ustack helper:</p>
<ul>
<li>It's running within kernel (though, in it's own context, so it can't crash
it). The most important consequences of it is that user-land addresses can't
be accessed directly, but only by using <code>copyin()</code> function.</li>
<li>Usage of control flow statements (if/foreach/while) in DTrace scripts is
prohibited, since all probes should terminate in a reasonable time. Otherwise
infinite loop in kernel space will cause your system to halt.</li>
</ul>
<h1 id="debugging-ustack-helper" tabindex="-1">Debugging ustack helper <a class="header-anchor" href="#debugging-ustack-helper">#</a></h1>
<p>During development of 64bit platform support for node.js ustack helper, I found
that it's pretty hard to debug ustack helper. The only method to do this is
insertion of probes which are returning some debugging information, and
observing this information later in stack traces.</p>
<p>Additionally, it's worth noting that failed <code>copyin()</code> or any bad memory access
won't produce any informative output, but you'll see raw address in stack trace
(i.e. 0x0000000012345678) rather than your pretty real function's name.</p>
<h1 id="epilogue" tabindex="-1">Epilogue <a class="header-anchor" href="#epilogue">#</a></h1>
<p>You can look at/play with node's <a href="https://github.com/joyent/node/blob/master/src/v8ustack.d">ustack helper</a>, big kudos to
<a href="https://github.com/davepacheco">Dave Pacheco</a> for developing it!</p>
<p>And you should check out Bryan Cantrill's and Dave Pacheco's presentation that
explains many things that wasn't covered in this post:
<a href="http://www.slideshare.net/bcantrill/goto2012">Dynamic Languages in Production: Progress and Open Challenges</a> and
<a href="http://www.livestream.com/dataweek/video?clipId=pla_59016422-9a89-45be-ac86-64bc4c45fe99&amp;utm_source=lslibrary&amp;utm_medium=ui-thumb">video</a>.</p>
<p>Huge thanks to <a href="http://voxer.com/">Voxer</a> for funding my investigation and work on porting
DTrace ustack helper to 64bit platform! Guys, I love you. You're awesome!</p>

<ul class="links-nextprev"><li>Previous: <a href="/2.candor-returns/">Candor returns</a></li><li>Next: <a href="/4.how-to-start-jitting/">How to start JIT-ting</a></li>
</ul>

		</main>

		<footer>
      Copyright Fedor Indutny 2023;
      <a href="https://github.com/indutny/blog" target="_blank" rel="noreferrer">Released</a>
      under
      <a href="https://opensource.org/licenses/mit-license.php" target="_blank" rel="noreferrer">
        MIT license
      </a>.
    </footer>

		<!-- Current page: /3.dtrace-ustack-helper/ -->
	</body>
</html>
