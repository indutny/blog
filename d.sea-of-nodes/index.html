<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Sea of Nodes</title>
		<meta name="description" content="Darkside of Software Engineering.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Fedor Indutny&#39;s Blog">
		<link rel="alternate" href="/feed/feed.json" type="application/json" title="Fedor Indutny&#39;s Blog">
		<meta name="generator" content="Eleventy v2.0.1">
		
		<style>/* Only include the syntax highlighter CSS on blog posts */
/**
 * okaidia theme for JavaScript, CSS and HTML
 * Loosely based on Monokai textmate theme by http://www.monokai.nl/
 * @author ocodia
 */

code[class*="language-"],
pre[class*="language-"] {
	color: #f8f8f2;
	background: none;
	text-shadow: 0 1px rgba(0, 0, 0, 0.3);
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
	border-radius: 0.3em;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #272822;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: #8292a2;
}

.token.punctuation {
	color: #f8f8f2;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.constant,
.token.symbol,
.token.deleted {
	color: #f92672;
}

.token.boolean,
.token.number {
	color: #ae81ff;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #a6e22e;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string,
.token.variable {
	color: #f8f8f2;
}

.token.atrule,
.token.attr-value,
.token.function,
.token.class-name {
	color: #e6db74;
}

.token.keyword {
	color: #66d9ef;
}

.token.regex,
.token.important {
	color: #fd971f;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}

/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
* { box-sizing: border-box; }
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #082840;
	--text-color-link-active: #5f2b48;
	--text-color-link-visited: #17050F;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main {
	padding: 1rem;
}
main :first-child {
	margin-top: 0;
}

header {
	border-bottom: 1px dashed var(--color-gray-20);
}
header:after {
	content: "";
	display: table;
	clear: both;
}

.links-nextprev {
	list-style: none;
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
}
pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
}
code {
	word-break: normal;
}

/* Header */
header {
	display: flex;
	gap: 1em .5em;
	flex-wrap: wrap;
	align-items: center;
	padding: 1em;
}
.home-link {
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
	margin-right: 2em;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	padding: 0;
	margin: 0;
	list-style: none;
  align-items: center;
}
.nav-item {
	display: inline-block;
	margin-right: 1em;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}
.nav-item svg.social {
  display: block;
  width: 18px;
  height: 18px;
}

/* Posts list */
.postlist {
	list-style: none;
	padding: 0;
	padding-left: 1.5rem;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	content: "" counter(start-from, decimal-leading-zero) ". ";
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	padding-left: .25em;
	padding-right: .5em;
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	text-transform: capitalize;
	font-style: italic;
}
.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

/* Direct Links / Markdown Headers */
.header-anchor {
	text-decoration: none;
	font-style: normal;
	font-size: 1em;
	margin-left: .1em;
}
a[href].header-anchor,
a[href].header-anchor:visited {
	color: transparent;
}
a[href].header-anchor:focus,
a[href].header-anchor:hover {
	text-decoration: underline;
}
a[href].header-anchor:focus,
:hover > a[href].header-anchor {
	color: #aaa;
}

h2 + .header-anchor {
	font-size: 1.5em;
}

footer {
  padding: 1.5em 0 0.5em 0;
  font-size: 0.75em;
  text-align: right;
}

img {
  max-width: 100%;
  height: auto;
}</style>
	</head>
	<body>
		<a href="#skip" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">Fedor Indutny&#39;s Blog</a>

      
			<nav>
				<h2 class="visually-hidden">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/blog/">Archive</a></li>
					<li class="nav-item"><a href="/about/">About Me</a></li>
          <li class="nav-item">
            <a href="https://github.com/indutny" target="_blank" rel="noreferrer">
              <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github social" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
            </a>
          </li>
          <li class="nav-item">
            <a href="https://fosstodon.org/@indutny" target="_blank" rel="me">
              <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="mastodon" class="svg-inline--fa fa-mastodon social" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"></path></svg>
            </a>
          </li>
				</ul>
			</nav>
		</header>

		<main id="skip">
			
<h1>Sea of Nodes</h1>

<ul class="post-metadata">
	<li><time datetime="2015-10-08">08 October 2015</time></li>
	<li><a href="/tags/compilers/" class="post-tag">compilers</a></li>
</ul>

<h2 id="brief-intro" tabindex="-1">Brief intro <a class="header-anchor" href="#brief-intro">#</a></h2>
<p>This post is going to be about the sea-of-nodes compiler concept that I have
recently learned.</p>
<p>While it is not completely necessary, it may be useful to take a peek at the
some of my previous posts on JIT-compilers before reading this:</p>
<ul>
<li><a href="/4.how-to-start-jitting">How to start JIT-ting</a></li>
<li><a href="/5.allocating-numbers">Allocating numbers</a></li>
<li><a href="/6.smis-and-doubles">SMIs and Doubles</a></li>
<li><a href="/a.deoptimize-me-not">Deoptimize me not, v8</a></li>
</ul>
<h2 id="compilers-translators" tabindex="-1">Compilers = translators <a class="header-anchor" href="#compilers-translators">#</a></h2>
<p>Compilers are something that every Software Engineer uses several times a day.
Surprisingly even people who consider themselves to be far from writing the
code, still use a compiler quite heavily throughout their day. This is
because most of the web depends on client-side code execution, and many of such
client-side programs are passed to the browser in a form of the source code.</p>
<p>Here we come to an important thing: while source code is (usually)
human-readable, it looks like complete garbage to your
laptop/computer/phone/...'s CPU. On other hand, machine code, that computers
<strong>can</strong> read, is (almost always) not human-readable. Something should be done
about it, and the solution to this problem is provided by the process called
<strong>translation</strong>.</p>
<p>Trivial compilers perform a single pass of <em>translation</em>: from the source code
to the machine code. However, in practice most compilers do at least two passes:
from the source code to <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">Abstract Syntax Tree</a> (AST), and from <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">AST</a> to
machine code. <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">AST</a> in this case acts like an <em>Intermediate Representation</em>
(IR), and as the name suggests, <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">AST</a> is just another form of the same source
code. These intermediate representations chain together and essentially are
nothing else but the abstraction layers.</p>
<p>There is no limit on the layer count. Each new layer brings the source program
closer to how it will look like in machine code.</p>
<h2 id="optimization-layers" tabindex="-1">Optimization layers <a class="header-anchor" href="#optimization-layers">#</a></h2>
<p>However, not all layers are used solely for translation. Many compilers also
additionally attempt to optimize the human-written code. (Which is usually
written to have a balance between code elegance and code performance).</p>
<p>Take the following JavaScript code, for example:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> acc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><br>  acc <span class="token operator">+=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre>
<p>If the compiler would translate it to the machine code straight out of <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">AST</a>,
it may resemble (in very abstract and detached from reality instruction set):</p>
<pre class="language-txt" tabindex="0"><code class="language-txt">acc = 0;<br>i = 0;<br>loop {<br>  // Load `.length` field of arr<br>  tmp = loadArrayLength(arr);<br>  if (i >= tmp)<br>    break;<br><br>  // Check that `i` is between 0 and `arr.length`<br>  // (NOTE: This is necessary for fast loads and<br>  // stores).<br>  checkIndex(arr, i);<br><br>  // Load value<br>  acc += load(arr, i);<br><br>  // Increment index<br>  i += 1;<br>}</code></pre>
<p>It may not be obvious, but this code is far from optimal. Array length does not
really change inside of the loop, and the range checks are not necessary at all.
Ideally, it should look like this:</p>
<pre class="language-txt" tabindex="0"><code class="language-txt">acc = 0;<br>i = 0;<br>len = loadArrayLength(arr);<br>loop {<br>  if (i >= tmp)<br>    break;<br><br>  acc += load(arr, i);<br>  i += 1;<br>}</code></pre>
<p>Let's try to imagine how we could do this.</p>
<p>Suppose we have an <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">AST</a> at hand, and we try to generate the machine code
straight out of it:</p>
<p><em>(NOTE: Generated with <a href="https://github.com/jquery/esprima">esprima</a>)</em></p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'ForStatement'</span><span class="token punctuation">,</span><br><br>  <span class="token comment">//</span><br>  <span class="token comment">// This is `var i = 0;`</span><br>  <span class="token comment">//</span><br>  <span class="token literal-property property">init</span><span class="token operator">:</span><br>   <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'VariableDeclaration'</span><span class="token punctuation">,</span><br>     <span class="token literal-property property">declarations</span><span class="token operator">:</span><br>      <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'VariableDeclarator'</span><span class="token punctuation">,</span><br>          <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'Identifier'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'i'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>          <span class="token literal-property property">init</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'Literal'</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">raw</span><span class="token operator">:</span> <span class="token string">'0'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'VariableDeclarator'</span><span class="token punctuation">,</span><br>          <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'Identifier'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'acc'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>          <span class="token literal-property property">init</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'Literal'</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">raw</span><span class="token operator">:</span> <span class="token string">'0'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>     <span class="token literal-property property">kind</span><span class="token operator">:</span> <span class="token string">'var'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br><br>  <span class="token comment">//</span><br>  <span class="token comment">// `i &lt; arr.length`</span><br>  <span class="token comment">//</span><br>  <span class="token literal-property property">test</span><span class="token operator">:</span><br>   <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'BinaryExpression'</span><span class="token punctuation">,</span><br>     <span class="token literal-property property">operator</span><span class="token operator">:</span> <span class="token string">'&lt;'</span><span class="token punctuation">,</span><br>     <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'Identifier'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'i'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>     <span class="token literal-property property">right</span><span class="token operator">:</span><br>      <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'MemberExpression'</span><span class="token punctuation">,</span><br>        <span class="token literal-property property">computed</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>        <span class="token literal-property property">object</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'Identifier'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'arr'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        <span class="token literal-property property">property</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'Identifier'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'length'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br><br>  <span class="token comment">//</span><br>  <span class="token comment">// `i++`</span><br>  <span class="token comment">//</span><br>  <span class="token literal-property property">update</span><span class="token operator">:</span><br>   <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'UpdateExpression'</span><span class="token punctuation">,</span><br>     <span class="token literal-property property">operator</span><span class="token operator">:</span> <span class="token string">'++'</span><span class="token punctuation">,</span><br>     <span class="token literal-property property">argument</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'Identifier'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'i'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>     <span class="token literal-property property">prefix</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br><br>  <span class="token comment">//</span><br>  <span class="token comment">// `arr[i] += 1;`</span><br>  <span class="token comment">//</span><br>  <span class="token literal-property property">body</span><span class="token operator">:</span><br>   <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'ExpressionStatement'</span><span class="token punctuation">,</span><br>     <span class="token literal-property property">expression</span><span class="token operator">:</span><br>      <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'AssignmentExpression'</span><span class="token punctuation">,</span><br>        <span class="token literal-property property">operator</span><span class="token operator">:</span> <span class="token string">'+='</span><span class="token punctuation">,</span><br>        <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'Identifier'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'acc'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        <span class="token literal-property property">right</span><span class="token operator">:</span><br>         <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'MemberExpression'</span><span class="token punctuation">,</span><br>           <span class="token literal-property property">computed</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>           <span class="token literal-property property">object</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'Identifier'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'arr'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>           <span class="token literal-property property">property</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'Identifier'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'i'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span></code></pre>
<p>This JSON could also be visualized:
<picture><source type="image/avif" srcset="/img/m5iVXXukxl-1170.avif 1170w"><source type="image/webp" srcset="/img/m5iVXXukxl-1170.webp 1170w"><img alt="AST" loading="lazy" decoding="async" src="/img/m5iVXXukxl-1170.svg" width="1170" height="556"></picture></p>
<p>This is a tree, so it is very natural to traverse it from the top to the bottom,
generating the machine code as we visit the AST nodes. The problem with this
approach is that the information about variables is very sparse, and is spread
through the different tree nodes.</p>
<p>Again, to safely move the length lookup out of the loop we need to know that the
array length does not change between the loop's iterations. Humans can do it
easily just by looking at the source code, but the compiler needs to do quite a
lot of work to confidently extract those facts directly from the AST.</p>
<p>Like many other compiler problems, this is often solved by lifting the data into
a more appropriate abstraction layer, i.e. intermediate representation. In this
particular case that choice of IR is known as a data-flow graph (DFG). Instead
of talking about syntax-entities (like <code>for loop</code>s, <code>expressions</code>, ...), we
should talk about the data itself (read, variables values), and how it changes
through the program.</p>
<h2 id="data-flow-graph" tabindex="-1">Data-flow Graph <a class="header-anchor" href="#data-flow-graph">#</a></h2>
<p>In our particular example, the data we are interested in is the value of
variable <code>arr</code>. We want to be able to easily observe all uses of it to verify
that there are no out-of-bounds accesses or any other change that would modify
the length of the array.</p>
<p>This is accomplished by introducing &quot;def-use&quot; (definition and uses) relationship
between the different data values. Concretely, it means that the value has been
declared once (<em>node</em>), and that it has been used somewhere to create new values
(<em>edge</em> for every use). Obviously, connecting different values together will
form a <strong>data-flow graph</strong> like this:</p>
<p><picture><source type="image/avif" srcset="/img/Q8URzKczR8-681.avif 681w"><source type="image/webp" srcset="/img/Q8URzKczR8-681.webp 681w"><img alt="Data-flow Graph" loading="lazy" decoding="async" src="/img/Q8URzKczR8-681.svg" width="681" height="647"></picture></p>
<p>Note the red <code>array</code> box in this vast graph. The solid arrows going out of it
represent uses of this value. By iterating over those edges, the compiler can
derive that the value of <code>array</code> is used at:</p>
<ul>
<li><code>loadArrayLength</code></li>
<li><code>checkIndex</code></li>
<li><code>load</code></li>
</ul>
<p>Such graphs are constructed in the way that explicitly &quot;clones&quot; the array node,
if its value was accessed in a destructive manner (i.e. stores, length sizes).
Whenever we see <code>array</code> node and observe its uses - we are always certain that
its value does not change.</p>
<p>It may sound complicated, but this property of the graph is quite easy to
achieve. The graph should follow <a href="https://en.wikipedia.org/wiki/Static_single_assignment_form">Single Static Assignment</a> (SSA) rules.
In short, to convert any program to <a href="https://en.wikipedia.org/wiki/Static_single_assignment_form">SSA</a> the compiler needs to rename all
assignments and later uses of the variables, to make sure that each variable is
assigned only once.</p>
<p>Example, before SSA:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><br>a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>After SSA:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">var</span> a0 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a0<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">var</span> a1 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>This way, we can be sure that when we are talking about <code>a0</code> - we are actually
talking about a single assignment to it. This is really close to how people do
things in the functional languages!</p>
<p>Seeing that <code>loadArrayLength</code> has no control dependency (i.e. no dashed lines;
we will talk about them in a bit), compiler may conclude that this node is free
to move anywhere it wants to be and can be placed outside of the loop.
By going through the graph further, we may observe that the value of <code>ssa:phi</code>
node is always between <code>0</code> and <code>arr.length</code>, so the <code>checkIndex</code> may be removed
altogether.</p>
<p>Pretty neat, isn't it?</p>
<h2 id="control-flow-graph" tabindex="-1">Control Flow Graph <a class="header-anchor" href="#control-flow-graph">#</a></h2>
<p>We just used some form of <a href="https://en.wikipedia.org/wiki/Data-flow_analysis">data-flow analysis</a> to extract information from
the program. This allows us to make safe assumptions about how it could be
optimized.</p>
<p>This <em>data-flow representation</em> is very useful in many other cases too. The only
problem is that by turning our code into this kind of graph, we made a step
backwards in our representation chain (from the source code to the machine
code). This intermediate representation is less suitable for generating machine
code than even the AST.</p>
<p>The reason is that the machine is just a sequential list of instructions, which
the CPU executes one-after-another. Our resulting graph doesn't appear to
convey that. In fact, there is no enforced ordering in it at all.</p>
<p>Usually, this is solved by grouping the graph nodes into blocks. This
representation is known as a <a href="https://en.wikipedia.org/wiki/Control_flow_graph">Control Flow Graph</a> (CFG). Example:</p>
<pre class="language-txt" tabindex="0"><code class="language-txt">b0 {<br>  i0 = literal 0<br>  i1 = literal 0<br><br>  i3 = array<br>  i4 = jump ^b0<br>}<br>b0 -> b1<br><br>b1 {<br>  i5 = ssa:phi ^b1 i0, i12<br>  i6 = ssa:phi ^i5, i1, i14<br><br>  i7 = loadArrayLength i3<br>  i8 = cmp "&lt;", i6, i7<br>  i9 = if ^i6, i8<br>}<br>b1 -> b2, b3<br>b2 {<br>  i10 = checkIndex ^b2, i3, i6<br>  i11 = load ^i10, i3, i6<br>  i12 = add i5, i11<br>  i13 = literal 1<br>  i14 = add i6, i13<br>  i15 = jump ^b2<br>}<br>b2 -> b1<br><br>b3 {<br>  i16 = exit ^b3<br>}</code></pre>
<p>It is called a graph not without the reason. For example, the <code>bXX</code> blocks
represent nodes, and the <code>bXX -&gt; bYY</code> arrows represent edges. Let's visualize
it:</p>
<p><picture><source type="image/avif" srcset="/img/sfOWjQef2W-134.avif 134w"><source type="image/webp" srcset="/img/sfOWjQef2W-134.webp 134w"><img alt="CFG" loading="lazy" decoding="async" src="/img/sfOWjQef2W-134.svg" width="134" height="260"></picture></p>
<p>As you can see, there is code before the loop in block <code>b0</code>, loop header in
<code>b1</code>, loop test in <code>b2</code>, loop body in <code>b3</code>, and exit node in <code>b4</code>.</p>
<p>Translation to machine code is very easy from this form. We just replace <code>iXX</code>
identifiers with CPU register names (in some sense, CPU registers are sort of
variables, the CPU has a limited amount of registers, so we need to be careful
to not run out of them), and generating machine code for each instruction,
line-by-line.</p>
<p>To recap, <a href="https://en.wikipedia.org/wiki/Control_flow_graph">CFG</a> has data-flow relations and also ordering. This allows us to
utilize it for both data-flow analysis and machine code generation. However,
attempting to optimize the CFG, by manipulating the blocks and their contents
contained within it, can quickly become complex and error-prone.</p>
<p>Instead, Clifford Click and Keith D. Cooper proposed to use an approach
called <a href="http://www.researchgate.net/profile/Cliff_Click/publication/2394127_Combining_Analyses_Combining_Optimizations/links/0a85e537233956f6dd000000.pdf"><strong>sea-of-nodes</strong></a>, the very topic of this blog post!</p>
<h2 id="sea-of-nodes" tabindex="-1">Sea-of-Nodes <a class="header-anchor" href="#sea-of-nodes">#</a></h2>
<p>Remember our fancy data-flow graph with dashed lines? Those dashed-lines are
actually what make that graph a <strong>sea-of-nodes</strong> graph.</p>
<p>Instead of grouping nodes in blocks and ordering them, we choose to declare the
control dependencies as the dashed edges in a graph. If we will take that graph,
remove everything <strong>non-dashed</strong>, and group things a bit we will get:</p>
<p><picture><source type="image/avif" srcset="/img/fm8maclA7P-448.avif 448w"><source type="image/webp" srcset="/img/fm8maclA7P-448.webp 448w"><img alt="Control-flow part of Sea-of-Nodes" loading="lazy" decoding="async" src="/img/fm8maclA7P-448.svg" width="448" height="921"></picture></p>
<p>With a bit of imagination and node reordering, we can see that this graph is the
same as the simplified CFG graphs that we have just seen above:</p>
<p><picture><source type="image/avif" srcset="/img/sfOWjQef2W-134.avif 134w"><source type="image/webp" srcset="/img/sfOWjQef2W-134.webp 134w"><img alt="CFG" loading="lazy" decoding="async" src="/img/sfOWjQef2W-134.svg" width="134" height="260"></picture></p>
<p>Let's take another look at the <strong>sea-of-nodes</strong> representation:</p>
<p><picture><source type="image/avif" srcset="/img/Q8URzKczR8-681.avif 681w"><source type="image/webp" srcset="/img/Q8URzKczR8-681.webp 681w"><img alt="Sea-of-Nodes" loading="lazy" decoding="async" src="/img/Q8URzKczR8-681.svg" width="681" height="647"></picture></p>
<p>The striking difference between this graph and CFG is that there is no ordering
of the nodes, except the ones that have control dependencies (in other words,
the nodes participating in the control flow).</p>
<p>This representation is very powerful way to look at the code. It has all
insights of the general data-flow graph, and could be changed easily without
constantly removing/replacing nodes in the blocks.</p>
<h2 id="reductions" tabindex="-1">Reductions <a class="header-anchor" href="#reductions">#</a></h2>
<p>Speaking of changes, let's discuss the way to modify the graph. The sea-of-nodes
graph is usually modified by doing graph reductions. We just queue all nodes in
the graph. Invoke our reduction function for every node in the queue. Everything
that this function touches (changes, replaces) is queued back, and will be
passed to the function later on. If you have many reductions, you can just stack
them up together and invoke all of them on each node in the queue, or
alternatively, you can just apply them one after another, if they depend on the
final state of each other. It works like a charm!</p>
<p>I have written a JavaScript toolset for my sea-of-nodes experiments, which
includes:</p>
<ul>
<li><a href="https://github.com/indutny/json-pipeline">json-pipeline</a> - the builder and stdlib of the graph. Provides methods
to create nodes, add inputs to them, change their control dependencies, and
export/import the graph to/from the printable data!</li>
<li><a href="https://github.com/indutny/json-pipeline-reducer">json-pipeline-reducer</a> - the reductions engine. Just create a reducer
instance, feed it several reduction functions, and execute the reducer on the
existing <a href="https://github.com/indutny/json-pipeline">json-pipeline</a> graph.</li>
<li><a href="https://github.com/indutny/json-pipeline-scheduler">json-pipeline-scheduler</a> - library for putting back unordered graph in a
limited amount of blocks connected to each other by control edges (dashed
lines).</li>
</ul>
<p>Combined together, these tools can solve many problems that could be formulated
in terms of data-flow equations.</p>
<p>Example of reduction, which will optimize our initial JS code:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> acc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><br>  acc <span class="token operator">+=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre>
<h3 id="tl-dr" tabindex="-1">TL;DR <a class="header-anchor" href="#tl-dr">#</a></h3>
<p>This code chunk is quite big, so if you want to skip it - here are the notes of
what we will do below:</p>
<ul>
<li>Compute integer ranges of various nodes: literal, add, phi</li>
<li>Compute limits that apply to branch's body</li>
<li>Apply range and limit information (<code>i</code> is always a non-negative number limited
by <code>arr.length</code>) to conclude that length check is not necessary and can be
removed</li>
<li><code>arr.length</code> will be moved out of the loop automatically by
<code>json-pipeline-scheduler</code>. This is because it does <a href="https://courses.cs.washington.edu/courses/cse501/04wi/papers/click-pldi95.pdf">Global Code Motion</a> to
schedule nodes in blocks.</li>
</ul>
<pre class="language-js" tabindex="0"><code class="language-js"><span class="token comment">// Just for viewing graphviz output</span><br><span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">var</span> Pipeline <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'json-pipeline'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">var</span> Reducer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'json-pipeline-reducer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">var</span> Scheduler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'json-pipeline-scheduler'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">//</span><br><span class="token comment">// Create empty graph with CFG convenience</span><br><span class="token comment">// methods.</span><br><span class="token comment">//</span><br><span class="token keyword">var</span> p <span class="token operator">=</span> Pipeline<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">'cfg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">//</span><br><span class="token comment">// Parse the printable data and generate</span><br><span class="token comment">// the graph.</span><br><span class="token comment">//</span><br>p<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">pipeline {<br>  b0 {<br>    i0 = literal 0<br>    i1 = literal 0<br><br>    i3 = array<br>    i4 = jump ^b0<br>  }<br>  b0 -> b1<br><br>  b1 {<br>    i5 = ssa:phi ^b1 i0, i12<br>    i6 = ssa:phi ^i5, i1, i14<br><br>    i7 = loadArrayLength i3<br>    i8 = cmp "&lt;", i6, i7<br>    i9 = if ^i6, i8<br>  }<br>  b1 -> b2, b3<br>  b2 {<br>    i10 = checkIndex ^b2, i3, i6<br>    i11 = load ^i10, i3, i6<br>    i12 = add i5, i11<br>    i13 = literal 1<br>    i14 = add i6, i13<br>    i15 = jump ^b2<br>  }<br>  b2 -> b1<br><br>  b3 {<br>    i16 = exit ^b3<br>  }<br>}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">cfg</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'printable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DEBUG</span><span class="token punctuation">)</span><br>  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">'before.gv'</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'graphviz'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">//</span><br><span class="token comment">// Just a helper to run reductions</span><br><span class="token comment">//</span><br><br><span class="token keyword">function</span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token parameter">graph<span class="token punctuation">,</span> reduction</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> reducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Reducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  reducer<span class="token punctuation">.</span><span class="token function">addReduction</span><span class="token punctuation">(</span>reduction<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  reducer<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>graph<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token punctuation">}</span><br><br><span class="token comment">//</span><br><span class="token comment">// Create reduction</span><br><span class="token comment">//</span><br><span class="token keyword">var</span> ranges <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">function</span> <span class="token function">getRange</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ranges<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span> ranges<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">var</span> range <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">from</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">Infinity</span><span class="token punctuation">,</span> <span class="token literal-property property">to</span><span class="token operator">:</span> <span class="token operator">+</span><span class="token number">Infinity</span><span class="token punctuation">,</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'any'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  ranges<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> range<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> range<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">updateRange</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> reducer<span class="token punctuation">,</span> from<span class="token punctuation">,</span> to</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> range <span class="token operator">=</span> <span class="token function">getRange</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Lowest type, can't get upwards</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>range<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'none'</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>range<span class="token punctuation">.</span>from <span class="token operator">===</span> from <span class="token operator">&amp;&amp;</span> range<span class="token punctuation">.</span>to <span class="token operator">===</span> to <span class="token operator">&amp;&amp;</span> range<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'int'</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span><span class="token punctuation">;</span><br><br>  range<span class="token punctuation">.</span>from <span class="token operator">=</span> from<span class="token punctuation">;</span><br>  range<span class="token punctuation">.</span>to <span class="token operator">=</span> to<span class="token punctuation">;</span><br>  range<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'int'</span><span class="token punctuation">;</span><br>  reducer<span class="token punctuation">.</span><span class="token function">change</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">updateType</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> reducer<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> range <span class="token operator">=</span> <span class="token function">getRange</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>range<span class="token punctuation">.</span>type <span class="token operator">===</span> type<span class="token punctuation">)</span><br>    <span class="token keyword">return</span><span class="token punctuation">;</span><br><br>  range<span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span><br>  reducer<span class="token punctuation">.</span><span class="token function">change</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">//</span><br><span class="token comment">// Set type of literal</span><br><span class="token comment">//</span><br><span class="token keyword">function</span> <span class="token function">reduceLiteral</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> reducer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> value <span class="token operator">=</span> node<span class="token punctuation">.</span>literals<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token function">updateRange</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> reducer<span class="token punctuation">,</span> value<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">reduceBinary</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> reducer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>left<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'none'</span> <span class="token operator">||</span> right<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'none'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">updateType</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> reducer<span class="token punctuation">,</span> <span class="token string">'none'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>left<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'int'</span> <span class="token operator">||</span> right<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'int'</span><span class="token punctuation">)</span><br>    <span class="token function">updateType</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> reducer<span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>left<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">'int'</span> <span class="token operator">||</span> right<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">'int'</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">//</span><br><span class="token comment">// Just join the ranges of inputs</span><br><span class="token comment">//</span><br><span class="token keyword">function</span> <span class="token function">reducePhi</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> reducer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> left <span class="token operator">=</span> <span class="token function">getRange</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> right <span class="token operator">=</span> <span class="token function">getRange</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">reduceBinary</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> reducer<span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>opcode <span class="token operator">!==</span> <span class="token string">'add'</span> <span class="token operator">||</span> left<span class="token punctuation">.</span>from <span class="token operator">!==</span> left<span class="token punctuation">.</span>to<span class="token punctuation">)</span><br>    <span class="token keyword">return</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">var</span> from <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span>from<span class="token punctuation">,</span> right<span class="token punctuation">.</span>from<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> to <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span>to<span class="token punctuation">,</span> right<span class="token punctuation">.</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">updateRange</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> reducer<span class="token punctuation">,</span> from<span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">//</span><br><span class="token comment">// Detect: phi = phi + &lt;positive number>, where initial phi is number,</span><br><span class="token comment">// report proper range.</span><br><span class="token comment">//</span><br><span class="token keyword">function</span> <span class="token function">reduceAdd</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> reducer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> left <span class="token operator">=</span> <span class="token function">getRange</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> right <span class="token operator">=</span> <span class="token function">getRange</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">reduceBinary</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> reducer<span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">var</span> phi <span class="token operator">=</span> node<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>phi<span class="token punctuation">.</span>opcode <span class="token operator">!==</span> <span class="token string">'ssa:phi'</span> <span class="token operator">||</span> right<span class="token punctuation">.</span>from <span class="token operator">!==</span> right<span class="token punctuation">.</span>to<span class="token punctuation">)</span><br>    <span class="token keyword">return</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">var</span> number <span class="token operator">=</span> right<span class="token punctuation">.</span>from<span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>number <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> phi<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!==</span> node<span class="token punctuation">)</span><br>    <span class="token keyword">return</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">var</span> initial <span class="token operator">=</span> <span class="token function">getRange</span><span class="token punctuation">(</span>phi<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>initial<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">'int'</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span><span class="token punctuation">;</span><br><br>  <span class="token function">updateRange</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> reducer<span class="token punctuation">,</span> initial<span class="token punctuation">.</span>from<span class="token punctuation">,</span> <span class="token operator">+</span><span class="token number">Infinity</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">var</span> limits <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">function</span> <span class="token function">getLimit</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>limits<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span> limits<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">var</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  limits<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> map<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">updateLimit</span><span class="token punctuation">(</span><span class="token parameter">holder<span class="token punctuation">,</span> node<span class="token punctuation">,</span> reducer<span class="token punctuation">,</span> type<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> map <span class="token operator">=</span> <span class="token function">getLimit</span><span class="token punctuation">(</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>map<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span><br>    map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'any'</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">var</span> limit <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>limit<span class="token punctuation">.</span>type <span class="token operator">===</span> type <span class="token operator">&amp;&amp;</span> limit<span class="token punctuation">.</span>value <span class="token operator">===</span> value<span class="token punctuation">)</span><br>    <span class="token keyword">return</span><span class="token punctuation">;</span><br>  limit<span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span><br>  limit<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span><br>  reducer<span class="token punctuation">.</span><span class="token function">change</span><span class="token punctuation">(</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">mergeLimit</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> reducer<span class="token punctuation">,</span> other</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> map <span class="token operator">=</span> <span class="token function">getLimit</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> otherMap <span class="token operator">=</span> <span class="token function">getLimit</span><span class="token punctuation">(</span>other<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  otherMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">limit<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">updateLimit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> key<span class="token punctuation">,</span> reducer<span class="token punctuation">,</span> limit<span class="token punctuation">.</span>type<span class="token punctuation">,</span> limit<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">//</span><br><span class="token comment">// Propagate limit from: X &lt; Y to `if`'s true branch</span><br><span class="token comment">//</span><br><span class="token keyword">function</span> <span class="token function">reduceIf</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> reducer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> test <span class="token operator">=</span> node<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>test<span class="token punctuation">.</span>opcode <span class="token operator">!==</span> <span class="token string">'cmp'</span> <span class="token operator">||</span> test<span class="token punctuation">.</span>literals<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'&lt;'</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">var</span> left <span class="token operator">=</span> test<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> right <span class="token operator">=</span> test<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>  <span class="token function">updateLimit</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>controlUses<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> left<span class="token punctuation">,</span> reducer<span class="token punctuation">,</span> <span class="token string">'&lt;'</span><span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">updateLimit</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>controlUses<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> left<span class="token punctuation">,</span> reducer<span class="token punctuation">,</span> <span class="token string">'>='</span><span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">//</span><br><span class="token comment">// Determine ranges and limits of</span><br><span class="token comment">// the values.</span><br><span class="token comment">//</span><br><br><span class="token keyword">var</span> rangeAndLimit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Reducer<span class="token punctuation">.</span>Reduction</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  <span class="token function-variable function">reduce</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> reducer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>opcode <span class="token operator">===</span> <span class="token string">'literal'</span><span class="token punctuation">)</span><br>      <span class="token function">reduceLiteral</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> reducer<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>opcode <span class="token operator">===</span> <span class="token string">'ssa:phi'</span><span class="token punctuation">)</span><br>      <span class="token function">reducePhi</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> reducer<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>opcode <span class="token operator">===</span> <span class="token string">'add'</span><span class="token punctuation">)</span><br>      <span class="token function">reduceAdd</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> reducer<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>opcode <span class="token operator">===</span> <span class="token string">'if'</span><span class="token punctuation">)</span><br>      <span class="token function">reduceIf</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> reducer<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">reduce</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> rangeAndLimit<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">//</span><br><span class="token comment">// Now that we have ranges and limits,</span><br><span class="token comment">// time to remove the useless array</span><br><span class="token comment">// length checks.</span><br><span class="token comment">//</span><br><br><span class="token keyword">function</span> <span class="token function">reduceCheckIndex</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> reducer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// Walk up the control chain</span><br>  <span class="token keyword">var</span> region <span class="token operator">=</span> node<span class="token punctuation">.</span>control<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token keyword">while</span> <span class="token punctuation">(</span>region<span class="token punctuation">.</span>opcode <span class="token operator">!==</span> <span class="token string">'region'</span> <span class="token operator">&amp;&amp;</span> region<span class="token punctuation">.</span>opcode <span class="token operator">!==</span> <span class="token string">'start'</span><span class="token punctuation">)</span><br>    region <span class="token operator">=</span> region<span class="token punctuation">.</span>control<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">var</span> array <span class="token operator">=</span> node<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> index <span class="token operator">=</span> node<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">var</span> limit <span class="token operator">=</span> <span class="token function">getLimit</span><span class="token punctuation">(</span>region<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>limit<span class="token punctuation">)</span><br>    <span class="token keyword">return</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">var</span> range <span class="token operator">=</span> <span class="token function">getRange</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Negative array index is not valid</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>range<span class="token punctuation">.</span>from <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Index should be limited by array length</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>limit<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">'&lt;'</span> <span class="token operator">||</span><br>      limit<span class="token punctuation">.</span>value<span class="token punctuation">.</span>opcode <span class="token operator">!==</span> <span class="token string">'loadArrayLength'</span> <span class="token operator">||</span><br>      limit<span class="token punctuation">.</span>value<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> array<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">// Check is safe to remove!</span><br>  reducer<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">var</span> eliminateChecks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Reducer<span class="token punctuation">.</span>Reduction</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  <span class="token function-variable function">reduce</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> reducer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>opcode <span class="token operator">===</span> <span class="token string">'checkIndex'</span><span class="token punctuation">)</span><br>      <span class="token function">reduceCheckIndex</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> reducer<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">reduce</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> eliminateChecks<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">//</span><br><span class="token comment">// Run scheduler to put everything</span><br><span class="token comment">// back to the CFG</span><br><span class="token comment">//</span><br><br><span class="token keyword">var</span> out <span class="token operator">=</span> Scheduler<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>out<span class="token punctuation">.</span><span class="token function">reindex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DEBUG</span><span class="token punctuation">)</span><br>  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">'after.gv'</span><span class="token punctuation">,</span> out<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'graphviz'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>out<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">cfg</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'printable'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Thank you for reading this. Please expect more information about this
sea-of-nodes approach.</p>
<hr>
<p>Special thanks to <a href="https://github.com/paulfryzel">Paul Fryzel</a> for proof-reading this, and providing
valuable feedback and grammar fixes!</p>

<ul class="links-nextprev"><li>Previous: <a href="/c.cpp-in-node/">Diving into C++ internals of node</a></li><li>Next: <a href="/e.uv-link-t/">uv_link_t - libuv pipeline</a></li>
</ul>

		</main>

		<footer>
      Copyright Fedor Indutny 2023;
      <a href="https://github.com/indutny/blog" target="_blank" rel="noreferrer">Released</a>
      under
      <a href="https://opensource.org/licenses/mit-license.php" target="_blank" rel="noreferrer">
        MIT license
      </a>.
    </footer>

		<!-- Current page: /d.sea-of-nodes/ -->
	</body>
</html>
