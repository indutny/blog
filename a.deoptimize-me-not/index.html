<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Deoptimize me not, v8</title>
		<meta name="description" content="Darkside of Software Engineering.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Fedor Indutny&#39;s Blog">
		<link rel="alternate" href="/feed/feed.json" type="application/json" title="Fedor Indutny&#39;s Blog">
		<meta name="generator" content="Eleventy v2.0.1">
		
		<style>/* Only include the syntax highlighter CSS on blog posts */
/**
 * okaidia theme for JavaScript, CSS and HTML
 * Loosely based on Monokai textmate theme by http://www.monokai.nl/
 * @author ocodia
 */

code[class*="language-"],
pre[class*="language-"] {
	color: #f8f8f2;
	background: none;
	text-shadow: 0 1px rgba(0, 0, 0, 0.3);
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
	border-radius: 0.3em;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #272822;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: #8292a2;
}

.token.punctuation {
	color: #f8f8f2;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.constant,
.token.symbol,
.token.deleted {
	color: #f92672;
}

.token.boolean,
.token.number {
	color: #ae81ff;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #a6e22e;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string,
.token.variable {
	color: #f8f8f2;
}

.token.atrule,
.token.attr-value,
.token.function,
.token.class-name {
	color: #e6db74;
}

.token.keyword {
	color: #66d9ef;
}

.token.regex,
.token.important {
	color: #fd971f;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}

/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
* { box-sizing: border-box; }
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #082840;
	--text-color-link-active: #5f2b48;
	--text-color-link-visited: #17050F;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main {
	padding: 1rem;
}
main :first-child {
	margin-top: 0;
}

header {
	border-bottom: 1px dashed var(--color-gray-20);
}
header:after {
	content: "";
	display: table;
	clear: both;
}

.links-nextprev {
	list-style: none;
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
}
pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
}
code {
	word-break: normal;
}

/* Header */
header {
	display: flex;
	gap: 1em .5em;
	flex-wrap: wrap;
	align-items: center;
	padding: 1em;
}
.home-link {
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
	margin-right: 2em;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	padding: 0;
	margin: 0;
	list-style: none;
  align-items: center;
}
.nav-item {
	display: inline-block;
	margin-right: 1em;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}
.nav-item svg.social {
  display: block;
  width: 18px;
  height: 18px;
}

/* Posts list */
.postlist {
	list-style: none;
	padding: 0;
	padding-left: 1.5rem;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	content: "" counter(start-from, decimal-leading-zero) ". ";
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	padding-left: .25em;
	padding-right: .5em;
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	text-transform: capitalize;
	font-style: italic;
}
.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

/* Direct Links / Markdown Headers */
.header-anchor {
	text-decoration: none;
	font-style: normal;
	font-size: 1em;
	margin-left: .1em;
}
a[href].header-anchor,
a[href].header-anchor:visited {
	color: transparent;
}
a[href].header-anchor:focus,
a[href].header-anchor:hover {
	text-decoration: underline;
}
a[href].header-anchor:focus,
:hover > a[href].header-anchor {
	color: #aaa;
}

h2 + .header-anchor {
	font-size: 1.5em;
}

footer {
  padding: 1.5em 0 0.5em 0;
  font-size: 0.75em;
  text-align: right;
}

img {
  max-width: 100%;
  height: auto;
}</style>
	</head>
	<body>
		<a href="#skip" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">Fedor Indutny&#39;s Blog</a>

      
			<nav>
				<h2 class="visually-hidden">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/blog/">Archive</a></li>
					<li class="nav-item"><a href="/about/">About Me</a></li>
          <li class="nav-item">
            <a href="https://github.com/indutny" target="_blank" rel="noreferrer">
              <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github social" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
            </a>
          </li>
          <li class="nav-item">
            <a href="https://mean.engineer/@indutny" target="_blank" rel="me">
              <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="mastodon" class="svg-inline--fa fa-mastodon social" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"></path></svg>
            </a>
          </li>
				</ul>
			</nav>
		</header>

		<main id="skip">
			
<h1>Deoptimize me not, v8</h1>

<ul class="post-metadata">
	<li><time datetime="2014-12-15">15 December 2014</time></li>
	<li><a href="/tags/compilers/" class="post-tag">compilers</a></li>
</ul>

<p>Compilers are awesome, right? If any programming concept may exist, it will
probably be used in compiler implementation at some point. I am always amazed
by my findings during v8 bug triaging or just random code exploration.</p>
<p>The interesting thing about v8 that I was always passionate about, but never
truly understood, was the Deoptimizer. The idea here is that v8 optimizes
code to make it run faster, but this optimization relies on assumptions
about types, ranges, actual values, const-ness, etc. These assumptions imply
that the optimized code won't run when these conditions are not met,
since the compiler needs to &quot;deoptimize&quot; it by returning to the previous
&quot;no-assumptions&quot; version of generated code when the assumptions are failing.</p>
<p>Technically it means that the compiler is in fact two compilers:
a base compiler and an &quot;optimizer&quot;. (Or even more, if we are talking about JSC
and SpiderMonkey). The concept is quite sound and can yield incredible
performance, but there is a nuance: the optimized code may be &quot;deoptimized&quot; in
various places, not just at the entry point, meaning that the environment (local
variables, arguments, context) should be mapped and moved around.</p>
<h2 id="stack-machines" tabindex="-1">Stack machines <a class="header-anchor" href="#stack-machines">#</a></h2>
<p>To better understand what needs to be done and how things are happening let's
consider a basic stack machine, like the one that we might use to interpret
program instead of JIT compiling it.</p>
<p><em>Note that this stack machine and assembly below are just an output of some
abstract compiler and has nothing do to with v8. Thus here only for
demonstration purposes</em></p>
<pre class="language-txt" tabindex="0"><code class="language-txt">push a<br>push b<br>push c<br>mul     ; pop 2 values and push `arg0 * arg1`<br>push d<br>mul     ; b * c * d<br>add     ; pop 2 values and push `arg0 + arg`<br>ret     ; pop and return value</code></pre>
<p>The interpreter will execute instructions one-by-one, maintaining the stack at
every point.</p>
<p>Now we let's imagine some register machine (like x86_64), and write down
the same program in assembly language. To make it a bit more interesting,
consider that the target architecture has only two registers and the rest of the
values need to be stored in memory (on-stack).</p>
<pre class="language-txt" tabindex="0"><code class="language-txt">mov [slot0], a   ; store value in 0 memory slot<br>mov rax, b       ; store value in rax register<br>mov rbx, c       ; store value in rbx register<br>mul rax, rbx     ; rax = rax * rbx<br>mov rbx, d<br>mul rax, rbx     ; rax = b * c * d<br>mov rbx, [slot0] ; load value from 0 memory slot<br>add rax, rbx     ; rax = b * c * d + a</code></pre>
<p>The instructions are executed one-by-one, maintaining the register values and
memory slots.</p>
<p>In terms of our compiler, the former code is an unoptimized version of our
program, and the latter one is optimized. In fact, this is a completely valid
claim if we would like to run it on x86_64 platform, as assembly has much higher
execution speed than interpreted code that needs to be emulated.</p>
<p>Suppose that the second <code>mul</code> instruction in assembly works only when the <code>d</code>
(which is in <code>rbx</code> register) is a small integer. Now if the execution will
reach the <code>mul</code> and find that there is a JavaScript string, it will just fail
to do the &quot;right thing&quot;. This <code>mul(num, str)</code> operation will definitely require
some sort of type coercion, and could be easily handled by the interpreter.
Doing it in assembly will very likely be much more costly in terms of
performance. To deal with this the compiler inserts check instructions:</p>
<pre class="language-txt" tabindex="0"><code class="language-txt">mov [slot0], a<br>mov rax, b<br>mov rbx, c<br>checkSmallInt rax<br>checkSmallInt rbx<br>mul rax, rbx<br>mov rbx, d<br>checkSmallInt rax<br>checkSmallInt rbx<br>mul rax, rbx ;<br>mov rbx, [slot0]<br>add rax, rbx</code></pre>
<p>So in such an uncommon case, where the argument of <code>mul</code> is not a small integer,
this code should somehow be &quot;deoptimized&quot; from assembly code to the stack
machine and continue execution in the interpreted version. Here is the position
in the optimized code where it will stop:</p>
<pre class="language-txt" tabindex="0"><code class="language-txt">mov [slot0], a<br>mov rax, b<br>mov rbx, c<br>checkSmallInt rax<br>checkSmallInt rbx<br>mul rax, rbx<br>mov rbx, d<br>checkSmallInt rax<br>checkSmallInt rbx &lt;-----<br>mul rax, rbx ;<br>mov rbx, [slot0]<br>add rax, rbx</code></pre>
<p>...and position in unoptimized code, where would like it to continue:</p>
<pre class="language-txt" tabindex="0"><code class="language-txt">push a<br>push b<br>push c<br>mul<br>push d<br>mul     ; &lt;-----<br>add<br>ret</code></pre>
<p>How could it do that? The simplest way is just to re-execute all code from the
program's entry point using the input arguments. This solution is very limited
though, because it is possible only if the optimized function was pure, or in
other words had no instructions with side effects (like function calls, etc...).</p>
<p>The more general solution is to find all live values (the ones that may be used
by later functions) at the deoptimization point, find their locations in both
optimized and unoptimized code, and copy the values from the registers/memory
to stack machine's slot.</p>
<p>This is exactly what the &quot;deoptimizer&quot; in v8 does. The main difference from our
imaginary example is that both unoptimized and optimized codes are in <code>x86_64</code>
assembly language.</p>
<h2 id="simulates" tabindex="-1">Simulates <a class="header-anchor" href="#simulates">#</a></h2>
<p>Now we know what to do, but how is it actually implemented in v8?</p>
<p>These mappings are possible thanks to the special high-level instructions called
<code>Simulate</code>s. This is how they look in the v8's high-level intermediate
representation (abbr. IR, see my <a href="https://www.youtube.com/watch?v=tf6YTgO6Org">EmpireNode talk</a> for more info on the IRs):</p>
<pre class="language-txt" tabindex="0"><code class="language-txt">v9 BlockEntry  &lt;|@<br>v10 Simulate id=3 var[3] = t8 &lt;|@<br>v11 StackCheck  changes[NewSpacePromotion] &lt;|@<br>v12 UseConst t8 &lt;|@<br>t13 ThisFunction  &lt;|@<br>t14 CheckNonSmi t3 &lt;|@<br>t15 CheckMaps t3 [0x2e26d7019781] &lt;|@<br>v16 CheckPrototypeMaps [...] &lt;|@<br>v17 Simulate id=24 push t3, push t4, push t8, var[3] = t13 &lt;|@<br>v18 EnterInlined middle, id=4 &lt;|@<br>t54 PushArgument t3 &lt;|@<br>t55 PushArgument t4 &lt;|@<br>t56 ArgumentsElements  &lt;|@<br>v19 UseConst t1 &lt;|@<br>t20 Constant ... &lt;|@<br>v25 Simulate id=26 pop 1, push t19, var[3] = t2, var[4] = t20 &lt;|@</code></pre>
<p>(Note that you can obtain such IR by running node.js with <code>--trace-hydrogen</code>
flag, which will print it out into the <code>hydrogen.cfg</code> or <code>hydrogen-&lt;pid&gt;.cfg</code>
file).</p>
<p>The thing is called <code>Simulate</code> with good reason. Strip away all other
instructions:</p>
<pre class="language-txt" tabindex="0"><code class="language-txt">v10 Simulate id=3 var[3] = t8 &lt;|@<br>v17 Simulate id=24 push t3, push t4, push t8, var[3] = t13 &lt;|@<br>v25 Simulate id=26 pop 1, push t19, var[3] = t2, var[4] = t20 &lt;|@</code></pre>
<p>...and we will see something that resembles... our simplified stack machine!
Having a stack machine means that we could &quot;simulate&quot; it's state by executing
instructions one-by-one. v8's has a couple of them:</p>
<ul>
<li><code>var[index] = value</code> - put a value in some on-stack slot</li>
<li><code>push value</code> - push a value to a virtual stack</li>
<li><code>pop count</code> - pop <code>count</code> of values from the stack</li>
</ul>
<p>Let's simulate some states out of the above sample:</p>
<pre class="language-txt" tabindex="0"><code class="language-txt">v10: var = { 3: t8 }, stack = []<br>v17: var = { 3: t13 }, stack = [ t3, t4, t8 ]<br>v25: var = { 3: t13, 4: t20 }, stack = [ t3, t4, t19 ]</code></pre>
<p><em>Note that this &quot;simulation&quot; happens at compile-time, not when actually
deoptimizing.</em></p>
<p>These states can be used to map the values from optimized to unoptimized code.
For example, if we would like to &quot;deoptimize&quot; at <code>t56</code>, we will have to find the
latest state which was at <code>v17</code>: <code>var = { 3: t13 }, stack = [ t3, t4, t8 ]</code>, and
just place the present values into a proper stack slots and local variables (for
<code>var</code> ones).</p>
<p>With the <code>--trace-deopt</code> flag v8 will give us some insights on how it is doing
this:</p>
<pre class="language-txt" tabindex="0"><code class="language-txt">**** DEOPT: outer at bailout #14, address 0x0, frame size 56<br>[deoptimizing: begin 0x341ad2082a49 outer @14]<br>translating outer => node=24, height=8<br>0x7fff5fbff3e8: [top + 72] &lt;- 0xb7720f7d8b9 ; [sp + 96] 0xb7720f7d8b9 &lt;an O><br>0x7fff5fbff3e0: [top + 64] &lt;- 0xb7720f7d8b9 ; rbx 0xb7720f7d8b9 &lt;an O><br>0x7fff5fbff3d8: [top + 56] &lt;- 0x21ba55263fa9 ; caller's pc<br>0x7fff5fbff3d0: [top + 48] &lt;- 0x7fff5fbff410 ; caller's fp<br>0x7fff5fbff3c8: [top + 40] &lt;- 0xb7720f7d479; context<br>0x7fff5fbff3c0: [top + 32] &lt;- 0x341ad2082ad9; function<br>0x7fff5fbff3b8: [top + 24] &lt;- 0x341ad2004121 &lt;undefined> ; literal<br>0x7fff5fbff3b0: [top + 16] &lt;- 0x341ad2082ad9 &lt;JS Function inner> ; literal<br>0x7fff5fbff3a8: [top + 8] &lt;- 0xb7720f7d8b9 ; [sp + 24] 0xb7720f7d8b9 &lt;an O><br>0x7fff5fbff3a0: [top + 0] &lt;- 0x341ad2004121 ; rax 0x341ad2004121 &lt;undefined></code></pre>
<p>Arrows here indicate the direction of movement. The output frame of the
unoptimized code is on the left side, and on the right side - optimized code's
values.</p>
<p>The mentioned frame is an on-stack structure used for storing the caller address
(to make <code>return</code> statements work), caller's frame address, and sometimes some
additional stuff (like JS context, <code>this</code>, arguments, and the function itself):</p>
<p><picture><source type="image/avif" srcset="/img/1g3z_8Q7Fn-397.avif 397w"><source type="image/webp" srcset="/img/1g3z_8Q7Fn-397.webp 397w"><img alt="Callstack" loading="lazy" decoding="async" src="/img/1g3z_8Q7Fn-397.png" width="397" height="472"></picture></p>
<p>Ignoring all the internal frame things, the interesting part would be:</p>
<pre class="language-txt" tabindex="0"><code class="language-txt">translating outer => node=24, height=8<br>0x7fff5fbff3a8: [top + 8] &lt;- 0xb7720f7d8b9 ; [sp + 24] 0xb7720f7d8b9 &lt;an O><br>0x7fff5fbff3a0: [top + 0] &lt;- 0x341ad2004121 ; rax 0x341ad2004121 &lt;undefined></code></pre>
<p>The high-level IR of the code that generated this trace contained:</p>
<pre class="language-txt" tabindex="0"><code class="language-txt">0 0 v10 Simulate id=3 var[3] = t8 &lt;|@<br>...<br>0 0 v17 Simulate id=24 push t3, push t4 &lt;|@</code></pre>
<p>There is only one simulate instruction, and the state is: <code>stack = [t3, t4]</code>.
(Sorry ignoring the local variables for this blog post).
Thus, the deoptimizer needs to put the values of the <code>t3</code> and <code>t4</code> instructions
into the stack slots. This information was stored ahead of time, and will be
looked up right when deoptimizing the code. Here, <code>t3</code> was in the <code>[sp + 24]</code>
stack slot in the optimized code, and <code>t4</code> was in <code>rax</code>. This process is called
a &quot;frame translation&quot;. Afterwards the execution will be redirected to the
unoptimized code, which will just continue operating on the values at the place
where the optimized code has been &quot;deoptimized&quot;.</p>
<h2 id="conclusion" tabindex="-1">Conclusion <a class="header-anchor" href="#conclusion">#</a></h2>
<p>The &quot;deoptimizer&quot; is really an interesting tool, and it is one of the main
cogs in <a href="http://blog.chromium.org/2010/12/new-crankshaft-for-v8.html">Crankshaft</a>'s engine. This instrument helps the compiler in
executing the dynamic-language code as if it had been written in C++, because
it can always return to the slow unoptimized code with &quot;true&quot; JavaScript
semantics.</p>
<p><em>Note that things are a bit more tricky with inlined functions, but this is a
topic for another blog post.</em></p>
<p><em>Big kudos to</em>:</p>
<ul>
<li><em>Vyacheslav Egorov</em></li>
<li><em>Ben Noordhuis</em></li>
<li><em>Jeremiah Senkpiel</em></li>
</ul>
<p><em>for proof-reading this and providing valuable feedback.</em></p>

<ul class="links-nextprev"><li>Previous: <a href="/9.heartbleed/">Cracking Cloudflare&#39;s heartbleed challenge</a></li><li>Next: <a href="/b.side-projects/">Side Projects</a></li>
</ul>

		</main>

		<footer>
      Copyright Fedor Indutny 2024;
      <a href="https://github.com/indutny/blog" target="_blank" rel="noreferrer">Released</a>
      under
      <a href="https://opensource.org/licenses/mit-license.php" target="_blank" rel="noreferrer">
        MIT license
      </a>.
    </footer>

		<!-- Current page: /a.deoptimize-me-not/ -->
	</body>
</html>
