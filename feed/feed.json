{
	"version": "https://jsonfeed.org/version/1.1",
	"title": "Fedor Indutny&#39;s Blog",
	"language": "en",
	"home_page_url": "https://darksi.de/",
	"feed_url": "https://darksi.de/feed/feed.json",
	"description": "Darkside of Software Engineering.",
	"author": {
		"name": "Fedor Indutny",
		"url": "https://darksi.de/about-me/"
	},
	"items": [
		{
			"id": "https://darksi.de/12.hashwick-v8-vulnerability/",
			"url": "https://darksi.de/12.hashwick-v8-vulnerability/",
			"title": "HashWick V8 Vulnerability",
			"content_html": "<p><picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/HOXaYY2Bnb-720.avif 720w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/HOXaYY2Bnb-720.webp 720w\"><img alt=\"Hash Wick\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/HOXaYY2Bnb-720.png\" width=\"720\" height=\"422\"></picture></p>\n<p>About one year ago, I've discovered a way to do a Denial-of-Service (DoS) attack\non a local Node.js instance. The process involved sending huge amounts of data\nto the HTTP server running on the same machine as the attacker, and measuring\nthe timing differences between various payloads. Given that the scope of attack\nwas limited to the same machine, it was decided by V8 team and myself that the\nissue wasn't worth looking in yet. Nevertheless, a <a href=\"https://darksi.de/f.v8-hash-seed-timing-attack/\">blog post</a> was published.</p>\n<p>This year, I had a chance to revisit the Hash Seed guessing game with restored\nenthusiasm and new ideas. The results of this experiment are murky, and no fix\nis available yet in V8. Thus <strong>all V8 release lines are vulnerable to the\nHashWick attack</strong>.</p>\n<p><em>(Disclaimer: the issue was disclosed responsibly. This blog post is published\nafter more than 90 days since the initial report)</em></p>\n<h2 id=\"what-is-a-hash-seed\" tabindex=\"-1\">What is a Hash Seed? <a class=\"header-anchor\" href=\"https://darksi.de/12.hashwick-v8-vulnerability/\">#</a></h2>\n<p>The Hash Seed is a random number that is used as an initial value for the\n(non-cryptographic) hash functions inside of V8 instances. Such numbers are used\nnot only in V8 or other VMs, they're used in <a href=\"https://lwn.net/Articles/711167/\">kernels</a>, <a href=\"https://github.com/antirez/redis/blob/cefe21d28a75f4fdbf24823ce42e777c2b9d5c6f/src/dict.c#L74\">databases</a>, and\nmany different kinds of software.</p>\n<p>The reason to have seeded hash functions is to prevent collision attacks on\nhash maps (e.g. JavaScript objects/dictionaries). In ideal scenario, use of\nrandom seed should make guessing the hash value of a string/number an impossible\nendeavor.</p>\n<p>Whenever a Node.js instance parses HTTP headers or JSON object, V8 has to create\na hash map for it. Each hash map is backed by a list (storage) of length\n<code>2 * N</code>. The keys are inserted at even positions, the values are inserted at odd\n(right after the key). The position index is determined by the hash of the key\nmodulo the storage size. Two equal keys will have two equal hashes, and will\npoint to the same cell in the list.</p>\n<p>In ideal scenario the indices for two different keys are always different. It\nis easy to see that it isn't possible due to the limited list size. The more\nkey/value pairs we insert into the object, the more likely the &quot;collision&quot; to\nhappen. When the hash values are the same, but the keys are different, V8\nhas to place the key in the next cell... or in the cell after the next, if the\nnext is filled already.</p>\n<p>All in all, this provides quite optimal insertion/lookup performance at\nrelatively low memory costs.</p>\n<h2 id=\"what-if-attacker-knows-hash-seed\" tabindex=\"-1\">What if attacker knows Hash Seed? <a class=\"header-anchor\" href=\"https://darksi.de/12.hashwick-v8-vulnerability/\">#</a></h2>\n<p>Every publicly exposed system is subject for external attacks. In the worst\ncase, an attacker gains access to the system or data in it. In less worse cases\nthe attacker might be able to overload the resources of the system by repeatedly\nhitting the &quot;slow&quot; paths in the system's code. Such attacks are called &quot;Denial\nof Service&quot; attacks or simply DoS.</p>\n<p>For the hash maps in V8, the hash collisions are exactly the slow path. Being\nable to generate a lot of (or precompute) keys with similar hash values (for\nvarious hash map storage capacities) without using many resources is a guarantee\nof success for such an attack. The worst case scenario is that a small JSON\nobject (or HTTP headers) could take seconds to parse. Sending thousands of such\nobjects would render any server unresponsive.</p>\n<p>What stands in a way of generating the collisions is a random Hash Seed number.\nGiven sufficient size of that number and a strong hash function, the indices of\nthe different keys would look absolutely random. Guessing the Hash Seed becomes\nimpractical both time-wise and information-wise.</p>\n<p>Unfortunately for V8, the hash function isn't strong enough and the hash seed\nis a small number.</p>\n<h2 id=\"how-to-find-v8-s-hash-seed\" tabindex=\"-1\">How to find V8's Hash Seed? <a class=\"header-anchor\" href=\"https://darksi.de/12.hashwick-v8-vulnerability/\">#</a></h2>\n<p>Imagine the following scenario: a Node.js HTTP server is available publicly and\naccepts JSON bodies for POST requests. It'd be reasonable to say that many\npublic Node.js servers are of this kind. It's important to note that this is\nalso applicable if Node.js is not directly exposed to a public internet port,\nsuch as the case of being proxy-passed via Nginx.</p>\n<p>How can an attacker find the value of V8's Hash Seed in such case?</p>\n<p>This was a subject of my research this and last year. Assuming absence of access\nto the server itself, the only way seems to be through the timing differences\nbetween processing different crafted HTTP requests.</p>\n<p>Hitting the slow path in hash map key insertion that we discussed above should\ngive a slightly slower response time. Knowing a lot of key combinations that\ncause the slowdown (and as many combinations that doesn't cause one) is enough\nfor reconstructing the seed value. The problem is, the difference between slow\nand fast path is in the order of microseconds, while the network latency is\noften at least a couple of milliseconds. The network jitter overwrites any minor\ntiming differences without leaving us a chance to measure them.</p>\n<p>What is needed for successful attack is an <strong>&quot;amplification&quot;</strong>. The request has\nto be crafted in such way that the key insertion is triggered many times in a\nsequence for the same key and same hash map contents. Each insertion would take\njust a couple of microseconds, but a thousand of them would add up to a\nmillisecond!</p>\n<p>Without giving away the complete tools for crafting such an attack, I can say\nthat the JSON body might look like this:</p>\n<p><code>{&quot;100000&quot;:0,&quot;101&quot;:1,&quot;101&quot;:1,...repeat many times...}</code></p>\n<p>It exploits several implementation details in V8 and a few quirks of JavaScript.\nIn particular, a JavaScript number lookup <code>obj[100000]</code> is equivalent to\nlooking up the &quot;stringified&quot; value of the same number <code>obj[&quot;100000&quot;]</code>.</p>\n<p>The next quirk is that JSON objects might contain duplicate keys. Each key will\nbe parsed and looked up in the object, regardless of how many times it is\nrepeated in the JSON. <em>Each lookup triggers either slow or fast path in the\ninsertion code</em>.</p>\n<p>The object above essentially becomes a sparse <code>Array</code> backed by a hash map with\nvery shallow storage capacity (just <code>4</code> values). Here's how V8 inserts key into\nit:</p>\n<ol>\n<li>Initially <code>storage</code> is <code>[ null, null, null, null ]</code></li>\n<li>The index of the first key (<code>100000</code>) is computed using the hash function and\nthe hash seed: <code>index = hash(100000, seed) % 4</code></li>\n<li>The value <code>0</code> is inserted into that slot of storage (e.g. <code>index = 1</code>):\n<code>[ null, 0, null, null ]</code></li>\n<li>The index of the second key is computed\n<code>index_2 = hash(random_key, seed) % 4</code></li>\n<li><code>while (storage[index_2] != null) index_2++</code></li>\n<li>The value is stored in <code>index_2</code> slot</li>\n</ol>\n<p>Step 5 is crucial for my attack. The extra check takes extra time, and this time\ndifference could be measured to get information about the hash seed.</p>\n<p>Thus fixing the first key to <code>100000</code>, and trying out different keys\n(probes) will give us the list of timings per each random key. Quarter of the\nprobes will have the same index as <code>100000</code> and will hit the slow path due to\ncollision. The rest will go through the fast path. The processing script would\nlater go through the list of timings and separate it by <code>75%</code> percentile of\nlatency. Most probes would be correctly classified as fast/slow. Misclassified\nprobes would increase Hash Seed search time.</p>\n<p>The result of processing is a list of probe keys, each with an assigned class:\n&quot;same index as 100000&quot; or &quot;different index&quot;. Each entry of this list is a\nconstraint on the Hash Seed value. An OpenCL script goes through all possible\n32-bit Hash Seed values (<code>0 - 0x3fffffff</code>), and finds the one that satisfies\nthe majority of the constraints. That value is the most likely Hash Seed of the\nattacked V8 instance. The OpenCL computation could take place on either CPU or\nGPU, and completes the search in about one minute on my MacBook Pro.</p>\n<p>My unoptimized PoC sends about 2 gb of JSON data to the server, collects the\ntiming information, and computes the Hash Seed in a <em>couple of minutes</em> (this\nincludes OpenCL brute-force time).</p>\n<h2 id=\"prevention\" tabindex=\"-1\">Prevention <a class=\"header-anchor\" href=\"https://darksi.de/12.hashwick-v8-vulnerability/\">#</a></h2>\n<p>This sounds dreary, but the fixes can be made. First of all, the hash seed size\nhas to be increased from 32 bits to 64 bits (this is already done in V8). Next,\nthe hash function has to be changed to <a href=\"https://en.wikipedia.org/wiki/SipHash\">SipHash</a> or other hash function with\nPRF (Pseudo-Random Function) properties.</p>\n<p>Google has an amazing team working on V8. I'm really hopeful that the remaining\nfixes will be completed soon.</p>\n<h2 id=\"prior-art\" tabindex=\"-1\">Prior-Art <a class=\"header-anchor\" href=\"https://darksi.de/12.hashwick-v8-vulnerability/\">#</a></h2>\n<p>The hash collision attacks have <a href=\"https://lwn.net/Articles/474912/\">a long history</a>, and most of the software\nprojects has moved to <a href=\"https://en.wikipedia.org/wiki/SipHash\">SipHash</a> and at least 64-bit Hash Seed since then.</p>\n<hr>\n<h4 id=\"credits\" tabindex=\"-1\">Credits <a class=\"header-anchor\" href=\"https://darksi.de/12.hashwick-v8-vulnerability/\">#</a></h4>\n<p>Huge thanks to <a href=\"https://github.com/aheckmann\">Aaron Heckmann</a>, <a href=\"https://github.com/snowinferno\">Greg Wilburn</a>, <a href=\"https://github.com/rauchg\">Guillermo Rauch</a>, and\n<a href=\"https://github.com/shaunwarman\">Shaun Warman</a> for providing feedback on this article.</p>\n",
			"date_published": "2018-08-22T00:00:00Z"
		}
		,
		{
			"id": "https://darksi.de/11.hyperbloom/",
			"url": "https://darksi.de/11.hyperbloom/",
			"title": "HyperBloom",
			"content_html": "<p>Over this weekend I got not so original (but definitely a fun one) idea to build\nfully distributed and decentralized Twitter. At the time it was inspired by the\n<a href=\"https://datproject.org/\">DAT Project</a> and <a href=\"https://github.com/mafintosh/hypercore\">Hypercore</a>, neither of which could support public\nreplies to user feeds.</p>\n<p>Hence, the most natural thing was to <a href=\"https://xkcd.com/927/\">write a new protocol</a>! Say hello to\n<a href=\"https://github.com/hyperbloom/hyperbloom\">HyperBloom</a>!</p>\n<h2 id=\"protocol\" tabindex=\"-1\">Protocol <a class=\"header-anchor\" href=\"https://darksi.de/11.hyperbloom/\">#</a></h2>\n<p>It is crucial to understand the needs for the protocol before discussing the\nprotocol itself. Let me list few requirements for it:</p>\n<ul>\n<li>Decentralized and distributed</li>\n<li>Viral. Everyone can reply to anyone's tweet without exchanging any public\nkeys or information ahead of time</li>\n<li>Secure</li>\n</ul>\n<p>How could it combine all these three qualities into one protocol? By combining\nexisting solutions, of course:</p>\n<ul>\n<li><a href=\"https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type#State-based_grow-only_set\">State-based grow-only set</a> with <a href=\"https://en.wikipedia.org/wiki/Bloom_filter\">Bloom Filters</a> for diffs</li>\n<li>Distributed <a href=\"https://en.wikipedia.org/wiki/Public_key_infrastructure\">Public Key Infrastructure</a> (PKI) for append permissions</li>\n</ul>\n<h3 id=\"trust-network\" tabindex=\"-1\">Trust Network <a class=\"header-anchor\" href=\"https://darksi.de/11.hyperbloom/\">#</a></h3>\n<p>Having grow-only set that is writable by anyone on the web is the best way to\nintroduce enormous amount of spam into social network. This can be tackled by\naccepting writes only from your friends. However, this kills the virality of the\nplatform.</p>\n<p>Perhaps friends-of-friends should be allowed to append to that Set? Better!</p>\n<p>The way <a href=\"https://github.com/hyperbloom/hyperbloom\">HyperBloom</a> addresses this is by letting author's issue so called\n<a href=\"https://github.com/hyperbloom/hyperbloom-protocol/blob/master/spec.md#signature-chain\"><em>Trust Links</em></a>. Each <em>Trust Link</em> acts like an edge in the Graph: <code>A -&gt; B</code>\nor <em>A</em> trusts <em>B</em>. When two peers connect to synchronize the values in a Set,\nthey each present a collection of links from the author of the Set to the peers\nthemselves. Each successive link in such collection is a continuation of the\nprevious link: <code>A -&gt; B, B -&gt; C, C -&gt; D</code>. With a total limit of <strong>5</strong> links in\none collection (chain).</p>\n<p>The limit is imposed to save the bandwidth. To further save it peers help each\nother by automatically issuing links that create shorter path to the author.</p>\n<p>Example:</p>\n<ol>\n<li>Peer B has following chain: <code>A -&gt; B</code></li>\n<li>Peer C has following chain: <code>A -&gt; D, D -&gt; E, E -&gt; C</code></li>\n<li>Peer B sends <code>B -&gt; C</code> to C to minimize the route</li>\n<li>Peer C uses <code>A -&gt; B, B -&gt; C</code> later on</li>\n</ol>\n<p>Each link has an expiration time, and such automatic link as in the example will\nhave the expiration time set to: <code>minimum(A -&gt; D, D -&gt; E, E -&gt; C)</code>. Essentially,\n<code>A</code> always controls how often it wants to refresh its peers' trust.</p>\n<h3 id=\"set\" tabindex=\"-1\">Set <a class=\"header-anchor\" href=\"https://darksi.de/11.hyperbloom/\">#</a></h3>\n<p>Set is not particularly interesting. It borrows some design decisions from\n<a href=\"https://bitcoin.org/en/glossary/simplified-payment-verification\">Bitcoin SPV client</a>. In particular the use of Bloom filters to optimally\ncompute the difference between the peers and set the missing values.</p>\n<h2 id=\"usage\" tabindex=\"-1\">Usage <a class=\"header-anchor\" href=\"https://darksi.de/11.hyperbloom/\">#</a></h2>\n<p>I'm combining both Hypercore and HyperBloom into a project called (for no\nparticular reason. May be Hyper-uni-corn?) <a href=\"https://github.com/indutny/hypercorn\">HyperCorn</a>. HyperCorn uses\nHyperCore logs for JSON message fields, and HyperBloom for notifying authors\nabout replies to their feeds.</p>\n<p>HyperBloom Trust Links are stored and distributed through HyperCore. So far it\nappears to be working, but it has pretty long way to go still. Mainly it needs\nan UI. Contact me, if you are interested!</p>\n<h2 id=\"open-questions\" tabindex=\"-1\">Open Questions <a class=\"header-anchor\" href=\"https://darksi.de/11.hyperbloom/\">#</a></h2>\n<ul>\n<li>Is virality a good thing?</li>\n<li>Should auto-links be issued?</li>\n<li>Is 5 links enough?</li>\n</ul>\n<p>I'd love to hear your opinion.</p>\n<p>(You can reply on <a href=\"https://twitter.com/indutny/status/857136827639189504\">twitter</a>)</p>\n<p>Thanks for reading.</p>\n",
			"date_published": "2017-04-26T00:00:00Z"
		}
		,
		{
			"id": "https://darksi.de/f.v8-hash-seed-timing-attack/",
			"url": "https://darksi.de/f.v8-hash-seed-timing-attack/",
			"title": "V8 hash seed timing attack",
			"content_html": "<h2 id=\"moment-of-history\" tabindex=\"-1\">Moment of History <a class=\"header-anchor\" href=\"https://darksi.de/f.v8-hash-seed-timing-attack/\">#</a></h2>\n<p>There is a mostly forgotten <a href=\"https://github.com/nodejs/node-v0.x-archive/issues/2431\">security issue</a> that was fixed in\nNode.js back in 2012. It was originally announced on the\n<a href=\"https://www.youtube.com/watch?v=R2Cq3CLI6H8\">28c3 conference</a> December, 2011 and the final fix landed in\n<a href=\"https://github.com/nodejs/node/commit/16953329413831b32f4c3b2255aeacec874ed69d\">January, 2012</a>.</p>\n<p>In few words, the most of dynamic languages use either bucket lists or\n<a href=\"https://en.wikipedia.org/wiki/Hash_table#Open_addressing\">open addressing</a> variants of hash tables. V8 uses the latter one, and in\nsuch case when VM is asked to insert a property into an object it does\nthe following sequence of actions:</p>\n<ol>\n<li>Compute the hash of the key (quite often with a <a href=\"https://en.wikipedia.org/wiki/Jenkins_hash_function\">Jenkins hash</a>)</li>\n<li>Clear the high bits of the hash value</li>\n<li>Use it as an index in the internal array</li>\n<li>Find unused slot in that array</li>\n<li>Insert the key/value pair at that slot.</li>\n</ol>\n<p>This sounds pretty much OK, except for the step 4. One may ask: What if the\ntarget slot is way too far from the index in the step 3? The answer is: it will\ntake more time to do such insertion.</p>\n<p>Do you see where it is going?</p>\n<h2 id=\"collision-attacks\" tabindex=\"-1\">Collision attacks <a class=\"header-anchor\" href=\"https://darksi.de/f.v8-hash-seed-timing-attack/\">#</a></h2>\n<p>If the attacker can insert many keys like these into the hash table - the whole\nprocedure is going be much slower than usual (20x slower in some cases). During\nthis time Node.js will be blocked, and performing such insertions one after\nanother leads directly to Denial of Service attack. To put it in concrete\ncontext: <code>req.headers</code> in <code>http.Server</code> is populated with user data, and is thus\nsusceptible to this kind of attack.</p>\n<p>How does one generate such keys? Trivial and fast brute-force could generate as\nmany keys as needed to give desired &quot;collisions&quot; given that attacker knows what\nhash function is used by VM.</p>\n<p>What was done to fix it in V8/Node.js? Together with V8 team we added seeds to\nall hash tables used in V8, and made sure that they are randomized on the\nprocess start.</p>\n<h2 id=\"inspiration-for-an-experiment\" tabindex=\"-1\">Inspiration for an Experiment <a class=\"header-anchor\" href=\"https://darksi.de/f.v8-hash-seed-timing-attack/\">#</a></h2>\n<p>After reading this <a href=\"http://perl11.org/blog/seed.html\">Perl blog post</a> I thought that it would be funny to\ncarry out an actual hash seed extraction out of the live node.js process:\nfirst - locally within the process itself, second - from http server on the same\nmachine, third - remotely (no luck so far). Knowing the seed means being able\nto craft the collisions, and this gets us back to DoS problem.</p>\n<p>Numerous code paths in V8 have been tried, until I stumbled upon a\n<a href=\"https://github.com/v8/v8/blob/140d4df7954259e60a555efc0b2d00a9c924564c/src/objects-inl.h#L3140-L3157\">particular function</a>. There V8 puts a new property into an internal list\ncalled <code>DescriptorArray</code>. For performance reasons properties in that array\nmust be sorted, and since V8 extends the array - it has to shift all bigger\nproperties to the right to make space for the new one.</p>\n<p>By measuring timing of such insertions, attacker could figure out approximate\nposition of the inserted key. <code>DescriptorArray</code> holds no more than 18 keys, so\nit could be attempted to insert the same 17 keys and one random one many times,\nand infer the difference in timing to find the random keys that were placed\neither at the very end or at the start of the array.</p>\n<p>It's easier said than done, though. V8 has many layers of caching (which is one\nof the reasons why your JavaScript code is so fast!). In order to get\nthrough to that <code>DescriptorArray::Append</code> function, I had to outflank all of\nthem. In the end, the resulting program does everything in reverse - the random\nkey is inserted first, and then 17 predefined keys are inserted right after it.\nThe difference is non-obvious, but that's the part of the solution to skip all\nof the caches.</p>\n<p>This is how it looks:</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">pre<span class=\"token punctuation\">,</span> list</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">const</span> o <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span><br>  o<span class=\"token punctuation\">[</span>pre<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> list<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><br>    o<span class=\"token punctuation\">[</span>list<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">return</span> o<span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>Now this script has to create a <code>list</code> of keys, and a large number of probes\n(2093 strings that are passed one after another as <code>pre</code>). It can try each probe\nwith the same <code>list</code>, and measure the timing with <code>process.hrtime()</code> with\nnanosecond precision. Largertime difference means that the probe was inserted\nat the start of the <code>DescriptorArray</code>, and thus its hash value (32 bit number)\nis less than all hashes of the keys in the <code>list</code>. When the time delta is least</p>\n<ul>\n<li>probe was appended to the end of the <code>DescriptorArray</code>, meaning that its hash\nis the biggest in it.</li>\n</ul>\n<p>It may sound like not too much to stick to, but if one can collect enough such\n&quot;relations&quot; between the probe and keys - one can brute force all 32-bit seed\nvalues to find the one that gives the best approximation to this relation!\nIn fact, it takes just about 15 minutes on 20 core machine to do it, and this\ntime can be improved by using GPU (I dare you!).</p>\n<p>The most important part of brute forcing function is <code>check</code>:</p>\n<pre class=\"language-c\" tabindex=\"0\"><code class=\"language-c\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> <span class=\"token function\">check</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">uint32_t</span> seed<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">int</span> score<span class=\"token punctuation\">;</span><br>  <span class=\"token class-name\">uint32_t</span> key_hashes<span class=\"token punctuation\">[</span><span class=\"token function\">ARRAY_SIZE</span><span class=\"token punctuation\">(</span>keys<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><br><br>  score <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">size_t</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token function\">ARRAY_SIZE</span><span class=\"token punctuation\">(</span>keys<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    key_hashes<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">jenkins</span><span class=\"token punctuation\">(</span>keys<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> seed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span><br><br>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">size_t</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token function\">ARRAY_SIZE</span><span class=\"token punctuation\">(</span>probes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">+=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token class-name\">uint32_t</span> l<span class=\"token punctuation\">;</span><br>    <span class=\"token class-name\">uint32_t</span> r<span class=\"token punctuation\">;</span><br><br>    l <span class=\"token operator\">=</span> <span class=\"token function\">jenkins</span><span class=\"token punctuation\">(</span>probes<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> seed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    r <span class=\"token operator\">=</span> <span class=\"token function\">jenkins</span><span class=\"token punctuation\">(</span>probes<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> seed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">size_t</span> j <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> j <span class=\"token operator\">&lt;</span> <span class=\"token function\">ARRAY_SIZE</span><span class=\"token punctuation\">(</span>keys<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> j<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>l <span class=\"token operator\">&lt;</span> key_hashes<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><br>        score<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span><br>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key_hashes<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">&lt;=</span> r<span class=\"token punctuation\">)</span><br>        score<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br>  <span class=\"token punctuation\">}</span><br><br>  <span class=\"token keyword\">return</span> score<span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p><code>l</code> is a probe that supposedly has the lowest hash value in <code>DescriptorArray</code>,\n<code>r</code> is a probe that has the highest. So all in all, <code>brute.c</code> just searches for\nthe seed value that maximizes the result of <code>check</code>. Simple!</p>\n<h2 id=\"conclusions-and-code\" tabindex=\"-1\">Conclusions and code <a class=\"header-anchor\" href=\"https://darksi.de/f.v8-hash-seed-timing-attack/\">#</a></h2>\n<p>This works locally as a charm, and works with a <code>http.Server</code> on the same\nmachine to some extent. Unfortunately (or fortunately?) this attack doesn't work\nwith remote servers (or I wasn't able to execute it), even when the ping is\naround 1ms. The timing difference that we are looking for is about several\nmicroseconds, and it looks like it is smudged out in the network delay\ndistribution.</p>\n<p>V8 team is aware of this effort, and the decision is that this is not a security\ndefect - hence it is published here.</p>\n<p>All code is available on <a href=\"https://github.com/indutny/hash-cracker\">github</a>. Please enjoy with care!</p>\n",
			"date_published": "2017-01-19T00:00:00Z"
		}
		,
		{
			"id": "https://darksi.de/e.uv-link-t/",
			"url": "https://darksi.de/e.uv-link-t/",
			"title": "uv_link_t - libuv pipeline",
			"content_html": "<h2 id=\"preface\" tabindex=\"-1\">Preface <a class=\"header-anchor\" href=\"https://darksi.de/e.uv-link-t/\">#</a></h2>\n<p>Writing servers/clients in C could be non-trivial. Even with the help of such\npowerful (and awesome dinosaur) libraries as <a href=\"https://github.com/libuv/libuv\">libuv</a>, it still takes lots of\neffort and boilerplate code to create real world applications.</p>\n<p>Some of this boilerplate code comes from the use of the widespread protocols\nlike TLS (SSL) and HTTP. While there are popular implementations available\nas an Open Source libraries (<a href=\"https://github.com/openssl/openssl\">OpenSSL</a>, <a href=\"https://github.com/nodejs/http-parser\">http-parser</a>), they still either\nprovide very abstract interface (like <a href=\"https://github.com/nodejs/http-parser\">http-parser</a>), or an API to transfer\nthe responsibility of the networking to the library itself (like <code>SSL_set_fd()</code>\nin <a href=\"https://github.com/openssl/openssl\">OpenSSL</a> and Amazon's <a href=\"https://github.com/awslabs/s2n\">s2n</a>). Such abstract nature makes them easier\nto embed, but the adaptor code inevitably tend to appear in the particular\napplications.</p>\n<h2 id=\"precursor-streambase\" tabindex=\"-1\">Precursor - StreamBase <a class=\"header-anchor\" href=\"https://darksi.de/e.uv-link-t/\">#</a></h2>\n<p><a href=\"https://github.com/libuv/libuv\">libuv</a> is hardly an exception, and <a href=\"https://github.com/nodejs/node/blob/master/src/tls_wrap.cc\">node.js</a> and <a href=\"https://github.com/indutny/bud/blob/master/src/client.c\">bud</a>'s TLS\nimplementation is a vivid evidence of this. However, in a contrast to <a href=\"https://github.com/indutny/bud/blob/master/src/client.c\">bud</a>,\n<a href=\"https://github.com/nodejs/node/blob/master/src/tls_wrap.cc\">node.js</a> TLS code lives off on an abstraction called <a href=\"https://github.com/nodejs/node/blob/master/src/stream_base.h\">StreamBase</a>. By\nseparating <a href=\"https://github.com/libuv/libuv\">libuv</a>-specific adaptor code into a generic C++ class, we have\ncreated a foundation for a simpler and reusable implementation of any other\nprotocol! See, for example, recent <a href=\"https://github.com/nodejs/node/blob/29228c4089431d0e65749421f43aafd05694f376/src/node_http_parser.cc#L472-L486\">node_http_parser.cc</a> which uses only\na minor amount of power available through the means of <a href=\"https://github.com/nodejs/node/blob/master/src/stream_base.h\">StreamBase</a>, but\nnevertheless provides <a href=\"https://github.com/nodejs/node/pull/2355\">10-20%</a> performance improvement since its inception.</p>\n<p>This implementation has some major drawbacks, preventing its wider adoption\noutside of the node.js core:</p>\n<ul>\n<li>C++ headers: lots of virtual classes, complex API, non-trivial inheritance\nscheme</li>\n<li>High internal dependence on the node.js core itself</li>\n</ul>\n<p>Because of these issues (and my own limitations) <a href=\"https://github.com/nodejs/node/blob/master/src/stream_base.h\">StreamBase</a> has defied all\nattempts to make it public.</p>\n<h2 id=\"uv-link-t\" tabindex=\"-1\">uv_link_t <a class=\"header-anchor\" href=\"https://darksi.de/e.uv-link-t/\">#</a></h2>\n<p>Heavily inspired by the success of <a href=\"https://github.com/nodejs/node/blob/master/src/stream_base.h\">StreamBase</a> in the node.js core, a\n<a href=\"https://github.com/indutny/uv_link_t\">uv_link_t</a> library was created. It has lots of similarities with the\n<a href=\"https://github.com/nodejs/node/blob/master/src/stream_base.h\">StreamBase</a>, but it is:</p>\n<ul>\n<li>Implemented in C: self-documented structures, C-cast based inheritance, etc</li>\n<li>Standalone library</li>\n</ul>\n<p>The API is based on the <a href=\"http://docs.libuv.org/en/v1.x/stream.html\">uv_stream_t</a> and shouldn't come as a big surprise\nto the users, since <a href=\"https://github.com/indutny/uv_link_t\">uv_link_t</a> is intended to be used together with\n<a href=\"https://github.com/libuv/libuv\">libuv</a>.</p>\n<p>Here is a visual explanation of how <a href=\"https://github.com/libuv/libuv\">uv_link_t</a> works:</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/AoLNueYhpH-717.avif 717w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/AoLNueYhpH-717.webp 717w\"><img alt=\"uv_link_source_t\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/AoLNueYhpH-717.svg\" width=\"717\" height=\"205\"></picture></p>\n<h2 id=\"examples\" tabindex=\"-1\">Examples <a class=\"header-anchor\" href=\"https://darksi.de/e.uv-link-t/\">#</a></h2>\n<p>Before we take a peek at the APIs, let's discuss what can be done with\n<a href=\"https://github.com/indutny/uv_link_t\">uv_link_t</a>. Technically, any stream-based (i.e. anything that uses\n<code>uv_stream-t</code>) protocol can be implemented on top of it. Multiple protocols can\nbe chained together (that's why it is called <code>uv_</code><strong>link</strong><code>_t</code>!), provided that\nthere is an implementation:</p>\n<p><code>TCP &lt;-&gt; TLS &lt;-&gt; HTTP &lt;-&gt; WebSocket</code>.</p>\n<p>This chaining works in a pretty transparent way, and every segment of it can be\nobserved without disturbing the data flow and operation of the other links.</p>\n<p>Existing protocols:</p>\n<ul>\n<li><a href=\"https://github.com/indutny/uv_ssl_t\">uv_ssl_t</a> - TLS, based on OpenSSL's API</li>\n<li><a href=\"https://github.com/indutny/uv_http_t\">uv_http_t</a> - low-level HTTP/1.1 implementation, possibly incomplete</li>\n</ul>\n<p>Small demo-project:</p>\n<ul>\n<li><a href=\"https://github.com/indutny/file-shooter\">file-shooter</a> - dumb-simple HTTPS server based on both <a href=\"https://github.com/indutny/uv_ssl_t\">uv_ssl_t</a> and\n<a href=\"https://github.com/indutny/uv_http_t\">uv_http_t</a></li>\n</ul>\n<p>Note that all these projects, including <a href=\"https://github.com/indutny/uv_link_t\">uv_link_t</a> itself are supposed to\nbe built with a <a href=\"https://github.com/gypkg/gypkg\">gypkg</a>, which is a subject for a future blog post.</p>\n<h2 id=\"api\" tabindex=\"-1\">API <a class=\"header-anchor\" href=\"https://darksi.de/e.uv-link-t/\">#</a></h2>\n<p>The backbone of the API is a <code>uv_link_t</code> structure:</p>\n<pre class=\"language-c\" tabindex=\"0\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"uv_link_t.h\"</span></span><br><br><span class=\"token keyword\">static</span> <span class=\"token class-name\">uv_link_methods_t</span> methods <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token comment\">/* To be discussed below */</span><br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span><br><br><span class=\"token keyword\">void</span> <span class=\"token function\">_</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token class-name\">uv_link_t</span> link<span class=\"token punctuation\">;</span><br><br>  <span class=\"token function\">uv_link_init</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>link<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>methods<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token comment\">/* ... some operations */</span><br>  <span class=\"token function\">uv_link_close</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>link<span class=\"token punctuation\">,</span> close_cb<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>In the most of the cases a first link should be an <code>uv_link_source_t</code>. It\nconsumes an instance of <code>uv_stream_t</code>, and propagates reads and writes from\nthe whole chain of links connected to it.</p>\n<pre class=\"language-c\" tabindex=\"0\"><code class=\"language-c\"><span class=\"token class-name\">uv_link_source_t</span> source<span class=\"token punctuation\">;</span><br><br><span class=\"token class-name\">uv_stream_t</span><span class=\"token operator\">*</span> to_be_consumed<span class=\"token punctuation\">;</span><br><span class=\"token function\">uv_link_source_init</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>source<span class=\"token punctuation\">,</span> to_be_consumed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>As mentioned before, links can be chained together:</p>\n<pre class=\"language-c\" tabindex=\"0\"><code class=\"language-c\"><span class=\"token class-name\">uv_link_t</span> a<span class=\"token punctuation\">;</span><br><span class=\"token class-name\">uv_link_t</span> b<span class=\"token punctuation\">;</span><br><br><span class=\"token comment\">/* Initialize `a` and `b` */</span><br><span class=\"token function\">uv_link_chain</span><span class=\"token punctuation\">(</span><span class=\"token comment\">/* from */</span> a<span class=\"token punctuation\">,</span> <span class=\"token comment\">/* to */</span> b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>This <code>uv_link_chain</code> call means that the data emitted by <code>a</code> will be passed as\nan input to <code>b</code>, and the output of <code>b</code> will written to <code>a</code>.</p>\n<p>Speaking of input/output, the API is pretty similar to <a href=\"https://github.com/libuv/libuv\">libuv</a>'s:</p>\n<pre class=\"language-c\" tabindex=\"0\"><code class=\"language-c\"><span class=\"token keyword\">int</span> <span class=\"token function\">uv_link_write</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">uv_link_t</span><span class=\"token operator\">*</span> link<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token class-name\">uv_buf_t</span> bufs<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><br>                  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> nbufs<span class=\"token punctuation\">,</span> <span class=\"token class-name\">uv_stream_t</span><span class=\"token operator\">*</span> send_handle<span class=\"token punctuation\">,</span><br>                  uv_link_write_cb cb<span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br><span class=\"token keyword\">int</span> <span class=\"token function\">uv_link_read_start</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">uv_link_t</span><span class=\"token operator\">*</span> link<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token keyword\">int</span> <span class=\"token function\">uv_link_read_stop</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">uv_link_t</span><span class=\"token operator\">*</span> link<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br><span class=\"token keyword\">void</span> <span class=\"token function\">fn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  link<span class=\"token operator\">-></span>alloc_cb <span class=\"token operator\">=</span> <span class=\"token comment\">/* something */</span><span class=\"token punctuation\">;</span><br>  link<span class=\"token operator\">-></span>read_cb <span class=\"token operator\">=</span> <span class=\"token comment\">/* something */</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>Please check the <a href=\"https://github.com/indutny/uv_link_t/blob/master/docs/api.md\">API docs</a> for further information on particular methods\nand structures (likes <code>uv_link_source_t</code> and <code>uv_link_observer_t</code>).</p>\n<p>There is also an <a href=\"https://github.com/indutny/uv_link_t/blob/master/docs/implementation-guide.md\">Implementation guide</a> for implementing custom types of\n<code>uv_link_t</code>.</p>\n<h2 id=\"error-reporting\" tabindex=\"-1\">Error reporting <a class=\"header-anchor\" href=\"https://darksi.de/e.uv-link-t/\">#</a></h2>\n<p>Having multiple independent implementations of <code>uv_link_t</code> interface, it is a\nnatural question to ask: how does <code>uv_link_t</code> handle error code conflict?</p>\n<p>The answer is that all error codes returned by <code>uv_link_...</code> methods are\nactually prefixed with the index of the particular link in a chain. Thus, even\nif there are several similar links in a chain, it is possible to get the pointer\nto the <code>uv_link_t</code> instance that have emitted it:</p>\n<pre class=\"language-c\" tabindex=\"0\"><code class=\"language-c\"><span class=\"token keyword\">int</span> <span class=\"token function\">uv_link_errno</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">uv_link_t</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span> link<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> <span class=\"token function\">uv_link_strerror</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">uv_link_t</span><span class=\"token operator\">*</span> link<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<h2 id=\"foreword-gypkg\" tabindex=\"-1\">Foreword: gypkg <a class=\"header-anchor\" href=\"https://darksi.de/e.uv-link-t/\">#</a></h2>\n<p><a href=\"https://github.com/gypkg/gypkg\">gypkg</a> is recommended to be used when embedding <code>uv_link_t</code> in the C\nproject. There are not too many source files to put into a <code>Makefile</code> or some\nother build file, but the convenience that <a href=\"https://github.com/gypkg/gypkg\">gypkg</a> provides, pays off very\nquickly!</p>\n<h3 id=\"installation-node-js-v6-is-required\" tabindex=\"-1\">Installation (node.js v6 is required): <a class=\"header-anchor\" href=\"https://darksi.de/e.uv-link-t/\">#</a></h3>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-g</span> gypkg</code></pre>\n<h3 id=\"init\" tabindex=\"-1\">Init <a class=\"header-anchor\" href=\"https://darksi.de/e.uv-link-t/\">#</a></h3>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\"><span class=\"token function\">mkdir</span> project<br><span class=\"token builtin class-name\">cd</span> project<br>gypkg init</code></pre>\n<h3 id=\"adding-uv-link-t-as-a-dependency\" tabindex=\"-1\">Adding <code>uv_link_t</code> as a dependency <a class=\"header-anchor\" href=\"https://darksi.de/e.uv-link-t/\">#</a></h3>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\"><span class=\"token function\">vim</span> project.gyp</code></pre>\n<pre class=\"language-python\" tabindex=\"0\"><code class=\"language-python\"><span class=\"token punctuation\">{</span><br>  <span class=\"token string\">\"variables\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token string\">\"gypkg_deps\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><br>      <span class=\"token string\">\"git://github.com/libuv/libuv.git@^1.9.0 => uv.gyp:libuv\"</span><span class=\"token punctuation\">,</span><br>      <span class=\"token string\">\"git://github.com/indutny/uv_link_t@^1.0.0 [gpg] => uv_link_t.gyp:uv_link_t\"</span><span class=\"token punctuation\">,</span><br>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br><br>  <span class=\"token comment\"># Some other GYP things</span><br><span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"building\" tabindex=\"-1\">Building <a class=\"header-anchor\" href=\"https://darksi.de/e.uv-link-t/\">#</a></h3>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\">gypkg build<br><span class=\"token function\">ls</span> <span class=\"token parameter variable\">-la</span> out/Release</code></pre>\n",
			"date_published": "2016-08-15T00:00:00Z"
		}
		,
		{
			"id": "https://darksi.de/d.sea-of-nodes/",
			"url": "https://darksi.de/d.sea-of-nodes/",
			"title": "Sea of Nodes",
			"content_html": "<h2 id=\"brief-intro\" tabindex=\"-1\">Brief intro <a class=\"header-anchor\" href=\"https://darksi.de/d.sea-of-nodes/\">#</a></h2>\n<p>This post is going to be about the sea-of-nodes compiler concept that I have\nrecently learned.</p>\n<p>While it is not completely necessary, it may be useful to take a peek at the\nsome of my previous posts on JIT-compilers before reading this:</p>\n<ul>\n<li><a href=\"https://darksi.de/4.how-to-start-jitting\">How to start JIT-ting</a></li>\n<li><a href=\"https://darksi.de/5.allocating-numbers\">Allocating numbers</a></li>\n<li><a href=\"https://darksi.de/6.smis-and-doubles\">SMIs and Doubles</a></li>\n<li><a href=\"https://darksi.de/a.deoptimize-me-not\">Deoptimize me not, v8</a></li>\n</ul>\n<h2 id=\"compilers-translators\" tabindex=\"-1\">Compilers = translators <a class=\"header-anchor\" href=\"https://darksi.de/d.sea-of-nodes/\">#</a></h2>\n<p>Compilers are something that every Software Engineer uses several times a day.\nSurprisingly even people who consider themselves to be far from writing the\ncode, still use a compiler quite heavily throughout their day. This is\nbecause most of the web depends on client-side code execution, and many of such\nclient-side programs are passed to the browser in a form of the source code.</p>\n<p>Here we come to an important thing: while source code is (usually)\nhuman-readable, it looks like complete garbage to your\nlaptop/computer/phone/...'s CPU. On other hand, machine code, that computers\n<strong>can</strong> read, is (almost always) not human-readable. Something should be done\nabout it, and the solution to this problem is provided by the process called\n<strong>translation</strong>.</p>\n<p>Trivial compilers perform a single pass of <em>translation</em>: from the source code\nto the machine code. However, in practice most compilers do at least two passes:\nfrom the source code to <a href=\"https://en.wikipedia.org/wiki/Abstract_syntax_tree\">Abstract Syntax Tree</a> (AST), and from <a href=\"https://en.wikipedia.org/wiki/Abstract_syntax_tree\">AST</a> to\nmachine code. <a href=\"https://en.wikipedia.org/wiki/Abstract_syntax_tree\">AST</a> in this case acts like an <em>Intermediate Representation</em>\n(IR), and as the name suggests, <a href=\"https://en.wikipedia.org/wiki/Abstract_syntax_tree\">AST</a> is just another form of the same source\ncode. These intermediate representations chain together and essentially are\nnothing else but the abstraction layers.</p>\n<p>There is no limit on the layer count. Each new layer brings the source program\ncloser to how it will look like in machine code.</p>\n<h2 id=\"optimization-layers\" tabindex=\"-1\">Optimization layers <a class=\"header-anchor\" href=\"https://darksi.de/d.sea-of-nodes/\">#</a></h2>\n<p>However, not all layers are used solely for translation. Many compilers also\nadditionally attempt to optimize the human-written code. (Which is usually\nwritten to have a balance between code elegance and code performance).</p>\n<p>Take the following JavaScript code, for example:</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\"><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> acc <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> arr<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><br>  acc <span class=\"token operator\">+=</span> arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre>\n<p>If the compiler would translate it to the machine code straight out of <a href=\"https://en.wikipedia.org/wiki/Abstract_syntax_tree\">AST</a>,\nit may resemble (in very abstract and detached from reality instruction set):</p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">acc = 0;<br>i = 0;<br>loop {<br>  // Load `.length` field of arr<br>  tmp = loadArrayLength(arr);<br>  if (i >= tmp)<br>    break;<br><br>  // Check that `i` is between 0 and `arr.length`<br>  // (NOTE: This is necessary for fast loads and<br>  // stores).<br>  checkIndex(arr, i);<br><br>  // Load value<br>  acc += load(arr, i);<br><br>  // Increment index<br>  i += 1;<br>}</code></pre>\n<p>It may not be obvious, but this code is far from optimal. Array length does not\nreally change inside of the loop, and the range checks are not necessary at all.\nIdeally, it should look like this:</p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">acc = 0;<br>i = 0;<br>len = loadArrayLength(arr);<br>loop {<br>  if (i >= tmp)<br>    break;<br><br>  acc += load(arr, i);<br>  i += 1;<br>}</code></pre>\n<p>Let's try to imagine how we could do this.</p>\n<p>Suppose we have an <a href=\"https://en.wikipedia.org/wiki/Abstract_syntax_tree\">AST</a> at hand, and we try to generate the machine code\nstraight out of it:</p>\n<p><em>(NOTE: Generated with <a href=\"https://github.com/jquery/esprima\">esprima</a>)</em></p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'ForStatement'</span><span class=\"token punctuation\">,</span><br><br>  <span class=\"token comment\">//</span><br>  <span class=\"token comment\">// This is `var i = 0;`</span><br>  <span class=\"token comment\">//</span><br>  <span class=\"token literal-property property\">init</span><span class=\"token operator\">:</span><br>   <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'VariableDeclaration'</span><span class=\"token punctuation\">,</span><br>     <span class=\"token literal-property property\">declarations</span><span class=\"token operator\">:</span><br>      <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'VariableDeclarator'</span><span class=\"token punctuation\">,</span><br>          <span class=\"token literal-property property\">id</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'Identifier'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'i'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br>          <span class=\"token literal-property property\">init</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'Literal'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">raw</span><span class=\"token operator\">:</span> <span class=\"token string\">'0'</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br>        <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'VariableDeclarator'</span><span class=\"token punctuation\">,</span><br>          <span class=\"token literal-property property\">id</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'Identifier'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'acc'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br>          <span class=\"token literal-property property\">init</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'Literal'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">raw</span><span class=\"token operator\">:</span> <span class=\"token string\">'0'</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><br>     <span class=\"token literal-property property\">kind</span><span class=\"token operator\">:</span> <span class=\"token string\">'var'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br><br>  <span class=\"token comment\">//</span><br>  <span class=\"token comment\">// `i &lt; arr.length`</span><br>  <span class=\"token comment\">//</span><br>  <span class=\"token literal-property property\">test</span><span class=\"token operator\">:</span><br>   <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'BinaryExpression'</span><span class=\"token punctuation\">,</span><br>     <span class=\"token literal-property property\">operator</span><span class=\"token operator\">:</span> <span class=\"token string\">'&lt;'</span><span class=\"token punctuation\">,</span><br>     <span class=\"token literal-property property\">left</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'Identifier'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'i'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br>     <span class=\"token literal-property property\">right</span><span class=\"token operator\">:</span><br>      <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'MemberExpression'</span><span class=\"token punctuation\">,</span><br>        <span class=\"token literal-property property\">computed</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span><br>        <span class=\"token literal-property property\">object</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'Identifier'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'arr'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br>        <span class=\"token literal-property property\">property</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'Identifier'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'length'</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br><br>  <span class=\"token comment\">//</span><br>  <span class=\"token comment\">// `i++`</span><br>  <span class=\"token comment\">//</span><br>  <span class=\"token literal-property property\">update</span><span class=\"token operator\">:</span><br>   <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'UpdateExpression'</span><span class=\"token punctuation\">,</span><br>     <span class=\"token literal-property property\">operator</span><span class=\"token operator\">:</span> <span class=\"token string\">'++'</span><span class=\"token punctuation\">,</span><br>     <span class=\"token literal-property property\">argument</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'Identifier'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'i'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br>     <span class=\"token literal-property property\">prefix</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br><br>  <span class=\"token comment\">//</span><br>  <span class=\"token comment\">// `arr[i] += 1;`</span><br>  <span class=\"token comment\">//</span><br>  <span class=\"token literal-property property\">body</span><span class=\"token operator\">:</span><br>   <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'ExpressionStatement'</span><span class=\"token punctuation\">,</span><br>     <span class=\"token literal-property property\">expression</span><span class=\"token operator\">:</span><br>      <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'AssignmentExpression'</span><span class=\"token punctuation\">,</span><br>        <span class=\"token literal-property property\">operator</span><span class=\"token operator\">:</span> <span class=\"token string\">'+='</span><span class=\"token punctuation\">,</span><br>        <span class=\"token literal-property property\">left</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'Identifier'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'acc'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br>        <span class=\"token literal-property property\">right</span><span class=\"token operator\">:</span><br>         <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'MemberExpression'</span><span class=\"token punctuation\">,</span><br>           <span class=\"token literal-property property\">computed</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span><br>           <span class=\"token literal-property property\">object</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'Identifier'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'arr'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br>           <span class=\"token literal-property property\">property</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'Identifier'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'i'</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span></code></pre>\n<p>This JSON could also be visualized:\n<picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/m5iVXXukxl-1170.avif 1170w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/m5iVXXukxl-1170.webp 1170w\"><img alt=\"AST\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/m5iVXXukxl-1170.svg\" width=\"1170\" height=\"556\"></picture></p>\n<p>This is a tree, so it is very natural to traverse it from the top to the bottom,\ngenerating the machine code as we visit the AST nodes. The problem with this\napproach is that the information about variables is very sparse, and is spread\nthrough the different tree nodes.</p>\n<p>Again, to safely move the length lookup out of the loop we need to know that the\narray length does not change between the loop's iterations. Humans can do it\neasily just by looking at the source code, but the compiler needs to do quite a\nlot of work to confidently extract those facts directly from the AST.</p>\n<p>Like many other compiler problems, this is often solved by lifting the data into\na more appropriate abstraction layer, i.e. intermediate representation. In this\nparticular case that choice of IR is known as a data-flow graph (DFG). Instead\nof talking about syntax-entities (like <code>for loop</code>s, <code>expressions</code>, ...), we\nshould talk about the data itself (read, variables values), and how it changes\nthrough the program.</p>\n<h2 id=\"data-flow-graph\" tabindex=\"-1\">Data-flow Graph <a class=\"header-anchor\" href=\"https://darksi.de/d.sea-of-nodes/\">#</a></h2>\n<p>In our particular example, the data we are interested in is the value of\nvariable <code>arr</code>. We want to be able to easily observe all uses of it to verify\nthat there are no out-of-bounds accesses or any other change that would modify\nthe length of the array.</p>\n<p>This is accomplished by introducing &quot;def-use&quot; (definition and uses) relationship\nbetween the different data values. Concretely, it means that the value has been\ndeclared once (<em>node</em>), and that it has been used somewhere to create new values\n(<em>edge</em> for every use). Obviously, connecting different values together will\nform a <strong>data-flow graph</strong> like this:</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/Q8URzKczR8-681.avif 681w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/Q8URzKczR8-681.webp 681w\"><img alt=\"Data-flow Graph\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/Q8URzKczR8-681.svg\" width=\"681\" height=\"647\"></picture></p>\n<p>Note the red <code>array</code> box in this vast graph. The solid arrows going out of it\nrepresent uses of this value. By iterating over those edges, the compiler can\nderive that the value of <code>array</code> is used at:</p>\n<ul>\n<li><code>loadArrayLength</code></li>\n<li><code>checkIndex</code></li>\n<li><code>load</code></li>\n</ul>\n<p>Such graphs are constructed in the way that explicitly &quot;clones&quot; the array node,\nif its value was accessed in a destructive manner (i.e. stores, length sizes).\nWhenever we see <code>array</code> node and observe its uses - we are always certain that\nits value does not change.</p>\n<p>It may sound complicated, but this property of the graph is quite easy to\nachieve. The graph should follow <a href=\"https://en.wikipedia.org/wiki/Static_single_assignment_form\">Single Static Assignment</a> (SSA) rules.\nIn short, to convert any program to <a href=\"https://en.wikipedia.org/wiki/Static_single_assignment_form\">SSA</a> the compiler needs to rename all\nassignments and later uses of the variables, to make sure that each variable is\nassigned only once.</p>\n<p>Example, before SSA:</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> a <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>a <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>After SSA:</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> a0 <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>a0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token keyword\">var</span> a1 <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>a1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>This way, we can be sure that when we are talking about <code>a0</code> - we are actually\ntalking about a single assignment to it. This is really close to how people do\nthings in the functional languages!</p>\n<p>Seeing that <code>loadArrayLength</code> has no control dependency (i.e. no dashed lines;\nwe will talk about them in a bit), compiler may conclude that this node is free\nto move anywhere it wants to be and can be placed outside of the loop.\nBy going through the graph further, we may observe that the value of <code>ssa:phi</code>\nnode is always between <code>0</code> and <code>arr.length</code>, so the <code>checkIndex</code> may be removed\naltogether.</p>\n<p>Pretty neat, isn't it?</p>\n<h2 id=\"control-flow-graph\" tabindex=\"-1\">Control Flow Graph <a class=\"header-anchor\" href=\"https://darksi.de/d.sea-of-nodes/\">#</a></h2>\n<p>We just used some form of <a href=\"https://en.wikipedia.org/wiki/Data-flow_analysis\">data-flow analysis</a> to extract information from\nthe program. This allows us to make safe assumptions about how it could be\noptimized.</p>\n<p>This <em>data-flow representation</em> is very useful in many other cases too. The only\nproblem is that by turning our code into this kind of graph, we made a step\nbackwards in our representation chain (from the source code to the machine\ncode). This intermediate representation is less suitable for generating machine\ncode than even the AST.</p>\n<p>The reason is that the machine is just a sequential list of instructions, which\nthe CPU executes one-after-another. Our resulting graph doesn't appear to\nconvey that. In fact, there is no enforced ordering in it at all.</p>\n<p>Usually, this is solved by grouping the graph nodes into blocks. This\nrepresentation is known as a <a href=\"https://en.wikipedia.org/wiki/Control_flow_graph\">Control Flow Graph</a> (CFG). Example:</p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">b0 {<br>  i0 = literal 0<br>  i1 = literal 0<br><br>  i3 = array<br>  i4 = jump ^b0<br>}<br>b0 -> b1<br><br>b1 {<br>  i5 = ssa:phi ^b1 i0, i12<br>  i6 = ssa:phi ^i5, i1, i14<br><br>  i7 = loadArrayLength i3<br>  i8 = cmp \"&lt;\", i6, i7<br>  i9 = if ^i6, i8<br>}<br>b1 -> b2, b3<br>b2 {<br>  i10 = checkIndex ^b2, i3, i6<br>  i11 = load ^i10, i3, i6<br>  i12 = add i5, i11<br>  i13 = literal 1<br>  i14 = add i6, i13<br>  i15 = jump ^b2<br>}<br>b2 -> b1<br><br>b3 {<br>  i16 = exit ^b3<br>}</code></pre>\n<p>It is called a graph not without the reason. For example, the <code>bXX</code> blocks\nrepresent nodes, and the <code>bXX -&gt; bYY</code> arrows represent edges. Let's visualize\nit:</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/sfOWjQef2W-134.avif 134w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/sfOWjQef2W-134.webp 134w\"><img alt=\"CFG\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/sfOWjQef2W-134.svg\" width=\"134\" height=\"260\"></picture></p>\n<p>As you can see, there is code before the loop in block <code>b0</code>, loop header in\n<code>b1</code>, loop test in <code>b2</code>, loop body in <code>b3</code>, and exit node in <code>b4</code>.</p>\n<p>Translation to machine code is very easy from this form. We just replace <code>iXX</code>\nidentifiers with CPU register names (in some sense, CPU registers are sort of\nvariables, the CPU has a limited amount of registers, so we need to be careful\nto not run out of them), and generating machine code for each instruction,\nline-by-line.</p>\n<p>To recap, <a href=\"https://en.wikipedia.org/wiki/Control_flow_graph\">CFG</a> has data-flow relations and also ordering. This allows us to\nutilize it for both data-flow analysis and machine code generation. However,\nattempting to optimize the CFG, by manipulating the blocks and their contents\ncontained within it, can quickly become complex and error-prone.</p>\n<p>Instead, Clifford Click and Keith D. Cooper proposed to use an approach\ncalled <a href=\"http://www.researchgate.net/profile/Cliff_Click/publication/2394127_Combining_Analyses_Combining_Optimizations/links/0a85e537233956f6dd000000.pdf\"><strong>sea-of-nodes</strong></a>, the very topic of this blog post!</p>\n<h2 id=\"sea-of-nodes\" tabindex=\"-1\">Sea-of-Nodes <a class=\"header-anchor\" href=\"https://darksi.de/d.sea-of-nodes/\">#</a></h2>\n<p>Remember our fancy data-flow graph with dashed lines? Those dashed-lines are\nactually what make that graph a <strong>sea-of-nodes</strong> graph.</p>\n<p>Instead of grouping nodes in blocks and ordering them, we choose to declare the\ncontrol dependencies as the dashed edges in a graph. If we will take that graph,\nremove everything <strong>non-dashed</strong>, and group things a bit we will get:</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/fm8maclA7P-448.avif 448w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/fm8maclA7P-448.webp 448w\"><img alt=\"Control-flow part of Sea-of-Nodes\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/fm8maclA7P-448.svg\" width=\"448\" height=\"921\"></picture></p>\n<p>With a bit of imagination and node reordering, we can see that this graph is the\nsame as the simplified CFG graphs that we have just seen above:</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/sfOWjQef2W-134.avif 134w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/sfOWjQef2W-134.webp 134w\"><img alt=\"CFG\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/sfOWjQef2W-134.svg\" width=\"134\" height=\"260\"></picture></p>\n<p>Let's take another look at the <strong>sea-of-nodes</strong> representation:</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/Q8URzKczR8-681.avif 681w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/Q8URzKczR8-681.webp 681w\"><img alt=\"Sea-of-Nodes\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/Q8URzKczR8-681.svg\" width=\"681\" height=\"647\"></picture></p>\n<p>The striking difference between this graph and CFG is that there is no ordering\nof the nodes, except the ones that have control dependencies (in other words,\nthe nodes participating in the control flow).</p>\n<p>This representation is very powerful way to look at the code. It has all\ninsights of the general data-flow graph, and could be changed easily without\nconstantly removing/replacing nodes in the blocks.</p>\n<h2 id=\"reductions\" tabindex=\"-1\">Reductions <a class=\"header-anchor\" href=\"https://darksi.de/d.sea-of-nodes/\">#</a></h2>\n<p>Speaking of changes, let's discuss the way to modify the graph. The sea-of-nodes\ngraph is usually modified by doing graph reductions. We just queue all nodes in\nthe graph. Invoke our reduction function for every node in the queue. Everything\nthat this function touches (changes, replaces) is queued back, and will be\npassed to the function later on. If you have many reductions, you can just stack\nthem up together and invoke all of them on each node in the queue, or\nalternatively, you can just apply them one after another, if they depend on the\nfinal state of each other. It works like a charm!</p>\n<p>I have written a JavaScript toolset for my sea-of-nodes experiments, which\nincludes:</p>\n<ul>\n<li><a href=\"https://github.com/indutny/json-pipeline\">json-pipeline</a> - the builder and stdlib of the graph. Provides methods\nto create nodes, add inputs to them, change their control dependencies, and\nexport/import the graph to/from the printable data!</li>\n<li><a href=\"https://github.com/indutny/json-pipeline-reducer\">json-pipeline-reducer</a> - the reductions engine. Just create a reducer\ninstance, feed it several reduction functions, and execute the reducer on the\nexisting <a href=\"https://github.com/indutny/json-pipeline\">json-pipeline</a> graph.</li>\n<li><a href=\"https://github.com/indutny/json-pipeline-scheduler\">json-pipeline-scheduler</a> - library for putting back unordered graph in a\nlimited amount of blocks connected to each other by control edges (dashed\nlines).</li>\n</ul>\n<p>Combined together, these tools can solve many problems that could be formulated\nin terms of data-flow equations.</p>\n<p>Example of reduction, which will optimize our initial JS code:</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\"><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> acc <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> arr<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><br>  acc <span class=\"token operator\">+=</span> arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre>\n<h3 id=\"tl-dr\" tabindex=\"-1\">TL;DR <a class=\"header-anchor\" href=\"https://darksi.de/d.sea-of-nodes/\">#</a></h3>\n<p>This code chunk is quite big, so if you want to skip it - here are the notes of\nwhat we will do below:</p>\n<ul>\n<li>Compute integer ranges of various nodes: literal, add, phi</li>\n<li>Compute limits that apply to branch's body</li>\n<li>Apply range and limit information (<code>i</code> is always a non-negative number limited\nby <code>arr.length</code>) to conclude that length check is not necessary and can be\nremoved</li>\n<li><code>arr.length</code> will be moved out of the loop automatically by\n<code>json-pipeline-scheduler</code>. This is because it does <a href=\"https://courses.cs.washington.edu/courses/cse501/04wi/papers/click-pldi95.pdf\">Global Code Motion</a> to\nschedule nodes in blocks.</li>\n</ul>\n<pre class=\"language-js\" tabindex=\"0\"><code class=\"language-js\"><span class=\"token comment\">// Just for viewing graphviz output</span><br><span class=\"token keyword\">var</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br><span class=\"token keyword\">var</span> Pipeline <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'json-pipeline'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token keyword\">var</span> Reducer <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'json-pipeline-reducer'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token keyword\">var</span> Scheduler <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'json-pipeline-scheduler'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br><span class=\"token comment\">//</span><br><span class=\"token comment\">// Create empty graph with CFG convenience</span><br><span class=\"token comment\">// methods.</span><br><span class=\"token comment\">//</span><br><span class=\"token keyword\">var</span> p <span class=\"token operator\">=</span> Pipeline<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">'cfg'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br><span class=\"token comment\">//</span><br><span class=\"token comment\">// Parse the printable data and generate</span><br><span class=\"token comment\">// the graph.</span><br><span class=\"token comment\">//</span><br>p<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">pipeline {<br>  b0 {<br>    i0 = literal 0<br>    i1 = literal 0<br><br>    i3 = array<br>    i4 = jump ^b0<br>  }<br>  b0 -> b1<br><br>  b1 {<br>    i5 = ssa:phi ^b1 i0, i12<br>    i6 = ssa:phi ^i5, i1, i14<br><br>    i7 = loadArrayLength i3<br>    i8 = cmp \"&lt;\", i6, i7<br>    i9 = if ^i6, i8<br>  }<br>  b1 -> b2, b3<br>  b2 {<br>    i10 = checkIndex ^b2, i3, i6<br>    i11 = load ^i10, i3, i6<br>    i12 = add i5, i11<br>    i13 = literal 1<br>    i14 = add i6, i13<br>    i15 = jump ^b2<br>  }<br>  b2 -> b1<br><br>  b3 {<br>    i16 = exit ^b3<br>  }<br>}</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">cfg</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'printable'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">DEBUG</span><span class=\"token punctuation\">)</span><br>  fs<span class=\"token punctuation\">.</span><span class=\"token function\">writeFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'before.gv'</span><span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token string\">'graphviz'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br><span class=\"token comment\">//</span><br><span class=\"token comment\">// Just a helper to run reductions</span><br><span class=\"token comment\">//</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">graph<span class=\"token punctuation\">,</span> reduction</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">var</span> reducer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Reducer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  reducer<span class=\"token punctuation\">.</span><span class=\"token function\">addReduction</span><span class=\"token punctuation\">(</span>reduction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  reducer<span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span>graph<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br><span class=\"token punctuation\">}</span><br><br><span class=\"token comment\">//</span><br><span class=\"token comment\">// Create reduction</span><br><span class=\"token comment\">//</span><br><span class=\"token keyword\">var</span> ranges <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">getRange</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ranges<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">return</span> ranges<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">var</span> range <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">from</span><span class=\"token operator\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">Infinity</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">to</span><span class=\"token operator\">:</span> <span class=\"token operator\">+</span><span class=\"token number\">Infinity</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'any'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span><br>  ranges<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">,</span> range<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">return</span> range<span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">updateRange</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node<span class=\"token punctuation\">,</span> reducer<span class=\"token punctuation\">,</span> from<span class=\"token punctuation\">,</span> to</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">var</span> range <span class=\"token operator\">=</span> <span class=\"token function\">getRange</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token comment\">// Lowest type, can't get upwards</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>range<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>range<span class=\"token punctuation\">.</span>from <span class=\"token operator\">===</span> from <span class=\"token operator\">&amp;&amp;</span> range<span class=\"token punctuation\">.</span>to <span class=\"token operator\">===</span> to <span class=\"token operator\">&amp;&amp;</span> range<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'int'</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span><br><br>  range<span class=\"token punctuation\">.</span>from <span class=\"token operator\">=</span> from<span class=\"token punctuation\">;</span><br>  range<span class=\"token punctuation\">.</span>to <span class=\"token operator\">=</span> to<span class=\"token punctuation\">;</span><br>  range<span class=\"token punctuation\">.</span>type <span class=\"token operator\">=</span> <span class=\"token string\">'int'</span><span class=\"token punctuation\">;</span><br>  reducer<span class=\"token punctuation\">.</span><span class=\"token function\">change</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">updateType</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node<span class=\"token punctuation\">,</span> reducer<span class=\"token punctuation\">,</span> type</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">var</span> range <span class=\"token operator\">=</span> <span class=\"token function\">getRange</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>range<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> type<span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span><br><br>  range<span class=\"token punctuation\">.</span>type <span class=\"token operator\">=</span> type<span class=\"token punctuation\">;</span><br>  reducer<span class=\"token punctuation\">.</span><span class=\"token function\">change</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token comment\">//</span><br><span class=\"token comment\">// Set type of literal</span><br><span class=\"token comment\">//</span><br><span class=\"token keyword\">function</span> <span class=\"token function\">reduceLiteral</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node<span class=\"token punctuation\">,</span> reducer</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">var</span> value <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>literals<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><br>  <span class=\"token function\">updateRange</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">,</span> reducer<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">reduceBinary</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node<span class=\"token punctuation\">,</span> left<span class=\"token punctuation\">,</span> right<span class=\"token punctuation\">,</span> reducer</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>left<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'none'</span> <span class=\"token operator\">||</span> right<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token function\">updateType</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">,</span> reducer<span class=\"token punctuation\">,</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span><br><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>left<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'int'</span> <span class=\"token operator\">||</span> right<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'int'</span><span class=\"token punctuation\">)</span><br>    <span class=\"token function\">updateType</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">,</span> reducer<span class=\"token punctuation\">,</span> <span class=\"token string\">'int'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>left<span class=\"token punctuation\">.</span>type <span class=\"token operator\">!==</span> <span class=\"token string\">'int'</span> <span class=\"token operator\">||</span> right<span class=\"token punctuation\">.</span>type <span class=\"token operator\">!==</span> <span class=\"token string\">'int'</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token comment\">//</span><br><span class=\"token comment\">// Just join the ranges of inputs</span><br><span class=\"token comment\">//</span><br><span class=\"token keyword\">function</span> <span class=\"token function\">reducePhi</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node<span class=\"token punctuation\">,</span> reducer</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">var</span> left <span class=\"token operator\">=</span> <span class=\"token function\">getRange</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>inputs<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">var</span> right <span class=\"token operator\">=</span> <span class=\"token function\">getRange</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>inputs<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">reduceBinary</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">,</span> left<span class=\"token punctuation\">,</span> right<span class=\"token punctuation\">,</span> reducer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>inputs<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>opcode <span class=\"token operator\">!==</span> <span class=\"token string\">'add'</span> <span class=\"token operator\">||</span> left<span class=\"token punctuation\">.</span>from <span class=\"token operator\">!==</span> left<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">var</span> from <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>left<span class=\"token punctuation\">.</span>from<span class=\"token punctuation\">,</span> right<span class=\"token punctuation\">.</span>from<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">var</span> to <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>left<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">,</span> right<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token function\">updateRange</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">,</span> reducer<span class=\"token punctuation\">,</span> from<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token comment\">//</span><br><span class=\"token comment\">// Detect: phi = phi + &lt;positive number>, where initial phi is number,</span><br><span class=\"token comment\">// report proper range.</span><br><span class=\"token comment\">//</span><br><span class=\"token keyword\">function</span> <span class=\"token function\">reduceAdd</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node<span class=\"token punctuation\">,</span> reducer</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">var</span> left <span class=\"token operator\">=</span> <span class=\"token function\">getRange</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>inputs<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">var</span> right <span class=\"token operator\">=</span> <span class=\"token function\">getRange</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>inputs<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">reduceBinary</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">,</span> left<span class=\"token punctuation\">,</span> right<span class=\"token punctuation\">,</span> reducer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">var</span> phi <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>inputs<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>phi<span class=\"token punctuation\">.</span>opcode <span class=\"token operator\">!==</span> <span class=\"token string\">'ssa:phi'</span> <span class=\"token operator\">||</span> right<span class=\"token punctuation\">.</span>from <span class=\"token operator\">!==</span> right<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">var</span> number <span class=\"token operator\">=</span> right<span class=\"token punctuation\">.</span>from<span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>number <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> phi<span class=\"token punctuation\">.</span>inputs<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!==</span> node<span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">var</span> initial <span class=\"token operator\">=</span> <span class=\"token function\">getRange</span><span class=\"token punctuation\">(</span>phi<span class=\"token punctuation\">.</span>inputs<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>initial<span class=\"token punctuation\">.</span>type <span class=\"token operator\">!==</span> <span class=\"token string\">'int'</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token function\">updateRange</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">,</span> reducer<span class=\"token punctuation\">,</span> initial<span class=\"token punctuation\">.</span>from<span class=\"token punctuation\">,</span> <span class=\"token operator\">+</span><span class=\"token number\">Infinity</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">var</span> limits <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">getLimit</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>limits<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">return</span> limits<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">var</span> map <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  limits<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">,</span> map<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">return</span> map<span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">updateLimit</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">holder<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">,</span> reducer<span class=\"token punctuation\">,</span> type<span class=\"token punctuation\">,</span> value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">var</span> map <span class=\"token operator\">=</span> <span class=\"token function\">getLimit</span><span class=\"token punctuation\">(</span>holder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>map<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><br>    map<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'any'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">var</span> limit <span class=\"token operator\">=</span> map<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>limit<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> type <span class=\"token operator\">&amp;&amp;</span> limit<span class=\"token punctuation\">.</span>value <span class=\"token operator\">===</span> value<span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span><br>  limit<span class=\"token punctuation\">.</span>type <span class=\"token operator\">=</span> type<span class=\"token punctuation\">;</span><br>  limit<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span><br>  reducer<span class=\"token punctuation\">.</span><span class=\"token function\">change</span><span class=\"token punctuation\">(</span>holder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">mergeLimit</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node<span class=\"token punctuation\">,</span> reducer<span class=\"token punctuation\">,</span> other</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">var</span> map <span class=\"token operator\">=</span> <span class=\"token function\">getLimit</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">var</span> otherMap <span class=\"token operator\">=</span> <span class=\"token function\">getLimit</span><span class=\"token punctuation\">(</span>other<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  otherMap<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">limit<span class=\"token punctuation\">,</span> key</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token function\">updateLimit</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> reducer<span class=\"token punctuation\">,</span> limit<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">,</span> limit<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token comment\">//</span><br><span class=\"token comment\">// Propagate limit from: X &lt; Y to `if`'s true branch</span><br><span class=\"token comment\">//</span><br><span class=\"token keyword\">function</span> <span class=\"token function\">reduceIf</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node<span class=\"token punctuation\">,</span> reducer</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">var</span> test <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>inputs<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>test<span class=\"token punctuation\">.</span>opcode <span class=\"token operator\">!==</span> <span class=\"token string\">'cmp'</span> <span class=\"token operator\">||</span> test<span class=\"token punctuation\">.</span>literals<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!==</span> <span class=\"token string\">'&lt;'</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">var</span> left <span class=\"token operator\">=</span> test<span class=\"token punctuation\">.</span>inputs<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">var</span> right <span class=\"token operator\">=</span> test<span class=\"token punctuation\">.</span>inputs<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token function\">updateLimit</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>controlUses<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> left<span class=\"token punctuation\">,</span> reducer<span class=\"token punctuation\">,</span> <span class=\"token string\">'&lt;'</span><span class=\"token punctuation\">,</span> right<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token function\">updateLimit</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>controlUses<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> left<span class=\"token punctuation\">,</span> reducer<span class=\"token punctuation\">,</span> <span class=\"token string\">'>='</span><span class=\"token punctuation\">,</span> right<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token comment\">//</span><br><span class=\"token comment\">// Determine ranges and limits of</span><br><span class=\"token comment\">// the values.</span><br><span class=\"token comment\">//</span><br><br><span class=\"token keyword\">var</span> rangeAndLimit <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Reducer<span class=\"token punctuation\">.</span>Reduction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><br>  <span class=\"token function-variable function\">reduce</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node<span class=\"token punctuation\">,</span> reducer</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>opcode <span class=\"token operator\">===</span> <span class=\"token string\">'literal'</span><span class=\"token punctuation\">)</span><br>      <span class=\"token function\">reduceLiteral</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">,</span> reducer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>opcode <span class=\"token operator\">===</span> <span class=\"token string\">'ssa:phi'</span><span class=\"token punctuation\">)</span><br>      <span class=\"token function\">reducePhi</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">,</span> reducer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>opcode <span class=\"token operator\">===</span> <span class=\"token string\">'add'</span><span class=\"token punctuation\">)</span><br>      <span class=\"token function\">reduceAdd</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">,</span> reducer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>opcode <span class=\"token operator\">===</span> <span class=\"token string\">'if'</span><span class=\"token punctuation\">)</span><br>      <span class=\"token function\">reduceIf</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">,</span> reducer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> rangeAndLimit<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br><span class=\"token comment\">//</span><br><span class=\"token comment\">// Now that we have ranges and limits,</span><br><span class=\"token comment\">// time to remove the useless array</span><br><span class=\"token comment\">// length checks.</span><br><span class=\"token comment\">//</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">reduceCheckIndex</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node<span class=\"token punctuation\">,</span> reducer</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token comment\">// Walk up the control chain</span><br>  <span class=\"token keyword\">var</span> region <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>control<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>region<span class=\"token punctuation\">.</span>opcode <span class=\"token operator\">!==</span> <span class=\"token string\">'region'</span> <span class=\"token operator\">&amp;&amp;</span> region<span class=\"token punctuation\">.</span>opcode <span class=\"token operator\">!==</span> <span class=\"token string\">'start'</span><span class=\"token punctuation\">)</span><br>    region <span class=\"token operator\">=</span> region<span class=\"token punctuation\">.</span>control<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">var</span> array <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>inputs<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">var</span> index <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>inputs<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">var</span> limit <span class=\"token operator\">=</span> <span class=\"token function\">getLimit</span><span class=\"token punctuation\">(</span>region<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>limit<span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">var</span> range <span class=\"token operator\">=</span> <span class=\"token function\">getRange</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token comment\">// Negative array index is not valid</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>range<span class=\"token punctuation\">.</span>from <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token comment\">// Index should be limited by array length</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>limit<span class=\"token punctuation\">.</span>type <span class=\"token operator\">!==</span> <span class=\"token string\">'&lt;'</span> <span class=\"token operator\">||</span><br>      limit<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">.</span>opcode <span class=\"token operator\">!==</span> <span class=\"token string\">'loadArrayLength'</span> <span class=\"token operator\">||</span><br>      limit<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">.</span>inputs<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!==</span> array<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span><br><br>  <span class=\"token comment\">// Check is safe to remove!</span><br>  reducer<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">var</span> eliminateChecks <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Reducer<span class=\"token punctuation\">.</span>Reduction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><br>  <span class=\"token function-variable function\">reduce</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node<span class=\"token punctuation\">,</span> reducer</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>opcode <span class=\"token operator\">===</span> <span class=\"token string\">'checkIndex'</span><span class=\"token punctuation\">)</span><br>      <span class=\"token function\">reduceCheckIndex</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">,</span> reducer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> eliminateChecks<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br><span class=\"token comment\">//</span><br><span class=\"token comment\">// Run scheduler to put everything</span><br><span class=\"token comment\">// back to the CFG</span><br><span class=\"token comment\">//</span><br><br><span class=\"token keyword\">var</span> out <span class=\"token operator\">=</span> Scheduler<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>out<span class=\"token punctuation\">.</span><span class=\"token function\">reindex</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">DEBUG</span><span class=\"token punctuation\">)</span><br>  fs<span class=\"token punctuation\">.</span><span class=\"token function\">writeFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'after.gv'</span><span class=\"token punctuation\">,</span> out<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token string\">'graphviz'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">cfg</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'printable'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>Thank you for reading this. Please expect more information about this\nsea-of-nodes approach.</p>\n<hr>\n<p>Special thanks to <a href=\"https://github.com/paulfryzel\">Paul Fryzel</a> for proof-reading this, and providing\nvaluable feedback and grammar fixes!</p>\n",
			"date_published": "2015-10-08T00:00:00Z"
		}
		,
		{
			"id": "https://darksi.de/c.cpp-in-node/",
			"url": "https://darksi.de/c.cpp-in-node/",
			"title": "Diving into C++ internals of node",
			"content_html": "<h2 id=\"intro\" tabindex=\"-1\">Intro <a class=\"header-anchor\" href=\"https://darksi.de/c.cpp-in-node/\">#</a></h2>\n<p>There is nothing to be scared about in the C++ internals of the project,\nespecially in internals of <a href=\"https://github.com/nodejs/io.js\">io.js</a> and <a href=\"https://github.com/nodejs/node\">node.js</a>.</p>\n<p>If you ever tried to optimize JavaScript code to squeeze out every possible\nperformance or memory usage improvement out of it - you already wrote some C++\ncode.</p>\n<p>Many blogs, workshops mention JavaScript optimizations, and some of the popular\nsuggestions are:</p>\n<h3 id=\"hidden-classes\" tabindex=\"-1\">Hidden Classes <a class=\"header-anchor\" href=\"https://darksi.de/c.cpp-in-node/\">#</a></h3>\n<p>Declare all properties in the constructor to avoid creating extra\n&quot;hidden classes&quot;. This makes them pretty much the same as a C structures,\nor C++ classes, where properties are declared ahead of time to help the\ncompiler optimize access to them.</p>\n<p>Example:</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">Point</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> z</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>x <span class=\"token operator\">=</span> x<br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>y <span class=\"token operator\">=</span> y<br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>z <span class=\"token operator\">=</span> z<br><span class=\"token punctuation\">}</span></code></pre>\n<p>Similar code in C++:</p>\n<pre class=\"language-c\" tabindex=\"0\"><code class=\"language-c\">class Point <span class=\"token punctuation\">{</span><br> public<span class=\"token operator\">:</span><br>  <span class=\"token keyword\">double</span> x<span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">double</span> y<span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">double</span> z<span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre>\n<h3 id=\"avoid-polymorphism\" tabindex=\"-1\">Avoid Polymorphism <a class=\"header-anchor\" href=\"https://darksi.de/c.cpp-in-node/\">#</a></h3>\n<p>Avoid storing different types of values in a variables, and avoid passing\ndifferent types of values as an arguments to the function. This principle could\nalso be called &quot;Make your code monomorphic&quot;, or &quot;don't mess with Compiler&quot;.\nThis makes code look like as it has static typing, which is what we do in\nC++.</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">x<span class=\"token punctuation\">,</span> y</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">return</span> x <span class=\"token operator\">+</span> y<span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// &lt;- good</span><br><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">'foo'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'bar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// &lt;- polymorphism!</span></code></pre>\n<p>Compare to:</p>\n<pre class=\"language-c\" tabindex=\"0\"><code class=\"language-c\"><span class=\"token keyword\">int</span> <span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> y<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">return</span> x <span class=\"token operator\">+</span> y<span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"cache-and-reuse\" tabindex=\"-1\">Cache and Reuse <a class=\"header-anchor\" href=\"https://darksi.de/c.cpp-in-node/\">#</a></h3>\n<p>Cache and reuse instances of objects that are expensive to create and are\nallocated often. This is one is similar to manual memory allocation in C++.</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">Parser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br><span class=\"token punctuation\">}</span><br><br>Parser<span class=\"token punctuation\">.</span>freelist <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><br><br>Parser<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">get</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>freelist<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>freelist<span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Parser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span><br><br><span class=\"token class-name\">Parser</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>release <span class=\"token operator\">=</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">;</span></code></pre>\n<p>In C++:</p>\n<pre class=\"language-c\" tabindex=\"0\"><code class=\"language-c\">Parser<span class=\"token operator\">*</span> p <span class=\"token operator\">=</span> new <span class=\"token function\">Parser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>delete p<span class=\"token punctuation\">;</span></code></pre>\n<p>To conclude, even if you never wrote C++ code, you actually very likely did it\nin JS.</p>\n<p>It is no surprise we use C++ in io.js/node.js. After all, V8 is written in C++\nand it provides only a limited set of ECMAScript JavaScript APIs. They are\ndefinitely cool, but if you got used to <code>setTimeout()</code> / <code>clearTimeout()</code> -\nyou'll be pretty disappointed to use just plain ECMA.</p>\n<p>Our C++ layer lives on top of the event-loop and provides all sorts of APIs:\nfrom net sockets to dns queries, from file system events to the zlib bindings.\nWhich is the main reason why node.js was created in the first place!</p>\n<h2 id=\"short-history-of-c-layer\" tabindex=\"-1\">Short History of C++ layer <a class=\"header-anchor\" href=\"https://darksi.de/c.cpp-in-node/\">#</a></h2>\n<p><picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/pjQ6T0k8WH-1012.avif 1012w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/pjQ6T0k8WH-1012.webp 1012w\"><img alt=\"History of Git Blame\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/pjQ6T0k8WH-1012.jpeg\" width=\"1012\" height=\"1500\"></picture></p>\n<p>To better understand all of these, and to ease the contribution process - it\nmight be a good idea to start with the history of the subject. Luckily, from its\ninception, node.js is using VCS, in particular git, so the history of the\ndevelopment might be revealed by running <code>git log</code> and <code>git blame</code> on it.</p>\n<p>Briefly, <code>git log deps/v8</code> - has the history of v8 fighting us, and\n<code>git log src/</code> - has the history of us fighting v8.</p>\n<h2 id=\"very-first-version\" tabindex=\"-1\">Very first version <a class=\"header-anchor\" href=\"https://darksi.de/c.cpp-in-node/\">#</a></h2>\n<p>Jokes aside, everything started from <a href=\"https://github.com/nodejs/io.js/commit/61890720\">61890720</a> commit. The commit log\njust says:</p>\n<p>add readme and initial code</p>\n<p>Unfortunately, we can't elaborate much from it, and need to figure out the\ndetails ourselves. What do we see there?</p>\n<ul>\n<li><a href=\"https://github.com/taf2/libebb\">libebb</a> - which was used as an HTTP parser. Ryan used the code\nfrom the <a href=\"https://github.com/gnosek/ebb\">Ebb</a> server that he has previously written for Ruby</li>\n<li><a href=\"https://cs.fit.edu/code/projects/cse2410_fall2014_bounce/repository/revisions/90fc8d36220c0d66c352ee5f72080b8592d310d5/show/deps/liboi\">liboi</a>- which was as a TCP server framework on top of the <a href=\"http://software.schmorp.de/pkg/libev.html\">libev</a>.\nliboi stands for <code>Library for Output Input</code></li>\n</ul>\n<p>So the first code (that actually started compiling only at <a href=\"https://github.com/nodejs/io.js/commit/7b7ceea\">7b7ceea</a>) only\nhad one HTTP server and supplied JavaScript source code was just a handler for\nit.</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">Process</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">request</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">.</span>verbose<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Processing \"</span> <span class=\"token operator\">+</span> request<span class=\"token punctuation\">.</span>host <span class=\"token operator\">+</span><br>        request<span class=\"token punctuation\">.</span>path <span class=\"token operator\">+</span><br>        <span class=\"token string\">\" from \"</span> <span class=\"token operator\">+</span> request<span class=\"token punctuation\">.</span>referrer <span class=\"token operator\">+</span><br>        <span class=\"token string\">\"@\"</span> <span class=\"token operator\">+</span> request<span class=\"token punctuation\">.</span>userAgent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>output<span class=\"token punctuation\">[</span>request<span class=\"token punctuation\">.</span>host<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><br>    output<span class=\"token punctuation\">[</span>request<span class=\"token punctuation\">.</span>host<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">else</span><br>    output<span class=\"token punctuation\">[</span>request<span class=\"token punctuation\">.</span>host<span class=\"token punctuation\">]</span><span class=\"token operator\">++</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>How was it organized internally?</p>\n<p>There was a <code>server.cc</code> file which was reading the command line options, loading\nthe JavaScript source file, feeding all of these into V8, and starting the HTTP\nserver.</p>\n<p>Second C++ file was <code>js_http_request_processor.cc</code> and it was responsible for\ninvoking the JavaScript http request handler. Not that much for a separate C++\nfile, right?</p>\n<p>It wasn't working that much at that point, and didn't have any of\nfunctionality that is provided today. So let's conclude and move on from it\nquickly.</p>\n<p>This version is characterized by following:</p>\n<ul>\n<li>One file to setup V8 and let JavaScript know about command-line arguments</li>\n<li>HTTP server fully implemented in C/C++, not invoking the JavaScript for any\nnetworking activities</li>\n<li>One C++ instance per every incoming request, this instance maps some of the\nHTTP fields (like host, url, method) to the JavaScript object.</li>\n</ul>\n<p>The last bullet point is very important to note: the C++ instance &lt;-&gt; JS object\nmapping is a building brick of all future releases of node.js (including the\npresent one).</p>\n<h2 id=\"064c8f02\" tabindex=\"-1\">064c8f02 <a class=\"header-anchor\" href=\"https://darksi.de/c.cpp-in-node/\">#</a></h2>\n<p>Now we quickly jump to <a href=\"https://github.com/nodejs/io.js/commit/064c8f02\">064c8f02</a>. The commit log says:</p>\n<p>Use ObjectWrap base class for File, Socket, Server.</p>\n<p>And this is the point where node.js has introduced one API to wrap all objects.</p>\n<p><code>net.Server</code>, <code>net.Socket</code>, and <code>File</code> C++ classes are children of this\n<code>ObjectWrap</code> class. Which means that for every instance of them -\nthere will be one instance of a JS object. Invoking methods on this JS object\nwill invoke C++ methods on the corresponding C++ class, and the constructor\nitself is a C++ class constructor.</p>\n<p>There are now different files for different parts of the provided API:</p>\n<ul>\n<li><code>src/node.cc</code> to set up C++ libraries and invoke <code>src/main.js</code> which\nloads the script file and does some JavaScript initialization. (At this commit\nwe started to write as much code as possible in JavaScript, and leave\nthe rest in the C++ land. This pattern is used in io.js and node.js now too)</li>\n<li><code>src/http.cc</code> - http server API, Connection, HttpRequest objects</li>\n<li><code>src/file.cc</code>, <code>src/file.js</code> - future <code>fs</code> module.\n<code>src/file.js</code> consists of the API abstractions for the C++ layer,\nbasically the same thing as with <code>src/node.cc</code> and <code>src/main.js</code></li>\n<li><code>src/process.cc</code> has only <code>exit()</code> method so far, will evolve into the\n<code>process</code> object</li>\n<li><code>src/timers.cc</code> is about <code>setTimeout</code>/<code>setInterval</code></li>\n</ul>\n<p>Just a side note: HTTP server is still provided by <a href=\"https://cs.fit.edu/code/projects/cse2410_fall2014_bounce/repository/revisions/90fc8d36220c0d66c352ee5f72080b8592d310d5/show/deps/liboi\">liboi</a>, and node.js is\nusing <a href=\"http://software.schmorp.de/pkg/libev.html\">libev</a>.</p>\n<h2 id=\"v0-2\" tabindex=\"-1\">v0.2 <a class=\"header-anchor\" href=\"https://darksi.de/c.cpp-in-node/\">#</a></h2>\n<p>There was lots of growing and maturing from that commit to the v0.2, and most\nnotable of them were about separating the JS parts from the C++ ones,\nadding CommonJS support, and tons of new modules! The file structure is\nbeginning to look like what we have now:</p>\n<ul>\n<li><code>lib/</code> folder for all JavaScript CommonJS modules</li>\n<li><code>src/</code> for their C++ counterparts</li>\n<li><code>deps/</code> for all dependencies: v8, http-parser, c-ares (for async DNS),\nlibeio (for async FS), and libev (for async networking and auxiliary stuff)</li>\n</ul>\n<p>Previously barely used through the <code>src/</code>, <code>ObjectWrap</code> now became a public API,\nwhich helped polish it out a lot and improved our core use case as well.</p>\n<p>Very importantly, in <a href=\"https://github.com/nodejs/io.js/commit/064c8f02\">064c8f02</a> all C++ interfaces were global objects. In\nv0.2 they are provided by <code>process.binding</code> and are thus not directly visible to\nthe user's code.</p>\n<p>For example, <code>process.binding('fs')</code>:</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\"><span class=\"token operator\">></span> process<span class=\"token punctuation\">.</span><span class=\"token function\">binding</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">access</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>Function<span class=\"token operator\">:</span> access<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><br>  <span class=\"token literal-property property\">close</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>Function<span class=\"token operator\">:</span> close<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><br>  <span class=\"token literal-property property\">open</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>Function<span class=\"token operator\">:</span> open<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><br>  <span class=\"token operator\">...</span>lots <span class=\"token keyword\">of</span> stuff<span class=\"token operator\">...</span></code></pre>\n<p>returns lots of C++ methods and classes that are heavily used for interoperation\nbetween C++ and JS in <code>lib/fs.js</code>. Similar stuff is done for the rest of the\n<code>lib/</code> modules.</p>\n<h2 id=\"v0-6\" tabindex=\"-1\">v0.6 <a class=\"header-anchor\" href=\"https://darksi.de/c.cpp-in-node/\">#</a></h2>\n<p>Just a short note: <code>libev</code> was removed and replaced by <a href=\"https://github.com/libuv/libuv\">libuv</a>. A product of\nlots of work by Ben Noordhuis, Bert Belder, Ryan Dahl, and others!</p>\n<p>The v0.6 version is a major milestone in evolution of node.js. Partly because\nWindows is now in the list of the officially supported platforms, partly because\nwe have our own single event-loop platform that supports both async File System\nand async networking operations.</p>\n<h2 id=\"v0-10\" tabindex=\"-1\">v0.10 <a class=\"header-anchor\" href=\"https://darksi.de/c.cpp-in-node/\">#</a></h2>\n<p>Good, stable, but boring...</p>\n<h2 id=\"v0-12-and-io-js\" tabindex=\"-1\">v0.12 and io.js <a class=\"header-anchor\" href=\"https://darksi.de/c.cpp-in-node/\">#</a></h2>\n<p>Lots of new stuff! :)</p>\n<p>Mainly, we have outgrown the <code>ObjectWrap</code> to accommodate the tracing API (which\nis still needs lots of rework, AFAIK). The hip thing now is <code>AsyncWrap</code> which is\nin many ways the same thing, but now is attached to some particular domain of\noperation (i.e. http, dns, tls) and which might have the another <code>AsyncWrap</code> as\na parent. Note that <code>ObjectWrap</code> lives in <code>src/node_object_wrap.h</code>, and\n<code>AsyncWrap</code> in <code>src/async-wrap.h</code>.</p>\n<p>This is now the present point of the node.js evolution, and I would like to\nstop with the Software Archeology at this point.</p>\n<h2 id=\"interoperation-handles-wraps-and-unicorns\" tabindex=\"-1\">Interoperation, handles, wraps, and unicorns! <a class=\"header-anchor\" href=\"https://darksi.de/c.cpp-in-node/\">#</a></h2>\n<p>We are finally ready to dive into the C++ internals, and explore them in a\ngreater detail.</p>\n<p>As we already figured out - whole APIs provided by the node.js/io.js live in\ntwo folders: <code>lib</code> and <code>src</code>. <code>lib</code> holds the core modules, <code>src</code> holds their\nC++ counterparts.</p>\n<p>When you call <code>require('fs')</code> - it does nothing but just executes the contents\nof the <code>lib/fs.js</code> file. No magic here.</p>\n<p>Now comes the interesting part, JavaScript is not capable of file system\noperations, nor it is capable of networking. This is actually for the\nbest! (You don't want your browser to mess up whole file system,\nright?) So when you do <code>fs.writeFileSync</code>, or when you are calling\n<code>http.request()</code> there is a lot of low-level C++ stuff happening outside of the\nJS-land.</p>\n<p>While the <code>fs</code> module is quite simple to explain, it is quite boring too. After\nall, in most of the cases it is just using number to represent the opened\nfile (so called <code>file descriptor</code>), and it is passing this number around:\nfrom C++ to JS, and from JS to C++. Nothing interesting, let's move on!</p>\n<p>Certainly much more attractive is the <code>net</code> module. We create sockets, get\nthe <code>connect</code> events, and expect the <code>.write()</code> callbacks to be eventually\ninvoked. All of these should be powered by the C++ machinery!</p>\n<p>Here is where most of the interoperation is happening. The\n<code>tcp_wrap</code> and <code>stream_wrap</code> bindings (remember, <code>process.binding()</code>, right?)\nprovide very useful classes for JS-land: TCP, TCPConnectWrap, WriteWrap,\nShutdownWrap.</p>\n<ul>\n<li><code>TCP</code> holds the TCP socket and provides methods for writing and reading\nstuff</li>\n<li><code>*Wrap</code> objects are what you pass to the <code>TCP</code> methods when you expect\nsome async action to happen, and need to receive notification (callback) on\ntheir completion.</li>\n</ul>\n<p>For example, the normal workflow for <code>net.connect()</code> follows:</p>\n<ul>\n<li>Create <code>TCP</code> instance in <code>lib/net.js</code>, store it in the <code>_handle</code> property of\nthe <code>net.Socket</code> object</li>\n<li>Parse all arguments to <code>net.connect()</code></li>\n<li>Create <code>TCPConnectWrap</code> instance (usually named <code>req</code>)</li>\n<li>Invoke <code>.connect()</code> method with <code>req, port, host</code></li>\n<li>Get <code>req.oncomplete</code> function invoked eventually, once the connection was\nestablished, or once the kernel reported an error</li>\n</ul>\n<p>In conclusion: most of the C++ classes are either handles, or requests.\nRequests are very temporary and never outlive the handle that they are bound to,\nwhile the handles are something that live much longer (i.e. for the entire life\ntime of the TCP connection).</p>\n<p>Speaking of the file structure: <code>TCP</code> is represented by the <code>TCPWrap</code> class in\n<code>src/tcp_wrap.cc</code>, <code>TCPConnectWrap</code> lives in the same place, and <code>WriteWrap</code>\nis in the <code>stream_base.cc</code> file (in io.js).</p>\n<h2 id=\"structure-of-c-files\" tabindex=\"-1\">Structure of C++ files <a class=\"header-anchor\" href=\"https://darksi.de/c.cpp-in-node/\">#</a></h2>\n<p>But how does the C++ provide this classes to JavaScript?</p>\n<p>Each binding has a <code>NODE_MODULE_CONTEXT_AWARE_BUILTIN</code> macro that registers it\nin the <code>node.cc</code>. This has the same effect as following JavaScript snippet:</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\">modules<span class=\"token punctuation\">[</span>moduleName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token literal-property property\">initialized</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span><br>  <span class=\"token literal-property property\">initFn</span><span class=\"token operator\">:</span> moduleInitFn<br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre>\n<p>When <code>process.binding('moduleName')</code> is invoked, <code>node.cc</code> looks up the proper\ninternal binding in this hashmap and initializes it (if it wasn't previously\ninitialized) by calling the supplied function.</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\">process<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">binding</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">moduleName</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">var</span> module <span class=\"token operator\">=</span> modules<span class=\"token punctuation\">[</span>moduleName<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">.</span>initialized<span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">return</span> module<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">;</span><br><br>  module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span><br>  module<span class=\"token punctuation\">.</span><span class=\"token function\">initFn</span><span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">return</span> module<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre>\n<p>This initialization function receives <code>exports</code> object as an input, and exports\nthe methods and classes to it in pretty much the same way as you normally do\nin CommonJS modules.</p>\n<p>Each of the exported classes are bound to some C++ classes, and most of them are\nactually derived from the <code>AsyncWrap</code> C++ class.</p>\n<p>The Handle instances are destroyed automatically by V8's GC (once they are\nclosed in JS), and the Wraps are manually destroyed by the Handle, once they are\nnot used anymore.</p>\n<p>Side-note:</p>\n<p>there are two types of references to the JS\nobjects from C++ land: normal and weak. By default <code>AsyncWrap</code>s are referencing\ntheir objects in a <code>normal</code> way, which means that the JS objects representing\nthe C++ classes won't be garbage collected until C++ class will dispose the\nreference. The weak mode is turned on only when the <code>MakeWeak</code> is called\nsomewhere in C++. This might be very useful when debugging memory leaks.</p>\n<h2 id=\"small-exam\" tabindex=\"-1\">Small exam <a class=\"header-anchor\" href=\"https://darksi.de/c.cpp-in-node/\">#</a></h2>\n<h3 id=\"situation\" tabindex=\"-1\">Situation <a class=\"header-anchor\" href=\"https://darksi.de/c.cpp-in-node/\">#</a></h3>\n<p>You debug some io.js/node.js issue, and find that it is crashing when\ninstantiating a class provided by <code>process.binding('broken')</code>. Where will you\nattempt to search for the C++ source code of that class?</p>\n<h3 id=\"answer\" tabindex=\"-1\">Answer <a class=\"header-anchor\" href=\"https://darksi.de/c.cpp-in-node/\">#</a></h3>\n<p>Somewhere in <code>src/</code>. Find\n<code>NODE_MODULE_CONTEXT_AWARE_BUILTIN(broken, ...)</code> and it is most like going to be\nin <code>src/broken_something.cc</code>.</p>\n<h2 id=\"c-streams\" tabindex=\"-1\">C++ Streams <a class=\"header-anchor\" href=\"https://darksi.de/c.cpp-in-node/\">#</a></h2>\n<p>Now comes one of my recent obsessions. The C++ Stream API.</p>\n<p>It is a established fact for me that exposing the building blocks of APIs helps\nto renovate, reshape and make them better <em>a lot better</em>. One of such thing\nthat I was always keen to re-do was a <code>StreamWrap</code> instance.</p>\n<p>It was ok-ish in v0.10, but when we moved TLS (SSL) implementation into C++\nland it changed dramatically... and, honestly saying, not in a good way.</p>\n<p>The previously singular <code>StreamWrap</code> instance, now became a monster that was\ncapable of passing the incoming data elsewhere, skipping the JavaScript\ncallbacks completely and doing some dark-magic OpenSSL machinery on top of it.\nThe implementation worked like a charm, providing much better TLS performance,\nbut the source code became cluttered and rigid.</p>\n<p>This &quot;move-parsing-to-elsewhere&quot; thing reminded me a lot about the\n<code>stream.pipe</code> that we had for JavaScript streams for ages. The natural thing to\ndo about it was to introduce something similar in the C++ land too. This is\nexactly what was done in io.js, and the results of this live in\n<code>src/stream_base.cc</code>.</p>\n<h2 id=\"next-step-with-the-c-stream-apis\" tabindex=\"-1\">Next step with the C++ Stream APIs <a class=\"header-anchor\" href=\"https://darksi.de/c.cpp-in-node/\">#</a></h2>\n<p>Now we have a very general implementation of this thing that could be reused in\nmany places. The first thing that I expect will be using this might be an\nHTTP2 stream. To do it in core, we should do it in user-land first, and it could\nbe accomplished only by exposing the C++ Stream API, in the same way as we did\nit with ObjectWrap.</p>\n<h2 id=\"epilogue\" tabindex=\"-1\">Epilogue <a class=\"header-anchor\" href=\"https://darksi.de/c.cpp-in-node/\">#</a></h2>\n<p>I'm going to ask you to:</p>\n<ul>\n<li>Clone the io.js repo</li>\n<li>Open the <code>src/</code></li>\n<li>Go through files in it, and check what you read about it</li>\n<li>Open <code>src/stream_base.h</code>, <code>src/stream_base.cc</code> and friends and figure out\nwhat seems to be wrong to you</li>\n<li><a href=\"https://github.com/nodejs/io.js/pulls\">Send a PR</a></li>\n<li>Have fun!</li>\n</ul>\n",
			"date_published": "2015-05-16T00:00:00Z"
		}
		,
		{
			"id": "https://darksi.de/b.side-projects/",
			"url": "https://darksi.de/b.side-projects/",
			"title": "Side Projects",
			"content_html": "<p>After reading <a href=\"https://github.com/antirez\">antirez</a>'s <a href=\"http://antirez.com/news/86\">blog post</a> I decided that it might be a good\nexercise to write down the notable side projects that I spent my time upon since\nJan 2014.</p>\n<p>Here is the list and some comments from me:</p>\n<h3 id=\"bn-js\" tabindex=\"-1\"><a href=\"https://github.com/indutny/bn.js\">bn.js</a> <a class=\"header-anchor\" href=\"https://darksi.de/b.side-projects/\">#</a></h3>\n<p>JavaScript library for working with Big Numbers. <a href=\"https://github.com/indutny/bn.js\">bn.js</a> is an ultra-fast\n<a href=\"https://github.com/justmoon/node-bignum\">bignum</a> alternative with support for running in io.js/node.js and browsers.</p>\n<p>This one took lots of time and effort through whole year with some periodic\n<a href=\"https://github.com/indutny/bn.js/graphs/contributors\">sparks in a contributions graph</a>, and many PRs from OpenSource community.\nSeriously, big kudos to you people for helping me with it!</p>\n<h3 id=\"elliptic\" tabindex=\"-1\"><a href=\"https://github.com/indutny/elliptic\">elliptic</a> <a class=\"header-anchor\" href=\"https://darksi.de/b.side-projects/\">#</a></h3>\n<p>JS library for doing Elliptic Curve crypto. It was the reason for creating the\n<a href=\"https://github.com/indutny/bn.js\">bn.js</a> in the first place, and excuse for me to learn more about EC\ncryptography and crazy math behind it.</p>\n<h3 id=\"bud\" tabindex=\"-1\"><a href=\"https://github.com/indutny/bud\">bud</a> <a class=\"header-anchor\" href=\"https://darksi.de/b.side-projects/\">#</a></h3>\n<p>A friendly and clever TLS-terminating proxy in C.</p>\n<p>Although I worked on it since Nov 2013, lots of development happened during the\n2014 year. This is my biggest project in C so far, and it has taught me a lot\nabout designing the APIs and interfaces in low-level languages.</p>\n<p>Bud seens lots of love from <a href=\"https://github.com/odeke-em\">Emmanuel Odeke</a>. Big thanks to you, Emmanuel!</p>\n<h3 id=\"tls-js\" tabindex=\"-1\"><a href=\"https://github.com/indutny/tls.js\">tls.js</a> <a class=\"header-anchor\" href=\"https://darksi.de/b.side-projects/\">#</a></h3>\n<p>(Incomplete) TLS implementation in JavaScript.</p>\n<p>Totally experimental protocol implementation. Did it just for fun, but it turned\nto be useful in screening the web servers.</p>\n<h3 id=\"hash-js\" tabindex=\"-1\"><a href=\"https://github.com/indutny/hash.js\">hash.js</a> <a class=\"header-anchor\" href=\"https://darksi.de/b.side-projects/\">#</a></h3>\n<p>Implementations of SHA1, SHA224, SHA256, SHA384, SHA512, RIPEMD160, various\nHMACs. One of the mandatory dependencies of...</p>\n<h3 id=\"bcoin\" tabindex=\"-1\"><a href=\"https://github.com/indutny/bcoin\">bcoin</a> <a class=\"header-anchor\" href=\"https://darksi.de/b.side-projects/\">#</a></h3>\n<p>BitCoin SPV client implementation. Purely experimental, but I heard that some\npeople do use it.</p>\n<p>Lots of contributions from <a href=\"https://github.com/chjj\">Christopher Jeffrey</a> here. Thank you!</p>\n<h3 id=\"bthread-src\" tabindex=\"-1\"><a href=\"https://chrome.google.com/webstore/detail/bthread/ldbfhhncehnfgppdlgjhfgffachpehkd\">bthread</a> (<a href=\"https://github.com/indutny/bthread\">src</a>) <a class=\"header-anchor\" href=\"https://darksi.de/b.side-projects/\">#</a></h3>\n<p>Writing blog posts in a BitCoin block-chain.</p>\n<p><em>I know many people hate me for this, but still I wanted to experiment with it\na little</em>.</p>\n<h3 id=\"js-js\" tabindex=\"-1\"><a href=\"https://github.com/js-js/js.js\">js.js</a> <a class=\"header-anchor\" href=\"https://darksi.de/b.side-projects/\">#</a></h3>\n<p>JS JIT compiler written in JS.</p>\n<p>Very preliminary implementation with little or no compatibility with ECMAScript\nyet :)</p>\n<h3 id=\"heap-js-jit-js-cfg-js\" tabindex=\"-1\"><a href=\"https://github.com/js-js\">heap.js, jit.js, cfg.js, ...</a> <a class=\"header-anchor\" href=\"https://darksi.de/b.side-projects/\">#</a></h3>\n<p>Various <a href=\"https://github.com/js-js/js.js\">js.js</a> dependencies.</p>\n<h3 id=\"lll-reduction\" tabindex=\"-1\"><a href=\"https://github.com/indutny/lll-reduction\">lll-reduction</a> <a class=\"header-anchor\" href=\"https://darksi.de/b.side-projects/\">#</a></h3>\n<p><a href=\"http://en.wikipedia.org/wiki/Lenstra%E2%80%93Lenstra%E2%80%93Lov%C3%A1sz_lattice_basis_reduction_algorithm\">LenstraLenstraLovsz algorithm</a> JavaScript implementation.</p>\n<p>I don't remember exact reasons for writing this, but I guess I thought about\ndoing more optimal <a href=\"http://www.hyperelliptic.org/tanja/conf/ECC08/slides/Mike-Scott.pdf\">GLV Method</a> for <a href=\"https://github.com/indutny/elliptic\">elliptic</a>.</p>\n<h3 id=\"core2dump\" tabindex=\"-1\"><a href=\"https://github.com/indutny/core2dump\">core2dump</a> <a class=\"header-anchor\" href=\"https://darksi.de/b.side-projects/\">#</a></h3>\n<p>Creating heap snapshots out of the core file on OS X, linuxes, and FreeBSD.</p>\n<h3 id=\"asn1-js\" tabindex=\"-1\"><a href=\"https://github.com/indutny/asn1.js\">asn1.js</a> <a class=\"header-anchor\" href=\"https://darksi.de/b.side-projects/\">#</a></h3>\n<p>ASN.1 encoding implementation in JS.</p>\n<h3 id=\"miller-rabin\" tabindex=\"-1\"><a href=\"https://github.com/indutny/miller-rabin\">miller-rabin</a> <a class=\"header-anchor\" href=\"https://darksi.de/b.side-projects/\">#</a></h3>\n<p>Miller-Rabin primality test in JS.</p>\n<h3 id=\"caine\" tabindex=\"-1\"><a href=\"https://github.com/indutny/caine\">caine</a> <a class=\"header-anchor\" href=\"https://darksi.de/b.side-projects/\">#</a></h3>\n<p>Butler bot for github projects. I wanted it to be used for io.js, but we decided\nto walk a different road.</p>\n<h4 id=\"epilogue\" tabindex=\"-1\">Epilogue <a class=\"header-anchor\" href=\"https://darksi.de/b.side-projects/\">#</a></h4>\n<p>I guess that's it.</p>\n<p>Most of these projects were a big incentive for me to dig into the protocols,\ntechnology, science. I find it much more enjoyable and interesting to\ninvestigate new topics through their applications.</p>\n<p><strong>Thank you for all your contributions, people! It is really awesome to see\nyou interested in helping me with these and other projects!</strong></p>\n<p>Thanks for reading this.</p>\n",
			"date_published": "2015-02-26T00:00:00Z"
		}
		,
		{
			"id": "https://darksi.de/a.deoptimize-me-not/",
			"url": "https://darksi.de/a.deoptimize-me-not/",
			"title": "Deoptimize me not, v8",
			"content_html": "<p>Compilers are awesome, right? If any programming concept may exist, it will\nprobably be used in compiler implementation at some point. I am always amazed\nby my findings during v8 bug triaging or just random code exploration.</p>\n<p>The interesting thing about v8 that I was always passionate about, but never\ntruly understood, was the Deoptimizer. The idea here is that v8 optimizes\ncode to make it run faster, but this optimization relies on assumptions\nabout types, ranges, actual values, const-ness, etc. These assumptions imply\nthat the optimized code won't run when these conditions are not met,\nsince the compiler needs to &quot;deoptimize&quot; it by returning to the previous\n&quot;no-assumptions&quot; version of generated code when the assumptions are failing.</p>\n<p>Technically it means that the compiler is in fact two compilers:\na base compiler and an &quot;optimizer&quot;. (Or even more, if we are talking about JSC\nand SpiderMonkey). The concept is quite sound and can yield incredible\nperformance, but there is a nuance: the optimized code may be &quot;deoptimized&quot; in\nvarious places, not just at the entry point, meaning that the environment (local\nvariables, arguments, context) should be mapped and moved around.</p>\n<h2 id=\"stack-machines\" tabindex=\"-1\">Stack machines <a class=\"header-anchor\" href=\"https://darksi.de/a.deoptimize-me-not/\">#</a></h2>\n<p>To better understand what needs to be done and how things are happening let's\nconsider a basic stack machine, like the one that we might use to interpret\nprogram instead of JIT compiling it.</p>\n<p><em>Note that this stack machine and assembly below are just an output of some\nabstract compiler and has nothing do to with v8. Thus here only for\ndemonstration purposes</em></p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">push a<br>push b<br>push c<br>mul     ; pop 2 values and push `arg0 * arg1`<br>push d<br>mul     ; b * c * d<br>add     ; pop 2 values and push `arg0 + arg`<br>ret     ; pop and return value</code></pre>\n<p>The interpreter will execute instructions one-by-one, maintaining the stack at\nevery point.</p>\n<p>Now we let's imagine some register machine (like x86_64), and write down\nthe same program in assembly language. To make it a bit more interesting,\nconsider that the target architecture has only two registers and the rest of the\nvalues need to be stored in memory (on-stack).</p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">mov [slot0], a   ; store value in 0 memory slot<br>mov rax, b       ; store value in rax register<br>mov rbx, c       ; store value in rbx register<br>mul rax, rbx     ; rax = rax * rbx<br>mov rbx, d<br>mul rax, rbx     ; rax = b * c * d<br>mov rbx, [slot0] ; load value from 0 memory slot<br>add rax, rbx     ; rax = b * c * d + a</code></pre>\n<p>The instructions are executed one-by-one, maintaining the register values and\nmemory slots.</p>\n<p>In terms of our compiler, the former code is an unoptimized version of our\nprogram, and the latter one is optimized. In fact, this is a completely valid\nclaim if we would like to run it on x86_64 platform, as assembly has much higher\nexecution speed than interpreted code that needs to be emulated.</p>\n<p>Suppose that the second <code>mul</code> instruction in assembly works only when the <code>d</code>\n(which is in <code>rbx</code> register) is a small integer. Now if the execution will\nreach the <code>mul</code> and find that there is a JavaScript string, it will just fail\nto do the &quot;right thing&quot;. This <code>mul(num, str)</code> operation will definitely require\nsome sort of type coercion, and could be easily handled by the interpreter.\nDoing it in assembly will very likely be much more costly in terms of\nperformance. To deal with this the compiler inserts check instructions:</p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">mov [slot0], a<br>mov rax, b<br>mov rbx, c<br>checkSmallInt rax<br>checkSmallInt rbx<br>mul rax, rbx<br>mov rbx, d<br>checkSmallInt rax<br>checkSmallInt rbx<br>mul rax, rbx ;<br>mov rbx, [slot0]<br>add rax, rbx</code></pre>\n<p>So in such an uncommon case, where the argument of <code>mul</code> is not a small integer,\nthis code should somehow be &quot;deoptimized&quot; from assembly code to the stack\nmachine and continue execution in the interpreted version. Here is the position\nin the optimized code where it will stop:</p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">mov [slot0], a<br>mov rax, b<br>mov rbx, c<br>checkSmallInt rax<br>checkSmallInt rbx<br>mul rax, rbx<br>mov rbx, d<br>checkSmallInt rax<br>checkSmallInt rbx &lt;-----<br>mul rax, rbx ;<br>mov rbx, [slot0]<br>add rax, rbx</code></pre>\n<p>...and position in unoptimized code, where would like it to continue:</p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">push a<br>push b<br>push c<br>mul<br>push d<br>mul     ; &lt;-----<br>add<br>ret</code></pre>\n<p>How could it do that? The simplest way is just to re-execute all code from the\nprogram's entry point using the input arguments. This solution is very limited\nthough, because it is possible only if the optimized function was pure, or in\nother words had no instructions with side effects (like function calls, etc...).</p>\n<p>The more general solution is to find all live values (the ones that may be used\nby later functions) at the deoptimization point, find their locations in both\noptimized and unoptimized code, and copy the values from the registers/memory\nto stack machine's slot.</p>\n<p>This is exactly what the &quot;deoptimizer&quot; in v8 does. The main difference from our\nimaginary example is that both unoptimized and optimized codes are in <code>x86_64</code>\nassembly language.</p>\n<h2 id=\"simulates\" tabindex=\"-1\">Simulates <a class=\"header-anchor\" href=\"https://darksi.de/a.deoptimize-me-not/\">#</a></h2>\n<p>Now we know what to do, but how is it actually implemented in v8?</p>\n<p>These mappings are possible thanks to the special high-level instructions called\n<code>Simulate</code>s. This is how they look in the v8's high-level intermediate\nrepresentation (abbr. IR, see my <a href=\"https://www.youtube.com/watch?v=tf6YTgO6Org\">EmpireNode talk</a> for more info on the IRs):</p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">v9 BlockEntry  &lt;|@<br>v10 Simulate id=3 var[3] = t8 &lt;|@<br>v11 StackCheck  changes[NewSpacePromotion] &lt;|@<br>v12 UseConst t8 &lt;|@<br>t13 ThisFunction  &lt;|@<br>t14 CheckNonSmi t3 &lt;|@<br>t15 CheckMaps t3 [0x2e26d7019781] &lt;|@<br>v16 CheckPrototypeMaps [...] &lt;|@<br>v17 Simulate id=24 push t3, push t4, push t8, var[3] = t13 &lt;|@<br>v18 EnterInlined middle, id=4 &lt;|@<br>t54 PushArgument t3 &lt;|@<br>t55 PushArgument t4 &lt;|@<br>t56 ArgumentsElements  &lt;|@<br>v19 UseConst t1 &lt;|@<br>t20 Constant ... &lt;|@<br>v25 Simulate id=26 pop 1, push t19, var[3] = t2, var[4] = t20 &lt;|@</code></pre>\n<p>(Note that you can obtain such IR by running node.js with <code>--trace-hydrogen</code>\nflag, which will print it out into the <code>hydrogen.cfg</code> or <code>hydrogen-&lt;pid&gt;.cfg</code>\nfile).</p>\n<p>The thing is called <code>Simulate</code> with good reason. Strip away all other\ninstructions:</p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">v10 Simulate id=3 var[3] = t8 &lt;|@<br>v17 Simulate id=24 push t3, push t4, push t8, var[3] = t13 &lt;|@<br>v25 Simulate id=26 pop 1, push t19, var[3] = t2, var[4] = t20 &lt;|@</code></pre>\n<p>...and we will see something that resembles... our simplified stack machine!\nHaving a stack machine means that we could &quot;simulate&quot; it's state by executing\ninstructions one-by-one. v8's has a couple of them:</p>\n<ul>\n<li><code>var[index] = value</code> - put a value in some on-stack slot</li>\n<li><code>push value</code> - push a value to a virtual stack</li>\n<li><code>pop count</code> - pop <code>count</code> of values from the stack</li>\n</ul>\n<p>Let's simulate some states out of the above sample:</p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">v10: var = { 3: t8 }, stack = []<br>v17: var = { 3: t13 }, stack = [ t3, t4, t8 ]<br>v25: var = { 3: t13, 4: t20 }, stack = [ t3, t4, t19 ]</code></pre>\n<p><em>Note that this &quot;simulation&quot; happens at compile-time, not when actually\ndeoptimizing.</em></p>\n<p>These states can be used to map the values from optimized to unoptimized code.\nFor example, if we would like to &quot;deoptimize&quot; at <code>t56</code>, we will have to find the\nlatest state which was at <code>v17</code>: <code>var = { 3: t13 }, stack = [ t3, t4, t8 ]</code>, and\njust place the present values into a proper stack slots and local variables (for\n<code>var</code> ones).</p>\n<p>With the <code>--trace-deopt</code> flag v8 will give us some insights on how it is doing\nthis:</p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">**** DEOPT: outer at bailout #14, address 0x0, frame size 56<br>[deoptimizing: begin 0x341ad2082a49 outer @14]<br>translating outer => node=24, height=8<br>0x7fff5fbff3e8: [top + 72] &lt;- 0xb7720f7d8b9 ; [sp + 96] 0xb7720f7d8b9 &lt;an O><br>0x7fff5fbff3e0: [top + 64] &lt;- 0xb7720f7d8b9 ; rbx 0xb7720f7d8b9 &lt;an O><br>0x7fff5fbff3d8: [top + 56] &lt;- 0x21ba55263fa9 ; caller's pc<br>0x7fff5fbff3d0: [top + 48] &lt;- 0x7fff5fbff410 ; caller's fp<br>0x7fff5fbff3c8: [top + 40] &lt;- 0xb7720f7d479; context<br>0x7fff5fbff3c0: [top + 32] &lt;- 0x341ad2082ad9; function<br>0x7fff5fbff3b8: [top + 24] &lt;- 0x341ad2004121 &lt;undefined> ; literal<br>0x7fff5fbff3b0: [top + 16] &lt;- 0x341ad2082ad9 &lt;JS Function inner> ; literal<br>0x7fff5fbff3a8: [top + 8] &lt;- 0xb7720f7d8b9 ; [sp + 24] 0xb7720f7d8b9 &lt;an O><br>0x7fff5fbff3a0: [top + 0] &lt;- 0x341ad2004121 ; rax 0x341ad2004121 &lt;undefined></code></pre>\n<p>Arrows here indicate the direction of movement. The output frame of the\nunoptimized code is on the left side, and on the right side - optimized code's\nvalues.</p>\n<p>The mentioned frame is an on-stack structure used for storing the caller address\n(to make <code>return</code> statements work), caller's frame address, and sometimes some\nadditional stuff (like JS context, <code>this</code>, arguments, and the function itself):</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/1g3z_8Q7Fn-397.avif 397w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/1g3z_8Q7Fn-397.webp 397w\"><img alt=\"Callstack\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/1g3z_8Q7Fn-397.png\" width=\"397\" height=\"472\"></picture></p>\n<p>Ignoring all the internal frame things, the interesting part would be:</p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">translating outer => node=24, height=8<br>0x7fff5fbff3a8: [top + 8] &lt;- 0xb7720f7d8b9 ; [sp + 24] 0xb7720f7d8b9 &lt;an O><br>0x7fff5fbff3a0: [top + 0] &lt;- 0x341ad2004121 ; rax 0x341ad2004121 &lt;undefined></code></pre>\n<p>The high-level IR of the code that generated this trace contained:</p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">0 0 v10 Simulate id=3 var[3] = t8 &lt;|@<br>...<br>0 0 v17 Simulate id=24 push t3, push t4 &lt;|@</code></pre>\n<p>There is only one simulate instruction, and the state is: <code>stack = [t3, t4]</code>.\n(Sorry ignoring the local variables for this blog post).\nThus, the deoptimizer needs to put the values of the <code>t3</code> and <code>t4</code> instructions\ninto the stack slots. This information was stored ahead of time, and will be\nlooked up right when deoptimizing the code. Here, <code>t3</code> was in the <code>[sp + 24]</code>\nstack slot in the optimized code, and <code>t4</code> was in <code>rax</code>. This process is called\na &quot;frame translation&quot;. Afterwards the execution will be redirected to the\nunoptimized code, which will just continue operating on the values at the place\nwhere the optimized code has been &quot;deoptimized&quot;.</p>\n<h2 id=\"conclusion\" tabindex=\"-1\">Conclusion <a class=\"header-anchor\" href=\"https://darksi.de/a.deoptimize-me-not/\">#</a></h2>\n<p>The &quot;deoptimizer&quot; is really an interesting tool, and it is one of the main\ncogs in <a href=\"http://blog.chromium.org/2010/12/new-crankshaft-for-v8.html\">Crankshaft</a>'s engine. This instrument helps the compiler in\nexecuting the dynamic-language code as if it had been written in C++, because\nit can always return to the slow unoptimized code with &quot;true&quot; JavaScript\nsemantics.</p>\n<p><em>Note that things are a bit more tricky with inlined functions, but this is a\ntopic for another blog post.</em></p>\n<p><em>Big kudos to</em>:</p>\n<ul>\n<li><em>Vyacheslav Egorov</em></li>\n<li><em>Ben Noordhuis</em></li>\n<li><em>Jeremiah Senkpiel</em></li>\n</ul>\n<p><em>for proof-reading this and providing valuable feedback.</em></p>\n",
			"date_published": "2014-12-15T00:00:00Z"
		}
		,
		{
			"id": "https://darksi.de/9.heartbleed/",
			"url": "https://darksi.de/9.heartbleed/",
			"title": "Cracking Cloudflare&#39;s heartbleed challenge",
			"content_html": "<h2 id=\"challenge\" tabindex=\"-1\">Challenge <a class=\"header-anchor\" href=\"https://darksi.de/9.heartbleed/\">#</a></h2>\n<p>At April 11th 2014 Cloudflare has published a <a href=\"http://blog.cloudflare.com/answering-the-critical-question-can-you-get-private-ssl-keys-using-heartbleed\">blog post</a> suggesting to\ntry out extracting a private key of their specially prepared\n<a href=\"https://www.cloudflarechallenge.com/heartbleed\">challenge site</a> using the <a href=\"http://heartbleed.com/\">Heartbleed</a> OpenSSL vulnerability. Being busy\nat the time, I decided to give it a try a couple of hours later, if noone would\ncrack it yet. This was a legal way to do some hackery, after all!</p>\n<h2 id=\"method\" tabindex=\"-1\">Method <a class=\"header-anchor\" href=\"https://darksi.de/9.heartbleed/\">#</a></h2>\n<p>The method of attack was following:</p>\n<ol>\n<li>Send a lot of random-sized fake heartbeats (without body)</li>\n<li>Try to find a 128-byte prime factor of the certificate's <a href=\"http://en.wikipedia.org/wiki/RSA_(cryptosystem)#Key_generation\">modulus</a></li>\n<li>Generate the rest of the private key's parameters out of it</li>\n</ol>\n<p>I wasn't searching for a PEM-encoded private key and/or:</p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">-----BEGIN RSA PRIVATE KEY-----</code></pre>\n<p>for a couple of reasons:</p>\n<ul>\n<li>It is loaded only at the process startup</li>\n<li>The key may be encrypted, and there is no point in brute forcing it</li>\n</ul>\n<p>According to my tests, DER-encoded key wasn't appearing in the memory either, so\ntrying to extract primes that are definitely in memory seem more feasible,\nbecause they are stored in the following struct in OpenSSL:</p>\n<pre class=\"language-c\" tabindex=\"0\"><code class=\"language-c\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">rsa_st</span><br>  <span class=\"token punctuation\">{</span><br>  <span class=\"token comment\">/* The first parameter is used to pickup errors where<br>   * this is passed instead of aEVP_PKEY, it is set to 0 */</span><br>  <span class=\"token keyword\">int</span> pad<span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">long</span> version<span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">const</span> RSA_METHOD <span class=\"token operator\">*</span>meth<span class=\"token punctuation\">;</span><br>  <span class=\"token comment\">/* functional reference if 'meth' is ENGINE-provided */</span><br>  ENGINE <span class=\"token operator\">*</span>engine<span class=\"token punctuation\">;</span><br>  BIGNUM <span class=\"token operator\">*</span>n<span class=\"token punctuation\">;</span><br>  BIGNUM <span class=\"token operator\">*</span>e<span class=\"token punctuation\">;</span><br>  BIGNUM <span class=\"token operator\">*</span>d<span class=\"token punctuation\">;</span><br>  BIGNUM <span class=\"token operator\">*</span>p<span class=\"token punctuation\">;</span><br>  BIGNUM <span class=\"token operator\">*</span>q<span class=\"token punctuation\">;</span><br>  BIGNUM <span class=\"token operator\">*</span>dmp1<span class=\"token punctuation\">;</span><br>  BIGNUM <span class=\"token operator\">*</span>dmq1<span class=\"token punctuation\">;</span><br>  BIGNUM <span class=\"token operator\">*</span>iqmp<span class=\"token punctuation\">;</span><br>  <span class=\"token comment\">/* be careful using this if the RSA structure is shared */</span><br>  CRYPTO_EX_DATA ex_data<span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">int</span> references<span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">int</span> flags<span class=\"token punctuation\">;</span><br><br>  <span class=\"token comment\">/* Used to cache montgomery values */</span><br>  BN_MONT_CTX <span class=\"token operator\">*</span>_method_mod_n<span class=\"token punctuation\">;</span><br>  BN_MONT_CTX <span class=\"token operator\">*</span>_method_mod_p<span class=\"token punctuation\">;</span><br>  BN_MONT_CTX <span class=\"token operator\">*</span>_method_mod_q<span class=\"token punctuation\">;</span><br><br>  <span class=\"token comment\">/* all BIGNUM values are actually in the following data, if it is not<br>   * NULL */</span><br>  <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>bignum_data<span class=\"token punctuation\">;</span><br>  BN_BLINDING <span class=\"token operator\">*</span>blinding<span class=\"token punctuation\">;</span><br>  BN_BLINDING <span class=\"token operator\">*</span>mt_blinding<span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre>\n<p>Where <code>BIGNUM</code> is:</p>\n<pre class=\"language-c\" tabindex=\"0\"><code class=\"language-c\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">bignum_st</span><br>  <span class=\"token punctuation\">{</span><br>  BN_ULONG <span class=\"token operator\">*</span>d<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* Pointer to an array of 'BN_BITS2' bit chunks. */</span><br>  <span class=\"token keyword\">int</span> top<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* Index of last used d +1. */</span><br>  <span class=\"token comment\">/* The next are internal book keeping for bn_expand. */</span><br>  <span class=\"token keyword\">int</span> dmax<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* Size of the d array. */</span><br>  <span class=\"token keyword\">int</span> neg<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* one if the number is negative */</span><br>  <span class=\"token keyword\">int</span> flags<span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre>\n<p>And <code>d</code> field of <code>BIGNUM</code> is a pointer to a little-endian representation of the\nnumber. Note that I could have been searching for a <code>dmp1</code>, <code>dmpq1</code> or <code>iqmp</code> as\nwell, but I was too lame at the time to put this in my tests.</p>\n<h2 id=\"implementation\" tabindex=\"-1\">Implementation <a class=\"header-anchor\" href=\"https://darksi.de/9.heartbleed/\">#</a></h2>\n<p>Being a node.js core developer, the platform choice for the extraction script\nwas obvious to me. Unfortunately, since node.js is embedding OpenSSL and\nexposing only some limited amount of methods as a JavaScript API, the\n<a href=\"https://github.com/indutny/heartbleed/blob/master/node-v0.10.26.patch\">patch to add fake heartbeat methods</a> was needed. (Update: patch is no longer\nneeded, just install module from npm).</p>\n<p>Having this at hand, the implementation was almost straightforward. It is\navailable as an <a href=\"https://github.com/indutny/heartbleed\">OpenSource project on github</a> now. Here are instructions for\nobtaining and using it:</p>\n<pre class=\"language-bash\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"token comment\"># Update: patch is no longer needed, just install module from npm</span><br><span class=\"token function\">git</span> clone git://github.com/indutny/heartbleed<br><span class=\"token function\">git</span> clone git://github.com/joyent/node <span class=\"token parameter variable\">-b</span> v0.10.26 node-hb<br><span class=\"token builtin class-name\">cd</span> node-hb<br><span class=\"token function\">git</span> apply <span class=\"token punctuation\">..</span>/heartbleed/node-v0.10.26.patch<br>./configure <span class=\"token parameter variable\">--prefix</span><span class=\"token operator\">=</span><span class=\"token environment constant\">$HOME</span>/.node/0.10.26-hb<br><span class=\"token function\">make</span> <span class=\"token parameter variable\">-j24</span> <span class=\"token function\">install</span><br><span class=\"token function\">ls</span> ./node<br><br><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token environment constant\">$HOME</span>/.node/0.10.26-hb/bin:<span class=\"token environment constant\">$PATH</span>\"</span><br><br><span class=\"token comment\"># Here it goes</span><br><span class=\"token function\">npm</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-g</span> heartbleed.js<br><br>heartbleed <span class=\"token parameter variable\">-h</span> cloudflarechallenge.com <span class=\"token parameter variable\">-c</span> <span class=\"token number\">1000</span> <span class=\"token operator\">>></span> key.pem</code></pre>\n<p>Note that it won't produce any result immediately, it took me 3 hours and a\ncertain amount of luck to obtain the key in a Cloudflare's challenge.</p>\n",
			"date_published": "2014-04-16T00:00:00Z"
		}
		,
		{
			"id": "https://darksi.de/8.bud-a-tls-swiss-knife/",
			"url": "https://darksi.de/8.bud-a-tls-swiss-knife/",
			"title": "Bud - a TLS &quot;swiss knife&quot;",
			"content_html": "<h2 id=\"bud\" tabindex=\"-1\">Bud <a class=\"header-anchor\" href=\"https://darksi.de/8.bud-a-tls-swiss-knife/\">#</a></h2>\n<p>To terminate TLS or not? Good question, but instead of answering it - I'll try\nto make you believe that if you need a TLS terminator - the <a href=\"http://github.com/indutny/bud\">Bud</a> is just\nthe right choice.</p>\n<h2 id=\"other-choices\" tabindex=\"-1\">Other choices <a class=\"header-anchor\" href=\"https://darksi.de/8.bud-a-tls-swiss-knife/\">#</a></h2>\n<p>Certainly, there are some other choices for TLS termination like:</p>\n<ul>\n<li><a href=\"https://github.com/voxer/stud\">stud</a></li>\n<li><a href=\"http://www.stunnel.org/\">stunnel</a></li>\n<li><a href=\"http://nginx.org/\">nginx</a> (though, not only a TLS terminator, but a web server too)</li>\n<li><a href=\"http://haproxy.1wt.eu/\">haproxy</a> (much more than just a TLS terminator, but quite good!)</li>\n<li>...probably some others?</li>\n</ul>\n<p>However, in many cases <a href=\"http://github.com/indutny/bud\">bud</a> could do their job as well as they do and also\nprovide some unique features.</p>\n<h2 id=\"features\" tabindex=\"-1\">Features <a class=\"header-anchor\" href=\"https://darksi.de/8.bud-a-tls-swiss-knife/\">#</a></h2>\n<h3 id=\"speed\" tabindex=\"-1\">Speed <a class=\"header-anchor\" href=\"https://darksi.de/8.bud-a-tls-swiss-knife/\">#</a></h3>\n<p>Bud is as fast as all of it rivals, here are comparison of it to <a href=\"https://github.com/voxer/stud\">stud</a>:</p>\n<p>Normal response:</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/QmnPUk4SPb-661.avif 661w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/QmnPUk4SPb-661.webp 661w\"><img alt=\"Normal RPS\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/QmnPUk4SPb-661.png\" width=\"661\" height=\"375\"></picture>\n<picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/1qCqcQP_Ga-663.avif 663w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/1qCqcQP_Ga-663.webp 663w\"><img alt=\"Normal Response\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/1qCqcQP_Ga-663.png\" width=\"663\" height=\"374\"></picture></p>\n<p>Big response:</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/_675-jDdym-655.avif 655w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/_675-jDdym-655.webp 655w\"><img alt=\"Big RPS\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/_675-jDdym-655.png\" width=\"655\" height=\"399\"></picture>\n<picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/Bge6f3HPKv-661.avif 661w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/Bge6f3HPKv-661.webp 661w\"><img alt=\"Big Response\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/Bge6f3HPKv-661.png\" width=\"661\" height=\"489\"></picture></p>\n<h3 id=\"asynchronous-sni-and-balancing\" tabindex=\"-1\">Asynchronous SNI and balancing <a class=\"header-anchor\" href=\"https://darksi.de/8.bud-a-tls-swiss-knife/\">#</a></h3>\n<p>This is a killer feature for any serious PaaS offering an HTTPS access to the\nhosted applications. When enabled in configuration, on every incoming request\nbud will do an http query to receive a TLS certificate/key pair and an address\nof the backend to which this connection should be balanced.</p>\n<p>See <a href=\"https://github.com/indutny/bud#sni-storage\">docs</a> for details.</p>\n<h3 id=\"asynchronous-ocsp-stapling\" tabindex=\"-1\">Asynchronous OCSP stapling <a class=\"header-anchor\" href=\"https://darksi.de/8.bud-a-tls-swiss-knife/\">#</a></h3>\n<p>The same kind of thing could be used to perform <a href=\"http://en.wikipedia.org/wiki/OCSP_stapling\">OCSP stapling</a>\nasynchronously, which is pretty useful if certificates are loaded dynamically\nand it isn't possible to store all of them in memory.</p>\n<p>See <a href=\"https://github.com/indutny/bud#ocsp-stapling\">docs</a> for more details.</p>\n<p>All that asynchronous APIs are JSON based, so replying to such requests is as\neasy as possible for almost any platform (including node.js).</p>\n<h3 id=\"x-forwarded-for\" tabindex=\"-1\">X-Forwarded-For <a class=\"header-anchor\" href=\"https://darksi.de/8.bud-a-tls-swiss-knife/\">#</a></h3>\n<p>The latest feature that I have implemented so far is an <code>x-forward</code> backend\noption. When enabled, bud will add <code>X-Forwarded-For</code> header to the first request\nof all incoming HTTP connections and send custom <code>X_FORWARD</code> frame for all\n<a href=\"http://en.wikipedia.org/wiki/SPDY\">SPDY</a> connections.</p>\n<p>This custom <code>X_FORWARD</code> frame is already supported in <a href=\"https://www.npmjs.org/package/spdy\">node-spdy@1.25.0</a> and\nwill automatically add <code>X-Forwarded-For</code> header to all requests on that SPDY\nconnection.</p>\n<p>The main pros of this method is that no actual protocol parsing is happening.\nThe cons is that, in case of HTTP protocol, only first request gets this header\nadded. This could be worked around by checking this header on incoming request\nand associating it with a underlying socket (<code>req.socket</code> in node.js.)</p>\n<h2 id=\"try-it-out\" tabindex=\"-1\">Try it out! <a class=\"header-anchor\" href=\"https://darksi.de/8.bud-a-tls-swiss-knife/\">#</a></h2>\n<p>Hearing all that awesome things - you may become interested in giving it a try,\nthanks to <a href=\"https://npmjs.org/\">npm</a> it is quite simple:</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-g</span> bud-tls</code></pre>\n<p>Generating a configuration is easy too:</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\">bud --default-config <span class=\"token operator\">></span> config.json<br><span class=\"token function\">vim</span> config.json</code></pre>\n<p>All this options are documented in the <a href=\"https://github.com/indutny/bud#bud-\">project's readme</a>.</p>\n<p>Just in case, this blog is running behind <a href=\"http://github.com/indutny/bud\">bud</a>!</p>\n<h2 id=\"reporting-issues\" tabindex=\"-1\">Reporting issues <a class=\"header-anchor\" href=\"https://darksi.de/8.bud-a-tls-swiss-knife/\">#</a></h2>\n<p>Something does not work as expected or just crashes? Please do not hesitate to\nreport it on <a href=\"https://github.com/indutny/bud/issues\">github issues</a>.</p>\n",
			"date_published": "2014-04-03T00:00:00Z"
		}
		,
		{
			"id": "https://darksi.de/7.freebsd-dtrace/",
			"url": "https://darksi.de/7.freebsd-dtrace/",
			"title": "Running node.js + DTrace on FreeBSD",
			"content_html": "<h2 id=\"preface\" tabindex=\"-1\">Preface <a class=\"header-anchor\" href=\"https://darksi.de/7.freebsd-dtrace/\">#</a></h2>\n<p>Tracing node.js activity and detecting performance problems and bottlenecks\nhas always been an important topic for many people in the community. Though,\nvarious ways to do this were available, including: systemtap, ETW and perfctr on\nWindows. The most complete tracing support was done by Joyent guys for the\nDTrace tool which works best on their <a href=\"http://wiki.illumos.org/display/illumos/illumos+Home\">Illumos</a> fork, called <a href=\"http://smartos.org/\">SmartOS</a>.</p>\n<p>Fortunately, since 9.0 version, FreeBSD maintainers have started fixing and\ntweaking their DTrace implementation too (which is actually a backport from\nSolaris). Considering that FreeBSD is much easier to install and is much\nmore usable as a primary OS for developers, being able to do flamegraphs for\nnode.js on it is something that I highly desired at the time.</p>\n<h2 id=\"what-was-broken\" tabindex=\"-1\">What was broken <a class=\"header-anchor\" href=\"https://darksi.de/7.freebsd-dtrace/\">#</a></h2>\n<p>Sadly, it wasn't working out-of-the-box. After the installation of FreeBSD in a\nVirtualBox has finished, I immediately tried to build and dtrace node with a\n<code>jstack()</code> utility (see my previous <a href=\"https://darksi.de/3.dtrace-ustack-helper\">blog post</a> on that topic), but it did\nnot work out. After some struggling it became obvious that <code>/dev/dtrace/helper</code>\nhas pretty narrow permissions and the node, running under non-root user, wasn't\nable to register itself within the system's DTrace module.</p>\n<p>Calling <code>sudo chmod 666 /dev/dtrace/helper</code> improved the situation, but not that\nmuch: version 0.11 of node.js was crashing, and version v0.10 was still not\nregistering it's ustack helper and DTrace provider (see <a href=\"http://www.solarisinternals.com/wiki/index.php/DTrace_Topics_USDT#USDT\">USDT</a> docs). This\nproblem was a bit tougher than the helper permissions, and took awhile to fix.</p>\n<h2 id=\"how-node-interacts-with-dtrace\" tabindex=\"-1\">How node interacts with DTrace <a class=\"header-anchor\" href=\"https://darksi.de/7.freebsd-dtrace/\">#</a></h2>\n<p>First of all, a bit of information about how node.js compiles it's DTrace\nhelpers and how they are used by the system. There were <a href=\"http://www.bsdcan.org/2008/schedule/attachments/60_dtrace_bsdcan.pdf\">some slides</a> on that\ntopic (how DTrace USDT interacts with kernel), but at that moment I figured it\nout by reading the implementation's source.</p>\n<p>There are two <code>.d</code> files in the node.js source tree: <code>src/node_provider.d</code> and\n<code>src/v8ustack.d</code>. The former declares a <code>node</code> DTrace USDT provider and the\nlatter exports an ustack helper Both of these files are compiled with\n<code>dtrace -G -s &lt;file.d&gt; -o &lt;out.o&gt;</code>, which in fact does the following thing:</p>\n<ol>\n<li>Compile all D-language chunks into DIFs (<a href=\"https://github.com/freebsd/freebsd/blob/3ecc6f129801776dd571d69cf9a262a97ad23968/sys/cddl/contrib/opensolaris/uts/common/sys/dtrace.h#L112\">DTrace Intermediate Format</a></li>\n<li>Encode them in the DOF (<a href=\"https://github.com/freebsd/freebsd/blob/3ecc6f129801776dd571d69cf9a262a97ad23968/sys/cddl/contrib/opensolaris/uts/common/sys/dtrace.h#L570\">DTrace Object File</a>) format</li>\n<li>Put them into the special <code>._SUNW_dof</code> ELF section</li>\n<li>Link it to the internally-stored <code>drti.o</code>, providing <code>dtrace_dof_init</code> and\n<code>dtrace_dof_fini</code> helper functions.</li>\n</ol>\n<p>These functions are called on the executable's initialization and\ndeinitialization (surprisingly!), each making an <code>ioctl()</code> syscall on the\n<code>/dev/dtrace/helper</code>. Specifically, <code>dtrace_dof_init()</code> loads and verifies the\n<code>._SUNW_dof</code> section of an ELF-file and registers it with-in the kernel.</p>\n<h2 id=\"how-i-fixed-it\" tabindex=\"-1\">How I fixed it <a class=\"header-anchor\" href=\"https://darksi.de/7.freebsd-dtrace/\">#</a></h2>\n<p>I decided to investigate the node.js v0.11 crashes. It was crashing on a\n<a href=\"https://github.com/freebsd/freebsd/blob/4d784918edbf9aefbab5ab12e4701d3104c3ff45/cddl/contrib/opensolaris/lib/libdtrace/common/drti.c#L110\">this line</a>, so it was either an ELF symbol problem or a DOF string\nproblem. Initially, I found that the DOF did not contain the STRTAB section\nthat <code>dtri.o</code> was searching for, but it turned out to be a slightly bigger\nproblem. Since node.js has two separate <code>.d</code> files, it has two DOFs for\neach of them in it's <code>._SUNW_dof</code> section, but the <code>drti.o</code> was loading only\none! After all I came up with a following patch:</p>\n<pre class=\"language-diff\" tabindex=\"0\"><code class=\"language-diff\">commit c46786f47483e7fc218727aa52cf6b2278a45053<br>Author: Fedor Indutny &lt;fedor.indutny@gmail.com><br>Date:   Mon Feb 17 01:16:13 2014 +0400<br><br><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span><span class=\"token line\">   dtrace: proper symbol fixup and import in drti<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">   <br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">   Application may contain multiple DOFs, merged into one ._SUNW_dof ELF<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">   section. Process all of them and fix symbols only in those ones that<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">   actaully define a provider. Use proper strtab for resolving symbols.<br></span></span><br>diff --git a/cddl/contrib/opensolaris/lib/libdtrace/common/drti.c b/cddl/contrib/opensolaris/lib/libdtrace/common/drti.c<br>index 3b4a38c..e47cfb4d 100644<br><span class=\"token coord\">--- a/cddl/contrib/opensolaris/lib/libdtrace/common/drti.c</span><br><span class=\"token coord\">+++ b/cddl/contrib/opensolaris/lib/libdtrace/common/drti.c</span><br><span class=\"token coord\">@@ -20,6 +20,7 @@</span><br><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span><span class=\"token line\"> */<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">/*<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\"> * Copyright 2008 Sun Microsystems, Inc.  All rights reserved.<br></span></span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span><span class=\"token line\"> * Copyright 2013 Voxer Inc. All rights reserved.<br></span></span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span><span class=\"token line\"> * Use is subject to license terms.<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\"> */<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\"><br></span></span>@@ -144,7 +145,8 @@ dtrace_dof_init(void)<br><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\tLmid_t lmid;<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">#else<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\tu_long lmid = 0;<br></span></span><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span><span class=\"token line\">\tdof_sec_t *sec;<br></span></span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span><span class=\"token line\">\tdof_sec_t *sec, *secstart, *dofstrtab, *dofprobes;<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\tdof_provider_t *dofprovider;<br></span></span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\tsize_t i;<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">#endif<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\tint fd;<br></span></span>@@ -152,12 +154,13 @@ dtrace_dof_init(void)<br><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span><span class=\"token line\">#if !defined(sun)<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\tElf *e;<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\tElf_Scn *scn = NULL;<br></span></span><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span><span class=\"token line\">\tElf_Data *symtabdata = NULL, *dynsymdata = NULL;<br></span></span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span><span class=\"token line\">\tElf_Data *symtabdata = NULL, *dynsymdata = NULL, *dofdata = NULL;<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\tdof_hdr_t *dof_next = NULL;<br></span></span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\tGElf_Shdr shdr;<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\tint efd, nprobes;<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\tchar *s;<br></span></span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span><span class=\"token line\">\tchar *dofstrtabraw;<br></span></span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\tsize_t shstridx, symtabidx = 0, dynsymidx = 0;<br></span></span><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span><span class=\"token line\">\tunsigned char *dofstrtab = NULL;<br></span></span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\tunsigned char *buf;<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\tint fixedprobes = 0;<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">#endif<br></span></span>@@ -209,7 +212,9 @@ dtrace_dof_init(void)<br><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\t\t} else if (shdr.sh_type == SHT_PROGBITS) {<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\t\t\ts = elf_strptr(e, shstridx, shdr.sh_name);<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\t\t\tif  (s &amp;&amp; strcmp(s, \".SUNW_dof\") == 0) {<br></span></span><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span><span class=\"token line\">\t\t\t\tdof = elf_getdata(scn, NULL)->d_buf;<br></span></span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t\t\tdofdata = elf_getdata(scn, NULL);<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t\t\tdof = dofdata->d_buf;<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t\t\tbreak;<br></span></span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\t\t\t}<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\t\t}<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\t}<br></span></span>@@ -219,6 +224,9 @@ dtrace_dof_init(void)<br><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\t\tclose(efd);<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\t\treturn;<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\t}<br></span></span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span><span class=\"token line\"><br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\twhile ((char *) dof &lt; (char *) dofdata->d_buf + dofdata->d_size) {<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\tdof_next = (void *) ((char *) dof + dof->dofh_filesz);<br></span></span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span><span class=\"token line\">#endif<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\"><br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\tif (dof->dofh_ident[DOF_ID_MAG0] != DOF_MAG_MAG0 ||<br></span></span>@@ -290,34 +298,49 @@ dtrace_dof_init(void)<br><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\t * We are assuming the number of probes is less than the number of<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\t * symbols (libc can have 4k symbols, for example).<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\t */<br></span></span><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span><span class=\"token line\">\tsec = (dof_sec_t *)(dof + 1);<br></span></span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span><span class=\"token line\">\tsecstart = sec = (dof_sec_t *)(dof + 1);<br></span></span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\tbuf = (char *)dof;<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\tfor (i = 0; i &lt; dof->dofh_secnum; i++, sec++) {<br></span></span><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span><span class=\"token line\">\t\tif (sec->dofs_type == DOF_SECT_STRTAB)<br></span><span class=\"token prefix deleted\">-</span><span class=\"token line\">\t\t\tdofstrtab = (unsigned char *)(buf + sec->dofs_offset);<br></span><span class=\"token prefix deleted\">-</span><span class=\"token line\">\t\telse if (sec->dofs_type == DOF_SECT_PROBES &amp;&amp; dofstrtab)<br></span></span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\tif (sec->dofs_type != DOF_SECT_PROVIDER)<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t\tcontinue;<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\"><br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\tdofprovider = (void *) (buf + sec->dofs_offset);<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\tdofstrtab = secstart + dofprovider->dofpv_strtab;<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\tdofprobes = secstart + dofprovider->dofpv_probes;<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\"><br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\tif (dofstrtab->dofs_type != DOF_SECT_STRTAB) {<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t\tfprintf(stderr, \"WARNING: expected STRTAB section, but got %d\\n\",<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t\t\t\tdofstrtab->dofs_type);<br></span></span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\t\t\tbreak;<br></span></span><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span><span class=\"token line\">\t<br></span><span class=\"token prefix deleted\">-</span><span class=\"token line\">\t}<br></span><span class=\"token prefix deleted\">-</span><span class=\"token line\">\tnprobes = sec->dofs_size / sec->dofs_entsize;<br></span><span class=\"token prefix deleted\">-</span><span class=\"token line\">\tfixsymbol(e, symtabdata, symtabidx, nprobes, buf, sec, &amp;fixedprobes,<br></span><span class=\"token prefix deleted\">-</span><span class=\"token line\">\t    dofstrtab);<br></span><span class=\"token prefix deleted\">-</span><span class=\"token line\">\tif (fixedprobes != nprobes) {<br></span><span class=\"token prefix deleted\">-</span><span class=\"token line\">\t\t/*<br></span><span class=\"token prefix deleted\">-</span><span class=\"token line\">\t\t * If we haven't fixed all the probes using the<br></span><span class=\"token prefix deleted\">-</span><span class=\"token line\">\t\t * symtab section, look inside the dynsym<br></span><span class=\"token prefix deleted\">-</span><span class=\"token line\">\t\t * section.<br></span><span class=\"token prefix deleted\">-</span><span class=\"token line\">\t\t */<br></span><span class=\"token prefix deleted\">-</span><span class=\"token line\">\t\tfixsymbol(e, dynsymdata, dynsymidx, nprobes, buf, sec,<br></span><span class=\"token prefix deleted\">-</span><span class=\"token line\">\t\t    &amp;fixedprobes, dofstrtab);<br></span><span class=\"token prefix deleted\">-</span><span class=\"token line\">\t}<br></span><span class=\"token prefix deleted\">-</span><span class=\"token line\">\tif (fixedprobes != nprobes) {<br></span><span class=\"token prefix deleted\">-</span><span class=\"token line\">\t\tfprintf(stderr, \"WARNING: number of probes \"<br></span><span class=\"token prefix deleted\">-</span><span class=\"token line\">\t\t    \"fixed does not match the number of \"<br></span><span class=\"token prefix deleted\">-</span><span class=\"token line\">\t\t    \"defined probes (%d != %d, \"<br></span><span class=\"token prefix deleted\">-</span><span class=\"token line\">\t\t    \"respectively)\\n\", fixedprobes, nprobes);<br></span><span class=\"token prefix deleted\">-</span><span class=\"token line\">\t\tfprintf(stderr, \"WARNING: some probes might \"<br></span><span class=\"token prefix deleted\">-</span><span class=\"token line\">\t\t    \"not fire or your program might crash\\n\");<br></span></span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t}<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\tif (dofprobes->dofs_type != DOF_SECT_PROBES) {<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t\tfprintf(stderr, \"WARNING: expected PROBES section, but got %d\\n\",<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t\t    dofprobes->dofs_type);<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t\tbreak;<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t}<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\"><br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\tdprintf(1, \"found provider %p\\n\", dofprovider);<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\tdofstrtabraw = (char *)(buf + dofstrtab->dofs_offset);<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\tnprobes = dofprobes->dofs_size / dofprobes->dofs_entsize;<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\tfixsymbol(e, symtabdata, symtabidx, nprobes, buf, dofprobes, &amp;fixedprobes,<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t\t\tdofstrtabraw);<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\tif (fixedprobes != nprobes) {<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t\t/*<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t\t * If we haven't fixed all the probes using the<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t\t * symtab section, look inside the dynsym<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t\t * section.<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t\t */<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t\tfixsymbol(e, dynsymdata, dynsymidx, nprobes, buf, dofprobes,<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t\t\t\t&amp;fixedprobes, dofstrtabraw);<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t}<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\tif (fixedprobes != nprobes) {<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t\tfprintf(stderr, \"WARNING: number of probes \"<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t\t    \"fixed does not match the number of \"<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t\t    \"defined probes (%d != %d, \"<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t\t    \"respectively)\\n\", fixedprobes, nprobes);<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t\tfprintf(stderr, \"WARNING: some probes might \"<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t\t    \"not fire or your program might crash\\n\");<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t}<br></span></span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\t}<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">#endif<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\tif ((gen = ioctl(fd, DTRACEHIOC_ADDDOF, &amp;dh)) == -1)<br></span></span>@@ -330,7 +353,12 @@ dtrace_dof_init(void)<br><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\t}<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\"><br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\t(void) close(fd);<br></span></span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span><span class=\"token line\"><br></span></span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span><span class=\"token line\">#if !defined(sun)<br></span></span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\t/* End of while loop */<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t\tdof = dof_next;<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\">\t}<br></span><span class=\"token prefix inserted\">+</span><span class=\"token line\"><br></span></span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\telf_end(e);<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">\t(void) close(efd);<br></span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">#endif</span></span></code></pre>\n<p>Although, node.js v0.11 has stopped crashing after applying it to the kernel\nsource code and rebuilding <code>libdtrace</code>, it still wasn't registering an ustack\nhelper and a provider (<code>sudo dtrace -l</code> did not contain any\n<code>node&lt;pid&gt;:::</code> probes).</p>\n<p>While reading <a href=\"https://github.com/freebsd/freebsd/blob/4d784918edbf9aefbab5ab12e4701d3104c3ff45/cddl/contrib/opensolaris/lib/libdtrace/common/drti.c#L52\">FreeBSD's source code</a> further, I found an environment\nvariable <code>DTRACE_DOF_INIT_DEBUG</code> that helped me to take a deeper look into\nwhat was happening for both node.js v0.10 and v0.11. After setting it to\n<code>DTRACE_DOF_INIT_DEBUG=1</code> node.js has started printing following things to the\nstderr:</p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">dtrace DOF node: DTrace ioctl failed for DOF at 0x804c00000:<br>Argument list too long</code></pre>\n<p>This was totally uninformative, and I started grepping through a DTrace kernel\nmodule with a hope to find some clues to this errors. <code>Argument list too long</code>\nis a verbose description of the <code>E2BIG</code> errno, and luckily the <a href=\"https://github.com/freebsd/freebsd/blob/3ecc6f129801776dd571d69cf9a262a97ad23968/sys/cddl/contrib/opensolaris/uts/common/dtrace/dtrace.c#L11989\">first place</a>\nwhere it is used was the place that I needed to fix. Basically, for the security\npurpose kernel limits the size of the DOF that could be loaded in it's memory.\nThis limit is set to the 128 KB by default, and the node.js now has\nsignificantly bigger ustack helper (7 MB for v0.11). Instead of just raising it\nto a higher value, I decided to export <code>sysctl</code> variable to make it configurable\nwithout rebuilding the kernel. Running node again after this tweaks gave me:</p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">dtrace DOF node: DTrace ioctl failed for DOF at 0x804c00000:<br>Invalid argument</code></pre>\n<p>This failure was even more vague, since it meant that the <code>EINVAL</code> was returned\nsomewhere, and there was tons of places where it could have happened. After\ninserting tons of debug prints in all possible places in kernel, I have isolated\nit down to <a href=\"https://github.com/freebsd/freebsd/blob/3ecc6f129801776dd571d69cf9a262a97ad23968/sys/cddl/contrib/opensolaris/uts/common/dtrace/dtrace.c#L12462\">this place</a>. Indeed, both of node DOFs contained a lot of\nactions and the default limit (16 * 1024) was way to small for it. Exporting\nanother sysctl variable has solved all problems and running node.js has finally\nprinted this:</p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">dtrace DOF node: DTrace ioctl succeeded for DOF at 0x8052c2c2c<br>dtrace DOF node: DTrace ioctl succeeded for DOF at 0x804c00000<br>dtrace DOF node: found provider 0x8052c3000</code></pre>\n<p>Just to confirm it, I checked the <code>dtrace -l</code> output and (yikes!) it was there\ntoo:</p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">48986 node909 node ... gc-done<br>48987 node909 node ... gc-start<br>48988 node909 node ... http-client-request<br>48989 node909 node ... http-client-response<br>48990 node909 node ... http-server-request<br>48991 node909 node ... http-server-response<br>48992 node909 node ... net-server-connection<br>48993 node909 node ... net-socket-read<br>48994 node909 node ... net-socket-write<br>48995 node909 node ... net-stream-end</code></pre>\n<h2 id=\"how-to-apply-all-this-patches\" tabindex=\"-1\">How to apply all this patches <a class=\"header-anchor\" href=\"https://darksi.de/7.freebsd-dtrace/\">#</a></h2>\n<p>I have came up with <a href=\"https://github.com/indutny/freebsd/compare/release/10.0.0...feature/10.0-dtrace-patches\">this instruction</a> for fixing your FreeBSD installation\nto make node.js DTrace helpers work. Just a brief in-line description:</p>\n<ol>\n<li>Apply <a href=\"https://github.com/indutny/freebsd/compare/release/10.0.0...feature/10.0-dtrace-patches\">these patches</a> to <code>/usr/src</code></li>\n<li>Rebuild and install kernel:\n<code>sudo make buildkernel &amp;&amp; sudo make installkernel</code></li>\n<li>Reboot <code>sudo shutdown -r</code></li>\n<li>Raise sysctl limits:</li>\n</ol>\n<ul>\n<li><code>sudo sysctl -w kern.dtrace.helper_actions_max=16000</code></li>\n<li><code>sudo sysctl -w kern.dtrace.dof_maxsize=8000000</code></li>\n</ul>\n<ol start=\"5\">\n<li>Clone node.js:\n<code>git clone git://github.com/joyent/node &amp;&amp; cd node &amp;&amp; git checkout v0.10</code></li>\n<li>Configure it: <code>./configure --prefix=... --with-dtrace</code></li>\n<li>Build and install it: <code>gmake -j24 &amp;&amp; gmake install</code></li>\n<li>Make DTrace device accessible to non-root users:\n<code>sudo chmod 666 /dev/dtrace/helper</code></li>\n<li>Verify that node.js DTrace probes are inserted:\n<code>DTRACE_DOF_INIT_DEBUG=1 /path/to/node</code>.</li>\n</ol>\n<p>Thanks for reading this, and please let me know if any of these patches don't\nwork for you!</p>\n",
			"date_published": "2014-04-01T00:00:00Z"
		}
		,
		{
			"id": "https://darksi.de/6.smids-and-doubles/",
			"url": "https://darksi.de/6.smids-and-doubles/",
			"title": "SMIs and Doubles",
			"content_html": "<p>This is a third post in the series of the JIT compiling crash-course. For a\ncontext please consider reading <a href=\"https://darksi.de/4.how-to-start-jitting\">the first one</a> and <a href=\"https://darksi.de/5.allocating-numbers\">the second</a>.</p>\n<h2 id=\"goal\" tabindex=\"-1\">Goal <a class=\"header-anchor\" href=\"https://darksi.de/6.smids-and-doubles/\">#</a></h2>\n<p>Last time we created very basic bump memory allocator and made our existing\ncode work with floating point double numbers, stored in the allocated heap\nobjects. However floating point numbers are not suitable for some of\nprecision-dependent operations and also, since they are stored in memory,\nrequiring additional memory loads and stores, slowing down the code performance.</p>\n<p>Both of this problems could be solved by working with the integers stored in the\nregisters (as we did it in <a href=\"https://darksi.de/4.how-to-start-jitting\">first blog post</a>), which means that we will need\nto support both types of numbers in our compiler's runtime (doubles and\nintegers).</p>\n<h2 id=\"tagging\" tabindex=\"-1\">Tagging <a class=\"header-anchor\" href=\"https://darksi.de/6.smids-and-doubles/\">#</a></h2>\n<p>Let's recall that we are storing both pointers and numbers in the 64bit general\npurpose registers (<code>rax</code>, <code>rbx</code>, ...). The main issue here is that, given some\nregister (say <code>rax</code>), we should be able to tell if it is a pointer to the heap\nobject (a &quot;boxed value&quot;) or an integer itself (an &quot;unboxed value&quot;,\nSmall Integer, or <em>SMI</em>).</p>\n<p>Usually, a method called &quot;tagging&quot; is used to solve this. While there are\n<a href=\"http://wingolog.org/archives/2011/05/18/value-representation-in-javascript-implementations\">various ways</a> to implement tagging, including: <a href=\"http://evilpie.github.io/sayrer-fatval-backup/cache.aspx.htm\">Nan-Boxing</a> (scroll down\nto <em>Mozillas New JavaScript Value Representation</em>), Nun-Boxing, and probably\nsome others, our compiler will just reserve the least significant bit of the\n64bit register and put <code>1</code> here if the value is a pointer and <code>0</code> if it is a\n<em>SMI</em> (Small Integer).</p>\n<p>Here is an example of this representation:</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/FZYMic5DRc-352.avif 352w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/FZYMic5DRc-352.webp 352w\"><img alt=\"Smi and Pointer\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/FZYMic5DRc-352.png\" width=\"352\" height=\"202\"></picture></p>\n<p>Note that to get the actual value of a SMI (&quot;untag&quot;) we will need to shift it\nright for one bit (<code>&gt;&gt; 1</code>), and to convert an integer to the SMI - shift left\n(<code>&lt;&lt; 1</code>). Using zero for tagging SMIs pays off greatly, since we don't need to\nto untag numbers to perform addition and subtraction.</p>\n<p>To use tagged pointers to heap objects we'll need to look one byte behind the\nactual value, which is relatively simple in the assembly language:</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\"><span class=\"token comment\">// Lets say that tagged pointer is in rbx</span><br><span class=\"token comment\">// And we're loading its contents into the rax</span><br><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>And just for the convenience - example of untagging SMIs:</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\"><span class=\"token comment\">// Untag</span><br><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">shr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token comment\">// Tag</span><br><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">shl</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>And now the most important part that we're going to do a lot - checking if the\nvalue is a pointer:</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\"><span class=\"token comment\">// Test that 'rax' has the last bit</span><br><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br><span class=\"token comment\">// 'z' stands for zero</span><br><span class=\"token comment\">// Basically, jump to the label if `(rax &amp; 1) == 0`</span><br><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">j</span><span class=\"token punctuation\">(</span><span class=\"token string\">'z'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'is-smi'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br><span class=\"token comment\">// 'nz' stands for non-zero</span><br><span class=\"token comment\">// Basically, jump to the label if `(rax &amp; 1) != 0`</span><br><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">j</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ne'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'is-heap-object-pointer'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<h2 id=\"reworking-previous-code\" tabindex=\"-1\">Reworking previous code <a class=\"header-anchor\" href=\"https://darksi.de/6.smids-and-doubles/\">#</a></h2>\n<p>Using <a href=\"https://github.com/indutny/jit.js/tree/master/example/heap\">the code from the previous blog post</a>, we can finally proceed to\nimplementing all this recently learned stuff.</p>\n<p>First, let's add a convenient helper methods to the assembly context.</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">untagSmi</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">reg</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">shr</span><span class=\"token punctuation\">(</span>reg<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">checkSmi</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value<span class=\"token punctuation\">,</span> t<span class=\"token punctuation\">,</span> f</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token comment\">// If no `true-` and `false-` bodies were specified -</span><br>  <span class=\"token comment\">// just test the value.</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>t <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>f<span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token comment\">// Enter the scope to be able to use named labels</span><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">labelScope</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token comment\">// Test the value</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Skip SMI case if result is non-zero</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">j</span><span class=\"token punctuation\">(</span><span class=\"token string\">'nz'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'non-smi'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Run SMI case</span><br>    <span class=\"token function\">t</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Jump to the shared end</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">j</span><span class=\"token punctuation\">(</span><span class=\"token string\">'end'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Non-SMI case</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token string\">'non-smi'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token function\">f</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Shared end</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token string\">'end'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">heapOffset</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">reg<span class=\"token punctuation\">,</span> offset</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token comment\">// NOTE: 8 is the size of pointer on x64 arch.</span><br>  <span class=\"token comment\">// We're adding 1 to the offset, because first</span><br>  <span class=\"token comment\">// quad word is used to store the heap object's type.</span><br>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>reg<span class=\"token punctuation\">,</span> <span class=\"token number\">8</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>offset <span class=\"token operator\">|</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre>\n<p>We can hook this methods into the jit.js context by passing them as a <code>helpers</code>\noption to the <code>jit.compile()</code> API method:</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> helpers <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token literal-property property\">untagSmi</span><span class=\"token operator\">:</span> untagSmi<span class=\"token punctuation\">,</span><br>  <span class=\"token literal-property property\">checkSmi</span><span class=\"token operator\">:</span> checkSmi<span class=\"token punctuation\">,</span><br>  <span class=\"token literal-property property\">heapOffset</span><span class=\"token operator\">:</span> heapOffset<br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span><br><br>jit<span class=\"token punctuation\">.</span><span class=\"token function\">compile</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token comment\">// We can use helpers here:</span><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">untagSmi</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">checkSmi</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token comment\">// Work with SMI</span><br>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token comment\">// Work with pointer</span><br>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">heapOffset</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">stubs</span><span class=\"token operator\">:</span> stubs<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">helpers</span><span class=\"token operator\">:</span> helpers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<h2 id=\"allocation\" tabindex=\"-1\">Allocation <a class=\"header-anchor\" href=\"https://darksi.de/6.smids-and-doubles/\">#</a></h2>\n<p>Now we should make our <code>Alloc</code> stub return tagged pointer. Also we will use the\nopportunity and improve it a bit by adding <code>tag</code> and <code>size</code> arguments to the\nstub (thus making possible generalized allocation with variable size and tag\nin the future):</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\">stubs<span class=\"token punctuation\">.</span><span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Alloc'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">size<span class=\"token punctuation\">,</span> tag</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token comment\">// Save 'rbx' and 'rcx' registers</span><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">spill</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rcx'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token comment\">// Load `offset`</span><br>    <span class=\"token comment\">//</span><br>    <span class=\"token comment\">// NOTE: We'll use pointer to `offset` variable,</span><br>    <span class=\"token comment\">// to be able to update</span><br>    <span class=\"token comment\">// it below</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Load end</span><br>    <span class=\"token comment\">//</span><br>    <span class=\"token comment\">// NOTE: Same applies to end, though, we're</span><br>    <span class=\"token comment\">// not updating it right now</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>end<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Calculate new `offset`</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rcx'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rax'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Add tag size and body size</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rcx'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rcx'</span><span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Check if we won't overflow our fixed size buffer</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">cmp</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rcx'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rbx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// this.j() performs conditional jump to the specified label.</span><br>    <span class=\"token comment\">// 'g' stands for 'greater'</span><br>    <span class=\"token comment\">// 'overflow' is a label name, bound below</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">j</span><span class=\"token punctuation\">(</span><span class=\"token string\">'g'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'overflow'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Ok, we're good to go, update offset</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rcx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// First 64bit pointer is reserved for 'tag',</span><br>    <span class=\"token comment\">// second one is a `double` value</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rcx'</span><span class=\"token punctuation\">,</span> tag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rcx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// !!!!!!!!!!!!!!!</span><br>    <span class=\"token comment\">// ! Tag pointer !</span><br>    <span class=\"token comment\">// !!!!!!!!!!!!!!!</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">or</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Return 'rax'</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">Return</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Overflowed :(</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token string\">'overflow'</span><span class=\"token punctuation\">)</span><br><br>    <span class=\"token comment\">// Invoke javascript function!</span><br>    <span class=\"token comment\">// NOTE: This is really funky stuff, but I'm not</span><br>    <span class=\"token comment\">// going to dive deep into it right now</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">runtime</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'GC is needed, but not implemented'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Crash</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">int3</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">Return</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<h2 id=\"math-stubs\" tabindex=\"-1\">Math stubs <a class=\"header-anchor\" href=\"https://darksi.de/6.smids-and-doubles/\">#</a></h2>\n<p>Also, as we're going to do a bit more book-keeping in math operations to support\nboth SMIs and doubles, let's split it apart and put the code, handling doubles\ninto the stub:</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> operators <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'+'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'*'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><br><span class=\"token keyword\">var</span> map <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">'+'</span><span class=\"token operator\">:</span> <span class=\"token string\">'addsd'</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">'-'</span><span class=\"token operator\">:</span> <span class=\"token string\">'subsd'</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">'*'</span><span class=\"token operator\">:</span> <span class=\"token string\">'mulsd'</span><span class=\"token punctuation\">,</span><br>            <span class=\"token string-property property\">'/'</span><span class=\"token operator\">:</span> <span class=\"token string\">'divsd'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span><br><br><span class=\"token comment\">// Define `Binary+`, `Binary-`, `Binary*`, and `Binary/` stubs</span><br>operators<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">operator</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  stubs<span class=\"token punctuation\">.</span><span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Binary'</span> <span class=\"token operator\">+</span> operator<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">left<span class=\"token punctuation\">,</span> right</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token comment\">// Save 'rbx' and 'rcx'</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">spill</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rcx'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>      <span class=\"token comment\">// Load arguments to rax and rbx</span><br>      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> left<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">,</span> right<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>      <span class=\"token comment\">// Convert both numbers to doubles</span><br>      <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'xmm1'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'xmm2'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">regs</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">var</span> nonSmi <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">label</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token keyword\">var</span> done <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">label</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">checkSmi</span><span class=\"token punctuation\">(</span>regs<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">j</span><span class=\"token punctuation\">(</span><span class=\"token string\">'nz'</span><span class=\"token punctuation\">,</span> nonSmi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>        <span class=\"token comment\">// Convert integer to double</span><br>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">untagSmi</span><span class=\"token punctuation\">(</span>regs<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">cvtsi2sd</span><span class=\"token punctuation\">(</span>regs<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> regs<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">j</span><span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span>nonSmi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">movq</span><span class=\"token punctuation\">(</span>regs<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">heapOffset</span><span class=\"token punctuation\">(</span>regs<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>      <span class=\"token keyword\">var</span> instr <span class=\"token operator\">=</span> map<span class=\"token punctuation\">[</span>operator<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><br><br>      <span class=\"token comment\">// Execute binary operation</span><br>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>instr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">[</span>instr<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token string\">'xmm1'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'xmm2'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Unsupported binary operator: '</span> <span class=\"token operator\">+</span><br>                        operator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>      <span class=\"token punctuation\">}</span><br><br>      <span class=\"token comment\">// Allocate new number, and put value in it</span><br>      <span class=\"token comment\">// NOTE: Last two arguments are arguments to</span><br>      <span class=\"token comment\">// the stub (`size` and `tag`)</span><br>      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">stub</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Alloc'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">movq</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">heapOffset</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'xmm1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">Return</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>Note that this stub also converts all incoming numbers to doubles.</p>\n<h2 id=\"compiler\" tabindex=\"-1\">Compiler <a class=\"header-anchor\" href=\"https://darksi.de/6.smids-and-doubles/\">#</a></h2>\n<p>And back to the compiler's code:</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">visitProgram</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ast</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  assert<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span><br>               <span class=\"token number\">1</span><span class=\"token punctuation\">,</span><br>               <span class=\"token string\">'Only one statement programs are supported'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  assert<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">,</span> <span class=\"token string\">'ExpressionStatement'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token comment\">// We've a pointer in 'rax', convert it to integer</span><br>  <span class=\"token function\">visit</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> ast<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>expression<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token comment\">// Get floating point number out of heap number</span><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">checkSmi</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token comment\">// Untag smi</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">untagSmi</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">movq</span><span class=\"token punctuation\">(</span><span class=\"token string\">'xmm1'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">heapOffset</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Round it towards zero</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">roundsd</span><span class=\"token punctuation\">(</span><span class=\"token string\">'zero'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'xmm1'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'xmm1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Convert double to integer</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">cvtsd2si</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'xmm1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">visitLiteral</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ast</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  assert<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> ast<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">,</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>value <span class=\"token operator\">|</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> ast<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token comment\">// Small Integer (SMI), Tagged value</span><br>    <span class=\"token comment\">// (i.e. val * 2) with last bit set to</span><br>    <span class=\"token comment\">// zero</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> utils<span class=\"token punctuation\">.</span><span class=\"token function\">tagSmi</span><span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token comment\">// Allocate new heap number</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">stub</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Alloc'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Save 'rbx' register</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">spill</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">loadDouble</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">,</span> ast<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>      <span class=\"token comment\">// NOTE: Pointers have last bit set to 1</span><br>      <span class=\"token comment\">// That's why we need to use 'heapOffset'</span><br>      <span class=\"token comment\">// routine to access it's memory</span><br>      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">heapOffset</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rbx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">visitBinary</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ast</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token comment\">// Preserve 'rbx' after leaving the AST node</span><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">spill</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token comment\">// Visit left side of expresion</span><br>    <span class=\"token function\">visit</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> ast<span class=\"token punctuation\">.</span>right<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Move it to 'rbx'</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rax'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Visit right side of expression (the result is in 'rax')</span><br>    <span class=\"token function\">visit</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> ast<span class=\"token punctuation\">.</span>left<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">//</span><br>    <span class=\"token comment\">// So, to conclude, we've left side in 'rax' and right in 'rbx'</span><br>    <span class=\"token comment\">//</span><br><br>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>operator <span class=\"token operator\">===</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>      <span class=\"token comment\">// Call stub for division</span><br>      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">stub</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Binary'</span> <span class=\"token operator\">+</span> ast<span class=\"token punctuation\">.</span>operator<span class=\"token punctuation\">,</span> <span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rbx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span><br>      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">labelScope</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token comment\">// Check if both numbers are SMIs</span><br>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">checkSmi</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">j</span><span class=\"token punctuation\">(</span><span class=\"token string\">'nz'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'call stub'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">checkSmi</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">j</span><span class=\"token punctuation\">(</span><span class=\"token string\">'nz'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'call stub'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>        <span class=\"token comment\">// Save rax in case of overflow</span><br>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rcx'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rax'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>        <span class=\"token comment\">// NOTE: both 'rax' and 'rbx' are tagged at this</span><br>        <span class=\"token comment\">// point.</span><br>        <span class=\"token comment\">// Tags don't need to be removed if we're doing</span><br>        <span class=\"token comment\">// addition or subtraction. However, in case of</span><br>        <span class=\"token comment\">// multiplication result would be 2x bigger if</span><br>        <span class=\"token comment\">// we won't untag one of the arguments.</span><br>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>operator <span class=\"token operator\">===</span> <span class=\"token string\">'+'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>          <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rbx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>operator <span class=\"token operator\">===</span> <span class=\"token string\">'-'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>          <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rbx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>operator <span class=\"token operator\">===</span> <span class=\"token string\">'*'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>          <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">untagSmi</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>          <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><br><br>        <span class=\"token comment\">// On overflow restore 'rax' from 'rcx' and invoke stub</span><br>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">j</span><span class=\"token punctuation\">(</span><span class=\"token string\">'o'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'restore'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>        <span class=\"token comment\">// Otherwise return 'rax'</span><br>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">j</span><span class=\"token punctuation\">(</span><span class=\"token string\">'done'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token string\">'restore'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rcx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token string\">'call stub'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>        <span class=\"token comment\">// Invoke stub and return heap number in 'rax'</span><br>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">stub</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Binary'</span> <span class=\"token operator\">+</span> ast<span class=\"token punctuation\">.</span>operator<span class=\"token punctuation\">,</span> <span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rbx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token string\">'done'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">visitUnary</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ast</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>operator <span class=\"token operator\">===</span> <span class=\"token string\">'-'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token comment\">// Negate argument by emulating binary expression</span><br>    <span class=\"token function\">visit</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><br>      <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'BinaryExpression'</span><span class=\"token punctuation\">,</span><br>      <span class=\"token literal-property property\">operator</span><span class=\"token operator\">:</span> <span class=\"token string\">'*'</span><span class=\"token punctuation\">,</span><br>      <span class=\"token literal-property property\">left</span><span class=\"token operator\">:</span> ast<span class=\"token punctuation\">.</span>argument<span class=\"token punctuation\">,</span><br>      <span class=\"token literal-property property\">right</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'Literal'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><br>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><br>  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Unsupported unary operator: '</span> <span class=\"token operator\">+</span> ast<span class=\"token punctuation\">.</span>operator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>To conclude, we are now working with SMIs by default, inlining all operations\nfor the speed's sake, and falling back to the doubles in case of overflow or any\nother trouble, like trying to sum a double and a SMI!</p>\n<p>That's all for now, see you here next time! Here is the full compiler code from\nthis article: <a href=\"https://github.com/indutny/jit.js/tree/master/example/heap-smi-and-double\">github</a>. Please try cloning, running and playing with it!\nHope you enjoyed this post.</p>\n",
			"date_published": "2013-11-14T00:00:00Z"
		}
		,
		{
			"id": "https://darksi.de/6.allocating-numbers/",
			"url": "https://darksi.de/6.allocating-numbers/",
			"title": "Allocating numbers",
			"content_html": "<h2 id=\"jit\" tabindex=\"-1\">JIT <a class=\"header-anchor\" href=\"https://darksi.de/6.allocating-numbers/\">#</a></h2>\n<p>This is the second blog post in the series about JIT compiling.\n<a href=\"https://darksi.de/4.how-to-start-jitting\">The previous post</a> was an introduction into the Just-In-Time code\ngeneration and, in particular, <a href=\"https://github.com/indutny/jit.js\">jit.js</a> usage. If you haven't read it yet -\nI recommend you to familiarize yourself with <a href=\"https://darksi.de/4.how-to-start-jitting\">it</a> first.</p>\n<h2 id=\"objectives\" tabindex=\"-1\">Objectives <a class=\"header-anchor\" href=\"https://darksi.de/6.allocating-numbers/\">#</a></h2>\n<p>Previously, we created a JIT compiler, supporting a very limited subset of\nJavaScript: integer numbers, math binary operators (<code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>), and\n<code>-</code> unary operator. This time, we will extend it by adding floating point\nnumber support, and, to make the process funnier and to spice things up,\nwe will allocate and store these numbers in the heap.</p>\n<p>Though, because we are doing things one step at a time, our heap won't have\nGarbage Collection, and will live inside fixed sized memory chunk (say &quot;yay&quot; to\nsimplicity!).</p>\n<h2 id=\"stubs\" tabindex=\"-1\">Stubs <a class=\"header-anchor\" href=\"https://darksi.de/6.allocating-numbers/\">#</a></h2>\n<p>Knowing what we aim to do, we can now set up internal structures for these\nfeatures. Essentially, what we'll need is a memory allocation procedure, that\ngenerates and returns memory addresses suitable for our goals.</p>\n<p>This allocation code could be generated for every AST node using series of\ninlined assembly instructions, which works great and, more importantly, is\nincredibly fast for concise operations. But due to the relatively big code's\nsize of this procedure, the resulting machine code output may become too big to\nbe fit entirely into the CPU's cache, causing potential performance problems to\nthe whole system.</p>\n<p>Generally, this is considered a bad practice. A better approach would be\nparameterizing such code blocks into shared procedures called <code>stubs</code> (I picked\nthat naming from <a href=\"https://github.com/v8/v8/blob/master/src/ia32/code-stubs-ia32.cc\">v8's source</a> and, perhaps, it is how these things are\nnamed in other VMs too). For even better optimization these procedures\ncould be lazily compiled, i.e. we should not compile those ones that are not\nused by generated code. This technique is good for both compilation time and\nexecutable code size (and therefore CPU caches too).</p>\n<p>Fortunately, <a href=\"https://github.com/indutny/jit.js\">jit.js</a> lets you generate <em>stubs</em> easily:</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> stubs <span class=\"token operator\">=</span> jit<span class=\"token punctuation\">.</span><span class=\"token function\">stubs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>stubs<span class=\"token punctuation\">.</span><span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Allocate'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token comment\">// Our code here</span><br>  <span class=\"token comment\">// ....</span><br><br>  <span class=\"token comment\">// Returning back to caller</span><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">Return</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>Simple, isn't it? Now, to use it in our JIT compiler we'll need to pass it in\nan options argument:</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\">jit<span class=\"token punctuation\">.</span><span class=\"token function\">compile</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token comment\">// Compiler code generation happens in this context</span><br><br>  <span class=\"token comment\">// Explanation:</span><br>  <span class=\"token comment\">// Read address of 'Allocate' stub into 'rax' register and</span><br>  <span class=\"token comment\">// call it.</span><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">stub</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Allocate'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">Return</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">stubs</span><span class=\"token operator\">:</span> stubs <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>As mentioned above, only stubs that were used during compilation process will\nactually be generated and reused between all callers.</p>\n<h2 id=\"heap\" tabindex=\"-1\">Heap <a class=\"header-anchor\" href=\"https://darksi.de/6.allocating-numbers/\">#</a></h2>\n<p>With this knowledge, we can proceed to the memory allocation phase. But first,\nlets take a short look at the structure and organization of the heap.</p>\n<p>The <em>heap</em> is the place where JavaScript (and many other) VMs create and store\nobjects (usually, ones that can't be fit into CPU registers). Some heap objects\nmay contain references to other objects (in other words, can reference them).\nAll live objects and their references create a directed graph, starting at\nso called <em>roots</em> (which are usually global variables and pointers on stack).</p>\n<p>Although, it is usually used in VMs with JIT compilation, Garbage Collection is\nnot required for the Heap. Indeed, many VMs and languages choose to use\nunmanaged memory instead (C/C++ as a banal example). In such cases you (as the\nlanguage user) will generally need to explicitly free unused resources to not\nrun out of the memory.</p>\n<p>But for obvious reasons, the JavaScript subset compiler that we're implementing,\nshould support both managed memory and Garbage Collection (which will be\nimplemented later).</p>\n<p>There are tons of books that may give you an advanced introduction into the\nheap allocation and garbage collection (my recommendation is\n<a href=\"http://www.amazon.com/The-Garbage-Collection-Handbook-Management/dp/1420082795/ref=sr_1_1?ie=UTF8&amp;qid=1383600127&amp;sr=8-1&amp;keywords=garbage+collection+handbook\">The Garbage Collection Handbook</a>), and considerably many ways to allocate\nand collect memory in the heap.</p>\n<p>Usually, you will need to choose between the allocation speed and memory\nfragmentation. But, since we are not covering this very deeply, I would\nrecommend to stick with the method called &quot;bump allocation&quot; for now.</p>\n<h2 id=\"bump-allocation\" tabindex=\"-1\">Bump allocation <a class=\"header-anchor\" href=\"https://darksi.de/6.allocating-numbers/\">#</a></h2>\n<p>Fixed-page bump allocation works in a following way.</p>\n<ol>\n<li>Take the memory chunk of fixed size (a <em>page</em>)</li>\n<li>Give away consequent slices of it as a return value of the allocation\nprocedure.</li>\n<li>When running low on memory, perform the Garbage Collection and free all\nunused space, by either compacting live objects or evacuating them to the\nnew memory chunk (replacing references to live objects in both cases).</li>\n</ol>\n<p>In terms of <a href=\"https://github.com/indutny/jit.js\">jit.js</a> and stubs API, this procedure may look as following:</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\"><span class=\"token comment\">// Create fixed size memory chunk</span><br><span class=\"token keyword\">var</span> page <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Buffer</span><span class=\"token punctuation\">(</span><span class=\"token number\">1024</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br><span class=\"token comment\">// Set-up pointers to page start and page end</span><br><span class=\"token keyword\">var</span> offset <span class=\"token operator\">=</span> jit<span class=\"token punctuation\">.</span><span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>page<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token keyword\">var</span> end <span class=\"token operator\">=</span> jit<span class=\"token punctuation\">.</span><span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>page<span class=\"token punctuation\">,</span> page<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>stubs<span class=\"token punctuation\">.</span><span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Alloc'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br><br>  <span class=\"token comment\">// Save 'rbx' and 'rcx' registers</span><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">spill</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rcx'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token comment\">// Load `offset`</span><br>    <span class=\"token comment\">//</span><br>    <span class=\"token comment\">// NOTE: We'll use pointer to `offset` variable, to be able to update</span><br>    <span class=\"token comment\">// it below</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Load end</span><br>    <span class=\"token comment\">//</span><br>    <span class=\"token comment\">// NOTE: Same applies to end, though, we're not updating it right now</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>end<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Calculate new `offset`</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rcx'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rax'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// We'll assume that all allocations are 16 bytes = two 64bit pointers</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rcx'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Check if we won't overflow our fixed size buffer</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">cmp</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rcx'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rbx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// this.j() performs conditional jump to the specified label.</span><br>    <span class=\"token comment\">// 'g' stands for 'greater'</span><br>    <span class=\"token comment\">// 'overflow' is a label name, bound below</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">j</span><span class=\"token punctuation\">(</span><span class=\"token string\">'g'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'overflow'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Ok, we're good to go, update offset</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rcx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// The first 64bit pointer is reserved for 'tag',</span><br>    <span class=\"token comment\">// the second one is a `double` value</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Return 'rax'</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">Return</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Overflowed :(</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token string\">'overflow'</span><span class=\"token punctuation\">)</span><br><br>    <span class=\"token comment\">// Invoke javascript function!</span><br>    <span class=\"token comment\">// NOTE: This is really funky stuff, but I'm not going to dive deep</span><br>    <span class=\"token comment\">// into it right now</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">runtime</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'GC is needed, but not implemented'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Crash</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">int3</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">Return</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>That's it! Not totally straightforward, but not really complicated either!</p>\n<p>This procedure will give away consequent slices of the <em>page</em>, and even tag\nthem! (I'll cover tagging in one of the next posts. Basically, they're used to\ndistinguish different kinds of heap objects).</p>\n<p>Few things to note here:</p>\n<ol>\n<li><code>jit.ptr(buf, offset)</code> returns a <code>Buffer</code>, containing a pointer to the given\n<code>buf</code> with <code>offset</code> added to it.</li>\n<li><code>this.spill()</code> is a routine for saving and restoring registers to/from the\nmemory (this process is usually called <em>spilling</em>). It takes list of the\nregisters and the closure. These registers will be saved before entering the\nclosure, and restored right after leaving it.\nNOTE: The restore code will be generated before each <code>this.Return()</code> too.</li>\n<li><code>this.mov(['rbx'], 'rcx')</code> - stores <code>rcx</code> register into the memory location,\npointed by the value of <code>rbx</code> register.\nNOTE: you can also specify an offset here: <code>this.mov(['rbx', 8], 'rcx')</code>.</li>\n<li>jit.js supports branching primitives: <code>this.cmp(a, b)</code>,\n<code>this.j(condition, labelName)</code>, <code>this.j(labelName)</code>, <code>this.bind(labelName)</code>.</li>\n</ol>\n<h1 id=\"floating-point\" tabindex=\"-1\">Floating point <a class=\"header-anchor\" href=\"https://darksi.de/6.allocating-numbers/\">#</a></h1>\n<p>Now as we have a <em>presumably</em> working allocation procedure, let's recall what\nshould be stored inside of this heap chunks. In the allocation procedure, we\ncreate chunks with the 8 byte tag value, and the 8 byte contents. This is\nenough to store <code>double</code> (as C type) floating point numbers.</p>\n<p>There are plenty of assembly instructions to load/store/work with such numbers.\nBut note that to work with them - you'll need to store them in the different\nregister set: <code>xmm0</code>, <code>xmm1</code>, ... <code>xmm15</code>. Although, 64-bit floating numbers\ncould be stored in the general purpose registers: <code>rax</code>, <code>rbx</code>, ... Performing\nmath operations is possible only with a <code>xmm</code> register set. Here are some\ninstructions, that are present in <code>jit.js</code> and should be useful for our\ncompiler:</p>\n<ol>\n<li><code>movq('xmm', 'gp')</code> or <code>movq('gp', 'xmm')</code> to move 64bits from the general\npurpose register (or memory pointed by it) to xmm, or the other way around.</li>\n<li><code>movsd('xmm', 'xmm')</code> to move the value from one xmm to another.</li>\n<li><code>addsd</code>, <code>mulsd</code>, <code>subsd</code>, <code>divsd</code> - addition, multiplication, subtraction,\ndivision.</li>\n<li><code>cvtsi2sd('xmm', 'gp')</code>, <code>cvts2si('gp', 'xmm')</code> - converts integer into\ndouble, and double into integer, respectively.</li>\n<li><code>roundsd('mode', 'xmm', 'xmm')</code> - round the <code>src</code> register using specified\n<code>mode</code> (which is one of: <code>nearest</code>, <code>down</code>, <code>up</code>, <code>zero</code>) and place the\nresult into the <code>dst</code> register.</li>\n</ol>\n<p>Using this sacred knowledge we can patch our existing code to make it work with\nthe floating point numbers (yeah, we will remove the integer support for now):</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\"><span class=\"token comment\">// Compile</span><br><span class=\"token keyword\">var</span> fn <span class=\"token operator\">=</span> jit<span class=\"token punctuation\">.</span><span class=\"token function\">compile</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token comment\">// This will generate default entry boilerplate</span><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">Proc</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token function\">visit</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> ast<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// The result should be in 'rax' at this point</span><br>    <span class=\"token comment\">//</span><br>    <span class=\"token comment\">// This will generate default exit boilerplate</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">Return</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">stubs</span><span class=\"token operator\">:</span> stubs <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br><span class=\"token comment\">// Execute</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">fn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">visit</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ast</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'Program'</span><span class=\"token punctuation\">)</span><br>    <span class=\"token function\">visitProgram</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> ast<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'Literal'</span><span class=\"token punctuation\">)</span><br>    <span class=\"token function\">visitLiteral</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> ast<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'UnaryExpression'</span><span class=\"token punctuation\">)</span><br>    <span class=\"token function\">visitUnary</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> ast<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'BinaryExpression'</span><span class=\"token punctuation\">)</span><br>    <span class=\"token function\">visitBinary</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> ast<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">else</span><br>    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Unknown ast node: '</span> <span class=\"token operator\">+</span> ast<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">visitProgram</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ast</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  assert<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span><br>               <span class=\"token number\">1</span><span class=\"token punctuation\">,</span><br>               <span class=\"token string\">'Only one statement programs are supported'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  assert<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">,</span> <span class=\"token string\">'ExpressionStatement'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token comment\">// We've a pointer in 'rax', convert it to integer</span><br>  <span class=\"token function\">visit</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> ast<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>expression<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token comment\">// Get floating point number out of heap number</span><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">movq</span><span class=\"token punctuation\">(</span><span class=\"token string\">'xmm1'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token comment\">// Round it towards zero</span><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">roundsd</span><span class=\"token punctuation\">(</span><span class=\"token string\">'zero'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'xmm1'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'xmm1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token comment\">// Convert double to integer</span><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">cvtsd2si</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'xmm1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">visitLiteral</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ast</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  assert<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> ast<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">,</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token comment\">// Allocate new heap number</span><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">stub</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Alloc'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token comment\">// Save 'rbx' register</span><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">spill</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">loadDouble</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">,</span> ast<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rbx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">visitBinary</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ast</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token comment\">// Preserve 'rbx' after leaving the AST node</span><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">spill</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token comment\">// Visit right side of expresion</span><br>    <span class=\"token function\">visit</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> ast<span class=\"token punctuation\">.</span>right<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Move it to 'rbx'</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rax'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Visit left side of expression (the result is in 'rax')</span><br>    <span class=\"token function\">visit</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> ast<span class=\"token punctuation\">.</span>left<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">//</span><br>    <span class=\"token comment\">// So, to conclude, we've left side in 'rax' and right in 'rbx'</span><br>    <span class=\"token comment\">//</span><br><br>    <span class=\"token comment\">// Let's load their double values</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">movq</span><span class=\"token punctuation\">(</span><span class=\"token string\">'xmm1'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">movq</span><span class=\"token punctuation\">(</span><span class=\"token string\">'xmm2'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Execute binary operation</span><br>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>operator <span class=\"token operator\">===</span> <span class=\"token string\">'+'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">addsd</span><span class=\"token punctuation\">(</span><span class=\"token string\">'xmm1'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'xmm2'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>operator <span class=\"token operator\">===</span> <span class=\"token string\">'-'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">subsd</span><span class=\"token punctuation\">(</span><span class=\"token string\">'xmm1'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'xmm2'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>operator <span class=\"token operator\">===</span> <span class=\"token string\">'*'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mulsd</span><span class=\"token punctuation\">(</span><span class=\"token string\">'xmm1'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'xmm2'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>operator <span class=\"token operator\">===</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">divsd</span><span class=\"token punctuation\">(</span><span class=\"token string\">'xmm1'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'xmm2'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span><br>      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Unsupported binary operator: '</span> <span class=\"token operator\">+</span> ast<span class=\"token punctuation\">.</span>operator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br><br>    <span class=\"token comment\">// Allocate new number, and put value in it</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">stub</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Alloc'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">movq</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'xmm1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">visitUnary</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ast</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>operator <span class=\"token operator\">===</span> <span class=\"token string\">'-'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token comment\">// Negate argument by emulating binary expression</span><br>    <span class=\"token function\">visit</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><br>      <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'BinaryExpression'</span><span class=\"token punctuation\">,</span><br>      <span class=\"token literal-property property\">operator</span><span class=\"token operator\">:</span> <span class=\"token string\">'*'</span><span class=\"token punctuation\">,</span><br>      <span class=\"token literal-property property\">left</span><span class=\"token operator\">:</span> ast<span class=\"token punctuation\">.</span>argument<span class=\"token punctuation\">,</span><br>      <span class=\"token literal-property property\">right</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'Literal'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><br>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><br>  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Unsupported unary operator: '</span> <span class=\"token operator\">+</span> ast<span class=\"token punctuation\">.</span>operator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<h2 id=\"to-be-continued\" tabindex=\"-1\">To be continued <a class=\"header-anchor\" href=\"https://darksi.de/6.allocating-numbers/\">#</a></h2>\n<p>So, that's all I have to say to you for now. On a more social theme, you may\nwant subscribe to my <a href=\"https://twitter.com/indutny\">twitter</a> or watch my <a href=\"https://github.com/indutny/blog\">blog on github</a>. Don't miss\nthe next post!</p>\n",
			"date_published": "2013-11-06T00:00:00Z"
		}
		,
		{
			"id": "https://darksi.de/4.how-to-start-jitting/",
			"url": "https://darksi.de/4.how-to-start-jitting/",
			"title": "How to start JIT-ting",
			"content_html": "<h2 id=\"premise\" tabindex=\"-1\">Premise <a class=\"header-anchor\" href=\"https://darksi.de/4.how-to-start-jitting/\">#</a></h2>\n<p>Most developers heard about JIT compilers and how they can make slow interpreted\nlanguages run at a speed, comparable to native code. However, not many people\nunderstand how exactly this JIT thing works, and even less people could\nwrite their own compilers.</p>\n<p>I think having at least, basic knowledge of compiler internals may greatly\nimprove understanding of the code that is running on that software.</p>\n<p>In this article, we'll visit some peaks of JIT-island, and probably even\nimplement a compiler ourselves!</p>\n<h2 id=\"what-we-ll-start-with\" tabindex=\"-1\">What we'll start with <a class=\"header-anchor\" href=\"https://darksi.de/4.how-to-start-jitting/\">#</a></h2>\n<p>Knowing some compiler basics, we can assume that every compiler is\ntransforming input in some format (usually, a source code) into the output in\nanother or same format (usually, a machine code). JIT compilers are not an\nexception.</p>\n<p>What really makes them exceptional, is the fact that they're running not ahead\nof time (like gcc, clang and others), but Just-In-Time (i.e. right before\nexecuting compiler's output).</p>\n<p>To start developing our own JIT compiler we'll need to select the input language\nfor it. Considering <a href=\"http://adambard.com/blog/top-github-languages-for-2013-so-far/\">TOP GITHUB LANGUAGES FOR 2013 (SO FAR)</a>, JavaScript\nseems like a good candidate for implementing some limited subset of\nit with simplified semantics. Even more, we'll implement JIT compiler in the\nJavaScript itself. You can call it META-META!</p>\n<h2 id=\"ast\" tabindex=\"-1\">AST <a class=\"header-anchor\" href=\"https://darksi.de/4.how-to-start-jitting/\">#</a></h2>\n<p>Our compiler will accept JavaScript source code as its input, and produce (and\nimmediately execute) machine code for the very popular X64 platform. But, while\nits pretty comfortable for humans to work with a textual representation,\ncompiler developers are usually tending to create multiple Intermediate\nRepresentations (IR) before generating the final machine code.</p>\n<p>Since we're writing simplified compiler, having only one IR should be enough for\nus, and I'll choose Abstract Syntax Tree (AST) representation for this purposes.</p>\n<p>Getting AST out of JavaScript code is really easy nowadays, and we can choose\nany (of dozens) library we like: <a href=\"https://github.com/ariya/esprima\">esprima</a>, <a href=\"https://github.com/ariya/esprima\">uglify-js</a>, etc. Just to be\non one page with me, I recommend you to choose <a href=\"https://github.com/ariya/esprima\">esprima</a>. It has a nice and\nwell defined <a href=\"https://developer.mozilla.org/en-US/docs/SpiderMonkey/Parser_API\">output format</a>.</p>\n<p>For example, this code: <code>obj.method(42)</code> will produce the following AST (using\n<code>esprima.parse(&quot;...&quot;)</code>):</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'Program'</span><span class=\"token punctuation\">,</span><br>  <span class=\"token literal-property property\">body</span><span class=\"token operator\">:</span><br>   <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'ExpressionStatement'</span><span class=\"token punctuation\">,</span><br>       <span class=\"token literal-property property\">expression</span><span class=\"token operator\">:</span><br>        <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'CallExpression'</span><span class=\"token punctuation\">,</span><br>          <span class=\"token literal-property property\">callee</span><span class=\"token operator\">:</span><br>           <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'MemberExpression'</span><span class=\"token punctuation\">,</span><br>             <span class=\"token literal-property property\">computed</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span><br>             <span class=\"token literal-property property\">object</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'Identifier'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'obj'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br>             <span class=\"token literal-property property\">property</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'Identifier'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'method'</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br>          <span class=\"token literal-property property\">arguments</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'Literal'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">42</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span></code></pre>\n<h2 id=\"machine-code\" tabindex=\"-1\">Machine code <a class=\"header-anchor\" href=\"https://darksi.de/4.how-to-start-jitting/\">#</a></h2>\n<p>Let's summarize: we have JavaScript source (<em>check</em>), its AST (<em>check</em>), and we\nwant to get machine code for it.</p>\n<p>If you're already familiar with assembly language then you can skip this\nchapter, as it contains only basic introductionary material on this topic.\nHowever, if you're new to it, reading next chapter may be hard without learning\nsome basics first. So please stay here, it won't take too long!</p>\n<p>Assembly language is the nearest textual representation of the binary code that\nyour CPU(s) understand and is(are) able to run. Considering that processors are\nexecuting code by reading and running instructions one-by-one, it may seem\nlogical to you that almost every line in assembly program represent an\ninstruction:</p>\n<pre><code>mov rax, 1    ; Put 1 into the register named `rax`\nmov rbx, 2    ; Put 2 into the register named `rbx`\nadd rax, rbx  ; Calculate sum of `rax` and `rbx` and put it into `rax`\n</code></pre>\n<p>This program's output (assuming you'll get it from <code>rax</code> register) is 3. And,\nas you've probably already figured out, it puts some data in some CPU slots\n(<a href=\"http://en.wikipedia.org/wiki/Processor_register\">registers</a>) and asks the CPU to calculate the sum of them.</p>\n<p>Usually processors have enough registers to store results of intermediate\noperations, but in some situations you may want to store/load data (and work\nwith it) from the computer's memory:</p>\n<pre><code>mov rax, 1\nmov [rbp-8], rbx  ; Save rbx register into a stack slot\nmov rbx, 2\nadd rax, rbx\nmov rbx, [rbp-8]  ; Restore rbx register from a stack slot\n</code></pre>\n<p>Registers have names, memory slots have addresses. These addresses are usually\nwritten using <code>[...]</code> syntax. For example, <code>[rbp-8]</code> means: take the value of\nthe <code>rbp</code> register, subtract <code>8</code>, and access a memory slot using the resulting\nvalue as the address.</p>\n<p>You can see that we're using <code>rbp</code> register here. <code>rbp</code> usually contains\naddress at which on-stack variables storage (i.e. variables that are stored in\ncurrent procedure's <a href=\"http://en.wikipedia.org/wiki/Stack_(abstract_data_type)\">stack</a>) starts; <code>8</code> is a size of <code>rbx</code> register (and any\nother register, prefixed with <code>r</code>), and since the <a href=\"http://en.wikipedia.org/wiki/Stack_(abstract_data_type)\">stack</a> is growing upwards,\nwe need to subtract it from <code>rbp</code> to get a free address slot for our purposes.</p>\n<p>There are many more nuances of programming at such a low level, and\nunfortunately I'm not going to cover all of them here. Also, please be aware\nthat I gave you a very shallow description, and what actually happens here may\nsometimes be much more complex.</p>\n<p>Knowing things mentioned above should be enough to proceed to the code\ngeneration.</p>\n<h2 id=\"code-generation\" tabindex=\"-1\">Code generation <a class=\"header-anchor\" href=\"https://darksi.de/4.how-to-start-jitting/\">#</a></h2>\n<p>Implementing the entire JavaScript is a rather complicated practice, so we'll\nimplement only a simplified arithmetics engine for now. (Which should be as fun\nas getting to the whole thing later!)</p>\n<p>The best and the easiest way to do it, is to traverse the AST using\n<a href=\"http://en.wikipedia.org/wiki/Depth-first_search\">Depth First Search</a>, generating machine code for each node. You might wonder\nhow could you generate machine code in a memory-safe language like JavaScript.\nThat's where I'm going to introduce you to <a href=\"https://github.com/indutny/jit.js\">jit.js</a>.</p>\n<p>It is a node.js module (and C++ addon, actually) capable of generating and\nexecution of machine code, using assembly-like JavaScript syntax:</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> jit <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'jit.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br><span class=\"token keyword\">var</span> fn <span class=\"token operator\">=</span> jit<span class=\"token punctuation\">.</span><span class=\"token function\">compile</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">Proc</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">42</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">Return</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">fn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 42</span></code></pre>\n<h2 id=\"let-s-write-it\" tabindex=\"-1\">Let's write it <a class=\"header-anchor\" href=\"https://darksi.de/4.how-to-start-jitting/\">#</a></h2>\n<p>Thus only one thing left now, a module to traverse the AST tree, generated by\n<a href=\"https://github.com/ariya/esprima\">esprima</a>. Thankfully, considering its structure and our minimalistic\ncompiler design it should be pretty easy.</p>\n<p>We're going to support:</p>\n<ol>\n<li>Number literals (<code>{ type: 'Literal', value: 123 }</code>)</li>\n<li>Binary expression, with operators: <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, <code>%</code>\n(<code>{ type: 'BinaryExpression', operator: '+', left: ... , right: .... }</code>)</li>\n<li>Unary expression, with the <code>-</code> operator\n(<code>{ type: 'UnaryExpression', operator: '-', argument: ... }</code>)</li>\n</ol>\n<p>All these operations are performed on integers, so don't expect it to work\nproperly with values like <code>0.5</code>, <code>0.66666</code>, etc.</p>\n<p>While processing expression, we'll be visiting each supported AST node of it,\ngenerating code that returns it's result in the <code>rax</code> register. Sounds easy,\nright? The only rule here is that we should keep all other registers clean\nafter leaving the AST node. Which, in other words, means that we should save all\nregisters that are used and restore them after they're not needed anymore.\nFortunately, CPUs have two magic instructions <code>push</code> and <code>pop</code> that can help us\nwith that task.</p>\n<p>Here is the resulting code with descriptive comments:</p>\n<pre class=\"language-javascript\" tabindex=\"0\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> jit <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'jit.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><br>    esprima <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'esprima'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><br>    assert <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'assert'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br><span class=\"token keyword\">var</span> ast <span class=\"token operator\">=</span> esprima<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br><span class=\"token comment\">// Compile</span><br><span class=\"token keyword\">var</span> fn <span class=\"token operator\">=</span> jit<span class=\"token punctuation\">.</span><span class=\"token function\">compile</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token comment\">// This will generate default entry boilerplate</span><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">Proc</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token function\">visit</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> ast<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// The result should be in 'rax' at this point</span><br><br>    <span class=\"token comment\">// This will generate default exit boilerplate</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">Return</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br><span class=\"token comment\">// Execute</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">fn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">visit</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ast</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'Program'</span><span class=\"token punctuation\">)</span><br>    <span class=\"token function\">visitProgram</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> ast<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'Literal'</span><span class=\"token punctuation\">)</span><br>    <span class=\"token function\">visitLiteral</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> ast<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'UnaryExpression'</span><span class=\"token punctuation\">)</span><br>    <span class=\"token function\">visitUnary</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> ast<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'BinaryExpression'</span><span class=\"token punctuation\">)</span><br>    <span class=\"token function\">visitBinary</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> ast<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">else</span><br>    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Unknown ast node: '</span> <span class=\"token operator\">+</span> ast<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">visitProgram</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ast</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  assert<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span><br>               <span class=\"token number\">1</span><span class=\"token punctuation\">,</span><br>               <span class=\"token string\">'Only one statement programs are supported'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  assert<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">,</span> <span class=\"token string\">'ExpressionStatement'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token function\">visit</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> ast<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>expression<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">visitLiteral</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ast</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  assert<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> ast<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">,</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  assert<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>value <span class=\"token operator\">|</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span><br>               ast<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">,</span><br>               <span class=\"token string\">'Only integer numbers are supported'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> ast<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">visitBinary</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ast</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token comment\">// Preserve 'rbx' after leaving the AST node</span><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token comment\">// Visit right side of expresion</span><br>  <span class=\"token function\">visit</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> ast<span class=\"token punctuation\">.</span>right<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token comment\">// Move it to 'rbx'</span><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rax'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token comment\">// Visit left side of expression (the result is in 'rax')</span><br>  <span class=\"token function\">visit</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> ast<span class=\"token punctuation\">.</span>left<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token comment\">//</span><br>  <span class=\"token comment\">// So, to conclude, we've left side in 'rax' and right in 'rbx'</span><br>  <span class=\"token comment\">//</span><br><br>  <span class=\"token comment\">// Execute binary operation</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>operator <span class=\"token operator\">===</span> <span class=\"token string\">'+'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rbx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>operator <span class=\"token operator\">===</span> <span class=\"token string\">'-'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rbx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>operator <span class=\"token operator\">===</span> <span class=\"token string\">'*'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token comment\">// Signed multiplication</span><br>    <span class=\"token comment\">// rax = rax * rbx</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">imul</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>operator <span class=\"token operator\">===</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token comment\">// Preserve 'rdx'</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rdx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// idiv is dividing rdx:rax by rbx, therefore we need to clear rdx</span><br>    <span class=\"token comment\">// before running it</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">xor</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rdx'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rdx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Signed division, rax = rax / rbx</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">idiv</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Restore 'rdx'</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rdx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>operator <span class=\"token operator\">===</span> <span class=\"token string\">'%'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token comment\">// Preserve 'rdx'</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rdx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Prepare to execute idiv</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">xor</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rdx'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rdx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">idiv</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// idiv puts remainder in 'rdx'</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mov</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rdx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token comment\">// Restore 'rdx'</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rdx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Unsupported binary operator: '</span> <span class=\"token operator\">+</span> ast<span class=\"token punctuation\">.</span>operator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span><br><br>  <span class=\"token comment\">// Restore 'rbx'</span><br>  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rbx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token comment\">// The result is in 'rax'</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">visitUnary</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ast</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token comment\">// Visit argument and put result into 'rax'</span><br>  <span class=\"token function\">visit</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> ast<span class=\"token punctuation\">.</span>argument<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">.</span>operator <span class=\"token operator\">===</span> <span class=\"token string\">'-'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token comment\">// Negate argument</span><br>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">neg</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rax'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Unsupported unary operator: '</span> <span class=\"token operator\">+</span> ast<span class=\"token punctuation\">.</span>operator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>You can try it by cloning it from <a href=\"https://github.com/indutny/jit.js/tree/master/example/basic\">github</a>, running <code>npm install</code> in it's\nfolder and then voila!</p>\n<pre class=\"language-bash\" tabindex=\"0\"><code class=\"language-bash\">$ <span class=\"token function\">node</span> ./main.js <span class=\"token string\">'1 + 2 * 3'</span><br><span class=\"token number\">7</span></code></pre>\n<p>Thanks for reading up to this point! I'll talk about floating point operations\nand the heap in the next blog post!</p>\n",
			"date_published": "2013-11-01T00:00:00Z"
		}
		,
		{
			"id": "https://darksi.de/3.dtrace-ustack-helper/",
			"url": "https://darksi.de/3.dtrace-ustack-helper/",
			"title": "DTrace and the little ustack helper that could",
			"content_html": "<p><picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/8T1ihGV-f7-747.avif 747w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/8T1ihGV-f7-747.webp 747w\"><img alt=\"Flamegraph\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/8T1ihGV-f7-747.png\" width=\"747\" height=\"326\"></picture></p>\n<p><a href=\"http://blog.nodejs.org/2012/04/25/profiling-node-js/\">Flamegraphs</a> are awesome if you need to profile your node.js application.\nThey provide a nice looking visual view of where your application is spending\nits time. Although they're <a href=\"http://blog.nodejs.org/2012/04/25/profiling-node-js/\">well</a> <a href=\"http://dtrace.org/blogs/dap/2012/01/05/where-does-your-node-program-spend-its-time/\">documented</a>, no one has ever said a\nword on how they work internally, but everyone mentions\n&quot;ustack helper&quot; which, right now, works only on SmartOS.</p>\n<h1 id=\"call-stack\" tabindex=\"-1\">Call stack <a class=\"header-anchor\" href=\"https://darksi.de/3.dtrace-ustack-helper/\">#</a></h1>\n<p>To understand profiling, one must understand what a callstack is. During its\nlifetime every application is using <a href=\"http://en.wikipedia.org/wiki/Stack_(abstract_data_type)\">stack</a>, which is a chunk of memory which can\nbe changed by using <code>push</code>, <code>pop</code>, <code>call</code> and other CPU instructions, or\nby accessing it directly.</p>\n<p>The <code>push</code> and <code>pop</code> instructions simply expand/shrink stack storing/loading\ndata on top of it. The <code>call</code> instruction is a little bit more interesting:</p>\n<p><em>(Quote from\n<a href=\"http://download.intel.com/products/processor/manual/325462.pdf\">Intel 64 and IA-32 Architectures Software Developers Manual</a>)</em></p>\n<blockquote>\n    ...the processor pushes the value of the EIP register (which contains the\n    offset of the instruction following the CALL instruction) on the stack (for\n    use later as a return-instruction pointer). The processor then branches to\n    the address in the current code segment specified by the target operand.\n</blockquote>\n<p>So coupled with the <code>ret</code> instruction <code>call</code> allows you to jump into some\nfunction and return back to the place where it was called. (Despite it's\nsimplicity, I still find it amazing.)</p>\n<p>That's how calling functions really work internally, but stack can be also used\nto store local (on-stack) function's data. This is achieved using stack frames.\nThis is how functions' assembly code do usually look:</p>\n<p><em>(I'll use <a href=\"http://en.wikipedia.org/wiki/X86_assembly_language#Syntax\">AT&amp;T assembly syntax</a>)</em></p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">push ebp ; Save previous frame pointer<br>mov  esp, ebp ; Set new frame pointer<br>sub  $0x60, esp ; Allocate space on stack<br><br>; Function's body.<br>mov  $0x10, -0x8(%ebp) ; set on-stack variable<br><br>mov  ebp, esp ; Shrink stack to it's initial value<br>pop  ebp ; Restore previous frame pointer<br>ret  0 ; Return to caller</code></pre>\n<p>If represented graphically stack generally looks like this:</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/1g3z_8Q7Fn-397.avif 397w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/1g3z_8Q7Fn-397.webp 397w\"><img alt=\"Callstack\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/1g3z_8Q7Fn-397.png\" width=\"397\" height=\"472\"></picture></p>\n<p>The main pros of using structure above are:</p>\n<ul>\n<li>Easiness of restoring stack back to its initial position</li>\n<li>Fast and simple access to on-stack variables</li>\n</ul>\n<h1 id=\"stack-trace\" tabindex=\"-1\">Stack trace <a class=\"header-anchor\" href=\"https://darksi.de/3.dtrace-ustack-helper/\">#</a></h1>\n<p>Suppose your application has thrown an exception or crashed with a segmentation\nfault. To find the cause of the problem one may start by looking at the stack\ntrace where the crash has happened:</p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">#0  0x00007fff84356d16 in kevent ()<br>#1  0x00000001000557b7 in kqueue_poll ()<br>#2  0x000000010004c77a in uv__run ()<br>#3  0x000000010004c92a in uv_run ()<br>#4  0x0000000100015319 in node::Start ()<br>#5  0x000000010000dd24 in start ()</code></pre>\n<p>Here, on the left, you can see addresses of functions' code. Debugger gets them\nby taking current <code>eip</code> and <code>ebp</code> registers (which stands for current\ninstruction address and current stack frame address), walking stack frames and\ncollecting return addresses from it. On the right side, you can see functions'\nreal names. <a href=\"http://www.gnu.org/software/gdb/\">gdb</a> automatically loads this information for you by searching\nfor debugging symbols corresponding to addresses it has collected.</p>\n<h1 id=\"flamegraph\" tabindex=\"-1\">Flamegraph <a class=\"header-anchor\" href=\"https://darksi.de/3.dtrace-ustack-helper/\">#</a></h1>\n<p>In order to create flamegraph, one will need to periodically collect\napplication's stack traces and join them (the process is called\n<a href=\"http://en.wikipedia.org/wiki/Profiling_(computer_programming)#Statistical_profilers\">statistical profiling</a>),  making boxes with functions that were called more\noften - wider, and putting box on the top of another box only if their functions\nappear above each other in the stack trace.</p>\n<h1 id=\"v8-s-stack-frames\" tabindex=\"-1\">V8's stack frames <a class=\"header-anchor\" href=\"https://darksi.de/3.dtrace-ustack-helper/\">#</a></h1>\n<p>When collecting stack traces of C/C++ application, dtrace will use static\ndebugging information using binary's symbols table. But when it comes to dynamic\nlanguages, getting such information turns out to be more complicated:\nfunctions are compiled lazily, often recompiled with applied optimizations, old\ncode may be evicted by GC... in other words, application is evolving during its\nexecution.</p>\n<p>Thankfully, V8 provides this information, but instead of debugging symbols\nit stores it in stack frames. Here is an example of v8's stack frame structure:</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/yVoU9rIBqQ-397.avif 397w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/yVoU9rIBqQ-397.webp 397w\"><img alt=\"V8 Callstack\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/yVoU9rIBqQ-397.png\" width=\"397\" height=\"367\"></picture></p>\n<p>So knowing this structure we can identify frames by checking marker/function\nvalue and getting function names from V8's heap (it's too big topic to cover\nhere, believe me).</p>\n<p>That's exactly the job of ustack helper, it takes frame address and should figure\nout and return function's name, or just fail. So everytime you call <code>jstack()</code>\nfunction in DTrace probe, ustack helper will be called for every unidentified\nframe.</p>\n<h1 id=\"ustack-helper-example\" tabindex=\"-1\">ustack helper example <a class=\"header-anchor\" href=\"https://darksi.de/3.dtrace-ustack-helper/\">#</a></h1>\n<p><em>NOTE: some knowledge of D language is required to fully understand code below</em></p>\n<pre class=\"language-d\" tabindex=\"0\"><code class=\"language-d\">dtrace<span class=\"token punctuation\">:</span>helper<span class=\"token punctuation\">:</span>ustack<span class=\"token punctuation\">:</span><br><span class=\"token punctuation\">{</span><br>  <span class=\"token comment\">/* frame pointer */</span><br>  <span class=\"token keyword\">this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>fp <span class=\"token operator\">=</span> arg1<span class=\"token punctuation\">;</span><br><br>  <span class=\"token comment\">/* Last statement - result */</span><br>  <span class=\"token string\">\"whoa! you've identified me\"</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>If you replace contents of <code>src/v8ustack.d</code> in node.js sources, recompile it\n(on SmartOS), run <code>bash benchmark/http-flamegraph.sh</code>, and open <code>stacks.src</code>,\nwhich should contain following stack traces:</p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">node`_ZN2v88internal7Context14native_contextEv<br>node`_ZN4node10StreamWrap15WriteStringImplILNS_13...<br>node`_ZN4node10StreamWrap15WriteUtf8StringERKN2v89ArgumentsE+0x9<br>whoa! you've identified me<br>whoa! you've identified me<br>whoa! you've identified me</code></pre>\n<p>As you can see, DTrace has identified some C++ functions and for all other\naddresses has called our ustack helper.</p>\n<p>Let's read some data from V8's stack frame:</p>\n<pre class=\"language-d\" tabindex=\"0\"><code class=\"language-d\">#define FP_MARKER <span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><br>#define FT_ENTRY <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">32</span><span class=\"token punctuation\">)</span><br><br><span class=\"token comment\">/* Init */</span><br>dtrace<span class=\"token punctuation\">:</span>helper<span class=\"token punctuation\">:</span>ustack<span class=\"token punctuation\">:</span><br><span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>fp <span class=\"token operator\">=</span> arg1<span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>done <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>marker <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>uint64_t<span class=\"token punctuation\">)</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token comment\">/* Get marker */</span><br>dtrace<span class=\"token punctuation\">:</span>helper<span class=\"token punctuation\">:</span>ustack<span class=\"token punctuation\">:</span><br><span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>marker <span class=\"token operator\">=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>uint64_t<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token function\">copyin</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>fp <span class=\"token operator\">+</span> FP_MARKER<span class=\"token punctuation\">,</span><br>                                     <span class=\"token function\">sizeof</span><span class=\"token punctuation\">(</span>uint64_t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token comment\">/* Match entry marker */</span><br>dtrace<span class=\"token punctuation\">:</span>helper<span class=\"token punctuation\">:</span>ustack<span class=\"token punctuation\">:</span><br><span class=\"token operator\">/</span><span class=\"token keyword\">this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>marker <span class=\"token operator\">==</span> FT_ENTRY<span class=\"token operator\">/</span><br><span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>done <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span><br>  <span class=\"token string\">\"entry\"</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token comment\">/* Match everything else */</span><br>dtrace<span class=\"token punctuation\">:</span>helper<span class=\"token punctuation\">:</span>ustack<span class=\"token punctuation\">:</span><br><span class=\"token operator\">/</span><span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>done<span class=\"token operator\">/</span><br><span class=\"token punctuation\">{</span><br>  <span class=\"token string\">\"everything else\"</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>Run it again, and if you're lucky enough you'll find this in <code>stacks.src</code>:</p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">everything else<br>everything else<br>entry<br>node`_ZN2v88internalL6InvokeEbNS0...</code></pre>\n<p>Important things about ustack helper:</p>\n<ul>\n<li>It's running within kernel (though, in it's own context, so it can't crash\nit). The most important consequences of it is that user-land addresses can't\nbe accessed directly, but only by using <code>copyin()</code> function.</li>\n<li>Usage of control flow statements (if/foreach/while) in DTrace scripts is\nprohibited, since all probes should terminate in a reasonable time. Otherwise\ninfinite loop in kernel space will cause your system to halt.</li>\n</ul>\n<h1 id=\"debugging-ustack-helper\" tabindex=\"-1\">Debugging ustack helper <a class=\"header-anchor\" href=\"https://darksi.de/3.dtrace-ustack-helper/\">#</a></h1>\n<p>During development of 64bit platform support for node.js ustack helper, I found\nthat it's pretty hard to debug ustack helper. The only method to do this is\ninsertion of probes which are returning some debugging information, and\nobserving this information later in stack traces.</p>\n<p>Additionally, it's worth noting that failed <code>copyin()</code> or any bad memory access\nwon't produce any informative output, but you'll see raw address in stack trace\n(i.e. 0x0000000012345678) rather than your pretty real function's name.</p>\n<h1 id=\"epilogue\" tabindex=\"-1\">Epilogue <a class=\"header-anchor\" href=\"https://darksi.de/3.dtrace-ustack-helper/\">#</a></h1>\n<p>You can look at/play with node's <a href=\"https://github.com/joyent/node/blob/master/src/v8ustack.d\">ustack helper</a>, big kudos to\n<a href=\"https://github.com/davepacheco\">Dave Pacheco</a> for developing it!</p>\n<p>And you should check out Bryan Cantrill's and Dave Pacheco's presentation that\nexplains many things that wasn't covered in this post:\n<a href=\"http://www.slideshare.net/bcantrill/goto2012\">Dynamic Languages in Production: Progress and Open Challenges</a> and\n<a href=\"http://www.livestream.com/dataweek/video?clipId=pla_59016422-9a89-45be-ac86-64bc4c45fe99&amp;utm_source=lslibrary&amp;utm_medium=ui-thumb\">video</a>.</p>\n<p>Huge thanks to <a href=\"http://voxer.com/\">Voxer</a> for funding my investigation and work on porting\nDTrace ustack helper to 64bit platform! Guys, I love you. You're awesome!</p>\n",
			"date_published": "2013-01-11T00:00:00Z"
		}
		,
		{
			"id": "https://darksi.de/2.candor-returns/",
			"url": "https://darksi.de/2.candor-returns/",
			"title": "Candor returns",
			"content_html": "<p>Before I start diving into the deep sea of compiler internals, I would like to\nfamiliarize you with the <a href=\"https://github.com/indutny/candor\">Candor</a> programming language and its Virtual\nMachine.</p>\n<p>This is the thing I was working on last 10 months, and one of the most wonderful\nand complex things I've been working on since the start of my software\ndevelopment career.</p>\n<p>Candor is an Ecmascript-inspired language, but while the newer versions of the\nEcmascript standard are adding new functionality and syntax features, my\nlanguage aims to make the syntax as simple as possible.</p>\n<h3 id=\"no-exceptions\" tabindex=\"-1\">No exceptions <a class=\"header-anchor\" href=\"https://darksi.de/2.candor-returns/\">#</a></h3>\n<p>Caller can always be sure that function will return after the call. You should\neither invoke a callback with an error argument, return negative number on\nerror, or do anything else to let caller know about errors that has happened.</p>\n<h3 id=\"no-undefined-and-null\" tabindex=\"-1\">No undefined and null <a class=\"header-anchor\" href=\"https://darksi.de/2.candor-returns/\">#</a></h3>\n<p>There is the only one value and type that represents undefined value - <code>nil</code>.\nThus, less checks and a more understandable behaviour of your application.</p>\n<h3 id=\"no-implicit-global-variables\" tabindex=\"-1\">No implicit global variables <a class=\"header-anchor\" href=\"https://darksi.de/2.candor-returns/\">#</a></h3>\n<p>Every global variable access should be done explicitly, by loading/storing\nproperties of the <code>global</code> object. To my mind, it's the most simplest and\npowerful way to prevent global leaks.</p>\n<h3 id=\"no-default-runtime\" tabindex=\"-1\">No default runtime <a class=\"header-anchor\" href=\"https://darksi.de/2.candor-returns/\">#</a></h3>\n<p>Candor has no default APIs that are doing 'high-level' things with objects and\narrays. These routines should be implemented by embedder (like <a href=\"https://github.com/indutny/candor.io\">candor.io</a>).</p>\n<p>Removing runtime from VM is good in terms of support, less dependencies - less\nthings to care about, and leaving things out of the core keeps it compact.</p>\n<h3 id=\"no-prototype-chains\" tabindex=\"-1\">No prototype chains <a class=\"header-anchor\" href=\"https://darksi.de/2.candor-returns/\">#</a></h3>\n<p>Objects are just magic-less hash-maps without special properties like\n<code>toString</code> or <code>__proto__</code>. Additionally you can have both numeric and string\nkeys in objects (in other words, <code>a[0]</code> and <code>a['0']</code> are not the same thing).</p>\n<p>Also there're no <code>length</code> property of array, it's replaced by <code>sizeof</code> keyword.\nExample: <code>sizeof [1,2,3] == 3</code> or even <code>sizeof &quot;string&quot;</code>.</p>\n<h3 id=\"no-complicated-type-coercion\" tabindex=\"-1\">No complicated type coercion <a class=\"header-anchor\" href=\"https://darksi.de/2.candor-returns/\">#</a></h3>\n<p>Objects, arrays and nil are always converted either to empty string or to zero,\ndepending on type of another argument. For example, this lets you increment\nuninitialized variables without getting any errors or unexpected behaviour:\n<code>nil + 1 == 1</code>.</p>\n<h3 id=\"dart-like-function-syntax\" tabindex=\"-1\">Dart-like function syntax <a class=\"header-anchor\" href=\"https://darksi.de/2.candor-returns/\">#</a></h3>\n<p>No <code>function</code> keyword, yay! Just write:</p>\n<pre class=\"language-dart\" tabindex=\"0\"><code class=\"language-dart\"><span class=\"token function\">function_name</span><span class=\"token punctuation\">(</span>arguments<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token comment\">//body</span><br><span class=\"token punctuation\">}</span></code></pre>\n<h2 id=\"syntax\" tabindex=\"-1\">Syntax <a class=\"header-anchor\" href=\"https://darksi.de/2.candor-returns/\">#</a></h2>\n<p>You can learn more about syntax and play with it on <a href=\"http://candor-lang.org/\">the official website</a>.</p>\n<h2 id=\"compiler\" tabindex=\"-1\">Compiler <a class=\"header-anchor\" href=\"https://darksi.de/2.candor-returns/\">#</a></h2>\n<p>Since the <a href=\"https://github.com/indutny/candor/commit/f3b1ebf3a839e32fcafa14b21af3\">start of this year</a> I have been working on delivering very\nprimitive JIT compiler and VM for Candor. The first version was generating\npretty ugly machine code, which was ineffective and massive.</p>\n<p>It was using the following algorithm:</p>\n<ol>\n<li>Visit AST node.</li>\n<li>Generate all it's children, and place their results into <code>rax</code>, <code>rbx</code>, <code>rcx</code>\n(depending on child's index). (Just in case - <a href=\"http://en.wikipedia.org/wiki/X86-64\">x86-64</a>)</li>\n<li>Generate code that calculates the result of operation and return value in\n<code>rax</code>.</li>\n</ol>\n<p>Pros - fast compilation, easy to understand algorithm. Cons - hard way to deal\nwith different CPU architectures (i.e. it needed more than 6 registers), dumb\ngenerated machine code.</p>\n<p>Thanks to <a href=\"https://code.google.com/p/v8/\">v8</a> and <a href=\"http://www.dartlang.org/\">Dart</a> hacker <a href=\"http://mrale.ph/\">Vyacheslav Egorov</a> and\n<a href=\"http://wingolog.org/\">Andy Wingo's blog</a>, I've figured out that <a href=\"https://github.com/indutny/candor/wiki/Compiler-papers\">there're much better ways</a> to\ndo JIT code generation, but it was too complex for me to understand at that\ntime. And despite I've created new branch <code>feature-ssa</code> and written tons of\ncode, I've never got something truly working.</p>\n<p>I got stuck at implementing registry allocator, mostly because of wrong design\ndecisions that I made before, and continuing development of this branch in this\nform was impossible.</p>\n<p>That's why I took a long break (for almost 6 months) and worked on other\nprojects, until I realized how this thing should be implemented.</p>\n<h2 id=\"candor-returns\" tabindex=\"-1\">Candor returns <a class=\"header-anchor\" href=\"https://darksi.de/2.candor-returns/\">#</a></h2>\n<p>After this pause I've considered many things and finally did it. Even more,\nCandor now has two compilers: non-optimizing and optimizing. The non-optimizing\nis used where it needs to compile a lot of source as fast as possible, and the\noptimizing compiler is used for small functions that might be quickly optimized.</p>\n<p>Main things that helped me to got to this state:</p>\n<ol>\n<li>Understanding how <a href=\"http://en.wikipedia.org/wiki/Control_flow_graph\">CFG</a> and <a href=\"http://en.wikipedia.org/wiki/Static_single_assignment_form\">SSA</a> should be really handled and\nrepresented. CFG is a way to represent tree of input source code (AST) in a\nlinear form, by placing instructions in blocks and connecting them with the\ncontrol-flow edges like: goto and branch (which is used in <code>if</code> and <code>while</code>\nstatements). What I was missing is that the instruction and it's value should\nbe the same object, otherwise it's very problematic to exploit\n<a href=\"http://en.wikipedia.org/wiki/Use-define_chain\">def-use chains</a>, which are very useful for getting type information and\nperforming dead code elimination.</li>\n<li>I was detecting variable conflicts in the blocks with two incoming\nedges in a over-complicated way. I was using lists of active variables and\nperforming very complex analysis to propagate them to blocks that needed\nthem. Apparently, it's very cool and simple to do it in a way v8 does it. By\ncreating environment for each basic block in CFG, placing variables into it\nand copying it as-it-is when adding successor to the block.</li>\n<li>I didn't understand that low-level intermediate representation should\noperate on <code>uses</code> which a parts of variable's liveness intervals... Previous\nversion was doing simplified linear-scan register allocation without holes in\nvariable's liveness intervals, which isn't resulting in good allocation.</li>\n</ol>\n<p>The main difference between optimizing and non-optimizing compiler is that the\nformer is trying to place everything in registers, while the latter operates\nonly on the stack slots (i.e. doing memory access on every variable load and\nstore).</p>\n<p>By having a register allocator that's capable of allocating registers in very\ngeneric terms, it was really straightforward to add support for a 32bit code\ngeneration. And now Candor is officially running on two platforms: ia32 and x64.</p>\n<h2 id=\"plans\" tabindex=\"-1\">Plans <a class=\"header-anchor\" href=\"https://darksi.de/2.candor-returns/\">#</a></h2>\n<p>Now that there are two brand new compilers, I'm going to work on adaptive\noptimization/deoptimization for it. Candor should be capable of optimizing\nhot functions on the fly and inlining small functions into their callers. Also,\nit's quite practical to generate code that's very fast in common cases, and\nfalls back to unoptimized code in all other cases.</p>\n<p>ARM support is also the part of my future plans for Candor, and I'll start\nworking on it as soon as I'll receive my Raspberry PI.</p>\n<h2 id=\"more-info\" tabindex=\"-1\">More info <a class=\"header-anchor\" href=\"https://darksi.de/2.candor-returns/\">#</a></h2>\n<p>If you want to ask questions and/or learn more about Candor you can subscribe to\nour <a href=\"https://groups.google.com/forum/?fromgroups&amp;hl=en#!forum/candorlang\">google group</a> or join the #candor IRC channel on freenode.</p>\n",
			"date_published": "2012-11-21T00:00:00Z"
		}
		,
		{
			"id": "https://darksi.de/1.to-lock-or-not-to-lock/",
			"url": "https://darksi.de/1.to-lock-or-not-to-lock/",
			"title": "To lock, or not to lock",
			"content_html": "<h1 id=\"tl-dr\" tabindex=\"-1\">TL;DR <a class=\"header-anchor\" href=\"https://darksi.de/1.to-lock-or-not-to-lock/\">#</a></h1>\n<p>As I've promised you in my <a href=\"https://darksi.de/0.benchmarking-tls/\">previous post</a>, I made <a href=\"https://github.com/indutny/tlsnappy\">TLSnappy</a> balance and\nhandle requests a little bit better.</p>\n<h1 id=\"data-flow\" tabindex=\"-1\">Data flow <a class=\"header-anchor\" href=\"https://darksi.de/1.to-lock-or-not-to-lock/\">#</a></h1>\n<p>For leveraging all available CPUs TLSnappy runs multiple threads that are each\npicking and processing tasks from their dispatch queues, one by one. Tasks are\ncreated from node's event-loop in following cases:</p>\n<ul>\n<li>Data comes from client and should be decrypted</li>\n<li>Data from server should be encrypted</li>\n</ul>\n<p>So, as you can see, each thread is receiving data from it's inputs (either\n<code>encrypted</code> or <code>clear</code>) and/or emitting data to it's outputs. This pattern\napparently requires a lot of data transfer <code>to</code> and <code>from</code> worker threads and\nrequires storing (buffering) that data in some temporary storage before\nprocessing it.</p>\n<p>To my mind, best structure to fit this needs is <a href=\"http://en.wikipedia.org/wiki/Circular_buffer\">Circular (Ring) buffer</a>.\nBecause it's fast, can be grown if more than it's current capacity needs to be\nheld.</p>\n<p>The <a href=\"https://github.com/indutny/tlsnappy/blob/old-ring/src/ring.h\">Naive version</a> of it was good enough to try out things, but it wasn't\nsupposed to be run in a multi-threaded concurrent environment - all access to\nthis buffer can take place only in a <a href=\"http://en.wikipedia.org/wiki/Critical_section\">critical section</a>. This means that at\nany time only one thread may access the ring's methods or properties. You might\nthink that this doesn't make difference, but, according to <a href=\"http://en.wikipedia.org/wiki/Amdahl's_law\">Amdahl's law</a>,\nreducing time spent in non-parallelizable (sequential) parts of application is\nmuch more critical for overall performance than speeding up parallel parts.</p>\n<h1 id=\"lock-less-ring-buffer\" tabindex=\"-1\">Lock-less ring buffer <a class=\"header-anchor\" href=\"https://darksi.de/1.to-lock-or-not-to-lock/\">#</a></h1>\n<p>Removing locks seemed to be essential for achieving better performance, however\na special structure needs to be used in order to make a ring buffer work across\nmultiple CPUs. Here is the structure I chose for it:</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/esP-7oyjWx-480.avif 480w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/esP-7oyjWx-480.webp 480w\"><img alt=\"Ring buffer\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/esP-7oyjWx-480.png\" width=\"480\" height=\"350\"></picture></p>\n<p>Ring consists of pages that're forming circular linked list, each page has two\noffsets: reader (<code>roffset</code>) and writer (<code>woffset</code>). And there're two special\npages (which could be the same one actually): reader head (<code>rhead</code>) and writer\nhead (<code>whead</code>).</p>\n<p>Initially the ring contains only one page which is <code>rhead</code> and <code>whead</code> at the\nsame time. When the producer wants to put data in - it goes to the <code>whead</code>,\ncopies data into the page, increments <code>woffset</code> and if the page is full - it\ncreate a new page, or reuses an old one that doesn't contain any un-read data.\nConsumer takes <code>rhead</code> reads up to <code>woffset - roffset</code> bytes from it, increments\n<code>roffset</code> and moves to the next page if <code>roffset</code> is equal to the size of the\npage.</p>\n<p>So here are benchmarks:</p>\n<p>Without lock-less ring:</p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">Transactions:                 200000 hits<br>Availability:                 100.00 %<br>Elapsed time:                  47.90 secs<br>Data transferred:             585.37 MB<br>Response time:                  0.02 secs<br>Transaction rate:            4175.37 trans/sec<br>Throughput:                    12.22 MB/sec<br>Concurrency:                   98.79<br>Successful transactions:      200000<br>Failed transactions:               0<br>Longest transaction:            0.09<br>Shortest transaction:           0.00</code></pre>\n<p>With lock-less ring:</p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">Transactions:                 200000 hits<br>Availability:                 100.00 %<br>Elapsed time:                  47.37 secs<br>Data transferred:             585.37 MB<br>Response time:                  0.02 secs<br>Transaction rate:            4222.08 trans/sec<br>Throughput:                    12.36 MB/sec<br>Concurrency:                   98.83<br>Successful transactions:      200000<br>Failed transactions:               0<br>Longest transaction:            0.12<br>Shortest transaction:           0.00</code></pre>\n<p>As you can see, performance hasn't greatly improved and is actually almost\nbeyond statistical error (which means that results are nearly the same). However\nthese are results for small 3kb page, lets try sending some big 100kb buffers.</p>\n<p>Without lock-less ring:</p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">Transactions:                 100000 hits<br>Availability:                 100.00 %<br>Elapsed time:                  64.06 secs<br>Data transferred:            9536.74 MB<br>Response time:                  0.06 secs<br>Transaction rate:            1561.04 trans/sec<br>Throughput:                   148.87 MB/sec<br>Concurrency:                   98.59<br>Successful transactions:      100000<br>Failed transactions:               0<br>Longest transaction:            1.93<br>Shortest transaction:           0.00</code></pre>\n<p>With lock-less ring:</p>\n<pre class=\"language-txt\" tabindex=\"0\"><code class=\"language-txt\">Transactions:                 100000 hits<br>Availability:                 100.00 %<br>Elapsed time:                  58.73 secs<br>Data transferred:            9536.74 MB<br>Response time:                  0.06 secs<br>Transaction rate:            1702.71 trans/sec<br>Throughput:                   162.38 MB/sec<br>Concurrency:                   98.98<br>Successful transactions:      100000<br>Failed transactions:               0<br>Longest transaction:            0.19<br>Shortest transaction:           0.00</code></pre>\n<p>Wow! That's much better - about 9% performance improvement.</p>\n<h1 id=\"instruments\" tabindex=\"-1\">Instruments <a class=\"header-anchor\" href=\"https://darksi.de/1.to-lock-or-not-to-lock/\">#</a></h1>\n<p>Still TLSnappy's performance wasn't even close to what nginx is capable of\n(~5100 requests per second). Thus it was necessary to continue investigation and\nthis is where <a href=\"https://developer.apple.com/library/mac/#documentation/DeveloperTools/Conceptual/InstrumentsUserGuide/Introduction/Introduction.html\">Instruments.app</a> comes into play, which is basically an UI for some\nvery useful dtrace scripts. I've run the <code>CPU Sampler</code> utility and this is what\nthe call tree looked like:\n<picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/KaTGFefVxh-640.avif 640w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/KaTGFefVxh-640.webp 640w\"><img alt=\"Original node\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/KaTGFefVxh-640.png\" width=\"640\" height=\"404\"></picture></p>\n<p>Obviously it spends almost 30% of time in synchronization between threads,\nparticularly in <code>CRYPTO_add_lock</code> function:\n<picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/IyHsVLZOjt-451.avif 451w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/IyHsVLZOjt-451.webp 451w\"><img alt=\"Old CRYPTO_add_lock\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/IyHsVLZOjt-451.png\" width=\"451\" height=\"276\"></picture></p>\n<p>After modifying the code to use atomic operations, which are supported by almost\nevery CPU nowadays):\n<picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/_efe9aMzp1-473.avif 473w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/_efe9aMzp1-473.webp 473w\"><img alt=\"New CRYPTO_add_lock\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/_efe9aMzp1-473.png\" width=\"473\" height=\"361\"></picture></p>\n<p>Call tree locked like this:\n<picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/v0MjasxvH8-665.avif 665w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/v0MjasxvH8-665.webp 665w\"><img alt=\"Patched node\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/v0MjasxvH8-665.png\" width=\"665\" height=\"407\"></picture></p>\n<h1 id=\"results\" tabindex=\"-1\">Results <a class=\"header-anchor\" href=\"https://darksi.de/1.to-lock-or-not-to-lock/\">#</a></h1>\n<p>I've opened <a href=\"https://github.com/joyent/node/pull/4105\">pull request for node.js</a> and sent the same patches to the\nopenssl-dev mailing list. With patched node and latest tlsnappy these are the\nbenchmark results:</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/BRRxxvW5zt-597.avif 597w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/BRRxxvW5zt-597.webp 597w\"><img alt=\"Requests per second\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/BRRxxvW5zt-597.png\" width=\"597\" height=\"369\"></picture>\n<picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/mY3nYrAyPR-597.avif 597w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/mY3nYrAyPR-597.webp 597w\"><img alt=\"Average load\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/mY3nYrAyPR-597.png\" width=\"597\" height=\"367\"></picture></p>\n<p>And that's without patches:</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/1RgcbbKMC2-748.avif 748w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/1RgcbbKMC2-748.webp 748w\"><img alt=\"Requests per second\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/1RgcbbKMC2-748.png\" width=\"748\" height=\"439\"></picture>\n<picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/gkPsNNFuzc-596.avif 596w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/gkPsNNFuzc-596.webp 596w\"><img alt=\"Average load\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/gkPsNNFuzc-596.png\" width=\"596\" height=\"368\"></picture></p>\n<p>A little comment about curve names here:</p>\n<ul>\n<li><code>default</code> - one tlsnappy process with 16 threads</li>\n<li><code>hybrid</code> - 4 tlsnappy processes with 4 threads each</li>\n<li><code>cluster</code> - 16 tlsnappy processes with 1 thread each</li>\n<li><code>http</code> - 16 node.js processes in cluster</li>\n</ul>\n<p>The work is unfinished yet, but now I know that OpenSSL doesn't really behave\nwell when used in multithreaded application.</p>\n",
			"date_published": "2012-10-11T00:00:00Z"
		}
		,
		{
			"id": "https://darksi.de/0.benchmarking-tls/",
			"url": "https://darksi.de/0.benchmarking-tls/",
			"title": "Benchmarking TLS, TLSnappy and NGINX",
			"content_html": "<h1 id=\"tl-dr\" tabindex=\"-1\">TL;DR <a class=\"header-anchor\" href=\"https://darksi.de/0.benchmarking-tls/\">#</a></h1>\n<p>I've created <a href=\"https://github.com/indutny/tlsnappy\">TLSnappy</a> module which is going to be faster than internal TLS\nmodule in node.js. So far it's slower on some benchmarks, but it'll definitely\nbe much snappier soon.</p>\n<h1 id=\"preface\" tabindex=\"-1\">Preface <a class=\"header-anchor\" href=\"https://darksi.de/0.benchmarking-tls/\">#</a></h1>\n<p>Many people were complaining about <a href=\"http://nodejs.org/api/tls.html\">tls</a> performance in node.js, which (as\nthey said) was significantly worse than in many other popular web servers,\nbalancers and terminators (i.e. nginx, haproxy..).</p>\n<p>Several things were done to address this issue, including:</p>\n<ul>\n<li>Disabling OpenSSL compression in node, see <a href=\"http://journal.paul.querna.org/articles/2011/04/05/openssl-memory-use/\">Paul Querna's article</a> and <a href=\"https://github.com/joyent/node/commit/e83c695\">Node.js commit</a></li>\n<li><a href=\"https://github.com/joyent/node/commit/e80cac62\">Bundling a newer version of OpenSSL</a></li>\n<li><a href=\"https://github.com/joyent/node/compare/7651228...e0e9f0c\">Enabling inlined assembly</a></li>\n<li><a href=\"https://github.com/joyent/node/commit/7651228\">Using slab allocator to reduce memory allocation overhead</a></li>\n</ul>\n<p>After all that stuff got in, rps (requests per second) rate was significantly\nimproved, but many users were still unhappy with overall TLS performance.</p>\n<h1 id=\"tlsnappy\" tabindex=\"-1\">TLSnappy <a class=\"header-anchor\" href=\"https://darksi.de/0.benchmarking-tls/\">#</a></h1>\n<p>This time, instead of patching and tweaking <a href=\"http://nodejs.org/api/tls.html\">tls</a> I decided that it may be\nworth trying to rewrite it from scratch as a third-party node.js addon. This\nrecently became <a href=\"https://github.com/TooTallNate/node-gyp/wiki/Linking-to-OpenSSL\">possible</a>, thanks to <a href=\"https://github.com/TooTallNate\">Nathan Rajlich</a> and his awesome\nnode.js native addon build tool <a href=\"https://github.com/TooTallNate/node-gyp\">node-gyp</a>.</p>\n<p>I didn't want to offer a module that's functionally equivalent to TLS, but\nwanted to fix some issues (as I've perceived them) and improve few things:</p>\n<ul>\n<li>Encryption/decryption should happen asynchronously (i.e. in other thread).\nThis could potentially speed up initial ssl handshake, and let the event loop\nperform more operations while encryption/decryption is happening in the\nbackground.</li>\n<li>The builtin TLS module passes, slices and copies buffers in <a href=\"https://github.com/indutny/tlsnappy\">javascript</a>.\nAll binary data operations should happen in C++.</li>\n</ul>\n<p>All this was implemented in <a href=\"https://github.com/indutny/tlsnappy\">TLSnappy</a> module.</p>\n<p>There were a lot of availability and stability issues (and surely much more that\nI'm yet unaware of). But tlsnappy seem to be quite a bit more performant than\nthe built-in tls module. Especially... when taking in account that <code>tlsnappy</code> is\nby default using all available cores to encrypt/decrypt requests, while <code>tls</code>\nmodule needs to be run in <a href=\"http://nodejs.org/api/cluster.html\">cluster</a> to balance load between all cores.</p>\n<h1 id=\"benchmarking\" tabindex=\"-1\">Benchmarking <a class=\"header-anchor\" href=\"https://darksi.de/0.benchmarking-tls/\">#</a></h1>\n<p>And I've confirmed that when I was benchmaring it with Apache Benchmark (ab) on\nmy Macbook Pro and on dedicated Xeon server. Here a results from the latter one:</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/oA-F8MEs7a-597.avif 597w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/oA-F8MEs7a-597.webp 597w\"><img alt=\"Xeon 16 threads (rps) - Apache Benchmark\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/oA-F8MEs7a-597.png\" width=\"597\" height=\"370\"></picture>\n<picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/XccLbpLWIB-597.avif 597w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/XccLbpLWIB-597.webp 597w\"><img alt=\"Xeon 16 threads (ms) - Apache Benchmark\" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/XccLbpLWIB-597.png\" width=\"597\" height=\"369\"></picture></p>\n<p>A little comment about curve names here:</p>\n<ul>\n<li><code>default</code> - one tlsnappy process with 16 threads</li>\n<li><code>hybrid</code> - 4 tlsnappy processes with 4 threads each</li>\n<li><code>cluster</code> - 16 tlsnappy processes with 1 thread each</li>\n<li><code>http</code> - 16 node.js processes in cluster</li>\n</ul>\n<p>As you can see tlsnappy is faster than tls server in almost every case, except\n<code>cluster</code> mode (which just wasn't saturating CPU enough). Everything looked\ngreat and shiny, until <a href=\"https://github.com/mranney\">Matt Ranney</a> has pointed out that <code>ab</code> results of\nhttps benchmarks are not really trustful:</p>\n<blockquote class=\"twitter-tweet tw-align-center\"><p>@<a href=\"https://twitter.com/ryah\">ryah</a> @<a href=\"https://twitter.com/indutny\">indutny</a> I was also mislead by \"ab\" with https benchmarks. I'm not sure what tool to use instead though.</p>&mdash; Matt Ranney (@mranney) <a href=\"https://twitter.com/mranney/status/252137849468633088\" data-datetime=\"2012-09-29T20:08:42+00:00\">September 29, 2012</a></blockquote>\n<p>I've installed siege, created node.js <a href=\"https://github.com/indutny/tlsnappy/blob/master/benchmark/script.js\">script</a> and let it run for some time:</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/1RgcbbKMC2-748.avif 748w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/1RgcbbKMC2-748.webp 748w\"><img alt=\"Xeon 16 threads (rps) - Siege \" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/1RgcbbKMC2-748.png\" width=\"748\" height=\"439\"></picture></p>\n<p>Results are much better now (nginx was doing 5000 rps with siege and 2500 rps\nwith ab), but now tlsnappy seems to be slower than node.js' default tls server.</p>\n<p>I started investigation and decided to track not only rps rate, but a CPU load\ntoo:</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://darksi.de/img/gkPsNNFuzc-596.avif 596w\"><source type=\"image/webp\" srcset=\"https://darksi.de/img/gkPsNNFuzc-596.webp 596w\"><img alt=\"Xeon 16 threads (load) - Siege \" loading=\"lazy\" decoding=\"async\" src=\"https://darksi.de/img/gkPsNNFuzc-596.png\" width=\"596\" height=\"368\"></picture></p>\n<h1 id=\"afterword\" tabindex=\"-1\">Afterword <a class=\"header-anchor\" href=\"https://darksi.de/0.benchmarking-tls/\">#</a></h1>\n<p>Right now, as you can see on the chart above, tlsnappy isn't saturating all CPUs\nwell. I suspect this is a major reason of its relative slowness in comparison\nto both nginx and https module. I'm working on making it balance and handle\nrequests better, and will sum up results of this investigation in the next blog\npost.</p>\n<p>For those of you, who are interested in more details -\n<a href=\"https://docs.google.com/spreadsheet/ccc?key=0AhEDnA4M4EKGdDIwb3VYZTd1alA5T1pTVnlQWl9wanc\">here is benchmarks' data</a></p>\n",
			"date_published": "2012-10-02T00:00:00Z"
		}
		
	]
}
