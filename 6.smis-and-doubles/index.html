<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>SMIs and Doubles</title>
		<meta name="description" content="Darkside of Software Engineering.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Fedor Indutny&#39;s Blog">
		<link rel="alternate" href="/feed/feed.json" type="application/json" title="Fedor Indutny&#39;s Blog">
		<meta name="generator" content="Eleventy v2.0.1">
		
		<style>/* Only include the syntax highlighter CSS on blog posts */
/**
 * okaidia theme for JavaScript, CSS and HTML
 * Loosely based on Monokai textmate theme by http://www.monokai.nl/
 * @author ocodia
 */

code[class*="language-"],
pre[class*="language-"] {
	color: #f8f8f2;
	background: none;
	text-shadow: 0 1px rgba(0, 0, 0, 0.3);
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
	border-radius: 0.3em;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #272822;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: #8292a2;
}

.token.punctuation {
	color: #f8f8f2;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.constant,
.token.symbol,
.token.deleted {
	color: #f92672;
}

.token.boolean,
.token.number {
	color: #ae81ff;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #a6e22e;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string,
.token.variable {
	color: #f8f8f2;
}

.token.atrule,
.token.attr-value,
.token.function,
.token.class-name {
	color: #e6db74;
}

.token.keyword {
	color: #66d9ef;
}

.token.regex,
.token.important {
	color: #fd971f;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}

/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
* { box-sizing: border-box; }
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #082840;
	--text-color-link-active: #5f2b48;
	--text-color-link-visited: #17050F;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main {
	padding: 1rem;
}
main :first-child {
	margin-top: 0;
}

header {
	border-bottom: 1px dashed var(--color-gray-20);
}
header:after {
	content: "";
	display: table;
	clear: both;
}

.links-nextprev {
	list-style: none;
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
}
pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
}
code {
	word-break: normal;
}

/* Header */
header {
	display: flex;
	gap: 1em .5em;
	flex-wrap: wrap;
	align-items: center;
	padding: 1em;
}
.home-link {
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
	margin-right: 2em;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	padding: 0;
	margin: 0;
	list-style: none;
  align-items: center;
}
.nav-item {
	display: inline-block;
	margin-right: 1em;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}
.nav-item svg.social {
  display: block;
  width: 18px;
  height: 18px;
}

/* Posts list */
.postlist {
	list-style: none;
	padding: 0;
	padding-left: 1.5rem;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	content: "" counter(start-from, decimal-leading-zero) ". ";
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	padding-left: .25em;
	padding-right: .5em;
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	text-transform: capitalize;
	font-style: italic;
}
.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

/* Direct Links / Markdown Headers */
.header-anchor {
	text-decoration: none;
	font-style: normal;
	font-size: 1em;
	margin-left: .1em;
}
a[href].header-anchor,
a[href].header-anchor:visited {
	color: transparent;
}
a[href].header-anchor:focus,
a[href].header-anchor:hover {
	text-decoration: underline;
}
a[href].header-anchor:focus,
:hover > a[href].header-anchor {
	color: #aaa;
}

h2 + .header-anchor {
	font-size: 1.5em;
}

footer {
  padding: 1.5em 0 0.5em 0;
  font-size: 0.75em;
  text-align: right;
}

img {
  max-width: 100%;
  height: auto;
}</style>
	</head>
	<body>
		<a href="#skip" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">Fedor Indutny&#39;s Blog</a>

      
			<nav>
				<h2 class="visually-hidden">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/blog/">Archive</a></li>
					<li class="nav-item"><a href="/about/">About Me</a></li>
          <li class="nav-item">
            <a href="https://github.com/indutny" target="_blank" rel="noreferrer">
              <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github social" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
            </a>
          </li>
          <li class="nav-item">
            <a href="https://fosstodon.org/@indutny" target="_blank" rel="me">
              <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="mastodon" class="svg-inline--fa fa-mastodon social" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"></path></svg>
            </a>
          </li>
				</ul>
			</nav>
		</header>

		<main id="skip">
			
<h1>SMIs and Doubles</h1>

<ul class="post-metadata">
	<li><time datetime="2013-11-14">14 November 2013</time></li>
	<li><a href="/tags/compilers/" class="post-tag">compilers</a></li>
</ul>

<p>This is a third post in the series of the JIT compiling crash-course. For a
context please consider reading <a href="/4.how-to-start-jitting">the first one</a> and <a href="/5.allocating-numbers">the second</a>.</p>
<h2 id="goal" tabindex="-1">Goal <a class="header-anchor" href="#goal">#</a></h2>
<p>Last time we created very basic bump memory allocator and made our existing
code work with floating point double numbers, stored in the allocated heap
objects. However floating point numbers are not suitable for some of
precision-dependent operations and also, since they are stored in memory,
requiring additional memory loads and stores, slowing down the code performance.</p>
<p>Both of this problems could be solved by working with the integers stored in the
registers (as we did it in <a href="/4.how-to-start-jitting">first blog post</a>), which means that we will need
to support both types of numbers in our compiler's runtime (doubles and
integers).</p>
<h2 id="tagging" tabindex="-1">Tagging <a class="header-anchor" href="#tagging">#</a></h2>
<p>Let's recall that we are storing both pointers and numbers in the 64bit general
purpose registers (<code>rax</code>, <code>rbx</code>, ...). The main issue here is that, given some
register (say <code>rax</code>), we should be able to tell if it is a pointer to the heap
object (a &quot;boxed value&quot;) or an integer itself (an &quot;unboxed value&quot;,
Small Integer, or <em>SMI</em>).</p>
<p>Usually, a method called &quot;tagging&quot; is used to solve this. While there are
<a href="http://wingolog.org/archives/2011/05/18/value-representation-in-javascript-implementations">various ways</a> to implement tagging, including: <a href="http://evilpie.github.io/sayrer-fatval-backup/cache.aspx.htm">Nan-Boxing</a> (scroll down
to <em>Mozilla’s New JavaScript Value Representation</em>), Nun-Boxing, and probably
some others, our compiler will just reserve the least significant bit of the
64bit register and put <code>1</code> here if the value is a pointer and <code>0</code> if it is a
<em>SMI</em> (Small Integer).</p>
<p>Here is an example of this representation:</p>
<p><picture><source type="image/avif" srcset="/img/FZYMic5DRc-352.avif 352w"><source type="image/webp" srcset="/img/FZYMic5DRc-352.webp 352w"><img alt="Smi and Pointer" loading="lazy" decoding="async" src="/img/FZYMic5DRc-352.png" width="352" height="202"></picture></p>
<p>Note that to get the actual value of a SMI (&quot;untag&quot;) we will need to shift it
right for one bit (<code>&gt;&gt; 1</code>), and to convert an integer to the SMI - shift left
(<code>&lt;&lt; 1</code>). Using zero for tagging SMIs pays off greatly, since we don't need to
to untag numbers to perform addition and subtraction.</p>
<p>To use tagged pointers to heap objects we'll need to look one byte behind the
actual value, which is relatively simple in the assembly language:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token comment">// Lets say that tagged pointer is in rbx</span><br><span class="token comment">// And we're loading its contents into the rax</span><br><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mov</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'rbx'</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>And just for the convenience - example of untagging SMIs:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token comment">// Untag</span><br><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">shr</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// Tag</span><br><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">shl</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>And now the most important part that we're going to do a lot - checking if the
value is a pointer:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token comment">// Test that 'rax' has the last bit</span><br><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// 'z' stands for zero</span><br><span class="token comment">// Basically, jump to the label if `(rax &amp; 1) == 0`</span><br><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">j</span><span class="token punctuation">(</span><span class="token string">'z'</span><span class="token punctuation">,</span> <span class="token string">'is-smi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// 'nz' stands for non-zero</span><br><span class="token comment">// Basically, jump to the label if `(rax &amp; 1) != 0`</span><br><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">j</span><span class="token punctuation">(</span><span class="token string">'ne'</span><span class="token punctuation">,</span> <span class="token string">'is-heap-object-pointer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2 id="reworking-previous-code" tabindex="-1">Reworking previous code <a class="header-anchor" href="#reworking-previous-code">#</a></h2>
<p>Using <a href="https://github.com/indutny/jit.js/tree/master/example/heap">the code from the previous blog post</a>, we can finally proceed to
implementing all this recently learned stuff.</p>
<p>First, let's add a convenient helper methods to the assembly context.</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">untagSmi</span><span class="token punctuation">(</span><span class="token parameter">reg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">shr</span><span class="token punctuation">(</span>reg<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">function</span> <span class="token function">checkSmi</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> t<span class="token punctuation">,</span> f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// If no `true-` and `false-` bodies were specified -</span><br>  <span class="token comment">// just test the value.</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>t <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>f<span class="token punctuation">)</span><br>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Enter the scope to be able to use named labels</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">labelScope</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Test the value</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Skip SMI case if result is non-zero</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">j</span><span class="token punctuation">(</span><span class="token string">'nz'</span><span class="token punctuation">,</span> <span class="token string">'non-smi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Run SMI case</span><br>    <span class="token function">t</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Jump to the shared end</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">j</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Non-SMI case</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">'non-smi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">f</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Shared end</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">function</span> <span class="token function">heapOffset</span><span class="token punctuation">(</span><span class="token parameter">reg<span class="token punctuation">,</span> offset</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// NOTE: 8 is the size of pointer on x64 arch.</span><br>  <span class="token comment">// We're adding 1 to the offset, because first</span><br>  <span class="token comment">// quad word is used to store the heap object's type.</span><br>  <span class="token keyword">return</span> <span class="token punctuation">[</span>reg<span class="token punctuation">,</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>offset <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>We can hook this methods into the jit.js context by passing them as a <code>helpers</code>
option to the <code>jit.compile()</code> API method:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">var</span> helpers <span class="token operator">=</span> <span class="token punctuation">{</span><br>  <span class="token literal-property property">untagSmi</span><span class="token operator">:</span> untagSmi<span class="token punctuation">,</span><br>  <span class="token literal-property property">checkSmi</span><span class="token operator">:</span> checkSmi<span class="token punctuation">,</span><br>  <span class="token literal-property property">heapOffset</span><span class="token operator">:</span> heapOffset<br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>jit<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// We can use helpers here:</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">untagSmi</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkSmi</span><span class="token punctuation">(</span><span class="token string">'rbx'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Work with SMI</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Work with pointer</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mov</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">heapOffset</span><span class="token punctuation">(</span><span class="token string">'rbx'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">stubs</span><span class="token operator">:</span> stubs<span class="token punctuation">,</span> <span class="token literal-property property">helpers</span><span class="token operator">:</span> helpers <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2 id="allocation" tabindex="-1">Allocation <a class="header-anchor" href="#allocation">#</a></h2>
<p>Now we should make our <code>Alloc</code> stub return tagged pointer. Also we will use the
opportunity and improve it a bit by adding <code>tag</code> and <code>size</code> arguments to the
stub (thus making possible generalized allocation with variable size and tag
in the future):</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">stubs<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'Alloc'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">size<span class="token punctuation">,</span> tag</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// Save 'rbx' and 'rcx' registers</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">spill</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'rbx'</span><span class="token punctuation">,</span> <span class="token string">'rcx'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Load `offset`</span><br>    <span class="token comment">//</span><br>    <span class="token comment">// NOTE: We'll use pointer to `offset` variable,</span><br>    <span class="token comment">// to be able to update</span><br>    <span class="token comment">// it below</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mov</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mov</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'rax'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Load end</span><br>    <span class="token comment">//</span><br>    <span class="token comment">// NOTE: Same applies to end, though, we're</span><br>    <span class="token comment">// not updating it right now</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mov</span><span class="token punctuation">(</span><span class="token string">'rbx'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mov</span><span class="token punctuation">(</span><span class="token string">'rbx'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'rbx'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Calculate new `offset`</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mov</span><span class="token punctuation">(</span><span class="token string">'rcx'</span><span class="token punctuation">,</span> <span class="token string">'rax'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Add tag size and body size</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'rcx'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'rcx'</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Check if we won't overflow our fixed size buffer</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cmp</span><span class="token punctuation">(</span><span class="token string">'rcx'</span><span class="token punctuation">,</span> <span class="token string">'rbx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// this.j() performs conditional jump to the specified label.</span><br>    <span class="token comment">// 'g' stands for 'greater'</span><br>    <span class="token comment">// 'overflow' is a label name, bound below</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">j</span><span class="token punctuation">(</span><span class="token string">'g'</span><span class="token punctuation">,</span> <span class="token string">'overflow'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Ok, we're good to go, update offset</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mov</span><span class="token punctuation">(</span><span class="token string">'rbx'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mov</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'rbx'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'rcx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// First 64bit pointer is reserved for 'tag',</span><br>    <span class="token comment">// second one is a `double` value</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mov</span><span class="token punctuation">(</span><span class="token string">'rcx'</span><span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mov</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'rax'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'rcx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// !!!!!!!!!!!!!!!</span><br>    <span class="token comment">// ! Tag pointer !</span><br>    <span class="token comment">// !!!!!!!!!!!!!!!</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Return 'rax'</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">Return</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Overflowed :(</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">'overflow'</span><span class="token punctuation">)</span><br><br>    <span class="token comment">// Invoke javascript function!</span><br>    <span class="token comment">// NOTE: This is really funky stuff, but I'm not</span><br>    <span class="token comment">// going to dive deep into it right now</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runtime</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'GC is needed, but not implemented'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Crash</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">int3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">Return</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2 id="math-stubs" tabindex="-1">Math stubs <a class="header-anchor" href="#math-stubs">#</a></h2>
<p>Also, as we're going to do a bit more book-keeping in math operations to support
both SMIs and doubles, let's split it apart and put the code, handling doubles
into the stub:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">var</span> operators <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'+'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token keyword">var</span> map <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string-property property">'+'</span><span class="token operator">:</span> <span class="token string">'addsd'</span><span class="token punctuation">,</span> <span class="token string-property property">'-'</span><span class="token operator">:</span> <span class="token string">'subsd'</span><span class="token punctuation">,</span> <span class="token string-property property">'*'</span><span class="token operator">:</span> <span class="token string">'mulsd'</span><span class="token punctuation">,</span><br>            <span class="token string-property property">'/'</span><span class="token operator">:</span> <span class="token string">'divsd'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token comment">// Define `Binary+`, `Binary-`, `Binary*`, and `Binary/` stubs</span><br>operators<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">operator</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  stubs<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'Binary'</span> <span class="token operator">+</span> operator<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">left<span class="token punctuation">,</span> right</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Save 'rbx' and 'rcx'</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">spill</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'rbx'</span><span class="token punctuation">,</span> <span class="token string">'rcx'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token comment">// Load arguments to rax and rbx</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mov</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> left<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mov</span><span class="token punctuation">(</span><span class="token string">'rbx'</span><span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>      <span class="token comment">// Convert both numbers to doubles</span><br>      <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token string">'xmm1'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'rbx'</span><span class="token punctuation">,</span> <span class="token string">'xmm2'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">regs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">var</span> nonSmi <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">label</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">var</span> done <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">label</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkSmi</span><span class="token punctuation">(</span>regs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">j</span><span class="token punctuation">(</span><span class="token string">'nz'</span><span class="token punctuation">,</span> nonSmi<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">// Convert integer to double</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">untagSmi</span><span class="token punctuation">(</span>regs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cvtsi2sd</span><span class="token punctuation">(</span>regs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">j</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>nonSmi<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">movq</span><span class="token punctuation">(</span>regs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">heapOffset</span><span class="token punctuation">(</span>regs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>      <span class="token keyword">var</span> instr <span class="token operator">=</span> map<span class="token punctuation">[</span>operator<span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>      <span class="token comment">// Execute binary operation</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>instr<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">this</span><span class="token punctuation">[</span>instr<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'xmm1'</span><span class="token punctuation">,</span> <span class="token string">'xmm2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Unsupported binary operator: '</span> <span class="token operator">+</span><br>                        operator<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br><br>      <span class="token comment">// Allocate new number, and put value in it</span><br>      <span class="token comment">// NOTE: Last two arguments are arguments to</span><br>      <span class="token comment">// the stub (`size` and `tag`)</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stub</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token string">'Alloc'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">movq</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">heapOffset</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'xmm1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">Return</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Note that this stub also converts all incoming numbers to doubles.</p>
<h2 id="compiler" tabindex="-1">Compiler <a class="header-anchor" href="#compiler">#</a></h2>
<p>And back to the compiler's code:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">visitProgram</span><span class="token punctuation">(</span><span class="token parameter">ast</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span>length<span class="token punctuation">,</span><br>               <span class="token number">1</span><span class="token punctuation">,</span><br>               <span class="token string">'Only one statement programs are supported'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token string">'ExpressionStatement'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// We've a pointer in 'rax', convert it to integer</span><br>  <span class="token function">visit</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ast<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Get floating point number out of heap number</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkSmi</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Untag smi</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">untagSmi</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">movq</span><span class="token punctuation">(</span><span class="token string">'xmm1'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">heapOffset</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Round it towards zero</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">roundsd</span><span class="token punctuation">(</span><span class="token string">'zero'</span><span class="token punctuation">,</span> <span class="token string">'xmm1'</span><span class="token punctuation">,</span> <span class="token string">'xmm1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Convert double to integer</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cvtsd2si</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token string">'xmm1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">visitLiteral</span><span class="token punctuation">(</span><span class="token parameter">ast</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> ast<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token string">'number'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>value <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> ast<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Small Integer (SMI), Tagged value</span><br>    <span class="token comment">// (i.e. val * 2) with last bit set to</span><br>    <span class="token comment">// zero</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mov</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> utils<span class="token punctuation">.</span><span class="token function">tagSmi</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Allocate new heap number</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stub</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token string">'Alloc'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Save 'rbx' register</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">spill</span><span class="token punctuation">(</span><span class="token string">'rbx'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadDouble</span><span class="token punctuation">(</span><span class="token string">'rbx'</span><span class="token punctuation">,</span> ast<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>      <span class="token comment">// NOTE: Pointers have last bit set to 1</span><br>      <span class="token comment">// That's why we need to use 'heapOffset'</span><br>      <span class="token comment">// routine to access it's memory</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mov</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">heapOffset</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'rbx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">visitBinary</span><span class="token punctuation">(</span><span class="token parameter">ast</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// Preserve 'rbx' after leaving the AST node</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">spill</span><span class="token punctuation">(</span><span class="token string">'rbx'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Visit left side of expresion</span><br>    <span class="token function">visit</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ast<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Move it to 'rbx'</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mov</span><span class="token punctuation">(</span><span class="token string">'rbx'</span><span class="token punctuation">,</span> <span class="token string">'rax'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Visit right side of expression (the result is in 'rax')</span><br>    <span class="token function">visit</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ast<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">//</span><br>    <span class="token comment">// So, to conclude, we've left side in 'rax' and right in 'rbx'</span><br>    <span class="token comment">//</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ast<span class="token punctuation">.</span>operator <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token comment">// Call stub for division</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stub</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token string">'Binary'</span> <span class="token operator">+</span> ast<span class="token punctuation">.</span>operator<span class="token punctuation">,</span> <span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token string">'rbx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">labelScope</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token comment">// Check if both numbers are SMIs</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkSmi</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">j</span><span class="token punctuation">(</span><span class="token string">'nz'</span><span class="token punctuation">,</span> <span class="token string">'call stub'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkSmi</span><span class="token punctuation">(</span><span class="token string">'rbx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">j</span><span class="token punctuation">(</span><span class="token string">'nz'</span><span class="token punctuation">,</span> <span class="token string">'call stub'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">// Save rax in case of overflow</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mov</span><span class="token punctuation">(</span><span class="token string">'rcx'</span><span class="token punctuation">,</span> <span class="token string">'rax'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">// NOTE: both 'rax' and 'rbx' are tagged at this</span><br>        <span class="token comment">// point.</span><br>        <span class="token comment">// Tags don't need to be removed if we're doing</span><br>        <span class="token comment">// addition or subtraction. However, in case of</span><br>        <span class="token comment">// multiplication result would be 2x bigger if</span><br>        <span class="token comment">// we won't untag one of the arguments.</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ast<span class="token punctuation">.</span>operator <span class="token operator">===</span> <span class="token string">'+'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token string">'rbx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ast<span class="token punctuation">.</span>operator <span class="token operator">===</span> <span class="token string">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token string">'rbx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ast<span class="token punctuation">.</span>operator <span class="token operator">===</span> <span class="token string">'*'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">untagSmi</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token string">'rbx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token comment">// On overflow restore 'rax' from 'rcx' and invoke stub</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">j</span><span class="token punctuation">(</span><span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token string">'restore'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">// Otherwise return 'rax'</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">j</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">'restore'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mov</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token string">'rcx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">'call stub'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">// Invoke stub and return heap number in 'rax'</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stub</span><span class="token punctuation">(</span><span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token string">'Binary'</span> <span class="token operator">+</span> ast<span class="token punctuation">.</span>operator<span class="token punctuation">,</span> <span class="token string">'rax'</span><span class="token punctuation">,</span> <span class="token string">'rbx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">visitUnary</span><span class="token punctuation">(</span><span class="token parameter">ast</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ast<span class="token punctuation">.</span>operator <span class="token operator">===</span> <span class="token string">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Negate argument by emulating binary expression</span><br>    <span class="token function">visit</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'BinaryExpression'</span><span class="token punctuation">,</span><br>      <span class="token literal-property property">operator</span><span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span><br>      <span class="token literal-property property">left</span><span class="token operator">:</span> ast<span class="token punctuation">.</span>argument<span class="token punctuation">,</span><br>      <span class="token literal-property property">right</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'Literal'</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Unsupported unary operator: '</span> <span class="token operator">+</span> ast<span class="token punctuation">.</span>operator<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>To conclude, we are now working with SMIs by default, inlining all operations
for the speed's sake, and falling back to the doubles in case of overflow or any
other trouble, like trying to sum a double and a SMI!</p>
<p>That's all for now, see you here next time! Here is the full compiler code from
this article: <a href="https://github.com/indutny/jit.js/tree/master/example/heap-smi-and-double">github</a>. Please try cloning, running and playing with it!
Hope you enjoyed this post.</p>

<ul class="links-nextprev"><li>Previous: <a href="/6.allocating-numbers/">Allocating numbers</a></li><li>Next: <a href="/7.freebsd-dtrace/">Running node.js + DTrace on FreeBSD</a></li>
</ul>

		</main>

		<footer>
      Copyright Fedor Indutny 2024;
      <a href="https://github.com/indutny/blog" target="_blank" rel="noreferrer">Released</a>
      under
      <a href="https://opensource.org/licenses/mit-license.php" target="_blank" rel="noreferrer">
        MIT license
      </a>.
    </footer>

		<!-- Current page: /6.smis-and-doubles/ -->
	</body>
</html>
