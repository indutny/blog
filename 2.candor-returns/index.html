<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Candor returns</title>
		<meta name="description" content="Darkside of Software Engineering.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Fedor Indutny&#39;s Blog">
		<link rel="alternate" href="/feed/feed.json" type="application/json" title="Fedor Indutny&#39;s Blog">
		<meta name="generator" content="Eleventy v2.0.1">
		
		<style>/* Only include the syntax highlighter CSS on blog posts */
/**
 * okaidia theme for JavaScript, CSS and HTML
 * Loosely based on Monokai textmate theme by http://www.monokai.nl/
 * @author ocodia
 */

code[class*="language-"],
pre[class*="language-"] {
	color: #f8f8f2;
	background: none;
	text-shadow: 0 1px rgba(0, 0, 0, 0.3);
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
	border-radius: 0.3em;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #272822;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: #8292a2;
}

.token.punctuation {
	color: #f8f8f2;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.constant,
.token.symbol,
.token.deleted {
	color: #f92672;
}

.token.boolean,
.token.number {
	color: #ae81ff;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #a6e22e;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string,
.token.variable {
	color: #f8f8f2;
}

.token.atrule,
.token.attr-value,
.token.function,
.token.class-name {
	color: #e6db74;
}

.token.keyword {
	color: #66d9ef;
}

.token.regex,
.token.important {
	color: #fd971f;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}

/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
* { box-sizing: border-box; }
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #082840;
	--text-color-link-active: #5f2b48;
	--text-color-link-visited: #17050F;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main {
	padding: 1rem;
}
main :first-child {
	margin-top: 0;
}

header {
	border-bottom: 1px dashed var(--color-gray-20);
}
header:after {
	content: "";
	display: table;
	clear: both;
}

.links-nextprev {
	list-style: none;
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
}
pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
}
code {
	word-break: normal;
}

/* Header */
header {
	display: flex;
	gap: 1em .5em;
	flex-wrap: wrap;
	align-items: center;
	padding: 1em;
}
.home-link {
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
	margin-right: 2em;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	padding: 0;
	margin: 0;
	list-style: none;
  align-items: center;
}
.nav-item {
	display: inline-block;
	margin-right: 1em;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}
.nav-item svg.social {
  display: block;
  width: 18px;
  height: 18px;
}

/* Posts list */
.postlist {
	list-style: none;
	padding: 0;
	padding-left: 1.5rem;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	content: "" counter(start-from, decimal-leading-zero) ". ";
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	padding-left: .25em;
	padding-right: .5em;
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	text-transform: capitalize;
	font-style: italic;
}
.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

/* Direct Links / Markdown Headers */
.header-anchor {
	text-decoration: none;
	font-style: normal;
	font-size: 1em;
	margin-left: .1em;
}
a[href].header-anchor,
a[href].header-anchor:visited {
	color: transparent;
}
a[href].header-anchor:focus,
a[href].header-anchor:hover {
	text-decoration: underline;
}
a[href].header-anchor:focus,
:hover > a[href].header-anchor {
	color: #aaa;
}

h2 + .header-anchor {
	font-size: 1.5em;
}

footer {
  padding: 1.5em 0 0.5em 0;
  font-size: 0.75em;
  text-align: right;
}

img {
  max-width: 100%;
  height: auto;
}</style>
	</head>
	<body>
		<a href="#skip" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">Fedor Indutny&#39;s Blog</a>

      
			<nav>
				<h2 class="visually-hidden">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/blog/">Archive</a></li>
					<li class="nav-item"><a href="/about/">About Me</a></li>
          <li class="nav-item">
            <a href="https://github.com/indutny" target="_blank" rel="noreferrer">
              <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github social" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
            </a>
          </li>
          <li class="nav-item">
            <a href="https://fosstodon.org/@indutny" target="_blank" rel="me">
              <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="mastodon" class="svg-inline--fa fa-mastodon social" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"></path></svg>
            </a>
          </li>
				</ul>
			</nav>
		</header>

		<main id="skip">
			
<h1>Candor returns</h1>

<ul class="post-metadata">
	<li><time datetime="2012-11-21">21 November 2012</time></li>
	<li><a href="/tags/compilers/" class="post-tag">compilers</a></li>
</ul>

<p>Before I start diving into the deep sea of compiler internals, I would like to
familiarize you with the <a href="https://github.com/indutny/candor">Candor</a> programming language and its Virtual
Machine.</p>
<p>This is the thing I was working on last 10 months, and one of the most wonderful
and complex things I've been working on since the start of my software
development career.</p>
<p>Candor is an Ecmascript-inspired language, but while the newer versions of the
Ecmascript standard are adding new functionality and syntax features, my
language aims to make the syntax as simple as possible.</p>
<h3 id="no-exceptions" tabindex="-1">No exceptions <a class="header-anchor" href="#no-exceptions">#</a></h3>
<p>Caller can always be sure that function will return after the call. You should
either invoke a callback with an error argument, return negative number on
error, or do anything else to let caller know about errors that has happened.</p>
<h3 id="no-undefined-and-null" tabindex="-1">No undefined and null <a class="header-anchor" href="#no-undefined-and-null">#</a></h3>
<p>There is the only one value and type that represents undefined value - <code>nil</code>.
Thus, less checks and a more understandable behaviour of your application.</p>
<h3 id="no-implicit-global-variables" tabindex="-1">No implicit global variables <a class="header-anchor" href="#no-implicit-global-variables">#</a></h3>
<p>Every global variable access should be done explicitly, by loading/storing
properties of the <code>global</code> object. To my mind, it's the most simplest and
powerful way to prevent global leaks.</p>
<h3 id="no-default-runtime" tabindex="-1">No default runtime <a class="header-anchor" href="#no-default-runtime">#</a></h3>
<p>Candor has no default APIs that are doing 'high-level' things with objects and
arrays. These routines should be implemented by embedder (like <a href="https://github.com/indutny/candor.io">candor.io</a>).</p>
<p>Removing runtime from VM is good in terms of support, less dependencies - less
things to care about, and leaving things out of the core keeps it compact.</p>
<h3 id="no-prototype-chains" tabindex="-1">No prototype chains <a class="header-anchor" href="#no-prototype-chains">#</a></h3>
<p>Objects are just magic-less hash-maps without special properties like
<code>toString</code> or <code>__proto__</code>. Additionally you can have both numeric and string
keys in objects (in other words, <code>a[0]</code> and <code>a['0']</code> are not the same thing).</p>
<p>Also there're no <code>length</code> property of array, it's replaced by <code>sizeof</code> keyword.
Example: <code>sizeof [1,2,3] == 3</code> or even <code>sizeof &quot;string&quot;</code>.</p>
<h3 id="no-complicated-type-coercion" tabindex="-1">No complicated type coercion <a class="header-anchor" href="#no-complicated-type-coercion">#</a></h3>
<p>Objects, arrays and nil are always converted either to empty string or to zero,
depending on type of another argument. For example, this lets you increment
uninitialized variables without getting any errors or unexpected behaviour:
<code>nil + 1 == 1</code>.</p>
<h3 id="dart-like-function-syntax" tabindex="-1">Dart-like function syntax <a class="header-anchor" href="#dart-like-function-syntax">#</a></h3>
<p>No <code>function</code> keyword, yay! Just write:</p>
<pre class="language-dart" tabindex="0"><code class="language-dart"><span class="token function">function_name</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">//body</span><br><span class="token punctuation">}</span></code></pre>
<h2 id="syntax" tabindex="-1">Syntax <a class="header-anchor" href="#syntax">#</a></h2>
<p>You can learn more about syntax and play with it on <a href="http://candor-lang.org/">the official website</a>.</p>
<h2 id="compiler" tabindex="-1">Compiler <a class="header-anchor" href="#compiler">#</a></h2>
<p>Since the <a href="https://github.com/indutny/candor/commit/f3b1ebf3a839e32fcafa14b21af3">start of this year</a> I have been working on delivering very
primitive JIT compiler and VM for Candor. The first version was generating
pretty ugly machine code, which was ineffective and massive.</p>
<p>It was using the following algorithm:</p>
<ol>
<li>Visit AST node.</li>
<li>Generate all it's children, and place their results into <code>rax</code>, <code>rbx</code>, <code>rcx</code>
(depending on child's index). (Just in case - <a href="http://en.wikipedia.org/wiki/X86-64">x86-64</a>)</li>
<li>Generate code that calculates the result of operation and return value in
<code>rax</code>.</li>
</ol>
<p>Pros - fast compilation, easy to understand algorithm. Cons - hard way to deal
with different CPU architectures (i.e. it needed more than 6 registers), dumb
generated machine code.</p>
<p>Thanks to <a href="https://code.google.com/p/v8/">v8</a> and <a href="http://www.dartlang.org/">Dart</a> hacker <a href="http://mrale.ph/">Vyacheslav Egorov</a> and
<a href="http://wingolog.org/">Andy Wingo's blog</a>, I've figured out that <a href="https://github.com/indutny/candor/wiki/Compiler-papers">there're much better ways</a> to
do JIT code generation, but it was too complex for me to understand at that
time. And despite I've created new branch <code>feature-ssa</code> and written tons of
code, I've never got something truly working.</p>
<p>I got stuck at implementing registry allocator, mostly because of wrong design
decisions that I made before, and continuing development of this branch in this
form was impossible.</p>
<p>That's why I took a long break (for almost 6 months) and worked on other
projects, until I realized how this thing should be implemented.</p>
<h2 id="candor-returns" tabindex="-1">Candor returns <a class="header-anchor" href="#candor-returns">#</a></h2>
<p>After this pause I've considered many things and finally did it. Even more,
Candor now has two compilers: non-optimizing and optimizing. The non-optimizing
is used where it needs to compile a lot of source as fast as possible, and the
optimizing compiler is used for small functions that might be quickly optimized.</p>
<p>Main things that helped me to got to this state:</p>
<ol>
<li>Understanding how <a href="http://en.wikipedia.org/wiki/Control_flow_graph">CFG</a> and <a href="http://en.wikipedia.org/wiki/Static_single_assignment_form">SSA</a> should be really handled and
represented. CFG is a way to represent tree of input source code (AST) in a
linear form, by placing instructions in blocks and connecting them with the
control-flow edges like: goto and branch (which is used in <code>if</code> and <code>while</code>
statements). What I was missing is that the instruction and it's value should
be the same object, otherwise it's very problematic to exploit
<a href="http://en.wikipedia.org/wiki/Use-define_chain">def-use chains</a>, which are very useful for getting type information and
performing dead code elimination.</li>
<li>I was detecting variable conflicts in the blocks with two incoming
edges in a over-complicated way. I was using lists of active variables and
performing very complex analysis to propagate them to blocks that needed
them. Apparently, it's very cool and simple to do it in a way v8 does it. By
creating environment for each basic block in CFG, placing variables into it
and copying it as-it-is when adding successor to the block.</li>
<li>I didn't understand that low-level intermediate representation should
operate on <code>uses</code> which a parts of variable's liveness intervals... Previous
version was doing simplified linear-scan register allocation without holes in
variable's liveness intervals, which isn't resulting in good allocation.</li>
</ol>
<p>The main difference between optimizing and non-optimizing compiler is that the
former is trying to place everything in registers, while the latter operates
only on the stack slots (i.e. doing memory access on every variable load and
store).</p>
<p>By having a register allocator that's capable of allocating registers in very
generic terms, it was really straightforward to add support for a 32bit code
generation. And now Candor is officially running on two platforms: ia32 and x64.</p>
<h2 id="plans" tabindex="-1">Plans <a class="header-anchor" href="#plans">#</a></h2>
<p>Now that there are two brand new compilers, I'm going to work on adaptive
optimization/deoptimization for it. Candor should be capable of optimizing
hot functions on the fly and inlining small functions into their callers. Also,
it's quite practical to generate code that's very fast in common cases, and
falls back to unoptimized code in all other cases.</p>
<p>ARM support is also the part of my future plans for Candor, and I'll start
working on it as soon as I'll receive my Raspberry PI.</p>
<h2 id="more-info" tabindex="-1">More info <a class="header-anchor" href="#more-info">#</a></h2>
<p>If you want to ask questions and/or learn more about Candor you can subscribe to
our <a href="https://groups.google.com/forum/?fromgroups&amp;hl=en#!forum/candorlang">google group</a> or join the #candor IRC channel on freenode.</p>

<ul class="links-nextprev"><li>Previous: <a href="/1.to-lock-or-not-to-lock/">To lock, or not to lock</a></li><li>Next: <a href="/3.dtrace-ustack-helper/">DTrace and the little ustack helper that could</a></li>
</ul>

		</main>

		<footer>
      Copyright Fedor Indutny 2023;
      <a href="https://github.com/indutny/blog" target="_blank" rel="noreferrer">Released</a>
      under
      <a href="https://opensource.org/licenses/mit-license.php" target="_blank" rel="noreferrer">
        MIT license
      </a>.
    </footer>

		<!-- Current page: /2.candor-returns/ -->
	</body>
</html>
